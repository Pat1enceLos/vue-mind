<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.4.11 (462458)"/><meta name="altitude" content="14.74790191650391"/><meta name="author" content="181imzxv256"/><meta name="created" content="2022-02-21 05:19:56 +0000"/><meta name="latitude" content="31.28205236856187"/><meta name="longitude" content="121.4380107838037"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2022-03-10 11:12:06 +0000"/><meta name="content-class" content="yinxiang.markdown"/><title>Vue.js设计与实现</title></head><body><div style="font-size: 14px; margin: 0; padding: 0; width: 100%;"><div style="line-height: 160%; box-sizing: content-box;"><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第一篇《框架设计概览》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第一章《权衡的艺术》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">声明式与命令式的权衡
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">编译时和运行时的权衡
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第二章《框架设计的核心要素》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">提升用户开发体验
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">控制框架代码的体积
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">框架要做到良好的Tree-Shaking
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">框架应该输出怎样的构建产物
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">特性开关
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">错误处理
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">良好的Typescript类型支持
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第三章《Vue.js3的设计思路》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">渲染器
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">组件的本质
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">模版的工作原理
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">Vue.js是各个模块组成的有机整体
</a></li></ul></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第二篇《响应系统》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第四章《响应系统的作用与实现》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">如何设计这个“桶”
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">分支切换与cleanup
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">嵌套的effect与effect栈
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">避免无限递归循环
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">调度执行
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">计算属性computed与lazy
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">watch的实现原理
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">过期的副作用
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第5章《非原始值的响应式方案》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">理解Proxy和Reflect
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">Javascript对象及Proxy的工作原理
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">如何代理Object
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">合理地触发响应
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">浅响应与深响应
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">只读和浅只读
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">代理数组
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">遍历数组
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">数组的查找方法
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">隐式修改数组长度的原型方法
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">代理Set和Map
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">建立相应关系
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">避免污染原始数据
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">处理forEach
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">迭代器方法
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">values与keys方法
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">总结
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第6章《原始值的响应式方案》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">响应丢失问题
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">自动脱ref
</a></li></ul></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第三篇《渲染器》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第7章《渲染器的设计》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">渲染器的基本概念
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">自定义渲染器
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第8章《挂载与更新》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">正确地设置元素属性
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">class的处理
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">卸载操作
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">区分vnode的类型
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">事件的处理
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">事件冒泡与更新时机问题
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">更新子节点
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">文本节点和注释节点
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">Fragment
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">总结
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第9章《简单Diff算法》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">减少DOM操作的性能开销
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">DOM复用与key的作用
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">找到需要移动的元素
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">如何移动元素
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">添加新元素
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">移除不存在的元素
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">总结
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第10章《双端Diff算法》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">双端比较的原理
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">双端比较的优势
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">非理想状况的处理方式
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">添加新元素
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">移除不存在的元素
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">总结
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第11章《快速Diff算法》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">相同的前置元素和后置元素
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">判断是否需要进行DOM移动操作
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">如何移动元素
</a></li></ul></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第四篇《组件化》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第12章《组件的实现原理》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">组件状态与自更新
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">组件实例与组件的生命周期
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">props与组件的被动更新
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">setup函数的作用与实现
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">组件事件与emit的实现
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">插槽的工作原理与实现
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">注册生命周期
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">总结
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第13章《异步组件与函数式组件》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">异步组件要解决的问题
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">异步组件的实现原理
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">超时与Error组件
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">延迟与Loading组件
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">重试机制
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">函数式组件
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">总结
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第14章《内建组件和模块》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">KeepAlive组件的实现原理
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">组件的激活与失灵
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">include和exclude
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">缓存管理
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">Teleport组件的实现原理
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">Teleport组件要解决的问题
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">实现Teleport组件
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">Transition组件的实现原理
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">原生DOM的过渡
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">实现Transition组件
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">总结
</a></li></ul></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第五篇《编译器》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第15章《编译器核心技术概览》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">模版DSL的编译器
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">parser的实现原理与状态机
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">构造AST
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">AST的转换与插件化架构
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">将模版AST转为JavaScript AST
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">代码生成
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第16章《解析器》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">文本模式及其对解析器的影响
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">递归下降算法构造模版AST
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">状态机的开启与停止
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">解析标签节点
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">解析属性
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">解析文本与解码HTML实体
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第17章《编译优化》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">动态节点收集与补丁标志
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">Block与PatchFlags
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">收集动态节点
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">渲染器的运行时支持
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">Block树
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">带有v-if指令的节点
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">带有v-for指令的节点
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">Fragment的稳定性
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">静态提升
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">预字符串化
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">缓存内联事件处理函数
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">v-once
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第六篇《服务端渲染》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">第18章《同构渲染》
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">CSR、SSR以及同构渲染
</a></li></ul></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">将虚拟DOM渲染为HTML字符串
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">将组件渲染为HTML字符串
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">客户端激活的原理
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">编写同构的代码
</a><ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;"><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">组件的生命周期
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">使用跨平台的API
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">只在某一端引入模块
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">避免交叉请求引起的状态污染
</a></li><li style="line-height: 160%; box-sizing: content-box; position: relative;"><a style="line-height: 160%; box-sizing: content-box; text-decoration: underline; color: #5286bc;">组件
</a></li></ul></li></ul></li></ul></li></ul></div><h2 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;">第一篇《框架设计概览》</h2>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第一章《权衡的艺术》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">声明式与命令式的权衡</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">声明式代码的性能不优于命令式代码的性能<br/>
声明式更看重结果，命令式更看重过程</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><code style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;">Vue.js采用了声明式，提高了可维护性</code></p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">编译时和运行时的权衡</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">render函数：运行时<br/>
template模版：编译成render函数，编译时</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><code style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;">所以vue.js是编译时+运行时</code></p>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第二章《框架设计的核心要素》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">提升用户开发体验</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">在chrome console 设置中开启Enable custom formatters可以格式化Ref、Reactive...等的信息输出</p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">控制框架代码的体积</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">vue.js中，对于warn的输出，只有开发环境下会打包下面代码，而生产模式下，在rollup.js中插件控制__DEV__为false,因此以下代码并不会打包，由此减少了生产环节的打包代码体积</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (__DEV__ &amp;&amp; !res) {
  warn(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`xxx`</span>);
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">框架要做到良好的Tree-Shaking</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">Tree-Shaking必须是ESM模块<br/>
Tree-Shaking副作用(调用函数的时候会对外部产生影响)。如果一个函数调用会产生副作用，那么就不能将其移除。<br/>
但是在rollup.js中，可以使用PURE来标识该段代码不会产生副作用，rollup.js可以放心进行Tree-Shaking</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*#__PURE__*/</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">框架应该输出怎样的构建产物</h4>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">通过script标签直接使用(IIFE格式)，<code style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;">vue.global.js</code>文件就是这种格式</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">现在主流浏览器对ESM格式的支持不错，可以使用&lt;script type="module" src=""&gt;来引入，<code style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;">vue.esm-browser.js</code>文件就是这种格式</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">除了vue.esm-browser.js文件外，还有vue.esm-bundler.js等带有-bundler的文件，这类文件主要是提供给webpack或者rollup.js这种打包工具使用的，因为这里不能直接把__DEV__设置为true或者false,而要通过(process.env.NODE_ENV !== 'production')来替换__DEV__常量。</li>
</ul>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span>(__DEV__) {
    warn(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'xxx'</span>);
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在带有-bundler的文件中</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span>(process.env.NODE_ENV !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'production'</span>) {
    warn(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'xxx'</span>);
}
</code></pre>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">同样也可以在nodejs中通过require引用资源，当进行服务端渲染的时候，Vue.js代码在Node.js中运行，而非浏览器中运行。</li>
</ul>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">特性开关</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">提供a,b,c三个对应特性的开关，用户可以通过设置a,b,c为true或者false来代表开启或关闭对应的特性。</p>
</blockquote>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">利用rollup.js的预定义常量插件来实现</li>
</ul>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">{
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">__FEATURE_OPTIONS_API__</span>: isBundlerESMBuild ? <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`__VUE_OPTIONS_API__`</span> : <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">在这里，如果是供打包工具使用的，就会使用__VUE_OPTIONS_API__常量，而__VUE_OPTIONS_API__是用来描述是否开启Vue2中options写法的特性开关。</p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">错误处理</h4>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">提供registerErrorHandler函数，用户可以使用它注册错误处理程序，然后在callWithErrorHandling函数内部捕获错误后，把错误传递给用户注册的错误处理程序</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">可以在源码中搜索callWithErrorHandling函数</li>
</ul>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">良好的Typescript类型支持</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">使用TS编写框架和框架对TS类型支持友好是两件完全不同的事</p>
</blockquote>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">runtime-core/src/apiDefineComponent.ts</p>
</blockquote>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第三章《Vue.js3的设计思路》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">渲染器</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">渲染器的作用就是把虚拟DOM渲染为真实DOM(都是使用一些熟悉的DOM操作API来完成渲染工作)</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">渲染器renderer的实现思路：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">创建元素：把vnode.tag作为标签名称来创建DOM元素</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">为元素添加属性和事件</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">处理children，如果是数组则递归调用renderer</li>
</ul>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">组件的本质</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">组件就是一组DOM元素的封装</p>
</blockquote>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">可以定义一个函数来代表组件，而函数的返回值就代表组件要渲染的内容。</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">因此可以让虚拟DOM对象中的tag属性来存储组件函数，但同时为了能够渲染组件，也需要渲染器的支持。</li>
</ul>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">renderer</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.tag === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        mountElement(vnode, container);
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.tag === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        mountComponent(vnode, container);
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> el = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.createElement(vnode.tag);
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> vnode.props) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #9a5334; line-height: 160%; box-sizing: content-box;">/^on/</span>.test(key)) {
            el.addEventListener(key.substr(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>).toLowerCase(), vnode.props[key])
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.children === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        el.appendChild(<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.createTextNode(vnode.children));
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(vnode.children)) {
        vnode.children.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">child</span> =&gt;</span> renderer(child, el))
    }
    
    container.appendChild(el);
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subtree = vnode.tag();
    renderer(subtree, container);
}
</code></pre>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">举一反三：组件也可以是一个对象</li>
</ul>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">renderer</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.tag === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        mountElement(vnode, container);
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.tag === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span>) {
        mountComponent(vnode, container);
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subtree = vnode.tag.render();
    renderer(subtree, container);
}

</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">模版的工作原理</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">编译器：编译器的作用是将模版编译为渲染函数</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">无论使用模版还是手写渲染函数，对于一个组件来说，它要渲染的内容最终都是通过渲染函数产生的，然后渲染器再把渲染函数返回的虚拟DOM渲染为真实DOM，这就是模版的工作原理</strong></p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">Vue.js是各个模块组成的有机整体</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">组件的实现依赖于渲染器，模版的编译依赖于编译器，并且编译后的代码是根据渲染器和虚拟DOM的设计决定的，因此Vue的各个模块之间是互相关联、互相制约的，共同构成一个有机整体。</p>
</blockquote>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">在编译器里，可以很容易发现哪些内容是动态的，因此编译器可以在生成代码的时候附带这些信息，例如patchFlag，这样渲染器看到这个标识时就知道哪些内容是动态的，对于渲染器来说，就省去了寻找变更点的工作量。</li>
</ul>
<h2 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;">第二篇《响应系统》</h2>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第四章《响应系统的作用与实现》</h3>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">当读取操作发生时，将副作用函数收集到“桶”中<br/>
当设置操作发生时，从“桶”中取出副作用函数并执行</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">如何设计这个“桶”</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">需要WeakMap(不是Map)</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 存储副作用函数的桶</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> bucket = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">WeakMap</span>();

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(data, {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!activeEffect) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>;
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 根据target从“桶”中取得depsMap，它也是一个Map类型：key --&gt; effects</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> depsMap = bucket.get(target);
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果不存在depsMap，那么新建一个Map并与target关联</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!depsMap) {
            bucket.set(target, (depsMap = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Map</span>()));
        }
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 根据key从depsMap中获取deps，它是一个Set</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> deps = depsMap.get(key);
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!deps) {
            depsMap.set(key, (deps = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Set</span>()));
        }
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 最后将当前激活的副作用函数添加到“桶“里</span>
        deps.add(activeEffect);
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> target[key];
    },
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">set</span>(target, key, newVal) {
        target[key] = newVal;
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> depsMap = bucket.get(target);
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!depsMap) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effects = depsMap.get(key);
        effects &amp;&amp; effects.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">fn</span> =&gt;</span> fn());
    }
})
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">分支切换与cleanup</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> data = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">ok</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">text</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'hello world'</span> };
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(data, { xxx });

effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.body.innerText = obj.ok ? obj.text : <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'not'</span>;
})

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里因为同时有obj.ok和obj.text，所以会同时收集两个依赖的副作用函数，但是当下一次obj.ok为false的时候，理应结果都是'not'，因此不管obj.text如何改变都可以不用触发副作用函数，但事实上会重新触发副作用函数。</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 每次触发副作用函数的时候，理应会重新进行依赖收集，这时期望之前obj.text绑定的响应关系被清除掉，但事实上并没有，它遗留下来了，从而导致当obj.ok为false时，obj.text的改变也会触发副作用函数</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 要解决这个问题，就是每次副作用函数执行时，我们可以先把它从所有与之关联的依赖集合中删除，即每次触发副作用函数，先把以前绑定的关系删除，然后重新绑定，这样就不会存在这个问题了</span>
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">要将一个副作用函数从所有与之关联的依赖集合中移除，就需要明确知道哪些依赖集合中包含它，因此需要重新设计副作用函数，如下所示</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> activeEffect
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effect</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">fn</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当effectFn执行时，将其设置为当前激活的副作用函数</span>
        activeEffect = effectFn
        fn()
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// activeEffect.deps 用来存储所有与该副作用函数相关联的依赖集合</span>
    effectFn.deps = []
    effectFn()
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// effectFn.deps如何收集的依赖</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">track</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">target, key</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!activeEffect) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>;
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> depsMap = bucket.get(target);
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!depsMap) {
        bucket.set(target, (depsMap = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Map</span>()));
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> deps = depsMap.get(key);
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!deps) {
        depsMap.set(key, (deps = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Set</span>()));
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将当前激活的副作用函数添加到“桶“里</span>
    deps.add(activeEffect);
    
    activeEffect.deps.push(deps);

    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> target[key];
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 有了这个联系后，就可以在每次副作用函数执行时，根据effectFn.deps获取所有相关联的依赖集合，进而将副作用函数从依赖集合中移除</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> activeEffect
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effect</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">fn</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当effectFn执行时，将其设置为当前激活的副作用函数</span>
        cleanup(effectFn)
        activeEffect = effectFn
        fn()
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// activeEffect.deps 用来存储所有与该副作用函数相关联的依赖集合</span>
    effectFn.deps = []
    effectFn()
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">cleanup</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; effectFn.deps.length; i++) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> deps = effectFn.deps[i];
        deps.delete(effectFn);
    }
    
    effectFn.deps.length = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>;
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 目前响应系统已经可以避免副作用函数产生遗留了，但是在trigger中会导致无限循环执行</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">trigger</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">target, key</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> depsMap = bucket.get(target);
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!depsMap) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effects = depsMap.get(key);
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectsToRun = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Set</span>(effects)
    effectsToRun.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn</span> =&gt;</span> effectFn())
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">嵌套的effect与effect栈</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn1</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn2</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* ... */</span>
    })
})
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在Vue.js中，Vue.js的渲染函数就是在一个effect中执行的</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当组件发生嵌套时，就发生了effect嵌套</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> Bar = {
    render() { <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* ... */</span> };
}
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> Foo = {
    render() {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="line-height: 160%; box-sizing: content-box;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Bar</span> /&gt;</span>
    }
}

// 相当于
effect(() =&gt; {
    Foo.render()
    effect(() =&gt; {
        Bar.render()
    })
})

// 问题
// 因为全局只有一个activeEffect存储副作用函数，当副作用函数发生嵌套时，内层副作用函数的执行会覆盖activeEffect的值，并且永远不会恢复到原来的值。这时如果后面再有依赖收集，即使这个响应式数据是在外层副作用函数中读取的，它们收集到的副作用函数也都会是内层副作用函数。
// 解决
// 需要一个副作用函数栈effectStack，在副作用函数执行时，将当前副作用函数压入栈中，待副作用函数执行完毕后将其从栈中弹出，并终止让activeEffect指向栈顶的副作用函数
let activeEffect
const effectStack = []
function effect(fn) {
    const effectFn = () =&gt; {
        cleanup(effectFn)
        activeEffect = effectFn
        effectStack.push(effectFn)
        fn()
        effectStack.pop()
        activeEffect = effectStack[effectStack.length - 1]
    }
    
    effectFn.deps = []
    effectFn()
    
}
</span></code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">避免无限递归循环</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> data = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> }
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(data, { <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* ... */</span> })
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> obj.foo++)
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里，既会读取obj.foo，也会设置obj.foo，这就导致了栈溢出</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 解决方法</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在trigger动作发生时增加守卫条件：如果trigger触发执行的副作用函数与当前正在执行的副作用函数相同，则不触发执行</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">trigger</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">target, key</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> depsMap = bucket.get(target);
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!depsMap) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>;
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effects = depsMap.get(key);
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectsToRun = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Set</span>();   
    effects &amp;&amp; effects.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn</span>) =&gt;</span> {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (effectFn !== activeEffect) {
            effectsToRun.add(effectFn)
        }
    })
    
    effectsToRun.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn</span> =&gt;</span> effectFn())
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这样就能避免无限递归调用</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">调度执行</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 为effect函数设计一个选项参数options，允许用户指定调度器</span>
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(obj.foo)
}, {
    scheduler(fn) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    }
})

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 应用，如果连续两次更改，只想要执行最后一次副作用函数</span>
obj.foo = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>;
obj.foo++
obj.foo++
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 3</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> jobQueue = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Set</span>();
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Promise</span>.resolve();

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> isFlushing = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>;
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">flushJob</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isFlushing) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>;
    isFlushing = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>;
    p.then(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> jobQueue.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">job</span> =&gt;</span> job()))
     .finnally(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> isFlushing = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>)
}

effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(obj.foo)
}, {
    scheduler(fn) {
        jobQueue.add(fn);
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 刷新队列</span>
        flushJob();
    }
})
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">计算属性computed与lazy</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">现在我们实现的effect函数会立即执行传递给它的副作用函数，但是在有些场景下并不想立即执行，就需要在options中添加lazy属性</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将副作用函数直接返回，让用户可以自己决定在什么时候去调用</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effect</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">fn, options={}</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        cleanup(effectFn)
        activeEffect = effectFn
        effectStack.push(effectFn)
        fn()
        effectStack.pop()
        activeEffect = effectStack[effectStack.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>]
    }
    effectFn.options = options
    effectFn.deps = []
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!options.lazy) {
        effectFn()
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> effectFn
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 获取副作用函数的返回值</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effect</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">fn, options={}</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        cleanup(effectFn)
        activeEffect = effectFn
        effectStack.push(effectFn)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = fn()
        effectStack.pop()
        activeEffect = effectStack[effectStack.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>]
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 返回</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res;
    }
    effectFn.options = options
    effectFn.deps = []
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!options.lazy) {
        effectFn()
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> effectFn
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 接下来就可以实现计算属性了</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">computed</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">getter</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 把getter当作副作用函数，创建一个lazy的effect</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = effect(getter, { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">lazy</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span> });
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span> value() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> effectFn()
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> obj;
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 应用</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> data = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">bar</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span> }
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(data, { <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* ... */</span> })
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> sumRes = computed(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> obj.foo + obj.bar)

<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(sumRes.value)

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但是现在的计算属性只做到了懒计算，只有真正读取sumRes.value的值时，才会进行计算并得到值。但是还做不到对值进行缓存，即使多次访问sumRes.value，会导致effectFn多次计算，即使obj.foo和obj.bar并没有改变</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">computed</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">getter</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用来缓存上一次计算的值</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> value
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// dirty标识，用来标识是否需要重新计算值，为true则需要</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> dirty = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>

    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 把getter当作副作用函数，创建一个lazy的effect</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = effect(getter, { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">lazy</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span> });
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span> value() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (dirty) {
                value = effectFn()
                dirty = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> value
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> obj;
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当obj.foo或obj.bar发生变化时，需要重置dirty值为true</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">computed</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">getter</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用来缓存上一次计算的值</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> value
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// dirty标识，用来标识是否需要重新计算值，为true则需要</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> dirty = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>

    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 把getter当作副作用函数，创建一个lazy的effect</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = effect(getter, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">lazy</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 添加调度器，在调度器中将dirty重置为true</span>
        scheduler() {
            dirty = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
        }
    });
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span> value() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (dirty) {
                value = effectFn()
                dirty = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> value
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> obj;
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 现在还有一个缺陷，就是我们在另外一个effect中读取计算属性的值时</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 原因：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 本质上这就是一个effect嵌套。一个计算属性内部拥有自己的effect，并且它是懒执行的。外层的effect不会被内层effect中的响应式数据收集</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> sumRes = computed(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> obj.foo + obj.bar)
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(sumRes.value)
});
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当obj.foo改变时，并不会触发副作用函数effect执行</span>
obj.foo++

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 解决办法</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 读取计算属性的值时，手动调用track函数进行追踪，当计算属性依赖的响应式数据发生变化时，手动调用trigger函数触发响应</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">computed</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">getter</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用来缓存上一次计算的值</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> value
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// dirty标识，用来标识是否需要重新计算值，为true则需要</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> dirty = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>

    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 把getter当作副作用函数，创建一个lazy的effect</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = effect(getter, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">lazy</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 添加调度器，在调度器中将dirty重置为true</span>
        scheduler() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!dirty) {
              dirty = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
              trigger(obj, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'value'</span>)
            }
        }
    });
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span> value() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (dirty) {
                value = effectFn()
                dirty = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            track(obj, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'value'</span>)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> value
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> obj;
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">watch的实现原理</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">所谓watch，其本质就是观测一个响应式数据，当数据发生变化时通知并执行响应的回调函数<br/>
实现本质上就是利用了effect以及options.scheduler选项</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果副作用函数存在scheduler选项，当响应式数据发生变化时，会触发scheduler调度函数执行，而非直接触发副作用函数执行</span>
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(obj.foo)
}, {
    scheduler() {
        
    }
})

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.简易版watch</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">watch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">source, cb</span>) </span>{
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> source.foo, {
        scheduler() {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 数据变化时，调用毁掉函数cb</span>
            cb()
        }
    })
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1中硬编码了source.foo，进一步封装</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.traverse</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">watch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">source, cb</span>) </span>{
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> traverse(source), {
        scheduler() {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 数据变化时，调用回调函数cb</span>
            cb()
        }
    })
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 递归读取操作，当任意属性发生变化时都能够触发回调函数执行</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">traverse</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">value, seen = new Set(</span>)) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> value !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> || value === <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span> || seen.has(value)) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
    
    seen.add(value)
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> k <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> value) {
        traverse(value[k], seen)
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> value
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 3.watch接收一个getter函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">watch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">source, cb</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> getter
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> source === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        getter = source
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        getter = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> traverse(source)
    }
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> getter(), {
        scheduler() {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 数据变化时，调用回调函数cb</span>
            cb()
        }
    })
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 4.在回调函数中拿到新值和旧值</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">watch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">source, cb</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> getter
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> source === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        getter = source
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        getter = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> traverse(source)
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldValue, newValue
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> getter(), {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">lazy</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
        scheduler() {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 重新执行副作用函数获取新值</span>
            newValue = effectFn()
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 数据变化时，调用回调函数cb</span>
            cb(newValue, oldValue)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新旧值</span>
            oldValue = newValue
        }
    })
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 手动调用副作用函数，拿到旧值</span>
    oldValue = effectFn()
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 5.立即执行的watch</span>
watch(obj, () =&gt; { <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'变化了'</span>) }, {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">immediate</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
})
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">watch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">source, cb, options = {}</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> getter
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> source === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        getter = source
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        getter = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> traverse(source)
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldValue, newValue
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 提取scheduler调度函数为一个独立的job函数</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> job = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        newValue = effectFn();
        cb(newValue, oldValue);
        oldValue = newValue;
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> getter(), {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">lazy</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">scheduler</span>: job
    })
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (options.immediate) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 立即执行job，从而触发回调执行</span>
        job()
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 手动调用副作用函数，拿到旧值</span>
        oldValue = effectFn()
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 6.回调函数的执行时机</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 通过flush选项来指定</span>
watch(obj, () =&gt; { <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'变化了'</span>) }, {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">flush</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'pre'</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 还可以指定 'post' | 'sync'</span>
})
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// pre代表组件更新前</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// post代表调度函数需要将副作用函数放到一个微任务队列中，并等待DOM更新结束后再执行</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">watch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">source, cb, options = {}</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> getter
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> source === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        getter = source
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        getter = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> traverse(source)
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldValue, newValue
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 提取scheduler调度函数为一个独立的job函数</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> job = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        newValue = effectFn();
        cb(newValue, oldValue);
        oldValue = newValue;
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> getter(), {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">lazy</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">scheduler</span>: <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (options.flush === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'post'</span>) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Promise</span>.resolve()
                p.then(job)
            } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                job()
            }
        }
    })
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (options.immediate) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 立即执行job，从而触发回调执行</span>
        job()
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 手动调用副作用函数，拿到旧值</span>
        oldValue = effectFn()
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">过期的副作用</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">竞态问题</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> finalData
watch(obj, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">async</span> () =&gt; {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">await</span> fetch(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'/path/to/request'</span>)
    finalData = res
})

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 假设第一次修改obj对象的某个字段值，这会导致回调函数执行，同时发送了第一次请求A</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在请求A的结果返回之前，对obj对象的某个字段进行第二次修改，这会导致发送第二次请求B</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 此时A和B都在进行中，并不能确定哪一个请求会先返回结果，如果请求B先于请求A，那么finalData最后存储的事A请求的结果，但是实际B请求返回的数据才是"最新的"</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 为了解决这个问题，就需要一个让副作用过期的手段</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在Vue.js中，watch函数的回调函数接受第三个参数onInvalidate，它是一个函数，类似于事件监听器，可以使用onInvalidate函数注册一个回调，这个回调函数会在当前副作用函数过期时执行：</span>
watch(obj, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">async</span> (newValue, oldValue, onInvalidate) =&gt; {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> expired = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>
    
    onInvalidate(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        expired = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
    })
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">await</span> fetch(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'/path/to/request'</span>)
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!expired) {
        finalData = res
    }
})

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 原理</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">watch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">source, cb, options = {}</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> getter
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> source === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        getter = source
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        getter = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> traverse(source)
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldValue, newValue
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 存储用户注册的过期回调</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> cleanup
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">onInvalidate</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">fn</span>) </span>{
        cleanup = fn
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 提取scheduler调度函数为一个独立的job函数</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> job = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        newValue = effectFn();
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (cleanup) {
            cleanup()
        }
        cb(newValue, oldValue, onInvalidate);
        oldValue = newValue;
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> effectFn = effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> getter(), {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">lazy</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">scheduler</span>: <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (options.flush === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'post'</span>) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Promise</span>.resolve()
                p.then(job)
            } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                job()
            }
        }
    })
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (options.immediate) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 立即执行job，从而触发回调执行</span>
        job()
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 手动调用副作用函数，拿到旧值</span>
        oldValue = effectFn()
    }
}
</code></pre>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第5章《非原始值的响应式方案》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">理解Proxy和Reflect</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">Proxy可以创建一个代理对象，它能够实现对<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">其他对象</strong>的代理，它允许我们<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">拦截</strong>并<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">重新定义</strong>对一个对象的基本操作<br/>
Proxy只能代理对象，不能代理非对象值(字符串、布尔值...)</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>() {}
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">set</span>() {}
})
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p2 = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(fn, {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用apply拦截函数调用</span>
    apply(target, thisArg, argArray) {
        target.call(thisArg, ...argArray)
    }
})
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">Reflect是一个全局对象，其下有许多方法(Reflect.get(), Reflect.apply()...)<br/>
Reflect可以接收第三个参数<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">receiver</strong>，可以把它理解为函数调用过程中的this</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> }
<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(obj.foo) <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1</span>
<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(obj, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span>)) <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> }
<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(obj, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span>, { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span> })) <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 输出2而不是1</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 问题</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>,
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span> bar() {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.foo
    }
}
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key) {
        track(target, key)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> target[key]
    },
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">set</span>(target, key, newVal) {
        target[key] = newVal
        trigger(target, key)
    }
})
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里访问p.bar，会调用getter函数，而getter函数访问了this.foo，因此我们认为副作用函数和foo之间也会建立联系，当我们修改p.foo时，也会触发响应</span>
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> { <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(p.bar) })
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但是当执行p.foo++时，并没有触发响应</span>
p.foo++

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 原因</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 最开始访问p.bar时，通过target[key]返回，就相当于obj.bar，因此，当我们使用p.bar访问bar属性的时候，它内部this指向的是obj，因此最终访问的是obj.foo，而不是p.foo，所有并没有建立foo和副作用函数的联系</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 解决方案 Reflect</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key, receiver) {
        track(target, key)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(target, key, receiver)
    }
})
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里可以看到副作用函数中访问p.bar，因此在这里receiver就是p，我们使用Reflect.get(target, key, receiver)访问，this就从原来的obj变成了代理对象p，因此就建立了响应式联系</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">Javascript对象及Proxy的工作原理</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在JavaScript中有两种对象，一种叫<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">常规对象</strong>，一种叫做<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">异质对象</strong><br/>
任何不属于常规对象的对象都是异质对象</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">如果区分一个对象obj是普通对象还是函数：<br/>
对象必要的内部方法：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[GetPrototypeOf]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[SetPrototypeOf]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[IsExtensible]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[PreventExtensions]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[GetOwnProperty]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[DefineOwnProperty]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[HasProperty]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[Get]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[Set]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[Delete]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[OwnPropertyKeys]]<br/>
除此之外，还有两个额外的必要内部方法：</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[Call]]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">[[Construct]]<br/>
如果一个对象需要作为函数调用，那么这个对象就必须部署内部方法[[Call]]，因此<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">函数对象会部署内部方法[[Call]]，而普通对象则不会</strong></li>
</ul>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">如何代理Object</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">一个普通对象所有可能的读取操作：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">访问属性：obj.foo</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">判断对象或原型上是否存在给定的key：key in obj</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">使用for...in循环遍历对象：for(const key in obj) {}</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">这里的拦截方式：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">访问属性可以使用proxy的get来拦截</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">in操作符的访问可以通过proxy的has来拦截</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">for....in可以通过proxy的ownKeys来拦截</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">代理对象时，需要针对不同情况进行拦截：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">修改：使用set正常拦截</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">新增：使用set，记录ITERATE_KEY，当新增属性时，触发与ITERATE_KEY相关联的副作用函数重新执行</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">删除：使用deleteProperty拦截，只有当被删除的属性是对象自己的属性并且成功删除时才触发更新</li>
</ul>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">合理地触发响应</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">想要合理的触发响应，我们需要明确的知道操作的类型是ADD还是SET抑或是其他操作类型，从而正确地触发响应</p>
</blockquote>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">当值没有变化时，应该不需要触发响应</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">从原型上继承属性的情况</li>
</ul>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = {}
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> proto = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">bar</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> }
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> child = reactive(obj)
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> parent = reactive(proto)
<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Object</span>.setPrototypeOf(child, parent)
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(child.bar)
})
child.bar = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 会导致副作用函数重新执行两次</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里child.bar和parent.bar都与副作用函数建立了响应联系</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当执行child.bar = 2时，child.bar和parent.bar都会触发副作用函数执行</span>
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">浅响应与深响应</h5>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">目前实现的reactive是浅响应</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = reactive({<span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: {<span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">bar</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>}})
effetc(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(obj.foo.bar))

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 不会触发响应</span>
obj.foo.bar = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 因此需要对Reflect.get返回的结果做一层包装</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">reactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'raw'</span>) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> target
            }
            track(target, key)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始值结果</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(target, key, receiver)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> res === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> &amp;&amp; res !== <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>) {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将结果包装成响应式结果</span>
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> reactive(res)
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
        }
    })
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但并不是所有时刻都需要深响应，这就催生了shallowReactive(只有对象的第一层属性是响应的)</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createReactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, isShallow = false</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'raw'</span>) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> target
            }
            track(target, key)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始值结果</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(target, key, receiver)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 浅响应直接返回</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isShallow) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> res === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> &amp;&amp; res !== <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>) {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将结果包装成响应式结果</span>
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> reactive(res)
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
        }
    })
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">reactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> createReactive(obj)
}
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">shallowReactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> createReactive(obj, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>)
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">只读和浅只读</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = readonly({ <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> })
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 尝试修改，得到警告</span>
obj.foo = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 同样可以使用createReactive函数来实现</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createReactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, isShallow = false, isReadonly = false</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当然，如果一个数据是只读的，那就意味着任何方式都不能修改它，因此也没有必要为只读数据建立响应关系。</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'raw'</span>) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> target
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!isReadonly) {
                track(target, key)
            }
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始值结果</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(target, key, receiver)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 浅响应直接返回</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isShallow) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> res === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> &amp;&amp; res !== <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>) {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将结果包装成响应式结果</span>
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> reactive(res)
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
        },
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">set</span>(target, key, newVal, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isReadonly) {
                <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.warn(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'只读'</span>)
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            ...
        },
        
        deleteProperty(target, key) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isReadonly) {
                <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.warn(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'只读'</span>)
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            ...
        }
    })
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 实现readonly函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">readonly</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> createReactive(obj, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>);
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 然而上面实现的readonly只能叫做shallowReadonly</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = readonly({ <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">bar</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> } })
obj.foo.bar = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>; <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 仍然可以修改</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 所以为了实现深只读，需要在get拦截函数里递归地调用readonly</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createReactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, isShallow = false, isReadonly = false</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当然，如果一个数据是只读的，那就意味着任何方式都不能修改它，因此也没有必要为只读数据建立响应关系。</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'raw'</span>) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> target
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!isReadonly) {
                track(target, key)
            }
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始值结果</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(target, key, receiver)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 浅响应直接返回</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isShallow) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> res === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> &amp;&amp; res !== <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>) {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将结果包装成响应式结果</span>
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> isReadonly ? readonly(res) : reactive(res)
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
        },
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">set</span>(target, key, newVal, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isReadonly) {
                <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.warn(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'只读'</span>)
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            ...
        },
        
        deleteProperty(target, key) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isReadonly) {
                <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.warn(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'只读'</span>)
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            ...
        }
    })
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">shallowReadonly</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> createReactive(obj, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>)
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">代理数组</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">数组就是一个异质对象，这是因为数组对象的[[DefineOwnProperty]]内部方法与常规对象不同，其他内部方法相同</p>
</blockquote>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">所有对数组元素或属性的"读取"操作：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">通过索引访问：arr[0]</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">访问数组的长度：arr.length</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">把数组作为对象，使用for...in循环遍历</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">使用for...of迭代遍历数组</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">数组的原型方法，如concat/join/every/some/find/findIndex/includes等不改变原数组的原型方法</li>
</ul>
</blockquote>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">所有对数组元素或属性的"设置"操作：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">通过索引访问数组元素修改: arr[1] = 3</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">修改数组长度：arr.length = 0</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">数组的栈方法：push/pop/shift/unshift</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">修改原数组的原型方法：splice/fill/sort</li>
</ul>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> arr = reactive([<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span>])
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(arr[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>])
})

arr[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>] = <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'bar'</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 能够触发响应</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 上面通过索引读取或设置数组元素的值时，代理对象的get/set拦截函数也会执行，因此不需要做额外的操作，就能够让数组索引的读取和设置操作是响应式的</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但通过索引设置数组的元素值与设置对象的属性值仍然存在根本上的不同，这时因为数组对象部署的内部方法[[DefineOwnProperty]]不同于常规对象。实际上，当我们通过索引值设置数组元素的值时，会执行数组对象所部署的内部方法[[Set]]，这一步与设置常规对象的属性值一样，根据规范可知，[[Set]]其实依赖于[[DefineOwnProperty]]</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果设置的索引值大于数组当前的长度，那么要更新数组的length属性</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> arr = reactive([<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span>])
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(arr.length)
})
arr[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>] = <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'bar'</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 会导致数组的长度变为2</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.所以修改set拦截函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createReactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, isShallow = false, isReadonly = false</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">set</span>(target, key, newVal, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isReadonly) {
                <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.warn(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'只读'</span>)
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldVal = target[key]
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 判断是修改还是新增</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> type = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(target) ? <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Number</span>(key) &lt; target.length ? <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'SET'</span> : <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ADD'</span> : <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Object</span>.prototype.hasOwnProperty.call(target, key) ? <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'SET'</span> : <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ADD'</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.set(target, key, newVal, receiver)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (target === receiver.raw) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldVal !== newVal &amp;&amp; (oldVal === oldVal || newVal === newVal)) {
                    trigger(target, key, type)
                }
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
        },
        ...
    )      
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">trigger</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">target, key, type</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> depsMap = bucket.get(target);
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!depsMap) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
    
    ...
    if (type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ADD'</span> &amp;&amp; <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(target)) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> lengthEffects = depsMap.get(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'length'</span>)
        lengthEffects &amp;&amp; lengthEffects.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn</span> =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (effectFn !== activeEffect) {
                effectsToRun.add(effectFn)
            }
        })
    }
    ...
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.同样修改length也会隐式地影响数组元素</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createReactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, isShallow = false, isReadonly = false</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">set</span>(target, key, newVal, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isReadonly) {
                <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.warn(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'只读'</span>)
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldVal = target[key]
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 判断是修改还是新增</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> type = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(target) ? <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Number</span>(key) &lt; target.length ? <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'SET'</span> : <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ADD'</span> : <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Object</span>.prototype.hasOwnProperty.call(target, key) ? <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'SET'</span> : <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ADD'</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.set(target, key, newVal, receiver)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (target === receiver.raw) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldVal !== newVal &amp;&amp; (oldVal === oldVal || newVal === newVal)) {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 增加第四个参数，即触发响应的新值</span>
                    trigger(target, key, type, newVal)
                }
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
        },
        ...
    )      
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">trigger</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">target, key, type</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> depsMap = bucket.get(target);
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!depsMap) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
    
    ...
    if (type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ADD'</span> &amp;&amp; <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(target)) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> lengthEffects = depsMap.get(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'length'</span>)
        lengthEffects &amp;&amp; lengthEffects.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn</span> =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (effectFn !== activeEffect) {
                effectsToRun.add(effectFn)
            }
        })
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 对于索引大于或等于新的length值的元素</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 需要把所有相关联的副作用函数取出并添加到effectsToRun中待执行</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(target) &amp;&amp; key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'length'</span>) {
        depsMap.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effects, key</span>) =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key &gt;= newVal) {
                effects.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">effectFn</span>) =&gt;</span> {
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (effectFn !== activeEffect) {
                        effectsToRun.add(effectFn)
                    }
                })
            }
        })
    }
    ...
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">遍历数组</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> arr = reactive([<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span>])
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> arr) {
        <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(key) <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 0</span>
    }
})
</code></pre>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">for...in循环</li>
</ul>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">我们应该尽量避免使用for...in循环遍历数组</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用for...in遍历循环数组与遍历常规对象并无差异，因此同样可以使用ownKeys拦截函数进行拦截</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 对于一个普通对象来说，只有当添加或删除属性值时才会重新触发副作用函数，但是对于数组来说有所不同：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1. 添加新元素： arr[100] = bar</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2. 修改数组长度：arr.length = 0</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 本质来说都是修改了数组的length</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createReactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, isShallow = false, isReadonly = false</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
        ownKeys(target) {
            track(target, <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(target) ? <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'length'</span> : ITERATE_KEY)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.ownKeys(target)
        }
    })
}
</code></pre>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">for...of循环</li>
</ul>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">for..of是用来遍历可迭代对象的<br/>
如果一个对象实现了Symbol.iterator方法，那么这个对象就是可以迭代的<br/>
数组内建了Symbol.iterator方法</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> arr = [<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>,<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>,<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">3</span>,<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">4</span>]
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> itr = arr[<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Symbol</span>.iterator]()

itr.next() <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// { value: 1, done: false }</span>
itr.next() <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// { value: 2, done: false }</span>
...

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 迭代数组时，只需要在副作用函数与数组的长度和索引之间建立响应联系，就能够实现响应式的for...of迭代</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 也就是说，在不增加任何代码的情况下，也能够让数组的迭代器方法正确地工作</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createReactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, isShallow = false, isReadonly = false</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当然，如果一个数据是只读的，那就意味着任何方式都不能修改它，因此也没有必要为只读数据建立响应关系。</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'raw'</span>) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> target
            }
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果key的类型是symbol，则不进行追踪</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!isReadonly &amp;&amp; <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> key !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'symbol'</span>) {
                track(target, key)
            }
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始值结果</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> res = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(target, key, receiver)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 浅响应直接返回</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isShallow) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> res === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> &amp;&amp; res !== <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>) {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将结果包装成响应式结果</span>
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> isReadonly ? readonly(res) : reactive(res)
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
        },
    })
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">数组的查找方法</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 问题一</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = []
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> arr = reactive([obj])
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里输出false,是因为递归创建reactive时，都会创建新的代理对象，即使参数Obj是相同的，每次调用reactive函数时，也会创建新的代理对象</span>
<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(arr.includes(arr[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>]))

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 解决方法</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用reactiveMap,通过原始对象寻找之前创建的代理对象，如果找到了直接返回已有的代理对象</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> reactiveMap = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Map</span>()

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">reactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> existionProxy = reactiveMap.get(obj)
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (existionProxy) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> existionProxy
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> proxy = createReactive(obj)
    reactiveMap.set(obj, proxy)
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> proxy
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 问题二</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = {}
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> arr = reactive([obj])
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这是因为includes内部this指向的是代理对象arr，在获取元素时用来比较的也是代理对象，所以不能匹配到原始对象obj</span>
<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(arr.includes(obj)) <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// false</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 解决方法</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 重写includes方法</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> originMethod = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.prototype.includes
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> arrayInstrumentations = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">includes</span>: <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">...args</span>) </span>{
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> res = originMethod.apply(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>, args)
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (res === <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 通过原始值再去查找</span>
            res = originMethod.apply(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.raw, args)
        }
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createReactive</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, isShallow = false, isReadonly = false</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(obj, {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用includes时会触发get拦截函数</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'raw'</span>) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> target
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用重写的includes返回结果</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(target) &amp;&amp; arrayInstrumentation.hasOwnProperty(key)) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(arrayInstrumentation, key, receiver);
            }
        }
    })
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">隐式修改数组长度的原型方法</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">push/pop/shift/unshift/splice</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> arr = reactive([])
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> arr.push(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>))

effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> arr.push(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>))
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里会出现栈溢出，因为第二次执行arr.push时，会触发length的副作用函数执行，因此又会执行第一个副作用函数arr.push(1)，如此一来就会导致栈溢出</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 问题的原因是push方法的调用会间接读取length属性</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 解决方案，屏蔽对length属性的读取</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 重写push</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> shouldTrack = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> originMethod = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.prototype.push
arrayInstrumentations[<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'push'</span>] = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">...args</span>) </span>{
    shouldTrack = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> res = originMethod.apply(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>, args)
    shouldTrack = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> res;
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在push默认方法执行时，禁止追踪</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">track</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">target, key</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!activeEffect || !shouldTrack) <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">代理Set和Map</h4>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">建立相应关系</h5>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">避免污染原始数据</h5>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">处理forEach</h5>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">迭代器方法</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p = reactive(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Map</span>([
    [<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'key1'</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'value1'</span>],
    [<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'key2'</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'value2'</span>]
]))
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> [key, value] <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">of</span> p) {
        <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(key, value)
    }
})

p.set(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'key3'</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'value3'</span>)

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 报错，p是不可迭代的</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 原因：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用迭代器时，会试图从代理对象上读取p[Symbol.iterator]属性，这个操作会触发get拦截函数</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 解决</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 把Symbol.iterator的实现放到mutableInstrumentations中</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> mutableInstrumentations = {
    [<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Symbol</span>.iterator]() {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> target = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.row
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> itr = target[<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Symbol</span>.iterator]()
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> itr
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 迭代值也是被代理的，也需要将其包装成响应式数据</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> mutableInstrumentatioins = {
    [<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Symbol</span>.iterator]() {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> target = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.row
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> itr = target[<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Symbol</span>.iterator]()
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> wrap = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">val</span>) =&gt;</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> val === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> &amp;&amp; val !== <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span> ? reactive(val) : val
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 调用track函数建立响应联系</span>
        track(target, ITERATE_KEY)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
            next() {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { value, done } = itr.next()
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: value ? [wrap(value[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>]), wrap(value[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>])] : value,
                    done,
                }
            }
        }
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 因为p.entries与p[Symbol.iterator]等价，所以可以使用同样的代码来实现对p.entries的拦截，但是需要注意的是，p.entries函数的返回值是一个对象，而不是一个迭代器对象</span>
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">values与keys方法</h5>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">keys与values略微不同，keys只需要绑定key和副作用函数的响应式关系，因此不需要在SET修改值而没有修改key的时候触发副作用函数</p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">总结</h4>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">使用proxy代理对象</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">因为访问器属性的this指向问题，使用Reflect.*修复</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">常规对象和异质对象</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">对象的代理</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">深响应与浅响应，深只读与浅只读</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">数组的代理</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">Map、Set、WeakMap、WeakSet的代理</li>
</ul>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第6章《原始值的响应式方案》</h3>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在JavaScript中，原始值是按值传递的，而非按引用传递。这意味着，如果一个函数接收原始值作为参数，那么形参与实参之间没有引用关系，它们是两个完全独立的值，对形参的修改不会影响到实参。<br/>
JavaScript中的Proxy无法提供对原始值的代理，因此想要将原始值变成响应式数据，就必须对其做一层包裹，也就是ref</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 封装一个ref函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">ref</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">val</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> wrapper = {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: val
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> reactive(wrapper)
}

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> refVal = ref(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>)
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(refVal.value)
})
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 修改值能够触发副作用函数重新执行</span>
refVal.value = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.问题</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如何区分refVal是原始值的包裹对象，还是一个非原始值的响应式数据</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> refVal1 = ref(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>)
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> refVal2 = reactive({<span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>})

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 解决方案</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">ref</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">val</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> wrapper = {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: val
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用Object.defineProperty在wrapper对象上定义一个不可枚举的属性__v_isRef，并且值为true</span>
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Object</span>.defineProperty(wrapper, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'__v_isRef'</span>, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
    })
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> reactive(wrapper)
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">响应丢失问题</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">ref除了能够用于原始值的响应式方案之外，还能用来解决响应丢失问题。</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 响应丢失问题</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">export</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">default</span> {
    setup() {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = reactive({ <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">bar</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span> })
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
            ...obj
        }
    }
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">接着可以在模版中访问</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>{{foo}} / {{bar}}<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">但是这么做 会导致响应丢失：当我们修改响应式数据的值时，不会触发重新渲染，这是由于展开运算符(...)导致的：</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
    ...obj
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 等价于</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">bar</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这其实就是返回了一个普通对象，它不具备任何响应式能力。</span>
</code></pre>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">解决方案</li>
</ul>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = reactive({ <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">bar</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span> })

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当读取值时，其实读取的事obj对象下相应的属性值</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newObj = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span> value() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> obj.foo
        }
    },
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">bar</span>: {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span> value() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> obj.bar
        }
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 观察newObj对象，可以发现它的结构存在相似之处：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这样可以将这种结构抽象出来并封装成函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">toRef</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, key</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> wrapper = {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span> value() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> obj[key]
        }
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> wrapper
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">toRefs</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> ret = {}
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> obj) {
        ret[key] = toRef(obj, key)
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> ret
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 为了概念上统一，会将通过toRef或toRefs转换后得到的结果视为真正的ref数据</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">toRef</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">obj, key</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> wrapper = {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span> value() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> obj[key]
        }
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用Object.defineProperty在wrapper对象上定义一个不可枚举的属性__v_isRef，并且值为true</span>
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Object</span>.defineProperty(wrapper, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'__v_isRef'</span>, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
    })
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> wrapper
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">自动脱ref</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">问题：toRefs会把响应式数据的第一层属性值转换为ref，因此必须通过value属性访问值</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = reactive({ <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> })

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newObj = { ...toRefs(obj) }
newObj.foo.value <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1</span>
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">自动脱ref，指的是属性的访问行为，即如果读取的属性是一个ref，则直接将该ref对应的value属性值返回</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 要实现此功能，需要使用Proxy为newObj创建一个代理对象</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">proxyRefs</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">target</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(target, {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> value = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(target, key, receiver);
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> value.__v_isRef ? value.value : value
        }
    })
}

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newObj = proxyRefs({ ...toRefs(obj) })

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 实际上，在编写组件时，setup函数所返回的数据会传递给proxyRefs函数进行处理，这也就是为什么在模版中我们不需要通过value属性来访问</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 同理，设置属性的值也应该有自动为ref设置值的能力</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">proxyRefs</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">target</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Proxy</span>(target, {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">get</span>(target, key, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> value = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.get(target, key, receiver);
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> value.__v_isRef ? value.value : value
        },
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">set</span>(target, key, newValue, receiver) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> value = target[key]
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (value.__v_isRef) {
                value.value = newValue
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Reflect</span>.set(target, key, newValue, receiver)
        }
    })
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 自动脱ref不仅出现在setup函数的返回值中，同样也存在reactive函数</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> count = ref(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>)
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> obj = reactive({ count })

obj.count <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 0</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 可以看到，obj.count本应该是一个ref，但由于自动脱ref，我们可以无须使用value属性</span>

</code></pre>
<h2 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;">第三篇《渲染器》</h2>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第7章《渲染器的设计》</h3>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">renderer</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">domString, container</span>) </span>{
    container.innerHtml = domString;
}
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> ref = ref(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>)
effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
    renderer(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`&lt;h1&gt;<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">${count.value}</span>&lt;/h1&gt;`</span>, <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.getElementById(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'app'</span>))
})
count.value++
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 修改count.value值时，副作用函数会重新执行，完成重新渲染</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">渲染器的基本概念</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">渲染器的作用是把虚拟DOM渲染为特定平台上的真实元素<br/>
虚拟DOM是树形结构，这棵树中的任何一个vnode节点都可以是一颗子树，因此vnode和vdom有时可以替换使用。<br/>
渲染器把虚拟DOM节点渲染为真实节点的过程叫做<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">挂载</strong></p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createRenderer</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
        ...
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> render;
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里使用createRender来创建渲染器的原因：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 渲染器与渲染不同，渲染器是更加宽泛的概念，它包含渲染，渲染器不仅可以用来渲染，还可以用来激活已有的DOM元素</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createRenderer</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
        ...
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 服务端渲染</span>
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">hydrate</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
        ...
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        render,
        hydrate,
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 渲染器执行任务</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> renderer = createRenderer()
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 首次渲染</span>
renderer.render(oldVnode, <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.querySelector(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'#app'</span>))
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第二次渲染</span>
renderer.render(newVnode, <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.querySelector(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'#app'</span>))
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 首次渲染可以直接挂在vnode，但是第二次渲染会使用newVnode与上一次渲染的oldVnode进行比较，试图找到并更新变更点，这个过程叫做"打补丁"(patch)</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createRenderer</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 新vnode存在，将其与旧vnode一起传给patch</span>
            patch(container._vnode, vnode, container)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 旧vnode存在且新vnode不存在，就直接卸载页面</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (container._vnode) {
                container.innerHTML = <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span>
            }
        }
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 把vnode存储到container._vnode下，即后续的旧vnode</span>
        container._vnode = vnode
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        render
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// n1:旧vnode；n2:新vnode；container:容器</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第一次渲染时，n1是undefined，因此直接挂载，所以patch函数不仅可以用来打补丁，也可以直接挂载</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">自定义渲染器</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createRenderer</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!n1) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 没有旧节点就直接挂载</span>
            mountElement(n2, container);
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
        }
    }
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> el = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.createElement(vnode.type)
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.children === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
            el.textContent = vnode.children
        }
        container.appendChild(el)
    }
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 新vnode存在，将其与旧vnode一起传给patch</span>
            patch(container._vnode, vnode, container)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 旧vnode存在且新vnode不存在，就直接卸载页面</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (container._vnode) {
                container.innerHTML = <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span>
            }
        }
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 把vnode存储到container._vnode下，即后续的旧vnode</span>
        container._vnode = vnode
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        render
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里如果使用mountElement，里面掉了大量基于浏览器的API，如果要设计通用渲染器，就需要将这些特有的API抽离</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> renderer = createRenderer({
    createElement(tag) {
    },
    setElementText(el, text) {
    
    },
    insert(el, parent, anchor = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>) {
    
    }
});

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createRenderer</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">options</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> {
        createElement,
        insert,
        setElementText,
    } = options
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{}
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, contaner</span>) </span>{}
}
</code></pre>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第8章《挂载与更新》</h3>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">HTML Attributes的作用是设置与之对应的DOM Properties的初始值</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">正确地设置元素属性</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> el = createElement(vnode.type)
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode.props) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> vnode.props) {
           <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> el) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> type = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> el[key]
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> value = vnode.props[key]
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'boolean'</span> &amp;&amp; value === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span>) {
                el[key] = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                el[key] = value
            }
           } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            el.setAttribute(key, vnode.props[key])
           }
        }
    }
    
    insert(el, container)
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 问题</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 上面的实现仍然存在问题，因为有一些DOM Properties时只读的</span>
&lt;form id=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"form1"</span> /&gt;
<span style="line-height: 160%; box-sizing: content-box;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">input</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">form</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"form1"</span> /&gt;</span>
// el.form是只读的，这时只能通过setAttribute函数来设置它

function shouldSetAsProps(el, key, value) {
    if (key === 'form' &amp;&amp; el.tagName === 'INPUT') return false
    return key in el
}
</span></code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">class的处理</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">设置class的三种方式：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">el.className</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">el.setAttribute</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">el.classList<br/>
三种方式中，el.className的性能最优，所以采用此方法</li>
</ul>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'class'</span>) {
    el.className = nextValue || <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span>
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">卸载操作</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">卸载操作发生在更新阶段，更新指的是在初次挂载完成之后，后续渲染会触发更新<br/>
之前通过使用innerHTML = ''来卸载是不严谨的：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">容器的内容可能是由某个或多个组件渲染的，当卸载操作发生时应该正确地调用这些组件的生命周期函数</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">即使内容不是由组件渲染的，有的元素存在自定义指令，应该在卸载操作发生时正确执行对应的指令钩子函数</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">innerHTML不会移除绑定在DOM元素上的事件处理函数</li>
</ul>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><code style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;">正确的卸载方式是，根据vnode对象获取与其相关联的真实DOM元素，然后使用原生DOM操作方法将该DOM元素移除</code></p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 让vnode.el引用真实DOM元素</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> el = vnode.el = createElement(vnode.type)
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode) {
        patch(container._vnode, vnode, container)
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (container._vnode) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 根据vnode获取要卸载的真实DOM元素</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> el = container._vnode.el
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 获取el的父元素</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> parent = el.parentNode
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (parent) parent.removeChild(el)
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// unmount(container._vnode) 封装</span>
        }
    }
    container._vnode = vnode
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 封装到unmount</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">unmount</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> parent = vnode.parentNode
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (parent) parent.removeChild(vnode.el)
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">区分vnode的类型</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">当vnode前后type不一致时，可以直接先卸载旧节点，然后挂载新节点</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n1 &amp;&amp; n1.type !== n2.type) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 直接卸载旧的vnode</span>
        unmount(n1);
        n1 = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { type } = n2
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!n1) {
            mountElement(n2, container)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新</span>
            patchElement(n1, n2)
        }
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// n2.type描述的是组件</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'xxx'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 处理其他类型的vnode</span>
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">事件的处理</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">约定，在vnode.props对象中，凡是以字符串on开头的属性都视作事件</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在patchprops中调用addEventlistener来绑定事件</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchProps</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">el, key, prevValue, nextValue</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #9a5334; line-height: 160%; box-sizing: content-box;">/^on/</span>.test(key)) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> name = key.slice(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>).toLowerCase()
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 移除上一次绑定的事件处理函数</span>
        prevValue &amp;&amp; el.removeEventListener(name, prevValue)
        el.addEventListener(name, nextValue)
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'class'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (shouldSetAsProps(el, key, nextValue)) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用invokers来封装</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchProps</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">el, key, prevValue, nextValue</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #9a5334; line-height: 160%; box-sizing: content-box;">/^on/</span>.test(key)) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> invokers = el._vei || (el._vel = {})
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> invoker = invokers[key]
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> name = key.slice(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>).toLowerCase()
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (nextValue) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!invoker) {
                invoker = el._vei[key] = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">e</span>) =&gt;</span> {
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(invoker.value)) {
                        invoker.value.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">fn</span> =&gt;</span> fn(e))
                    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                        invoker.value(e)
                    }
                }
            }
            invoker.value = nextValue
            el.addEventListener(name, invoker)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (invoker) {
            el.removeEventListener(name, invoker)
        }
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'class'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (shouldSetAsProps(el, key, nextValue)) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">事件冒泡与更新时机问题</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">通过比较事件触发时间和事件冒泡时间来决定事件执行<br/>
事件触发时的事件，和事件重新绑定后，冒泡触发的时间做比较</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">更新子节点</h4>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">文本节点和注释节点</h4>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">Fragment</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">多根节点模版<br/>
和文本节点与注释节点类似，片段也没有所谓的标签名称</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> vnode = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: Fragment,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'li'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'1'</span> },
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'li'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'2'</span> },
    ]
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n1 &amp;&amp; n1.type !== n2.type) {
        unmount(n1)
        n1 = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { type } = n2
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Text) { <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// Text = Symbol() 文本节点</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ..</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Fragment) { <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// Fragment = Symbol() 片段节点</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!n1) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 旧vnode不存在，则只需要将Fragment的children逐个挂载</span>
            n2.children.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span> =&gt;</span> patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, c, container))
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果旧vnode存在，则只需要更新Fragment的Children</span>
            patchChildren(n1, n2, container)
        }
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 需要注意，卸载节点也需要支持Fragment</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">unmount</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode.type === Fragment) {
        vnode.children.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span> =&gt;</span> unmount(c))
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> parent = vnode.el.parentNode
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (parent) {
        parent.removeChild(vnode.el)
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">总结</h4>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">为元素设置属性，不能总使用setAttribute或者通过元素的DOM Properties来设置</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">特殊属性的处理，如class,style</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">卸载组件不能直接使用innerHTML,需要触发生命周期钩子函数、指令钩子函数、移除DOM元素上的事件处理函数</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">vnode类型区分</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">vnode事件绑定</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">事件与更新时机的问题</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">子节点的更新</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">Fragment、文本节点、注释节点的实现</li>
</ul>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第9章《简单Diff算法》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">减少DOM操作的性能开销</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchChildren</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> n2.children === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(n2.children)) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldChildren = n1.children;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newChildren = n2.children;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; oldChildren.length; i++) {
            patch(oldChildren[i], newChildren[i])
        }
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在遍历新旧节点的时候，不能总是遍历旧的子节点或者新的子节点，应该遍历其中长度较短的那一组。接着再比较新旧两组子节点的长度，判断需要挂载还是卸载</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchChildren</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> n2.children === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(n2.children)) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldChildren = n1.children;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newChildren = n2.children;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldLen = oldChildren.length
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newLen = newChildren.length
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> commonLength = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Math</span>.min(oldLen, newLen)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; commonLength; i++) {
            patch(oldChildren[i], newChildren[i])
        }
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (newLen &gt; oldLen) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = commonLength; i &lt; newLen; i++) {
                patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, newChildren[i], container)
            }
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldLen &gt; newLen) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = commonLength; i &lt; oldLen; i++) {
                unmount(oldChildren[i])
            }
        }
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">DOM复用与key的作用</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">之前的做法可以减少DOM操作的次数，但这种方式仍然存在可优化的空间</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">[
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span> },
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span> },
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'span'</span> }
] <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// oldChildren</span>

[
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'span'</span> },
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span> },
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span> }
] <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// newChildren</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果按照之前的做法，这里需要执行6次DOM操作，每次都需要先卸载再挂载</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但是观察发现，两组子节点仅仅是顺序不同，所以最优的处理方式是，通过DOM的移动来完成子节点的更新</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但是如何确定新的子节点就是之前出现的旧的子节点呢，这时候就需要引入额外的key来作为vnode的标识</span>

[
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'1'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">key</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> },
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'2'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">key</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span> },
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'3'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">key</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">3</span> }
] <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// oldChildren</span>

[
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'3'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">key</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">3</span> },
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'1'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">key</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> },
    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'2'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">key</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span> }
] <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// newChildren</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// key属性就像虚拟节点的“身份证”，只要两个虚拟节点的type属性值和key属性值都相同，那么我们就认为它们是相同的</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 就算DOM可以复用，有时也需要进行更新，因为DOM的内容可能改变了</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 双重for循环寻找相同DOM</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; newChildren.length; i++) {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newVnode = newChildren[i]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> j = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; j &lt; oldChildren.length; j++) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldVnode = oldChildren[j]
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (newVnode.key === oldVnode.key) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 可以复用，但仍然需要调用patch函数更新</span>
            patch(oldVnode, newVnode, container)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">break</span>
        }
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">找到需要移动的元素</h4>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">如何移动元素</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">每次新旧节点比较时，存储遇到的最大的旧子节点的索引，然后后面每次比较，如果比这个索引小，就需要移动</p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">添加新元素</h4>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">移除不存在的元素</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">当基本的更新结束时，需要遍历旧的一组子节点，然后去新的子节点中寻找具有相同key的节点，如果找不到，则说明应该删除该节点</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; oldChildren.length; i++) {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldVnode = oldChildren[i]
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> has = newChildren.find(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode</span> =&gt;</span> vnode.key === oldVnode.key)
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!has) {
        unmount(oldVnode)
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">总结</h4>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">简单diff的核心：
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">拿新的一组子节点 中的节点去旧的一组子节点中寻找可复用的节点，如果找到了就记录该节点的位置，把这个位置索引称为最大索引</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">如果一个节点的索引值小于最大索引，则说明该节点需要移动</li>
</ul>
</li>
</ul>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第10章《双端Diff算法》</h3>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">上一章的简单Diff算法仍然存在很多缺陷，这些缺陷可以通过双端Diff算法解决<br/>
简单Diff算法的问题在于对DOM的移动操作并不是最优的</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">双端比较的原理</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">在双端比较中，每一轮比较都分为四个步骤：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">第一步，比较旧的第一个节点和新的第一个节点<br/>
如果它们的key相同，那么说明可以复用</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">第二步，比较旧的最后一个节点和新的最后一个节点<br/>
如果它们的key相同，那么说明可以复用</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">第三步，比较旧的第一个节点和新的最后一个节点<br/>
如果它们的key相同，那么说明可以复用，需要将旧的第一个节点移动到旧的最后一个节点后面，然后更新索引....</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">第四步，比较旧的最后一个节点和新的第一个节点<br/>
如果它们的key相同，那么说明可以复用，就将旧的最后一个节点移动到旧的第一个节点前面，然后更新索引：oldEndVNode = oldChildren[--oldEndIdx]；newStartVNode = newChildren[++newStartIdx]</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><code style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;">这四步的比较需要封装到一个while循环中</code></p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 头部索引值要小于尾部索引值</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldStartVnode.key === newStartVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第一步</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 都在头部，不需要移动，只需要patch</span>
        patch(oldStartVnode, newStartVNode, container)
        oldStartVNode = oldChildren[++oldStartIdx]
        newStartVNode = newChildren[++newStartIdx]
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldEndVnode.key === newEndVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第二步</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 都在尾部，不需要移动，只需要patch</span>
        patch(oldEndVNode, newEndVNode, container)
        oldEndVNode = oldChildren[--oldEndIdx]
        newEndVNode = newChildren[--newEndIdx]
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldStartVnode.key === newEndVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第三步</span>
        patch(oldStartVnode, newEndVNode, container)
        
        insert(oldStartVNode.el, container, oldEndVNode.el.nextSibling)
        
        oldStartVNode = oldChildren[++oldStartIdx]
        newEndVNode = newChildren[--newEndIdx]
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldEndVnode.key === newStartVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第四步</span>
        patch(oldEndVNode, newStartVNode, container)
        
        insert(oldEndVNode.el, container, oldStartVNode.el)
        
        oldEndVNode = oldChildren[--oldEndIdx]
        newStartVNode = newChildren[++newStartIdx]
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">双端比较的优势</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">[1, 2, 3]到[3, 1, 2]简单Diff需要移动两次DOM，但是双端比较只需要移动一次</p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">非理想状况的处理方式</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">理想情况下，每一轮都会命中四个步骤中的一个<br/>
在不理想情况下，没有命中四个步骤，只能添加额外步骤来处理<br/>
额外步骤就是尝试看看非头部、非尾部的节点能否复用，拿新的一组节点中的头部节点去旧的一组子节点中寻找</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!oldStartVNode) {
        oldStartVNode = oldChildren[++oldStartIdx]
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!oldEndVNode) {
        oldEndVNode = oldChildren[--oldEndIdx]
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldStartVnode.key === newStartVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第一步</span>
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldEndVnode.key === newEndVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第二步</span>
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldStartVnode.key === newEndVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第三步</span>
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldEndVnode.key === newStartVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第四步</span>
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> idxInOld = oldChildren.findIndex(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span> =&gt;</span> node.key === newStartVNode.key)
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 能找到节点，而且需要移动节点到头部，注意这里不是 &gt;= 0</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (idxInOld &gt; <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> vnodeToMove = oldChildren[idxInOld]
            patch(vnodeToMove, newStartVNode, container)
            
            insert(vnodeToMove.el, container, oldStartVNode.el)
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 由于idxInOld位置已经移动到了别处，因此将其设为undefined</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 需要注意的是，当旧节点中的节点被设置为undefined后，下次比较遇到时，直接跳过</span>
            oldChildren[idxInOld] = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">undefined</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新newStartIdx到下一个位置</span>
            newStartVNode = newChildren[++newStartIdx]
        }
    }
}

</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">添加新元素</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在循环中，既没有匹配到4个步骤，也不能在新节点中找到可复用的旧节点，这就说明这个节点是一个新增节点，这时只需要将其挂载到当前头部节点之前就可以</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!oldStartVNode) {
        oldStartVNode = oldChildren[++oldStartIdx]
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!oldEndVNode) {
        oldEndVNode = oldChildren[--oldEndIdx]
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldStartVnode.key === newStartVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第一步</span>
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldEndVnode.key === newEndVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第二步</span>
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldStartVnode.key === newEndVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第三步</span>
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldEndVnode.key === newStartVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 第四步</span>
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> idxInOld = oldChildren.findIndex(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span> =&gt;</span> node.key === newStartVNode.key)
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 能找到节点，而且需要移动节点到头部，注意这里不是 &gt;= 0</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (idxInOld &gt; <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> vnodeToMove = oldChildren[idxInOld]
            patch(vnodeToMove, newStartVNode, container)
            
            insert(vnodeToMove.el, container, oldStartVNode.el)
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 由于idxInOld位置已经移动到了别处，因此将其设为undefined</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 需要注意的是，当旧节点中的节点被设置为undefined后，下次比较遇到时，直接跳过</span>
            oldChildren[idxInOld] = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">undefined</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新newStartIdx到下一个位置</span>
            newStartVNode = newChildren[++newStartIdx]
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, newStartVNode, container, oldStartVNode.el)
        }
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但是这样还是存在问题：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// </span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 。。。</span>
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 循环结束后检查索引值的情况</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 旧的结束，新的索引还有问题</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldEndIdx &lt; oldStartIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 把后面的依次插入到旧节点的最后</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = newStartIdx; i &lt;= newEndIdx; i++) {
        patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, newChildren[i], container, oldStartVNode.el)
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">移除不存在的元素</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 。。。</span>
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 循环结束后检查索引值的情况</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 旧的结束，新的索引还有问题</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (oldEndIdx &lt; oldStartIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 把后面的依次插入到旧节点的最后</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = newStartIdx; i &lt;= newEndIdx; i++) {
        patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, newChildren[i], container, oldStartVNode.el)
    }
} <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (newEndIdx &lt; newStartidx &amp;&amp; oldStartIdx &lt;= oldEndIdx) {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 移除</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = oldStartIdx; i &lt; oldEndIdx; i++) {
        unmount(oldChildren[i])
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">总结</h4>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">双端Diff的优势在于，对于同样的更新场景，执行的DOM移动操作次数更少</li>
</ul>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第11章《快速Diff算法》</h3>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">最长递归子序列</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">相同的前置元素和后置元素</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">快速diff包含预处理步骤</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">判断两个节点是否全等，全等则不需要处理</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">可以去掉相同的前缀节点或后缀节点</li>
</ul>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchKeyedChildren</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newChildren = n2.children;
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldChildren = n1.children;
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里就完成了对前置节点的更新</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 索引j指向新旧两组子节点的开头</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> j = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldVNode = oldChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newVNode = newChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 循环向后遍历直到遇到拥有不同key的节点</span>
        patch(oldVNode, newVNode, container)
        
        j++
        oldVNode = oldChildren[j]
        newVNode = newChildren[j]
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里完成对后置节点的处理</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldEnd = oldChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newEnd = newChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    oldVNode = oldChildren[oldEnd]
    newVNode = newChildren[newEnd]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        patch(oldVNode, newVNode, container)
        
        oldEnd--
        newEnd--
        oldVNode = oldChildren[oldEnd]
        newVNode = newChildren[newEnd]
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里会有两个条件</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 条件一：oldEnd &lt; j，说明旧节点被处理完毕了</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 条件二：newEnd &gt;= j，说明在预处理后，在新的节点中仍然有未被处理的节点，这些遗留的节点将被视作新增节点</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果条件一和条件二同时成立，说明在新的一组节点中，存在遗留节点，并且这些节点都是新增节点，我们需要将其挂载到正确的位置</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchKeyedChildren</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newChildren = n2.children;
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldChildren = n1.children;
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里就完成了对前置节点的更新</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 索引j指向新旧两组子节点的开头</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> j = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldVNode = oldChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newVNode = newChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 循环向后遍历直到遇到拥有不同key的节点</span>
        patch(oldVNode, newVNode, container)
        
        j++
        oldVNode = oldChildren[j]
        newVNode = newChildren[j]
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里完成对后置节点的处理</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldEnd = oldChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newEnd = newChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    oldVNode = oldChildren[oldEnd]
    newVNode = newChildren[newEnd]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        patch(oldVNode, newVNode, container)
        
        oldEnd--
        newEnd--
        oldVNode = oldChildren[oldEnd]
        newVNode = newChildren[newEnd]
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// j --&gt; newEnd之间的节点应作为新节点插入</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (j &gt; oldEnd &amp;&amp; j &lt;= newEnd) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> anchorIndex = newEnd + <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 判断锚点是否是最后一个元素</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> anchor = anchorIndex &lt; newChildren.length ? newChildren[anchorIndex].el : <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(j &lt;= newEnd) {
            patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, newChildren[j++], container, anchor)
        }
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (j &gt; newEnd &amp;&amp; j &lt;= oldEnd) {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// j --&gt; oldEnd之间的节点应该被卸载</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(j &lt;= oldEnd) {
            unmount(oldChildren[j++])
        }
    
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">判断是否需要进行DOM移动操作</h4>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">构造source数组，长度为剩下的新子节点的长度，初始值都为-1</p>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">source数组将用来存储<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">新的一组子节点中的节点在旧的一组子节点中的位置索引，后面将会使用它计算出一个最长递归子序列，并用于辅助完成DOM移动的操作</strong><br/>
快速Diff算法判断节点是否需要移动的方法与简单Diff算法类似</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchKeyedChildren</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newChildren = n2.children;
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldChildren = n1.children;
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里就完成了对前置节点的更新</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 索引j指向新旧两组子节点的开头</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> j = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldVNode = oldChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newVNode = newChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 循环向后遍历直到遇到拥有不同key的节点</span>
        patch(oldVNode, newVNode, container)
        
        j++
        oldVNode = oldChildren[j]
        newVNode = newChildren[j]
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里完成对后置节点的处理</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldEnd = oldChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newEnd = newChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    oldVNode = oldChildren[oldEnd]
    newVNode = newChildren[newEnd]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        patch(oldVNode, newVNode, container)
        
        oldEnd--
        newEnd--
        oldVNode = oldChildren[oldEnd]
        newVNode = newChildren[newEnd]
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里会有两个条件</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 条件一：oldEnd &lt; j，说明旧节点被处理完毕了</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 条件二：newEnd &gt;= j，说明在预处理后，在新的节点中仍然有未被处理的节点，这些遗留的节点将被视作新增节点</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果条件一和条件二同时成立，说明在新的一组节点中，存在遗留节点，并且这些节点都是新增节点，我们需要将其挂载到正确的位置</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchKeyedChildren</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newChildren = n2.children;
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldChildren = n1.children;
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里就完成了对前置节点的更新</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 索引j指向新旧两组子节点的开头</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> j = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldVNode = oldChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newVNode = newChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 循环向后遍历直到遇到拥有不同key的节点</span>
        patch(oldVNode, newVNode, container)
        
        j++
        oldVNode = oldChildren[j]
        newVNode = newChildren[j]
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里完成对后置节点的处理</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldEnd = oldChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newEnd = newChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    oldVNode = oldChildren[oldEnd]
    newVNode = newChildren[newEnd]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        patch(oldVNode, newVNode, container)
        
        oldEnd--
        newEnd--
        oldVNode = oldChildren[oldEnd]
        newVNode = newChildren[newEnd]
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// j --&gt; newEnd之间的节点应作为新节点插入</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (j &gt; oldEnd &amp;&amp; j &lt;= newEnd) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> anchorIndex = newEnd + <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 判断锚点是否是最后一个元素</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> anchor = anchorIndex &lt; newChildren.length ? newChildren[anchorIndex].el : <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(j &lt;= newEnd) {
            patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, newChildren[j++], container, anchor)
        }
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (j &gt; newEnd &amp;&amp; j &lt;= oldEnd) {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// j --&gt; oldEnd之间的节点应该被卸载</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(j &lt;= oldEnd) {
            unmount(oldChildren[j++])
        }
    
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 处理非理想情况</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> count = newEnd - j + <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> source = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>(count).fill(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">-1</span>)
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 起始索引</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldStart = j
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newStart = j
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> moved = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 类似于普通diff中的lastIndex</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> pos = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> keyIndex = {}
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = newStart; i &lt;= newEnd; i++) {
            keyIndex[newChildren[i].key] = i
        }
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 新增patched变量，代表更新过的节点数量</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> patched = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = oldStart; i &lt;= oldEnd; i++) {
            oldVNode = oldChildren[i]
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果更新过的节点数量小于等于需要更新的节点数量，则执行更新</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (patched &lt;= count) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> k = keyIndex[oldVNode.key]
            
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> k !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'undefined'</span>) {
                    newVNode = newChildren[k]
                    patch(oldVNode, newVNode, container)
                    patched++
                    source[k - newStart] = i

                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (k &lt; pos) {
                        moved = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
                    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                        pos = k
                    }
                } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                    unmount(oldVNode)
                }
            } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                unmount(oldVNode)
            }
            
        }
       
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">如何移动元素</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchKeyedChildren</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newChildren = n2.children;
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldChildren = n1.children;
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里就完成了对前置节点的更新</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 索引j指向新旧两组子节点的开头</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> j = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldVNode = oldChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newVNode = newChildren[j]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 循环向后遍历直到遇到拥有不同key的节点</span>
        patch(oldVNode, newVNode, container)
        
        j++
        oldVNode = oldChildren[j]
        newVNode = newChildren[j]
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里完成对后置节点的处理</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> oldEnd = oldChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> newEnd = newChildren.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
    oldVNode = oldChildren[oldEnd]
    newVNode = newChildren[newEnd]
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(oldVNode.key === newVNode.key) {
        patch(oldVNode, newVNode, container)
        
        oldEnd--
        newEnd--
        oldVNode = oldChildren[oldEnd]
        newVNode = newChildren[newEnd]
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// j --&gt; newEnd之间的节点应作为新节点插入</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (j &gt; oldEnd &amp;&amp; j &lt;= newEnd) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> anchorIndex = newEnd + <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 判断锚点是否是最后一个元素</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> anchor = anchorIndex &lt; newChildren.length ? newChildren[anchorIndex].el : <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(j &lt;= newEnd) {
            patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, newChildren[j++], container, anchor)
        }
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (j &gt; newEnd &amp;&amp; j &lt;= oldEnd) {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// j --&gt; oldEnd之间的节点应该被卸载</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(j &lt;= oldEnd) {
            unmount(oldChildren[j++])
        }
    
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 处理非理想情况</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> count = newEnd - j + <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> source = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>(count).fill(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">-1</span>)
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 起始索引</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldStart = j
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newStart = j
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> moved = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 类似于普通diff中的lastIndex</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> pos = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> keyIndex = {}
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = newStart; i &lt;= newEnd; i++) {
            keyIndex[newChildren[i].key] = i
        }
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 新增patched变量，代表更新过的节点数量</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> patched = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = oldStart; i &lt;= oldEnd; i++) {
            oldVNode = oldChildren[i]
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果更新过的节点数量小于等于需要更新的节点数量，则执行更新</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (patched &lt;= count) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> k = keyIndex[oldVNode.key]
            
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> k !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'undefined'</span>) {
                    newVNode = newChildren[k]
                    patch(oldVNode, newVNode, container)
                    patched++
                    source[k - newStart] = i

                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (k &lt; pos) {
                        moved = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
                    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                        pos = k
                    }
                } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                    unmount(oldVNode)
                }
            } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                unmount(oldVNode)
            }
            
        }
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (moved) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果moved为true，则需要进行DOM移动操作</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 为了移动DOM，需要先根据source计算出最长递增子序列</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如source为[0,8,4,12]，结果就为[0,8,12]或者[0,4,12]</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> seq = lis(source) <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 计算最长递增子序列，这里得到的元素是在source中的位置索引</span>
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 为了完成节点的移动，还需要创建两个索引值i和s</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// i指向新的一组子节点中的最后一个节点</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// s指向最长递增子序列中的最后一个元素</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> s = seq.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = count - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(i; i &gt;= <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i--) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (source[i] === <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">-1</span>) {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 说明索引为i的节点是新节点，应该将其挂载</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> pos = i + newStart <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 该节点在新children中的真实位置索引</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newVNode = newChildren[pos]
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 该节点的下一个节点的位置索引</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> nextPos = pos + <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> anchor = nextPos &lt; newChildren.length ? newChildren[nextPos].el : <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>

                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 挂载</span>
                    patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, newVnode, container, anchor)
                } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (i !== seq[s]) {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果节点的索引i不等于seq[s]的值，说明该节点需要移动</span>
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 该节点在新的一组子节点中的真实位置索引</span>
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里就是一步到位，直接将节点插入到最后正确的位置</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> pos = i + newStart
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newVNode = newChildren[pos]
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 该节点的下一个节点的位置索引</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> nextPos = pos + <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> anchor = nextPos &lt; newChildren.length ? newChildren[nextPos].el : <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
                    insert(newVNode.el, container, anchor)
                } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当i === seq[s]时，说明该节点不需要移动</span>
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 只需要让s指向前面一个位置</span>
                    s--
                }
            }
        }
       
    }
}
</code></pre>
<h2 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;">第四篇《组件化》</h2>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第12章《组件的实现原理》</h3>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">为了让渲染器能够处理组件类型的虚拟节点，还需要在patch函数中对组件类型的虚拟节点进行处理</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n1 &amp;&amp; n1.type !== n2.type) {
        unmount(n1);
        n1 = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { type } = n2
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Text) {
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Fragment) {
        
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 组件处理</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!n1) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 挂载组件</span>
            mountElement(n2, container, anchor)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新组件</span>
            patchComponent(n1, n2, anchor)
        }
    }
}
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">渲染器有能力处理组件后，就需要设计组件在用户层面的接口。一个组件必须包含一个渲染函数，即render函数，并且渲染函数的返回值应该是虚拟DOM</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 渲染器中真正完成组件渲染任务的是mountComponent函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> componentOptions = vnode.type
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { render } = componentOptions
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render()
    
    patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, subTree, container, anchor)
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">组件状态与自更新</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> MyComponent = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'MyComponent'</span>,
    data() {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'hello world'</span>
        }
    },
    render() {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`foo的值是<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">${<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.foo}</span>`</span>
        }
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> componentOptions = vnode.type
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { render } = componentOptions
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始数据</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> state = reactive(data())
    
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一旦组件自身的响应式数据发生变化，组件就会自动重新执行渲染函数</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render.call(state, state)
    
        patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, subTree, container, anchor)
    })

}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 问题</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 由于effect是同步的，因此当响应式数据发生变化时，副作用函数会同步执行，因此会导致渲染函数执行多次，这实际是没有必要的。为此需要一个调度器，当副作用函数需要重新执行时，不会立即执行它，而是将它缓冲到微任务队列，等到执行栈清空后，再取出来执行。</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> queue = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Set</span>()
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一个标志，代表是否正在刷新任务队列</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> isFlushing = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 创建一个立即resolve的Promise实例</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Promise</span>.resolve()

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">queueJob</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">job</span>) </span>{
    queue.add(job)
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!isFlushing) {
        isFlushing = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
        p.then(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">try</span> {
                queue.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">job</span> =&gt;</span> job())
            } finnaly {
                isFlushing = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>
                queue.length = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>
            }
        })
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> componentOptions = vnode.type
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { render } = componentOptions
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始数据</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> state = reactive(data())
    
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一旦组件自身的响应式数据发生变化，组件就会自动重新执行渲染函数</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render.call(state, state)
    
        patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, subTree, container, anchor)
    }, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">scheduler</span>: queueJob
    })

}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里当响应式数据发生变化时，副作用函数不会立即执行，而是会被queueJob函数调度</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但是上面代码还存在问题，patch时，每次更新都会进行全新的挂载，而不是打补丁。为此，需要实现组件实例，用它来维护组件整个生命周期的状态，这样渲染器才能够在正确的时机执行合适的操作。</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">组件实例与组件的生命周期</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">组件实例本质上就是一个状态集合(或一个对象)，它维护着组件运行过程中的所有信息<br/>
例如组件的生命周期函数、组件渲染的子树</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> componentOptions = vnode.type
        
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始数据</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> state = reactive(data())
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { render, data, beforeCreate, created, beforeMount, mounted, beforeUpdate, updated } = componentOptions
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里调用beforeCreate钩子</span>
    beforeCreate &amp;&amp; beforeCreate()
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> instance = {
        state, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 组件自身的状态数据，即data</span>
        isMounted: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一个布尔值，用来表示组件是否已经被挂载</span>
        subTree: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 组件所渲染的内容，即子树</span>
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将组件实例设置到vnode上，用于后续更新</span>
    vnode.component = instance
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用created钩子</span>
    created &amp;&amp; created.call(state)
    
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一旦组件自身的响应式数据发生变化，组件就会自动重新执行渲染函数</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render.call(state, state)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!instance.isMounted) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用beforeMount钩子</span>
            beforeMount &amp;&amp; beforeMount.call(state)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 初次挂载</span>
            patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, subTree, container, anchor)
            instance.isMounted = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用mounted钩子</span>
            mounted &amp;&amp; mounted.call(state)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用beforeUpdate钩子</span>
            beforeUpdate &amp;&amp; beforeUpdate.call(state)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当isMounted为true时，说明组件已经被挂载，只需要完成自更新即可</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 所以调用patch函数时，第一个参数为组件上一次渲染的子树</span>
            patch(instance.subTree, subTree, container, anchor)
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用updated钩子</span>
            updated &amp;&amp; updated.call(state)
        }
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新组件实例的子树</span>
        instance.subTree = subTree
    }, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">scheduler</span>: queueJob
    })

}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">props与组件的被动更新</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在虚拟DOM层面，组件的props与普通HTML标签的属性差别不大</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> componentOptions = vnode.type
        
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始数据</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> state = reactive(data())
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { render, data, props, propsOptions, beforeCreate, created, beforeMount, mounted, beforeUpdate, updated } = componentOptions
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> [props, attrs] = resolveProps(propsOptions, vnode.props)
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里调用beforeCreate钩子</span>
    beforeCreate &amp;&amp; beforeCreate()
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> instance = {
        state, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 组件自身的状态数据，即data</span>
        props: shallowReactive(props), <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将props包装成shallowReactive</span>
        isMounted: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一个布尔值，用来表示组件是否已经被挂载</span>
        subTree: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 组件所渲染的内容，即子树</span>
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将组件实例设置到vnode上，用于后续更新</span>
    vnode.component = instance
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用created钩子</span>
    created &amp;&amp; created.call(state)
    
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一旦组件自身的响应式数据发生变化，组件就会自动重新执行渲染函数</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render.call(state, state)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!instance.isMounted) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用beforeMount钩子</span>
            beforeMount &amp;&amp; beforeMount.call(state)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 初次挂载</span>
            patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, subTree, container, anchor)
            instance.isMounted = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用mounted钩子</span>
            mounted &amp;&amp; mounted.call(state)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用beforeUpdate钩子</span>
            beforeUpdate &amp;&amp; beforeUpdate.call(state)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当isMounted为true时，说明组件已经被挂载，只需要完成自更新即可</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 所以调用patch函数时，第一个参数为组件上一次渲染的子树</span>
            patch(instance.subTree, subTree, container, anchor)
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用updated钩子</span>
            updated &amp;&amp; updated.call(state)
        }
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新组件实例的子树</span>
        instance.subTree = subTree
    }, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">scheduler</span>: queueJob
    })

}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">resolveProps</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">options, propsData</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> props = {}
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> attrs = {}
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 遍历为组件传递的props数据</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> propsData) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> options) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果为组件传递的props数据在组件自身的props选项中有定义，则将其视为合法的props</span>
            props[key] = propsData[key]
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 否则将其作为attrs</span>
            attrs[key] = propsData[key]
        }
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> [props, attrs]
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// props数据变化时，需要触发父组件重新渲染</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 父组件更新时会调用patchComponent函数来完成子组件的更新。这种更新叫做子组件的被动更新，当被动更新时：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.检测子组件是否真的需要更新，因为子组件的props可能是不变的</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.如果需要更新，则更新子组件的props、slots等内容</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">setup函数的作用与实现</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">setup函数主要用于配合组合式API，为用户提供一个地方，用于建立组合逻辑、创建响应式数据、创建通用函数、注册生命周期钩子函数等能力。</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">在组件的整个生命周期中，setup函数只会在被挂载时执行一次，它的返回值可以有两种情况：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">返回一个函数，该函数将作为组件的render函数。这种方式常用于组件不是以模版来表达其渲染内容的情况</li>
</ul>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> Comp = {
    setup() {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'hello'</span> }
        }
    }
}
</code></pre>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">返回一个对象，该对象中包含的数据将暴露给模版使用</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">另外setup函数接收两个参数。第一个参数时props数据对象，第二个参数也是一个对象，通常称为setupContext</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> Comp = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">String</span>
    },
    setup(props, setupContext) {
        props.foo
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { slots, emit, attrs, expose } = setupContext
    }
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><code style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;">通常情况下，不建议将setup与Vue.js2中的组件选项混合使用</code></p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> componentOptions = vnode.type
        
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 得到原始数据</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> state = reactive(data())
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { render, data, props, propsOptions, beforeCreate, created, beforeMount, mounted, beforeUpdate, updated, setup } = componentOptions
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> [props, attrs] = resolveProps(propsOptions, vnode.props)
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里调用beforeCreate钩子</span>
    beforeCreate &amp;&amp; beforeCreate()
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> instance = {
        state, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 组件自身的状态数据，即data</span>
        props: shallowReactive(props), <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将props包装成shallowReactive</span>
        isMounted: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一个布尔值，用来表示组件是否已经被挂载</span>
        subTree: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 组件所渲染的内容，即子树</span>
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> setupContext = { attrs }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> setupResult = setup(shallowReadonly(instance.props), setupContext)
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> setupState = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> setupResult === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 渲染函数</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (render) <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.error(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'setup函数返回渲染函数，render选项将被忽略'</span>)
        render = setupResult
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 作为数据赋值</span>
        setupState = setupContext
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将组件实例设置到vnode上，用于后续更新</span>
    vnode.component = instance
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用created钩子</span>
    created &amp;&amp; created.call(state)
    
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一旦组件自身的响应式数据发生变化，组件就会自动重新执行渲染函数</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render.call(state, state)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!instance.isMounted) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用beforeMount钩子</span>
            beforeMount &amp;&amp; beforeMount.call(state)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 初次挂载</span>
            patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, subTree, container, anchor)
            instance.isMounted = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用mounted钩子</span>
            mounted &amp;&amp; mounted.call(state)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用beforeUpdate钩子</span>
            beforeUpdate &amp;&amp; beforeUpdate.call(state)
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当isMounted为true时，说明组件已经被挂载，只需要完成自更新即可</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 所以调用patch函数时，第一个参数为组件上一次渲染的子树</span>
            patch(instance.subTree, subTree, container, anchor)
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里调用updated钩子</span>
            updated &amp;&amp; updated.call(state)
        }
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新组件实例的子树</span>
        instance.subTree = subTree
    }, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">scheduler</span>: queueJob
    })

}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">组件事件与emit的实现</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">emit用来发射组件的自定义事件<br/>
在具体的实现上，发射自定义事件的本质就是根据事件名称去props数据对象中寻找对应的事件处理函数并执行</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">插槽的工作原理与实现</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">header</span>&gt;</span><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">slot</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"header"</span>/&gt;</span><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">header</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
        <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">slot</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"body"</span>/&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">footer</span>&gt;</span><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">slot</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"footer"</span> /&gt;</span><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">footer</span>&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">注册生命周期</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">onMounted、onUpdated</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> currentInstance = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">setCurrentInstance</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">instance</span>) </span>{
    currentInstance = instance
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> instance = {
        state, 
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: shallowReactive(props),
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">isMounted</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">subTree</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>,
        slots,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">mounted</span>: []
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> setupContext = { attrs, emit, slots }
    setCurrentInstance(instance)
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> setupResult = setup(shallowReadonly(instance.props), setupContext)
    setCurrentInstance(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)
    
    effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render.call(renderContext, renderContext)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!instance.isMounted) {
         <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
         
         instance.mounted &amp;&amp; instance.mounted.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">hook</span> =&gt;</span> hook.call(renderContext))
        }
    })
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// onMounted</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">onMounted</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">fn</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (currentInstance) {
        currentInstance.mounted.push(fn)
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.error(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'onMounted函数只能在setup中调用'</span>)
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">总结</h4>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第13章《异步组件与函数式组件》</h3>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">异步组件：以异步的方式加载并渲染一个组件<br/>
函数式组件：使用一个普通函数定义组件，并使用该函数的返回值作为组件要渲染的内容，特点是无状态、编写简单且直观<br/>
vue2中，相比有状态组件来说，函数式组件具有明显的性能优势，但在vue3中，函数式组件与有状态组件的性能差距不大</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">异步组件要解决的问题</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">// 同步渲染
import App from './app.vue'
createApp(App).mount('#app')

// 异步渲染
const loader = () =&gt; import('App.vue')
loader().then(App =&gt; createApp(App).mount('#app
'))

// 异步加载一个组件
&lt;template&gt;
    &lt;ComA /&gt;
    &lt;component :is="asyncComp" /&gt;
&lt;/template&gt;
&lt;script&gt;
import { shallowRef } from 'vue'
import CompA from 'ComA.vue'

export default {
    components: {
        CompA,
    },
    setup() {
        const asyncComp = shallowRef(null)
        
        import('CompB.vue').then(CompB =&gt; asyncComp.value = CompB)
        
        return {
            asyncComp
        }
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">异步组件的实现原理</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">异步组件本质上是通过封装手段来实现友好的用户接口，从而降低用户层面的使用复杂度</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">export</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">default</span> {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">components</span>: {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">AsyncComp</span>: defineAsyncComponent(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">import</span>(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'CompA'</span>))
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用defineAsyncComponent来定义异步组件，并直接使用components来注册它</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// defineAsyncComponent是一个高阶组件</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">defineAsyncComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">loader</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一个变量，用来存储异步加载的组件</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> InnerComp = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'AsyncComponentWrapper'</span>,
        setup() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> loaded = ref(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>)
            loader().then(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span> =&gt;</span> {
                InnerComp = c;
                loaded.value = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            })
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 异步组件加载成功就渲染组件，否则渲染一个占位内容</span>
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> loaded.value ? { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: InnerComp } : { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: Text, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span> }
            }
        }
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// defineAsyncComponent函数本质上是一个高阶组件，它的返回值是一个包装组件</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 包装组件会根据加载器的状态来决定渲染什么内容。异步组件加载成功就渲染组件，否则渲染一个占位内容</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 通常占位内容是一个注释节点。组件没有被加载成功时，页面中会渲染一个注释节点来占位</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">超时与Error组件</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">异步组件通常以网络请求的形式进行加载，既然存在网络请求，就要考虑网速较慢的情况，尤其在弱网环境下，因此需要为用户提供指定超时时长的能力，当加载组件的时间超过了指定时长后，会触发超时错误。这时如果配置了Error组件，会渲染该组件</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> AsyncComp = defineAsyncComponent({
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">loader</span>: <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">import</span>(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'CompA.vue'</span>),
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">timeout</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2000</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">errorComponent</span>: MyErrorComp
})

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">defineAsyncComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">options</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// options是加载器，将其格式化为配置项</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> options === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        options = {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">loader</span>: options
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { loader } = options

    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一个变量，用来存储异步加载的组件</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> InnerComp = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'AsyncComponentWrapper'</span>,
        setup() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> loaded = ref(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> timeout = ref(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>)
            loader().then(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span> =&gt;</span> {
                InnerComp = c;
                loaded.value = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            })
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> timer = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (options.timeout) {
                timer = setTimeout(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                    timeout.value = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
                }, options.timeout)
            }
            
            onUnmounted(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> clearTimeout(timer))
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> placeholder = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: Text, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span> }
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (loaded.value) {
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: InnerComp }
                } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (timeout.value) {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果超时且存在错误组件，则渲染该组件</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> options.errorComponent ? { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: options.errorComponent } : placeholder
                }
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> placeholder
            }
        }
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 希望有更完善的机制来处理异步组件加载过程中发生的错误：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.当错误发生时，把错误对象作为Error组件的props传递过去</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.除了超时外，有能力处理其他原因导致的加载错误，例如网络失败</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">defineAsyncComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">options</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// options是加载器，将其格式化为配置项</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> options === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        options = {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">loader</span>: options
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { loader } = options

    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一个变量，用来存储异步加载的组件</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> InnerComp = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'AsyncComponentWrapper'</span>,
        setup() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> loaded = ref(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> error = shallowRef(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)
            loader().then(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span> =&gt;</span> {
                InnerComp = c;
                loaded.value = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }).catch(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">err</span> =&gt;</span> error.value = err)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> timer = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (options.timeout) {
                timer = setTimeout(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 超时后创建一个错误对象，并复制给error.value</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> err = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Error</span>(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Async component timed out after ....'</span>)
                    error.value = err;
                }, options.timeout)
            }
            
            onUnmounted(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> clearTimeout(timer))
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> placeholder = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: Text, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span> }
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (loaded.value) {
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: InnerComp }
                } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (error.value &amp;&amp; options.errorComponent) {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果错误且存在错误组件，则渲染该组件</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: options.errorComponent, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">error</span>: error.value } }
                }
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> placeholder
            }
        }
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">延迟与Loading组件</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">异步组件受网络影响大，加载过程可能很慢可能很快。这时可以通过展示Loading组件来提供更好的用户体验。但是展示Loading组件的时机是一个需要仔细考虑的问题<br/>
通常，在开始加载时渲染Loading组件，但是如果网络良好，这会导致刚渲染的Loading组件立马被卸载，这会导致闪烁，体验不好。因此，需要为Loading组件设置一个延迟展示的时间<br/>
例如当超过200ms没有完成加载，才展示Loading组件。这样，对于在200ms内能够完成加载的情况来说，就避免了闪烁问题的出现</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用户接口设计</span>
defineAsyncComponent({
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">loader</span>: <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Promise</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">r</span> =&gt;</span> { <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* ...*/</span> }),
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 延迟200ms展示Loading组件</span>
    delay: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">200</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">loadingComponent</span>: {
     setup() {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'h2'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Loading...'</span> }
     }   
    }
})


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 实现</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">defineAsyncComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">options</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// options是加载器，将其格式化为配置项</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> options === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        options = {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">loader</span>: options
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { loader } = options

    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 一个变量，用来存储异步加载的组件</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> InnerComp = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'AsyncComponentWrapper'</span>,
        setup() {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> loaded = ref(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> error = shallowRef(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> loading = ref(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>)
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> loadingTimer = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (options.delay) {
                loadingTimer = setTimeout(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                    loading.value = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
                }, options.delay)
            } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                loading.value = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>;
            }
            
            loader().then(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span> =&gt;</span> {
                InnerComp = c;
                loaded.value = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            }).catch(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">err</span> =&gt;</span> error.value = err)
                .finally(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                    loading.value = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>
                    clearTimeout(loadingTimer)
                })
           
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> timer = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (options.timeout) {
                timer = setTimeout(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 超时后创建一个错误对象，并复制给error.value</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> err = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Error</span>(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Async component timed out after ....'</span>)
                    error.value = err;
                }, options.timeout)
            }
            
            onUnmounted(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> clearTimeout(timer))
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> placeholder = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: Text, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span> }
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (loaded.value) {
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: InnerComp }
                } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (error.value &amp;&amp; options.errorComponent) {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果错误且存在错误组件，则渲染该组件</span>
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: options.errorComponent, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">error</span>: error.value } }
                } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (loading.value &amp;&amp; options.loadingComponent) {
                    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: options.loadingComponent }
                }
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> placeholder
            }
        }
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">重试机制</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">重试指的是当加载出错时，有能力重新发起加载组件的请求</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 模拟接口请求失败</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">fetch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Promise</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">resolve, reject</span>) =&gt;</span> {
        
        setTimeout(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            reject(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'err'</span>)
        }, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1000</span>)
    })
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">load</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">onError</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> p = fetch()
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> p.catch(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">err</span> =&gt;</span> {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Promise</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">resolve, reject</span>) =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> retry = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> resolve(load(onError))
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> fail = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> reject(err)
            onError(retry, fail)
        })
    })
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 调用load加载资源</span>
load(
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">retry</span>) =&gt;</span> {
        retry()
    }
).then(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">res</span> =&gt;</span> {
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.log(res)
})
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">函数式组件</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">函数式组件本质上就是一个普通函数，该函数的返回值是虚拟DOM<br/>
在Vue3中使用函数式组件，主要是因为它的简单性，而不是因为它的性能好。这是因为在vue3中，即使是有状态组件，其初始化性能消耗也非常小</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在用户接口层，一个函数式组件就是一个返回虚拟DOM的函数</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 函数式组件没有自身状态，但它仍然可以接收由外部传入的props</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">MyFuncComp</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">props</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'h1'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: props.title }
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 定义props</span>
MyFuncComp.props = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">title</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">String</span>
}


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// patch函数的支持非常简单</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n1 &amp;&amp; n1.type !== n2.type) {
        unmount(n1)
        n1 = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { type } = n2
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Text) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Fragment) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> || <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// object是有状态组件，function是函数式组件</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 他们都可以用mountComponent函数来完成挂载</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用patchComponent函数来更新</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!n1) {
            mountComponent(n2, container, anchor)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            patchComponent(n1, n2, anchor)
        }
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> isFunctional = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> componentOptions = vnode.type
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isFunctional) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果是函数式组件，则将vnode.type作为渲染函数，将vnode.type.props作为props选项定义即可</span>
        componentOptions = {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">render</span>: vnode.type,
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: vnode.type.props
        }
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 我们需要通过isFunctional变量实现选择性地执行初始化逻辑，因为对于函数式组件来说，它无须初始化data以及生命周期钩子。从这里可以看出，函数式组件的初始化性能消耗小于有状态组件</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">总结</h4>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">
<p style="line-height: 160%; box-sizing: content-box; color: #333; margin: 0;">异步组件</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-top: 0; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">允许用户指定加载出错的组件</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">允许用户指定Loading组件，以及展示该组件的延迟时间</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">允许用户设置加载组件的超时时长</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">组件加载失败时提供重试的能力</li>
</ul>
</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">
<p style="line-height: 160%; box-sizing: content-box; color: #333; margin: 0;">函数式组件</p>
</li>
</ul>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第14章《内建组件和模块》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">KeepAlive组件的实现原理</h4>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">组件的激活与失灵</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">KeepAlive组件可以避免一个组件被频繁地销毁/重建</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">v-if</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"currentTab === 1"</span> &gt;</span>...<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">v-if</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"currentTab === 2"</span> &gt;</span>...<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">v-if</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"currentTab === 3"</span> &gt;</span>...<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span>&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">&lt;!-- 根据currentTab值的不同，会渲染不同的Tab组件。当用户频繁切换Tab会导致不停地卸载并重建对应的&lt;Tab&gt;组件，为了避免产生的性能开销，可以使用KeepAlive组件来解决这个问题 --&gt;</span>

<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">KeepAlive</span>&gt;</span>
        <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">v-if</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"currentTab === 1"</span> &gt;</span>...<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span>&gt;</span>
        <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">v-if</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"currentTab === 2"</span> &gt;</span>...<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span>&gt;</span>
        <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">v-if</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"currentTab === 3"</span> &gt;</span>...<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Tab</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">KeepAlive</span>&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">&lt;!-- 这样无论怎样切换Tab，都不会频繁的创建和销毁 --&gt;</span>
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">KeepAlive组件的本质是缓存管理，再加上特殊的挂载/卸载逻辑<br/>
KeepAlive组件的实现需要渲染器层面的支持。这是因为被KeepAlive的组件在卸载时，不能真的将其卸载，否则就无法维持组件的当前状态了。<br/>
正确的做法是，将被KeepAlive的组件从原容器搬运到另外一个隐藏的容器中，实现假"卸载"。当被搬运到隐藏容器中的组件需要再次被"挂载"时，也不能执行真正的挂载逻辑，而应该把该组件从隐藏容器中再搬运到原容器。这个过程对应组件的生命周期，即activated和deactivated</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 基本的KeepAlive组件</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> KeepAlive = {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// KeepAlive组件独有的属性，用作标识</span>
    __isKeepAlive: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
    setup(props, { slots }) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 创建一个缓存对象</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// key: vnode.type</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// value: vnode</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> cache = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Map</span>()
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当前KeepAlive组件的实例</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> instance = currentInstance
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 对于KeepAlive组件来说，它的实例上存在特殊的keepAliveCtx对象，该对象由渲染器注入</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 该对象会暴露渲染器的一些内部方法，其中move函数用来将一段DOM移动到另一个容器中</span>
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { move, createElement } = instance.keepAliveCtx
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 创建隐藏容器</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> storageContainer = createElement(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>)
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// KeepAlive组件的实例上会被添加两个内部函数，分别是_deActivate和_activate</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这两个函数会在渲染器中被调用</span>
        instance._deActivate = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode</span>) =&gt;</span> {
            move(vnode, storageContainer)
        }
        instance._activate = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) =&gt;</span> {
            move(vnode, container, anchor)
        }
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// KeepAlive的默认插槽就是要被KeepAlive的组件</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> rawVNode = slots.default()
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果不是组件，直接渲染即可，因为非组件的虚拟节点无法被KeepAlive</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> rawVNode.type !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span>) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> rawVNode
            }
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在挂载时先获取缓存的组件vnode</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> cachedVNode = cache.get(rawVNode.type)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (cachedVNode) {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果有缓存的内容，则说明不应该执行挂载，而应该执行激活</span>
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 继承组件实例</span>
                rawVNode.component = cachedVNode.component
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在vnode上添加keptAlive属性，标记为true，避免渲染器重新挂载它</span>
                rawVNode.keptAlive = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果没有缓存，则将其添加到缓存中，这样下次激活组件时就不会执行新的挂载动作了</span>
                cache.set(rawVNode.type, rawVNode)
            }
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在组件vnode上添加shouldKeepAlive属性，并标记为true，避免渲染器真的将组件卸载</span>
            rawVNode.shouldKeepAlive = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将KeepAlive组件的实例也添加到vnode上，以便在渲染器中访问</span>
            rawVNode.keepAliveInstance = instance
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 渲染组件vnode</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> rawVNode
            
        }
    }
}

</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">与普通组件的一个较大的区别在于，KeepAlive组件与渲染器的结合非常深。<br/>
KeepAlive组件会在内部组件的vnode的对象上添加一些标记属性：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">shouldKeepAlive: 当渲染器卸载内部组件时，可以检查该属性得知内部组件需要被KeepAlive，因此调用_deactivate函数</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">keepAliveInstance: 内部组件的vnode对象会持有KeepAlive组件实例，在unmount函数中会通过keepAliveInstance来访问_deActivate函数<br/>
keptAlive: 内部组件如果已经被缓存过，还会为其添加一个keptAlive标记，这样当内部组件需要重新渲染时，渲染器并不户重新挂载它，而是调用_activate函数</li>
</ul>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n1 &amp;&amp; n1.type !== n2.type) {
        unmount(n1)
        n1 = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { type } = n2
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Text) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Fragment) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> || <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// object是有状态组件，function是函数式组件</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 他们都可以用mountComponent函数来完成挂载</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用patchComponent函数来更新</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!n1) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n2.keptAlive) {
                n2.keepAliveInstance._activate(n2, container, anchor)
            } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                mountComponent(n2, container, anchor)
            }
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            patchComponent(n1, n2, anchor)
        }
    }
}
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">失活的本质是将组件所渲染的内容移动到隐藏容器中，而激活的本质是将组件所渲染的内容从隐藏容器中搬回原来的容器</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ....</span>
    
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> instance = {
        state,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: shallowReactive(props),
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">isMounted</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">false</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">subTree</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>,
        slots,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">mounted</span>: [],
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 只有KeepAlive组件的实例下会有keepAliveCtx属性</span>
        keepAliveCtx: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>,
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 检查当前要挂载的组件是否是KeepAlive组件</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> isKeepAlive = vnode.type.__isKeepAlive
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (isKeepAlive) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在KeepAlive组件实例上添加KeepAliveCtx对象</span>
        instance.keepAliveCtx = {
            move(vnode, container, anchor) {
                insert(vnode.component.subTree.el, container, anchor)
            },
            createElement
        }
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ....</span>
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">include和exclude</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在默认情况下，KeepAlive会对所有的内部组件进行缓存。但有时候用户期望只缓存特定组件。<br/>
为了使用户能够自定义缓存规则，需要让KeepAlive组件支持两个Props，分别是include和exclude<br/>
include用来显示地配置应该被缓存的组件，而exclude用来显示地配置不应该被缓存的组件</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> KeepAlive = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">__isKeepAlive</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">include</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">RegExp</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">exclude</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">RegExp</span>,
    },
    setup(props, { slots }) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// include和exclude只接收正则类型的值，他会根据内部组件的名称(name属性)进行匹配</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> KeepAlive = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">__isKeepAlive</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">include</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">RegExp</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">exclude</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">RegExp</span>,
    },
    setup(props, { slots }) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
        
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> rawVNode = slots.default()
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> rawVNode.type !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span>) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> rawVNode
            }
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> name = rawVNode.type.name
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 对name进行匹配</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果name无法被include匹配或者能被exclude匹配</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (name &amp;&amp; (props.include &amp;&amp; !props.include.test(name)) || (props.exclude &amp;&amp; props.exclude.test(name))) {
                
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 直接渲染内部组件，不进行后续操作</span>
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> rawVNode
            }
        }
    }
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">缓存管理</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">前面使用一个map来管理缓存</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> cache = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Map</span>()
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 键是组件选项对象，即vnode.type属性的值，而该map对象的值是用于描述组件的vnode对象。</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 由于用于描述组件的vnode对象存在对组件实例的引用(vnode.component)，所以缓存用于描述组件的Vnode对象，就等价于缓存了组件实例</span>
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">如果缓存存在，则继承组件实例，并将用于描述组件的vnode对象标记为keptAlive,这样渲染器就不会重新创建新的组件实例<br/>
如果缓存不存在，则设置缓存</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">这里的问题在于，当缓存不存在的时候，总是会设置新的缓存。这会导致缓存不断增加，占用大量内存。为了解决这个问题，必须设置一个缓存阈值，当缓存数量超过指定阈值时对缓存进行修剪</strong></p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">而如何进行修剪成了新的问题：</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">vue采用的修剪策略叫做“最新一次访问”</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">KeepAlive</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">:max</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"2"</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">component</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">:is</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"dynamicCom"</span> /&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">KeepAlive</span>&gt;</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">&lt;!--
    如果有三个组件，而缓存容量为2
    1.初始渲染Comp1，添加缓存，缓存队列[Comp1]，最新一次访问的是ComP1
    2.切换到Comp2，添加缓存，缓存队列为[Comp1, Comp2],最新一次访问是Comp2
    3.切换到Comp3, 缓存容量已满，需要修剪，最新一次访问的是Comp2,因此Comp1被修剪，缓存队列[Comp2, Comp3]，最新一次访问的是Comp3
    
--&gt;</span>
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><code style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;">vue为了用户可以自定义缓存策略，新增了cache接口</code></p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">KeepAlive</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">:cache</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"cache"</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Comp</span>/&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">KeepAlive</span>&gt;</span>

const _cache = new Map()
const cache: KeepAliveCache = {
    get(key) {
        _cache.get(key)
    },
    set(key, value) {
        _cache.set(key, value)
    },
    delete(key) {
        _cache.delete(key)
    },
    forEach(fn) {
        _cache.forEach(fn)
    }
    
    
}
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在KeepAlive组件的内部实现中，如果用户提供了自定义的缓存实例，则直接使用该缓存实例来管理缓存。</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">Teleport组件的实现原理</h4>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">Teleport组件要解决的问题</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">通常情况下，在将虚拟DOM渲染为真实DOM时，最终渲染出来的真实DOM的层级结构与虚拟DOM的层级结构一致<br/>
Teleport组件，可以将指定内容渲染到特定容器中，而不受DOM层级的限制</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Teleport</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">to</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"body"</span>&gt;</span>
        <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">class</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"overlay"</span>&gt;</span><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">Teleport</span>&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">&lt;!--  通过为Teleport组件指定渲染目标body，即to属性的值，该组件就会直接把它的插槽内容渲染到body下 --&gt;</span>
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">实现Teleport组件</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">与KeepAlive组件一样，Teleport组件也需要渲染器的底层支持。<br/>
要将Teleport组件的渲染逻辑从渲染器中分离出来，这样做的好处是</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">可以避免渲染器逻辑代码膨胀</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">当用户没有使用Teleport组件时，可以利用Tree-Shaking机制删除无用的Teleport代码</li>
</ul>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patch</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n1 &amp;&amp; n1.type !== n2.type) {
        unmount(n1);
        n1 = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>;
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { type } = n2;
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Text) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === Fragment) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> &amp;&amp; type.__isTeleport) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 组件中如果存在__isTeleport标识，那么它是Teleport组件</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 调用Teleport组件选项中的process函数将控制权交接出去</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 传递给process函数的第五个参数是渲染器的一些内部方法</span>
        type.process(n1, n2, container, anchor, {
            patch,
            patchChildren,
            unmount,
            move(vnode, container, anchor) {
                insert(vnode.component ? vnode.component.subTree.el : vnode.el, container, anchor)
            }
        })
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> || <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里调用process将渲染控制权交接出去，这就实现了渲染逻辑的分离</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// Teleport设计虚拟DOM</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;Teleport to="body"&gt;
    &lt;h1&gt;title&lt;/h1&gt;
    &lt;p&gt;content&lt;/p&gt;
&lt;/Teleport&gt;
直接将其子节点编译为一个数组即可

function render() {
    return {
        type: Teleport,
        children: [
            { type: 'h1', children: 'title' },
            { type: 'p', children: 'content' }
        ]
    }
}

*/</span>


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 实现Teleport组件</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> Teleport = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">__isTeleport</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>,
    process(n1, n2, container, anchor, internals) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在这里处理渲染逻辑</span>
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 通过internals参数取得渲染器的内部方法</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { patch, patchChildren, move } = internals
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!n1) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 挂载</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> target = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> n2.props.to === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span> ? <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.querySelector(n2.props.to) : n2.props.to
            
            n2.children.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span> =&gt;</span> patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, c, target, anchor))
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新</span>
            patchChildren(n1, n2, container);
            
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果新旧to参数的值不同，则需要对内容进行移动</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n2.props.to !== n1.props.to) {
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newTarget = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> n2.props.to === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span> ? <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.querySelector(n2.props.to) : n2.props.to
                
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 移动到新容器</span>
                n2.children.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span> =&gt;</span> move(c, newTarget))
            }
        }
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">Transition组件的实现原理</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">Transition组件与渲染器的结合更加紧密</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">核心原理：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">当DOM元素被挂载时，将动效附加到该DOM元素上</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">当DOM元素被卸载时，不要立即卸载DOM元素，而是等到附加到该DOM元素上的动效执行完成后再卸载它</li>
</ul>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">原生DOM的过渡</h5>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">进场过度的实现原理：</p>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">从创建DOM元素完成后，到把DOM元素添加到body前，整个过程可以视作beforeEnter阶段<br/>
在把DOM元素添加到body之后，则可以视作enter阶段</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #d7ba7d; line-height: 160%; box-sizing: content-box;">.enter-from</span> {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">transform</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">translateX</span>(200px)
}
<span style="color: #d7ba7d; line-height: 160%; box-sizing: content-box;">.enter-active</span> {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">transition</span>: transform <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1s</span> ease-in-out;
}
<span style="color: #d7ba7d; line-height: 160%; box-sizing: content-box;">.enter-to</span> {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">transform</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">translateX</span>(0)
}
</code></pre>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">beforeEnter阶段，添加enter-from和enter-active类</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">enter阶段，在下一帧中移除enter-from类，添加enter-to类</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">进场动效结束，移除enter-to和enter-active类</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">离场过度的实现原理：</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #d7ba7d; line-height: 160%; box-sizing: content-box;">.leave-from</span> {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">transform</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">translateX</span>(0)
}
<span style="color: #d7ba7d; line-height: 160%; box-sizing: content-box;">.leave-to</span> {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">transform</span>: <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">translateX</span>(200px)
}
<span style="color: #d7ba7d; line-height: 160%; box-sizing: content-box;">.leave-active</span> {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">transition</span>: transform <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2s</span> ease-out
}
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">当元素被卸载时，不要将其立即卸载，而是等待过渡效果结束后再卸载。<br/>
需要把用于卸载DOM元素的代码封装到一个函数中，该函数会等待过渡效果结束后被调用</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">el.addEventListener(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'click'</span>, () =&gt; {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 封装卸载函数</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> performRemove = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> el.parentNode.removeChild(el)
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 设置初始状态</span>
    el.classList.add(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-from'</span>)
    el.classList.add(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-active'</span>)
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 强制reflow：使初始状态生效</span>
    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.body.offsetHeight
    
    requestAnimationFrame(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        requestAnimationFrame(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            el.classList.remove(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-from'</span>)
            el.classList.add(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-to'</span>)
            
            el.addEventListener(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'transitionend'</span>, () =&gt; {
                el.classList.remove(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-to'</span>)
                el.classList.remove(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-active'</span>)
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 过渡完后，调用移除函数</span>
                performRemove()
            })
        })
    })
})
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">实现Transition组件</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// Transition组件在虚拟DOM层面的表现形式</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;template&gt;
    &lt;Transition&gt;
        &lt;div&gt;过渡元素&lt;/div&gt;
    &lt;/Transition&gt;
&lt;/template&gt;

编译后：
function render() {
    return {
        type: Transition,
        children: {
            default() {
                return { type: 'div', children: '过渡元素' }
            }
        }
    }
}
Transition组件的子节点被编译为默认插槽，这与普通组件的行为一致
*/</span>


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 实现Transition</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 主要作用是在过渡元素的虚拟节点上添加transition相关的钩子函数</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> Transition = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Transition'</span>,
    setup(props, { slots }) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> innerVNode = slots.default();
            
            innerVNode.transition =  {
                beforeEnter(el) {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 初始状态</span>
                    el.classList.add(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'enter-from'</span>)
                    el.classList.add(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'enter-active'</span>)
                },
                enter(el) {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在下一帧切换到结束状态</span>
                    nextFrame(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                        el.classList.remove(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'enter-from'</span>)
                        el.classList.add(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'enter-to'</span>)
                        
                        el.addEventListener(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'transitionend'</span>, () =&gt; {
                            el.classList.remove(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'enter-to'</span>)
                            el.classList.remove(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'enter-active'</span>)
                        })
                    })
                },
                leave(el, performRemove) {
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 设置离场过度的初始状态</span>
                    el.classList.add(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-from'</span>)
                    el.classList.add(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-active'</span>)
                    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 强制reflow</span>
                    <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.body.offsetHeight
                    
                    nextFrame(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
                        el.classList.remove(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-from'</span>)
                        el.classList.add(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-to'</span>)
                        
                        el.addEventListener(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'transitionend'</span>, () =&gt; {
                            el.classList.remove(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-to'</span>)
                            el.classList.remove(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'leave-active'</span>)
                            performRemove()
                        })
                    })
                }
            }
            
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> innerVNode
        }
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 渲染器在渲染需要过渡的虚拟节点时，会在合适的时机调用附加到该虚拟节点上的过渡相关的生命周期钩子函数，具体体现在mountElement函数以及unmount函数中</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> el = vnode.el = createElement(vnode.type)
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.children === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        setElementText(el, vnode.children)
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(vnode.children)) {
        vnode.children.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">child</span> =&gt;</span> patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, child, el))
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode.props) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> vnode.props) {
            patchProps(el, key, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, vnode.props[key])
        }
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 判断VNode是否需要过渡</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> needTransition = vnode.transition
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (needTransition) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 调用transition.beforeEnter钩子函数</span>
        vnode.transition.beforeEnter(el)
    }
    insert(el, container, anchor)
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (needTransition) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 调用transition.enter钩子函数</span>
        vnode.transition.enter(el)
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">unmount</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 判断VNode是否需要过渡</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> needTransition = vnode.transition
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode.type === Fragment) {
        vnode.children.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span> =&gt;</span> unmount(c))
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span>) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode.shouldKeepAlive) {
            vnode.keepAliveInstance._deActivate(vnode)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            unmount(vnode.component.subTree)
        }
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
    }
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> parent = vnode.el.parentNode
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (parent) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 封装卸载函数</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> performRemove = <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> parent.removeChild(vnode.el)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (needTransition) {
            vnode.transition.leave(vnode.el, performRemove)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            performRemove()
        }
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">总结</h4>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">KeepAlive组件</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">Teleport组件</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">Transition组件</li>
</ul>
<h2 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 34px; border-bottom: 1px solid #dbdbdb; color: #333;">第五篇《编译器》</h2>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第15章《编译器核心技术概览》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">模版DSL的编译器</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">编译器其实只是一段程序，用来将“一种语言A”翻译成“另外一种语言B”<br/>
语言A通常叫做<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">源代码</strong>，语言B通常叫做<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">目标代码</strong><br/>
编译器将源代码翻译为目标代码的过程叫做<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">编译</strong><br/>
完整的编译过程通常包含词法分析、语法分析、语义分析、中间代码生成、优化、目标代码生成等步骤</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">整个编译过程分为编译前端和编译后端，编译前端包含词法分析、语法分析和语义分析，它通常与目标平台无关，仅负责分析源代码。编译后端则通常与目标平台有关，编译后端涉及中间代码生成和优化以及目标代码生成。但是编译后端并不一定会包含中间代码生成和优化，这取决于具体的场景和实现</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">Vue的模版作为DSL(领域特定语言)，其编译流程会有所不同。对于Vue来说，源代码就是组件的模版，而目标代码是能够在浏览器平台上运行的JavaScript代码，或其他拥有JavaScript运行时的平台代码。</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">Vue模版编译器的目标代码其实就是渲染函数：<br/>
Vue模版编译器会首先对模版进行词法分析和语法分析，得到模版AST。接着将模版AST转换成JavaScript AST。最后根据JavaScript AST生成JavaScript代码，即渲染函数代码</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;div&gt;
    &lt;h1 v-if="ok"&gt;Vue Template&lt;/h1&gt;
&lt;/div&gt;
*/</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 会被编译为如下AST</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> ast = {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 逻辑根节点</span>
    type: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Root'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// div标签节点</span>
        {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Element'</span>,
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// h1标签节点</span>
                {
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Element'</span>,
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'h1'</span>,
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: [
                        {
                            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Directive'</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 类型为Directive表示指令</span>
                            name: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'if'</span>,
                            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">exp</span>: {
                                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 表达式节点</span>
                                type: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Expression'</span>,
                                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">content</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ok'</span>,
                            }
                        }   
                    ]
                }
            ]
        }
    ]
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 可以看到AST其实就是一个具有层级结构的对象。模版AST具有与模版同构的嵌套结构。每一棵AST都有一个逻辑上的跟节点，其类型为Root。模版中真正的根节点则作为Root节点的children存在</span>


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 可以通过封装parse函数来完成对模版的词法分析和语法分析</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> template = <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`
    &lt;div&gt;
        &lt;h1 v-if="ok"&gt;Vue Template&lt;/h1&gt;
    &lt;/div&gt;
`</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> templateAST = parse(template)

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 可以通过封装transform函数来完成模版AST到JavaScript AST的转换工作</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> jsAST = transform(templateAST)

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 可以通过封装generate函数来完成JavaScript AST到JavaScript代码的转换</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> code = generate(jsAST) <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 返回字符串形式的代码</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">parser的实现原理与状态机</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">有限状态自动机：有限状态是指有限个状态，而自动机意味着随着字符的输入，解析器会自动地在不同状态间迁移</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 定义状态机的状态</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> State = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">initial</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 初始状态</span>
    tagOpen: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 标签开始状态</span>
    tagName: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">3</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 标签名称状态</span>
    text: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">4</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 文本状态</span>
    tagEnd: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">5</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 结束标签状态</span>
    tagEndName: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">6</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 结束标签名称状态</span>
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">总而言之，通过有限自动机，能够将模版解析为一个个Token，进而可以用他们构建一棵AST。</p>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">构造AST</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">GPL通用用途语言(js,c,...)<br/>
DSL特定领域语言(vue template ...)</p>
</blockquote>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">首先使用之前的tokenize函数将模版进行标记化</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> tokens = tokenize(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`&lt;div&gt;&lt;p&gt;Vue&lt;/p&gt;&lt;p&gt;Template&lt;/p&gt;&lt;/div&gt;`</span>)

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
tokens = [
    { type: 'tag', name: 'div' },
    { type: 'tag', name: 'p' },
    { type: 'text', content: 'Vue' },
    { type: 'tagEnd', name: 'p' },
    { type: 'tag', name: 'p' },
    { type: 'text', content: 'Template' },
    { type: 'tagEnd', name: 'p' },
    { type: 'tagEnd', name: 'div' },
]
*/</span>


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 扫描token列表并构建AST</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">parse</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">str</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 首先对模版标记化，得到tokens</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> tokens = tokenize(str)
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 创建Root根节点</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> root = {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Root'</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [],
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 创建elementStack栈，起初只有Root根节点</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> elementStack = [root]
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 开启while循环扫描tokens</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span>(tokens.length) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 获取当前栈顶节点作为父节点</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> parent = elementStack[elementStack.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>]
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当前扫描的token</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> t = tokens[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>]
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">switch</span>(t.type) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">case</span> <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'tag'</span>:
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果当前Token是开始标签，则创建Element类型的AST节点</span>
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> elementNode = {
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Element'</span>,
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: t.name,
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [],
                }
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将其添加到父级节点的children中</span>
                parent.children.push(elementNode)
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将当前节点压入栈</span>
                elementStack.push(elementNode)
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">break</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">case</span> <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'text'</span>:
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> textNode = {
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Text'</span>,
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">content</span>: t.content,
                }
                parent.children.push(textNode)
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">break</span>
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">case</span> <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'tagEnd'</span>:
                elementStack.pop()
                <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">break</span>
              
        }
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 消费已经扫描过的token</span>
        tokens.shift()
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 返回AST</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> root
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 问题：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 还不能处理自闭和标签等</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">AST的转换与插件化架构</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">AST的转换，指的是对AST进行一系列操作，将其转换为新的AST的过程<br/>
新的AST可以是原语言或原DSL的描述，也可以是其他语言或其他DSL的描述</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">由于AST是树型数据结构，所以需要编写一个深度优先遍历的算法</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">traverseNode</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">ast, context</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当前节点，ast本身就是Root节点</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> currentNode = ast
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> transform = context.nodeTransforms
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; transform.length; i++) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将当前节点currentNode和context都传递给nodeTransforms中注册的回调函数</span>
        transform[i](currentNode, context)
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果有子节点，则递归地调用traverseNode</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> children = currentNode.children
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (children) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; children.length; i++) {
            traverseNode(children[i])
        }
    }
}


<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">transformElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> context = {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">nodeTransforms</span>: [
            transformElement,
            transformText,
        ]
    }
    
    traverseNode(ast, context)
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">transformElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
}
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">transformText</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">将模版AST转为JavaScript AST</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">&lt;div&gt;<span style="line-height: 160%; box-sizing: content-box;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>Vue<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span></span><span style="line-height: 160%; box-sizing: content-box;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>Template&gt;<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span></span><span style="line-height: 160%; box-sizing: content-box;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span></span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 目标</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> h(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, [
        h(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Vue'</span>),
        h(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Tempalte'</span>),
    ])
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 设计数据结构来描述函数声明语句</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> FunctionDeclNode = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'FunctionDecl'</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 代表函数声明</span>
    id: {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Identifier'</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'render'</span>,
    },
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">params</span>: [], <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 参数</span>
    body: [
        {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ReturnStatement'</span>,
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">return</span>: <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
        }
    ]
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 渲染函数的返回值</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> CallExp = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'CallExpression'</span>,
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 被调用函数的名称</span>
    callee: {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Identifier'</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'h'</span>,
    },
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">arguments</span>: [],
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 字符串字面量</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> Str = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'StringLiteral'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 数组</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> Arr = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ArrayExpression'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">elements</span>: [],
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 最终JavaScript AST</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> FunctionDeclNode = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'FunctionDecl'</span>, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 代表函数声明</span>
    id: {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Identifier'</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'render'</span>,
    },
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">params</span>: [], <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 参数</span>
    body: [
        {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ReturnStatement'</span>,
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">return</span>: {
                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'CallExpression'</span>,
                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">callee</span>: { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Identifier'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'h'</span> },
                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">arguments</span>: [
                    {
                        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'StringLiteral'</span>,
                        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
                    },
                    {
                        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ArrayExpression'</span>,
                        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">elements</span>: [
                            {
                                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'CallExpression'</span>,
                                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">callee</span>: { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Identifier'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'h'</span> },
                                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">arguments</span>: [
                                    {<span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'StringLiteral'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span> },
                                    {<span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'StringLiteral'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Vue'</span> }
                                ]
                            },
                            {
                                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'CallExpression'</span>,
                                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">callee</span>: { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Identifier'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'h'</span> },
                                <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">arguments</span>: [
                                    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'StringLiteral'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span> },
                                    { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'StringLiteral'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">value</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Template'</span> }
                                ]
                            }
                        ]
                    }
                ]
            }
        }
    ]
}


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 辅助函数</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用来创建StringLiteral节点</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createStringLiteral</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">value</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'StringLiteral'</span>,
        value
    }
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用来创建Identifier节点</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createIdentifier</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">name</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Identifier'</span>,
        name
    }
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用来创建ArrayExpression节点</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createArrayExpression</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">elements</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ArrayExpression'</span>,
        elements
    }
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用来创建CallExpression节点</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createCallExpression</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">callee, arguments</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'CallExpression'</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">callee</span>: createIdentifier(callee),
        <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">arguments</span>
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 转换函数</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 转换文本节点</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">transformText</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果不是文本节点，直接return</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (node.type !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Text'</span>) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 文本节点对应的JavaScript AST节点其实就是一个字符串字面量，</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 因此只需要使用node.content创建一个StringLiteral类型的节点即可</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 最后将文本节点对应的JavaScript AST节点添加到node.jsNode属性下</span>
    node.jsNode = createStringLiteral(node.content)
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 转换标签节点</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">transformElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将转换代码编写在退出阶段的回调函数中，</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这样可以保证该标签节点的子节点全部被处理完毕</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果被转换的节点不是元素节点，直接return</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (node.type !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Element'</span>) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
        }
        
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.创建h函数调用语句</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// h函数调用的第一个参数是标签名称，因此以node.tag来创建一个字符串字面量节点作为第一个参数</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> callExp = createCallExpression(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'h'</span>, [
            createStringLiteral(node.tag)
        ])
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.处理h函数调用的参数</span>
        node.children.length === <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果当前标签节点只有一个子节点，则直接使用子节点的jsNode作为参数</span>
            ? callExp.arguments.push(node.children[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>].jsNode) 
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果当前标签节点有多个子节点，则创建一个ArrayExpression节点作为参数</span>
            : callExp.arguments.push(createArrayExpression(node.children.map(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">c</span>) =&gt;</span> c.jsNode)
            
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 3.将当前标签节点对应的JavaScript AST添加到JsNode属性下</span>
        node.jsNode = callExp
    }
}


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 补全JavaScript AST</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 转换Root根节点</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">transformRoot</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果不是根节点，直接return</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (node.type !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Root'</span>) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span>
        }
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// node是根节点，根节点的第一个子节点就是模版的根节点</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里先不考虑模版存在多个根节点的情况</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> vnodeJSAST = node.children[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>].jsNode
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 创建render函数的声明语句节点，将vnodeJSAST作为render函数体的返回语句</span>
        node.jsNode = {
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'FunctionDecl'</span>,
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">id</span>: { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Identifier'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">name</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'render'</span> },
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">params</span>: [],
            <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">body</span>: [
                {
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ReturnStatement'</span>,
                    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">return</span>: vnodeJSAST
                }
            ]
        }
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">代码生成</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">根据JavaScript AST生成渲染函数的代码<br/>
本质上是字符串拼接的艺术</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">generate</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> context = {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 存储最终生成的渲染函数代码</span>
        code： <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span>,
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/// 在生成代码时，通过调用push完成代码的拼接</span>
        push(code) {
            context.code += code;
        }
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 完成代码生成功能</span>
    genNode(node, context)
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> context.code
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果需要考虑生成代码的格数，就要考虑缩进、换行...</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这就需要扩展context对象</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">generate</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> context = {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 存储最终生成的渲染函数代码</span>
        code： <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">''</span>,
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/// 在生成代码时，通过调用push完成代码的拼接</span>
        push(code) {
            context.code += code;
        },
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 缩进级别，0代表没有缩进</span>
        currentIndent: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>,
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 换行后，同样要保持缩进的空格数量</span>
        newline() {
            context.code += <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'\n'</span> + <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`  `</span>.repeat(context.currentIndent)
        },
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 用来缩进，即让currentIndent自增后，调用换行函数</span>
        indent() {
            context.currentIndent++;
            context.newline()
        },
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 取消缩进</span>
        deIndent() {
            context.currentIndent--;
            context.newline()
        }
        
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 完成代码生成功能</span>
    genNode(node, context)
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> context.code
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 生成代码函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">generate</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node, context</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">switch</span>(node.type) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">case</span> <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'FunctionDecl'</span>:
            genFunctionDecl(node, context)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">break</span>;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">case</span> <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ReturnStatement'</span>:
            genReturnStatement(node, context)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">break</span>;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">case</span> <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'CallExpression'</span>:
            genCallExpression(node, context)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">break</span>;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">case</span> <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'StringLiteral'</span>:
            genStringLiteral(node, context)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">break</span>;
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">case</span> <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'ArrayExpression'</span>:
            genArrayExpression(node, context)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">break</span>;
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">genNode</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">nodes, context</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { push } = context
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; nodes.length; i++) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> node = nodes[i]
        genNode(node, context)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (i &lt; nodes.length - <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>) {
            push(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">', '</span>)
        }
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">genFunctionDecl</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node, context</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { push, indent, deIndent } = context
    
    push(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`fucntion <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">${node.id.name}</span>`</span>)
    push(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`(`</span>)
    genNodeList(node.params, context)
    push(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`)`</span>)
    push(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`{`</span>)
    indent()
    node.body.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n</span> =&gt;</span> genNode(n, context))
    deIndent()
    push(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`}`</span>)
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">genArrayExpression</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node, context</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 。。。。</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 最终得到的代码如下</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> h(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, [h(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Vue'</span>), h(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'Template'</span>)])
}
</code></pre>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第16章《解析器》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">文本模式及其对解析器的影响</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">文本模式指的是<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">解析器</strong>在工作时所进入的一些特殊状态，在不同的特殊状态下，解析器对文本的解析行为会有所不同。<br/>
具体来说，当解析器遇到一些特殊标签，会切换模式，从而影响对文本的解析行为<br/>
这些特殊标签是</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">&lt;title&gt;、&lt;textarea&gt;，会切换到RCDATA模式</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">&lt;style&gt;、&lt;xmp&gt;、&lt;iframe&gt;、&lt;noembed&gt;、&lt;noframes&gt;、&lt;noscript&gt;标签，会切换到RAWTEXT模式</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">当遇到&lt;![CDATA[字符串时，会进入CDATA模式</li>
</ul>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">递归下降算法构造模版AST</h4>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">状态机的开启与停止</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">当解析器遇到开始标签时，会将该标签压入父级节点栈，同时开启新的状态机。当解析器遇到结束标签，并且父级节点栈中存在与该标签同名的开始标签节点时，会停止当前正在运行的状态机</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">解析标签节点</h4>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">解析属性</h4>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">解析文本与解码HTML实体</h4>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第17章《编译优化》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">动态节点收集与补丁标志</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">之前的Diff算法无论是哪一种，当它在对比新旧两棵虚拟DOM树的时候，总是要按照虚拟DOM的层级结构一层一层的遍历</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">id</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"foo"</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">class</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"bar"</span>&gt;</span>{{ text }}<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">在上面这段模版中，唯一可能变化的就是p标签的文本子节点的内容。也就是说，当响应式数据text的值发生变化时，最高效的更新方式就是直接设置p标签的文本内容。但是传统Diff算法会对比新旧DOM树：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">对比div节点，以及该节点的属性和子节点</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">对比p节点，以及该节点的属性和子节点</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">对比p节点的文本子节点，如果文本子节点的内容变了，则更新</li>
</ul>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">可以看到如果能跳过这些无意义的操作，性能将会大幅提升，而这就是Vue3编译优化的思路来源</p>
</blockquote>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">实际上，模版的结构非常稳定。通过编译手段，可以分析出很多关键信息，例如哪些是动态节点，哪些是静态节点。结合这些信息，编译器可以直接生成原生DOM操作的代码，这样甚至能够抛掉虚拟DOM，从而避免虚拟DOM带来的性能开销。但是，考虑到渲染函数的灵活性，以及Vue2的兼容问题，Vue3最终还是选择了保留虚拟DOM。这样依赖，就必然要面临它所带来的额外性能开销</p>
</blockquote>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">为什么虚拟DOM会产生额外的性能开销？根本原因在于，渲染器在运行时得不到足够的信息。传统Diff算法无法利用编译时提取到任何的关键信息，这导致渲染器在运行时不可能去做相关的优化。而Vue3的编译器会将编译时得到的关键信息附着在它生成的虚拟DOM上，这些信息会通过虚拟DOM传递给渲染器。最终，渲染器会根据这些关键信息执行“快捷路径”，从而提升运行时性能</p>
</blockquote>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">Block与PatchFlags</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">&lt;!-- 假如有如下模版--&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>foo<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>{{ bar }}<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">这里只有{{ bar }}是动态的内容。因此在理想情况下，当响应式数据bar的值发生变化时，只需要更新p标签的文本节点即可</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 传统的虚拟DOM</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> vnode = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span> },
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar },
    ]
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 优化后的虚拟DOM</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> vnode = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span> },
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">patchFlag</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> } <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这是动态节点</span>
    ]
}
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">用来描述p标签的虚拟节点拥有一个额外的属性，即patchFlag,它的值是一个数组。只要虚拟节点存在该属性，就认为它是一个动态节点。<br/>
patchFlag就是所谓的补丁标志<br/>
可以把它理解为一系列数字标记，并根据数字值的不同赋予它不同的含义：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">数字1:代表元素有动态的TextContent</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">数字2:代表元素有动态的class绑定</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">数字3:代表元素有动态的style绑定</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">数字4:其他...</li>
</ul>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> PatchFlags = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">TEXT</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">CLASS</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">STYLE</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">3</span>,
    ...
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">有了这项信息，就可以在虚拟节点的创建阶段，把它的动态子节点提取出来，并将其存储到该虚拟节点的dynamicChildren数组内:</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> vnode = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span> },
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">patchFlag</span>: PatchFlags.TEXT } <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这是动态节点</span>
    ],
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">patchFlag</span>: PatchFlags.TEXT }
    ]
}
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">这里多了一个额外的dynamicChildren属性，把带有该属性的虚拟节点称为“块“，即<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">Block</strong><br/>
所以一个Block本质上也是一个虚拟DOM节点，它只不过比普通的虚拟节点多出一个用来存储动态子节点的dynamicChildren属性<br/>
一个Block不仅能够收集它的直接动态子节点，还能够收集所有动态子代节点</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
        <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>{{ bar }}<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">Block如下：</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> vnode = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
        tag: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
            { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">patchFlag</span>: PatchFlags.TEXT }
        ]
    ],
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// Block可以收集所有动态子代节点</span>
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">patchFlag</span>: PatchFlags.TEXT }
    ]
}
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">有了Block的概念后，渲染器的更新操作将会以Block为维度。也就是说，当渲染器在更新一个Block时，会忽略虚拟节点的Children数组，而是直接找到该虚拟节点的dynamicChildren数组，并只更新该数组中的动态节点。这样在更新的时候就实现了跳过静态内容，只更新动态内容<br/>
同时，由于动态节点中存在对应的补丁标志，所以在更新动态节点的时候，也能够做到靶向更新</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">什么情况下需要将一个普通的虚拟节点变成Block节点呢</strong></p>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">实际上，在编写模版代码的时候，所有模版的根节点都会是一个Block节点</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">tempalte</span>&gt;</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">&lt;!-- 这个div标签是一个Block --&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
        <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>{{ bar }}<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">p</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">div</span>&gt;</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">&lt;!-- 这个h1标签是一个Block --&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">h1</span>&gt;</span>
        <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">span</span> <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">:id</span>=<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">"dynamicId"</span>&gt;</span><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">span</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">h1</span>&gt;</span>
</code></pre>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">实际上，除了模版中的根节点要作为BLock角色外。任何带有v-for、v-if/v-else-if/v-else等指令的节点都需要作为Block节点</p>
</blockquote>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">收集动态节点</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在编译器生成的渲染函数代码中，并不会直接包含用来描述虚拟节点的数据结构，而是包含着用来创建虚拟DOM节点的辅助函数</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">render() {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">id</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span> }, [
        createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'text'</span>)
    ])
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 其中createVNode是用来创建虚拟DOM节点的辅助函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createVNode</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">tag, props, children</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key = props &amp;&amp; props.key
    props &amp;&amp; <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">delete</span> props.key
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        tag,
        props,
        children,
        key,
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;div &gt;
    &lt;p &gt;{{ text }} &lt;/p&gt;
&lt;/div&gt;
*/</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在编译优化后，会生成带有补丁标志的渲染函数</span>
render() {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">id</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span> }, [
        createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">class</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'bar'</span> }, text, PatchFlags.TEXT)
    ])       
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这里PatchFlags.TEXT代表当前虚拟DOM节点是一个动态节点，并且动态因素是具有动态的文本子节点。这样就实现了对动态节点的标记</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 接下里要考虑如何将根节点变成一个Block，以及如何将动态子代节点收集到该Block的dynamicChildren数组中。这里有一个事实，即在渲染函数内，对createVNode函数的调用是层层嵌套结构，并且函数的执行顺序是“内层先执行，外层后执行”</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当外层createVNode函数执行时，内层的createVNode已经执行完毕了。因此，为了让外层Block节点能够收集到内层动态节点，就需要一个栈结构的数据来临时存储内层的动态节点</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 动态节点栈</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> dynamicChildrenStack = []
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当前动态节点集合</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> currentDynamicChildren = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// openBlock用来创建一个新的动态节点集合，并将该集合压入栈中</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">openBlock</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    dynamicChildrenStack.push((currentDynamicChildren = []))
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// closeBlock用来将通过openBlock创建的动态节点集合从栈中弹出</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">openBlock</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    currentDynamicChildren = dynamicChildrenStack.pop()
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 为此还需要调整createVNode函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createVNode</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">tag, props, children, flags</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key = props &amp;&amp; props.key
    props &amp;&amp; <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">delete</span> props.key
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> vnode = {
        tag,
        props,
        children,
        key,
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">patchFlags</span>: flags
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> flags !== <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'undefined'</span> &amp;&amp; currentDynamicChildren) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 动态节点，将其添加到当前动态节点集合</span>
        currentDynamicChildren.push(vnode)
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 最后重新设计渲染函数的执行方式</span>
render() {
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.使用createBlock代替createVNode来创建Block</span>
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.每当调用createBLock之前，先调用openBlock</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> (openBoock(), createBlock(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, [
        createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">class</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span> }, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* patch flag*/</span>),
        createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">class</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'bar'</span> }, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>),
    ]))
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createBlock</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">tag, props, children</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// block本质上也是一个vnode</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> block = createVNode(tag, props, children)
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将当前动态节点集合作为block.dynamicChildren</span>
    block.dynamicChildren = currentDynamicChildren
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 关闭Block</span>
    closeBlock()
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 返回</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> block
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">渲染器的运行时支持</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 传统节点的更新方式</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> el = n2.el = n1.el
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldProps = n1.props
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newProps = n2.props
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> newProps) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (newProps[key] !== oldProps[key]) {
            patchProps(el, key, oldProps[key], newProps[key])
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> oldProps) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!(key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> newProps)) {
             patchProps(el, key, oldProps[key], <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)
        }
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 处理children时，调用patchCHildren函数</span>
    patchChildren(n1, n2, el)
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 有了dynamicChildren后，可以直接对比动态节点</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> el = n2.el = n1.el
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldProps = n1.props
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newProps = n2.props
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> newProps) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (newProps[key] !== oldProps[key]) {
            patchProps(el, key, oldProps[key], newProps[key])
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> oldProps) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!(key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> newProps)) {
             patchProps(el, key, oldProps[key], <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n2.dynamicChildren) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 调用patchBlockChildren函数，这样只会更新动态节点</span>
        patchBlockChildren(n1, n2)
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        patchChildren(n1, n2, el)
    }
    
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchBlockChildren</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2</span>) </span>{
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 只更新动态节点</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; n2.dynamicChildren.length; i++) {
            patchElement(n1.dynamicChildren[i], n2.dynamicChildren[i])
        }
    }
}


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 对于单个动态节点的更新可以针对性地完成靶向更新</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> el = n2.el = n1.el
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> oldProps = n1.props
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> newProps = n2.props
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n2.patchFlags) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 靶向更新</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n2.patchFlags === <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n2.patchFlags === <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (...) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
        }
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 全量更新</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> newProps) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (newProps[key] !== oldProps[key]) {
                patchProps(el, key, oldProps[key], newProps[key])
            }
        }
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> oldProps) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!(key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> newProps)) {
                 patchProps(el, key, oldProps[key], <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)
            }
        }
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (n2.dynamicChildren) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 调用patchBlockChildren函数，这样只会更新动态节点</span>
        patchBlockChildren(n1, n2)
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        patchChildren(n1, n2, el)
    }
    
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">patchBlockChildren</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">n1, n2</span>) </span>{
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 只更新动态节点</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; n2.dynamicChildren.length; i++) {
            patchElement(n1.dynamicChildren[i], n2.dynamicChildren[i])
        }
    }
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">Block树</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">之前约定组件模版的根节点必须作为Block角色。这样，从根节点开始，所有动态子代节点都会被收集到根节点的dynamicChildren数组中。但是如果只有根节点是Block角色，是不会形成BLock树的。<br/>
既然是Block树，就意味着还会有其他特殊节点充当Block角色<br/>
实际上，带有结构化指令的节点，如v-if和v-for指令的节点都应该作为Block角色</p>
</blockquote>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">带有v-if指令的节点</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;div&gt;
    &lt;section v-if="foo"&gt;
        &lt;p&gt;{{ a }} &lt;/p&gt;
    &lt;/section&gt;
    &lt;div v-else&gt;
        &lt;p&gt;{{ a }}&lt;/p&gt;
    &lt;/div&gt;
&lt;/div&gt;
*/</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 上面当变量foo是true时，收集到的动态节点是</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> block = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.a, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">patchFlags</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> }
    ]
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 上面当变量foo是false时，收集到的动态节点是</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> block = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.a, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">patchFlags</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> }
    ]
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 可以发现，无论变量foo是true还是false，block所收集的动态节点是不变的。这意味着，在Diff阶段不会做任何更新</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但是带有v-if指令的是Section，带有v-else的是div。很明显，更新前后的标签不同，如果不做任何更新将产生严重的bug</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 产生这些问题的原因在于，dynamicChildren数组中收集的动态节点是忽略虚拟DOM树层级的，因此必须要让带有v-if/v-else-if/v-else等结构化指令的节点也作为Block角色</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
Block(Div)
    - Block(Section v-if)
    - BLock(Div v-else)
*/</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 父级Block除了会收集动态子代节点外，也会收集子Block，两个子Block将作为父级Block的动态节点被收集到父级的dynamicChildren数组中</span>

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> block = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'section'</span>, { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">key</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* key值会根据不同的Block而发生变化 */</span> }, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [...]}
    ]
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在Diff过程中，渲染器能够根据Block的key值区分出更新前后的两个Block是不同的，并使用新的Block替换旧的Block</span>
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">带有v-for指令的节点</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;div&gt;
    &lt;p v-for="item in list"&gt;{{ item }}&lt;/p&gt;
    &lt;i&gt;{{ foo }}&lt;/i&gt;
    &lt;i&gt;{{ bar }}&lt;/i&gt;
&lt;/div&gt;
*/</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// list是一个数组，list数组由[1,2]更新为[1]</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新前</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> prevBlock = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span>, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.foo, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
    ]
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新后</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> nextBlock = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.foo, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
    ]
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新前4个动态节点，更新后3个动态节点。因为dynamicChildren内的节点未必是同级的，所以不能进行Diff操作</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使v-for也是一个Block</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 由于v-for指令渲染的是一个片段，因此需要使用类型为Fragment的节点</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> block = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: Fragment, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* v-for的节点 */</span>] },
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.foo, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
    ]
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">Fragment的稳定性</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新前</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> prevBlock = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: Fragment, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
            { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: item, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*TEXT*/</span> },
            { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: item, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">2</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*TEXT*/</span> }
        ]},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.foo, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
    ]
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 更新后</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> nextBlock = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: Fragment, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [
            { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: item, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*TEXT*/</span> }
        ]},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.foo, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'i'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: ctx.bar, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>},
    ]
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 可以发现，Fragment本身收集的动态节点仍然面临结构不稳定的情况。</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 所谓结构不稳定，从结果上看，指的是更新前后一个block的dynamicChildren数组中收集的节点数量或顺序不一致</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这种不一致会导致无法进行靶向更新</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 但是针对这种情况，没有更好的解决办法。只能回退到传统虚拟DOM的Diff手段，即直接使用Fragment的children而非dynamicChildren来进行Diff操作</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 需要注意的是，Fragment的子节点(children)仍然可以是由Block组成的数组</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> block = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: Fragment,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: item, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*...*/</span>], <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span> },
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">tag</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: item, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">dynamicChildren</span>: [<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*...*/</span>], <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span> },
    ]
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这样，当Fragment的子节点进行更新时，就可以恢复优化模式</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">静态提升</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">静态提升能够减少更新时创建虚拟DOM带来的性能开销和内存占用</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;div&gt;
    &lt;p&gt;static text&lt;/p&gt;
    &lt;p&gt;{{ title }}&lt;/p&gt;
&lt;/div&gt;
*/</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在没有静态提升的情况下，对应的渲染函数：</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> (openBlock(), createBlock(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, [
        createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'static text'</span>),
        createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, ctx.title, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>),
    ]))
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 当响应式数据title发生变化时，整个渲染函数会重新执行，并产生新的虚拟DOM。这个过程会有一个明显的问题，即纯静态的虚拟节点在更新时也会被重新创建一次，这是没有必要的</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 因此解决方案就是静态提升，即把纯静态的节点提升到渲染函数之外</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> hoist1 = createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'text'</span>)

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"/>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> (openBlock(), createBlock(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, [
        hoist1, <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 静态节点引用</span>
        createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, ctx.title, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>),
    ]))
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 需要注意的是，静态提升是以树为单位的。</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;div&gt;
    &lt;section&gt;
        &lt;p&gt;
            &lt;span&gt;abc&lt;/span&gt;
        &lt;/p&gt;
    &lt;/section&gt;
&lt;/div&gt;
这里除了根节点会作为BLock角色而不可被提升外，整个&lt;section&gt;元素及其子代节点都会被提升
*/</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 虽然包含动态绑定的节点本身不会被提升，但是该动态节点上仍然可能存在纯静态的属性</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;div&gt;
    &lt;p foo="bar" a=b&gt;{{ text }}&lt;/p&gt;
&lt;/div&gt;
*/</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 可以将纯静态的props提升到渲染函数之外</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> hoistProp = { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">foo</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'bar'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">a</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'b'</span> }

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">ctx</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> (openBlock(), createBlock(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, [
        createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, hoistProp, ctx.text)
    ]))
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这样做同样可以减少创建虚拟DOM产生的开销以及内存占用</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">预字符串化</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">基于静态提升，还可以进一步采用预字符串化的优化手段<br/>
预字符串化是基于静态提升的一种优化策略</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;div&gt;
    &lt;p&gt;&lt;/p&gt;    
    &lt;p&gt;&lt;/p&gt;    
    &lt;p&gt;&lt;/p&gt;    
    ...
&lt;/div
*/</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 上面模版包含大量静态节点，当采用静态提升优化时，编译后的代码如下</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> hoist1 = createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, PatchFlags.HOISTED)
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> hoist2 = createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, PatchFlags.HOISTED)
...

render() {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> (openBlock(), createBlock(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, [
        hoist1, hoist2, ...
    ]))
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 预字符串化能够将这些静态节点序列化为字符串，并生成一个Static类型的VNode</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> hoistStatic = createStatickVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;.....&lt;p&gt;&lt;/p&gt;'</span>)
render() {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> (openBlock(), createBlock(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, [
        hoistStatic
    ]))
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 这么做的优势有：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.大块的静态内容可以通过innerHTML进行设置，在性能上有一定优势</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.减少创建虚拟节点产生的性能开销</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 3.较少内存占用</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">缓存内联事件处理函数</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">缓存内联事件处理函数可以避免不必要的更新</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;Comp @change="a+b"/&gt;
*/</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 上面编译后</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">ctx</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> h(Comp, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">onChange</span>: <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> (ctx.a + ctx.b)
    })
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 很显然，每次重新渲染，都会为Comp组件创建一个全新的props对象。同时，props中的onChange也会是全新的函数。这会导致渲染器对Comp组件进行更新，造成额外的性能开销</span>

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">ctx, cache</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> h(Comp, {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 将内联事件处理函数缓存到cache数组中</span>
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// cache数组来自组件实例</span>
        onChange: cache[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>] || <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">cache[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>] = ($event</span>) =&gt;</span> (ctx.a + ctx.b))
    })
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">v-once</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">Vue3不仅会缓存内联事件处理函数，配合v-once还可实现对虚拟DOM的缓存。</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/*
&lt;section&gt;
    &lt;div v-once&gt;{{ foo }}&lt;/div&gt;
&lt;/section&gt;
*/</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 编译后</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">ctx, cache</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> (openBlock(), createBlock(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, [
        cache[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>] || (cache[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>] = createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, ctx.foo, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>))
    ]))
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 因此渲染函数重新执行时，会优先读取缓存，也不需要参与Diff操作了</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 实际编译后</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">render</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">ctx, cache</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> (openBlock(), createBlock(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, [
        cache[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>] || (
        setBlockTracking(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">-1</span>) <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 阻止这段VNode被Block收集</span>
        (cache[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>] = createVNode(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, ctx.foo, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span> <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/* TEXT */</span>)),
        setBlockTracking(<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>), <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 恢复</span>
        cache[<span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>] <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 整个表达式的值</span>
    ])))
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// setBlockTracking(-1)用来暂停动态节点的收集。即使用V-once包裹的动态节点不会被父级Block收集</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// v-once通常用于不会发生改变的动态绑定中，例如绑定一个常量，为了提升性能，可以使用v-once来标记这段内容</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// v-once从两个方面提升性能：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.避免组件更新时重新创建虚拟DOM带来的性能开销(cache)</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.避免无用的Diff开销(v-once)</span>
</code></pre>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">第六篇《服务端渲染》</h3>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">第18章《同构渲染》</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">Vue可以在Nodejs环境中运行，它可以将同样的组件渲染为字符串并发送给浏览器。<br/>
Vue不仅能够独立地进行CSR或SSR，还能够将两者结合，形成所谓的<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">同构渲染</strong></p>
</blockquote>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">CSR、SSR以及同构渲染</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在Web2.0之前，网站主要负责提供各种内容，包括博客、新闻、小说等。这些站点主要强调内容本身，而不强调与用户的交互。当时的站点基本采用传统的服务端渲染技术来实现</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">服务端渲染的工作流程：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">用户通过浏览器请求站点</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">服务器请求API获取数据</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">接口返回数据给服务端</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">服务器根据模版和获取的数据拼接出最终的HTML字符串</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">服务器将HTML字符串发送给浏览器，浏览器解析HTML内容并渲染</li>
</ul>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">后来AJAX为代表，催生了Web2.0。大量的SPA诞生，也就是CSR，与SSR不同，CSR时在浏览器中完成模版与数据的融合，并渲染出最终的HTML页面</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">CSR的工作流程：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">客户端向服务器或CDN发送请求，获取静态的HTML页面。通常此时的HTML是空页面，此时页面处于白屏阶段</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">虽然HTML页面是空的，但是浏览器会解析HTML内容。因为页面的渲染任务是由JavaScript来完成的，所以当JavaScript被解释和执行后才会渲染出页面内容，即白屏结束</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">客户端再通过AJAX技术请求API获取数据，一旦接口返回数据，客户端就会完成动态内容的渲染，并呈现完整的页面</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">SSR与CSR的比较：</p>
<table style="margin: 2px 0 14px; color: #333; width: auto; border-collapse: collapse; box-sizing: border-box;"><thead style="line-height: 160%; box-sizing: content-box;"><tr style="line-height: 160%; box-sizing: content-box;"><th style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;"/><th style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;">SSR</th><th style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;">CSR</th></tr></thead><tbody style="line-height: 160%; box-sizing: content-box;"><tr style="line-height: 160%; box-sizing: content-box;"><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">SEO</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">友好</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">不友好</td></tr><tr style="line-height: 160%; box-sizing: content-box;"><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">白屏问题</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">无</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">有</td></tr><tr style="line-height: 160%; box-sizing: content-box;"><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">占用服务端资源</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">多</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">少</td></tr><tr style="line-height: 160%; box-sizing: content-box;"><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">用户体验</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">差</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">好</td></tr></tbody></table>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">同构渲染：</strong></p>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">同构渲染分为首次渲染(即首次访问页面或刷新页面)以及非首次渲染<br/>
实际上，同构渲染中的首次渲染与SSR的工作原理一致。也就是说，当首次访问或者刷新页面时，整个页面的内容是在服务端完成渲染的。同构渲染所产生的HTML与SSR所产生的HTML页面有一点最大的不同，即同构渲染产生的HTML会包含当前页面所需要的初始化数据，就是服务器通过API请求的数据会被序列化为字符串，并拼接到静态的HTML字符串中<br/>
当浏览器接受到初次渲染的静态HMTL页面后，会解析并渲染该页面，会发现HTML代码中的&lt;link&gt;和&lt;script&gt;，获取相应的资源并激活，这里的激活就是"hydration"<br/>
激活包含两部分工作内容：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">Vue在当前页面已经渲染的DOM元素以及Vue组件所渲染的虚拟DOM之间建立联系</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">Vue从HTML中提取由服务端序列化后发送过来的数据，用以初始化整个Vuejs程序</li>
</ul>
</blockquote>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">激活完成后，整个应用程序已经完全被Vue接管为CSR应用程序了。当然，如果刷新页面，仍然会进行服务端渲染，然后再进行激活，如此往复</p>
</blockquote>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">对比：</p>
<table style="margin: 2px 0 14px; color: #333; width: auto; border-collapse: collapse; box-sizing: border-box;"><thead style="line-height: 160%; box-sizing: content-box;"><tr style="line-height: 160%; box-sizing: content-box;"><th style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;"/><th style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;">SSR</th><th style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;">CSR</th><th style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #72777b; border-top: 0; background-color: #7b8184; font-weight: 300; color: #fff; padding-top: 6px;">同构渲染</th></tr></thead><tbody style="line-height: 160%; box-sizing: content-box;"><tr style="line-height: 160%; box-sizing: content-box;"><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">SEO</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">友好</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">不友好</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">友好</td></tr><tr style="line-height: 160%; box-sizing: content-box;"><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">白屏问题</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">无</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">有</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">无</td></tr><tr style="line-height: 160%; box-sizing: content-box;"><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">占用服务端资源</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">多</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">少</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">中</td></tr><tr style="line-height: 160%; box-sizing: content-box;"><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">用户体验</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">差</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">好</td><td style="line-height: 160%; box-sizing: content-box;  padding: 5px 14px 5px 12px; border: 1px solid #eaeaea;">好</td></tr></tbody></table>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;"><code style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; color: #c1788b; padding: 4px 4px 2px 0; letter-spacing: -.3px;">同构渲染无法提升可交互时间(TTI)</code></strong></p>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">同构的含义是，同样一套代码既可以在服务端运行，也可以在客户端运行</p>
</blockquote>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">将虚拟DOM渲染为HTML字符串</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> ElementVNode = {
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'div'</span>,
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">props</span>: {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">id</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'foo'</span>
    },
    <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: [
        { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'p'</span>, <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">children</span>: <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'hello'</span> }
    ]
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 为了将其渲染为字符串，需要实现renderElementVNode</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">renderElementVNode</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 取出标签名称tag和标签属性props，以及标签子节点</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: tag, props, children } = vnode
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 开始标签的头部</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> ret = <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`&lt;<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">${tag}</span>`</span>
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (props) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> k <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> props) {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 以key="value"的形式拼接字符串</span>
            ret += <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">` <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">${k}</span>="<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">${props[k]}</span>"`</span>
        }
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 开始标签闭合</span>
    ret += <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`&gt;`</span>
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 处理子节点</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> children === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        ret += children
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(children)) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 如果子节点的类型是数组，则递归调用renderElementVNode</span>
        children.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">child</span> =&gt;</span> ret += renderElementVNode(child))
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 结束标签</span>
    ret += <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">`&lt;/<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">${tag}</span>&gt;`</span>
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> ret
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 依然存在的问题：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.自闭和标签的处理</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.对Props处理，考虑是否合法，是否进行HTML转义</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 3.子节点的类型可能是Fragment、组件、函数式组件、文本等</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 4.标签的文本子节点也需要进行HTML转义</span>


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.自闭和标签</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 不添加结束标签，同样也没有子节点，不处理</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.props</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// key属性仅用于Diff算法，Ref属性仅用于实现template ref功能，服务端渲染时应该忽略这些属性</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 服务端渲染也无需考虑事件绑定</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">将组件渲染为HTML字符串</h4>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">const MyComponent = {
    setup() {
        return () =&gt; {
            return {
                type: 'div',
                children: 'hello'
            }
        }
    }
}
// 用来描述组件的VNode对象
const CompVNode = {
    type: MyComponent
}
</code></pre>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 渲染组件</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> html = renderComponentVNode(CompVNode)

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">renderComponentVNode</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 获取setup组件选项</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: { setup } } = vnode
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 执行setup函数得到渲染函数render</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> render = setup()
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 执行渲染函数得到subTree,即组件要渲染的内容</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render()
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 调用renderElementVNode完成渲染，并返回结果</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> renderElementVNode(subTree)
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 仍然存在问题：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.subTree本身可能是任意类型的虚拟节点，不能直接使用renderElementVNode来渲染</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.执行setup函数时，也应该提供setupContext对象。而执行渲染函数render时，也应该将其指向renderContext对象</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 1.解决第一个问题</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 封装通用函数</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">renderVNode</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> type = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> vnode.type
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> renderElementVNode(vnode)
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span> || type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'function'</span>) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> renderComponentVNode(vnode)
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode.type === TEXT) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 处理文本</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode.type === Fragment) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 处理片段</span>
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 处理其他类型</span>
    }
}
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用renderVNode</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">renderComponentVNode</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 获取setup组件选项</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> { <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">type</span>: { setup } } = vnode
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 执行setup函数得到渲染函数render</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> render = setup()
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 执行渲染函数得到subTree,即组件要渲染的内容</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render()
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 调用renderElementVNode完成渲染，并返回结果</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> renderVNode(subTree)
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 2.解决setup</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 在进行服务端渲染时，组件的初始化流程与客户端渲染时组件的初始化流程基本一致，但有两个重要的区别：</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// - 服务端渲染的是应用的当前快照，它不存在数据变更后重新渲染的情况。因此所有数据在服务端都无须是响应式的。利用这一点，可以减少服务端渲染过程中创建响应式数据对象的开销</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// - 服务端渲染只需要获取组件要渲染的subTree即可，无须调用渲染器完成真实DOM的创建</span>

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 由于服务端渲染不需要渲染真实DOM，所以无须创建并执行render effect。这意味着，组件的beforeMount以及mounted钩子不会被触发。而且，由于服务端渲染不存在数据变更后的重新渲染逻辑，所以beforeUpdate与updated钩子也不会在服务端执行</span>
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">客户端激活的原理</h4>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">对于同构渲染来说，组件的代码会在服务端和客户端分别执行一次。在服务端，组件会被渲染为静态的HTML字符串，然后发送给浏览器，浏览器再把这段纯静态的HTML渲染出来。这意味着，此时页面中已经存在对应的DOM元素。同时，该组件还会被打包到一个JavaScript文件中，并在客户端被下载到浏览器中解释并执行。这时问题来了，当组件的代码在客户端执行时，会再次创建DOM吗？答案是不会。由于浏览器在渲染了由服务端发送过来的HTML字符串之后，页面中已经存在对应的DOM元素了，所以组件代码在客户端运行时，不需要再次创建响应的DOM元素。但是组件代码在客户端仍然需要做两件重要的事情：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">在页面中的DOM元素与虚拟节点对象之间建立联系</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">为页面中的DOM元素添加事件绑定</li>
</ul>
</blockquote>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">一个虚拟节点被挂载之后，为了保证更新程序能正确运行，需要通过该虚拟节点的vnode.el属性存储对真实DOM对象的引用。而同构渲染也是一样，为了应用程序在后续更新过程中能够正确运行，需要在页面中已经存在的DOM对象与虚拟节点对象之间建立正确的联系</p>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 同构渲染使用render.hydrate来完成激活</span>
renderer.hydrate(vnode, container)

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// mock流程</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// html代表服务端渲染的字符串</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> html = renderComponentVNode(compVNode)
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 获取挂载点</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> container = <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">document</span>.querySelector(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'#app'</span>)
container.innerHTML = html

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 激活</span>
renderer.hydrate(compVNode, container)


<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 实现hydrate</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createRenderer</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">options</span>) </span>{
    <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">hydrate</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node, vnode</span>) </span>{
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
    }
    
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> {
        render,
        hydrate,
    }
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">hyrate</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 从容器元素的第一个子节点开始</span>
    hydrateNode(container,.firstChild, vnode)
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">hydrateNode</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">node, vnode</span>) </span>{
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> { type } = vnode
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 让vnode引用真实node</span>
    vnode.el = node
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 检查虚拟DOM的类型，如果是组件，则调用mountCOmponent函数完成激活</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'object'</span>) {
        mountComponent(vnode, container, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)
    } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">typeof</span> type === <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'string'</span>) {
        <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 检查真实DOM的类型与虚拟DOM类型是否匹配</span>
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (node.nodeType !== <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1</span>) {
            <span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">console</span>.error(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">'xxx'</span>)
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 普通元素调用hydrateElement</span>
            hydrateElement(node, vnode)
        }
    }
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// hydrateNode函数需要返回当前节点的下一个兄弟节点，以便继续进行后续的激活操作</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> node.nextSibling
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">hydrateElement</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">el, vnode</span>) </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 为DOM元素添加事件</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span>(vnode.props) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> key <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">in</span> vnode.props) {
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #9a5334; line-height: 160%; box-sizing: content-box;">/^on/</span>.test(key)) {
                patchProps(el, key, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, vnode.props[key])
            }
        }
    }
    
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 递归地激活子节点</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #4ec9b0; line-height: 160%; box-sizing: content-box;">Array</span>.isArray(vnode.children)) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> nextNode = el.firstChild
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> len = vnode.children.length
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">let</span> i = <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">0</span>; i &lt; len; i++) {
            nextNode = hydrateNode(nextNode, vnode.children[i])
        }
    }
}

<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 对于组件的激活，还需要针对性地处理mountComponent函数</span>
<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 由于服务端渲染的页面中已经存在真实DOM元素，所以调用mountComponent进行组件的挂载时，无须再次创建真实DOM元素</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">function</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">mountComponent</span>(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">vnode, container, anchor</span>) </span>{
     <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
     instance.update = effect(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">const</span> subTree = render.call(renderContext, renderContext)
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!instance.isMounted) {
            beforeMount &amp;&amp; beforeMount.call(renderContext)
            <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (vnode.el) {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 存在vnode.el，直接调用激活函数</span>
                hydrateNode(vnode.el, subTree)
            } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
                <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 正常挂载</span>
                patch(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, subTree, container, anchor)
            }
            instance.isMounted = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">true</span>;
            mounted &amp;&amp; mounted.call(renderContext)
            instance.mounted &amp;&amp; instance.mounted.forEach(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">hook</span> =&gt;</span> hook.call(renderContext))
        } <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">else</span> {
            beforeUpdate &amp;&amp; beforeUpdate.call(renderContext)
            patch(instance.subTree, subTree, container, anchor)
            updated &amp;&amp; updated.call(renderContext)
        }
        instance.subTree = subTree
     }, {
        <span style="color: #9cdcfe; line-height: 160%; box-sizing: content-box;">scheduler</span>: queueJob
     })
}
</code></pre>
<h4 style="line-height: 160%; box-sizing: content-box; font-size: 20px; color: #333;">编写同构的代码</h4>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">组件的生命周期</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">实际上只有beforeCreate与created这两个钩子函数会在服务端执行</p>
</blockquote>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0;">在服务端渲染时，定时器内的代码没有任何意义，遇到这种问题的解决办法：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333; margin-bottom: 0;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">将创建定时器的代码移动到mounted钩子中，即只在客户端执行定时器</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">使用环境变量包裹这段代码，让其不在服务端中运行</li>
</ul>
</blockquote>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">create() {
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">import</span>.meta.env.SSR) {
        <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.timer = setInterval(<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> =&gt;</span> {
            <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ...</span>
        }, <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;">1000</span>)
    }
}
</code></pre>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">使用跨平台的API</h5>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">编写代码时，要避免使用平台特有的API</p>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">只在某一端引入模块</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">使用import.meta.env.SSR来做代码守卫</p>
</blockquote>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">避免交叉请求引起的状态污染</h5>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">在服务端渲染时，会为每一个请求创建一个全新的应用实例、</p>
</blockquote>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">&lt;ClientOnly&gt;组件</h5>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;">
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">tempalte</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">ClientOnly</span>&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">SsrIncompatibleComp</span>/&gt;</span>
    <span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">ClientOnly</span>&gt;</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">&lt;/<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">template</span>&gt;</span>
</code></pre>
</div><center style="display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden">%5Btoc%5D%0A%0A%23%23%20%E7%AC%AC%E4%B8%80%E7%AF%87%E3%80%8A%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E6%A6%82%E8%A7%88%E3%80%8B%0A%0A%23%23%23%20%E7%AC%AC%E4%B8%80%E7%AB%A0%E3%80%8A%E6%9D%83%E8%A1%A1%E7%9A%84%E8%89%BA%E6%9C%AF%E3%80%8B%0A%0A%23%23%23%23%20%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%B8%8E%E5%91%BD%E4%BB%A4%E5%BC%8F%E7%9A%84%E6%9D%83%E8%A1%A1%0A%3E%20%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BB%A3%E7%A0%81%E7%9A%84%E6%80%A7%E8%83%BD%E4%B8%8D%E4%BC%98%E4%BA%8E%E5%91%BD%E4%BB%A4%E5%BC%8F%E4%BB%A3%E7%A0%81%E7%9A%84%E6%80%A7%E8%83%BD%0A%3E%20%E5%A3%B0%E6%98%8E%E5%BC%8F%E6%9B%B4%E7%9C%8B%E9%87%8D%E7%BB%93%E6%9E%9C%EF%BC%8C%E5%91%BD%E4%BB%A4%E5%BC%8F%E6%9B%B4%E7%9C%8B%E9%87%8D%E8%BF%87%E7%A8%8B%0A%0A%60Vue.js%E9%87%87%E7%94%A8%E4%BA%86%E5%A3%B0%E6%98%8E%E5%BC%8F%EF%BC%8C%E6%8F%90%E9%AB%98%E4%BA%86%E5%8F%AF%E7%BB%B4%E6%8A%A4%E6%80%A7%60%0A%0A%23%23%23%23%20%E7%BC%96%E8%AF%91%E6%97%B6%E5%92%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%E6%9D%83%E8%A1%A1%0A%0Arender%E5%87%BD%E6%95%B0%EF%BC%9A%E8%BF%90%E8%A1%8C%E6%97%B6%0Atemplate%E6%A8%A1%E7%89%88%EF%BC%9A%E7%BC%96%E8%AF%91%E6%88%90render%E5%87%BD%E6%95%B0%EF%BC%8C%E7%BC%96%E8%AF%91%E6%97%B6%0A%0A%60%E6%89%80%E4%BB%A5vue.js%E6%98%AF%E7%BC%96%E8%AF%91%E6%97%B6%2B%E8%BF%90%E8%A1%8C%E6%97%B6%60%0A%0A%23%23%23%20%E7%AC%AC%E4%BA%8C%E7%AB%A0%E3%80%8A%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E6%A0%B8%E5%BF%83%E8%A6%81%E7%B4%A0%E3%80%8B%0A%0A%23%23%23%23%20%E6%8F%90%E5%8D%87%E7%94%A8%E6%88%B7%E5%BC%80%E5%8F%91%E4%BD%93%E9%AA%8C%0A%E5%9C%A8chrome%20console%20%E8%AE%BE%E7%BD%AE%E4%B8%AD%E5%BC%80%E5%90%AFEnable%20custom%20formatters%E5%8F%AF%E4%BB%A5%E6%A0%BC%E5%BC%8F%E5%8C%96Ref%E3%80%81Reactive...%E7%AD%89%E7%9A%84%E4%BF%A1%E6%81%AF%E8%BE%93%E5%87%BA%0A%0A%23%23%23%23%20%E6%8E%A7%E5%88%B6%E6%A1%86%E6%9E%B6%E4%BB%A3%E7%A0%81%E7%9A%84%E4%BD%93%E7%A7%AF%0Avue.js%E4%B8%AD%EF%BC%8C%E5%AF%B9%E4%BA%8Ewarn%E7%9A%84%E8%BE%93%E5%87%BA%EF%BC%8C%E5%8F%AA%E6%9C%89%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E4%B8%8B%E4%BC%9A%E6%89%93%E5%8C%85%E4%B8%8B%E9%9D%A2%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%80%8C%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F%E4%B8%8B%EF%BC%8C%E5%9C%A8rollup.js%E4%B8%AD%E6%8F%92%E4%BB%B6%E6%8E%A7%E5%88%B6__DEV__%E4%B8%BAfalse%2C%E5%9B%A0%E6%AD%A4%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81%E5%B9%B6%E4%B8%8D%E4%BC%9A%E6%89%93%E5%8C%85%EF%BC%8C%E7%94%B1%E6%AD%A4%E5%87%8F%E5%B0%91%E4%BA%86%E7%94%9F%E4%BA%A7%E7%8E%AF%E8%8A%82%E7%9A%84%E6%89%93%E5%8C%85%E4%BB%A3%E7%A0%81%E4%BD%93%E7%A7%AF%0A%60%60%60js%0Aif%20(__DEV__%20%26%26%20!res)%20%7B%0A%20%20warn(%60xxx%60)%3B%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E6%A1%86%E6%9E%B6%E8%A6%81%E5%81%9A%E5%88%B0%E8%89%AF%E5%A5%BD%E7%9A%84Tree-Shaking%0A%3E%20Tree-Shaking%E5%BF%85%E9%A1%BB%E6%98%AFESM%E6%A8%A1%E5%9D%97%0A%3E%20Tree-Shaking%E5%89%AF%E4%BD%9C%E7%94%A8(%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E5%AF%B9%E5%A4%96%E9%83%A8%E4%BA%A7%E7%94%9F%E5%BD%B1%E5%93%8D)%E3%80%82%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E4%BC%9A%E4%BA%A7%E7%94%9F%E5%89%AF%E4%BD%9C%E7%94%A8%EF%BC%8C%E9%82%A3%E4%B9%88%E5%B0%B1%E4%B8%8D%E8%83%BD%E5%B0%86%E5%85%B6%E7%A7%BB%E9%99%A4%E3%80%82%0A%3E%20%E4%BD%86%E6%98%AF%E5%9C%A8rollup.js%E4%B8%AD%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8PURE%E6%9D%A5%E6%A0%87%E8%AF%86%E8%AF%A5%E6%AE%B5%E4%BB%A3%E7%A0%81%E4%B8%8D%E4%BC%9A%E4%BA%A7%E7%94%9F%E5%89%AF%E4%BD%9C%E7%94%A8%EF%BC%8Crollup.js%E5%8F%AF%E4%BB%A5%E6%94%BE%E5%BF%83%E8%BF%9B%E8%A1%8CTree-Shaking%0A%60%60%60js%0A%2F*%23__PURE__*%2F%0A%60%60%60%0A%0A%23%23%23%23%20%E6%A1%86%E6%9E%B6%E5%BA%94%E8%AF%A5%E8%BE%93%E5%87%BA%E6%80%8E%E6%A0%B7%E7%9A%84%E6%9E%84%E5%BB%BA%E4%BA%A7%E7%89%A9%0A%20-%20%E9%80%9A%E8%BF%87script%E6%A0%87%E7%AD%BE%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8(IIFE%E6%A0%BC%E5%BC%8F)%EF%BC%8C%60vue.global.js%60%E6%96%87%E4%BB%B6%E5%B0%B1%E6%98%AF%E8%BF%99%E7%A7%8D%E6%A0%BC%E5%BC%8F%0A%20-%20%E7%8E%B0%E5%9C%A8%E4%B8%BB%E6%B5%81%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AF%B9ESM%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%94%AF%E6%8C%81%E4%B8%8D%E9%94%99%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%3Cscript%20type%3D%22module%22%20src%3D%22%22%3E%E6%9D%A5%E5%BC%95%E5%85%A5%EF%BC%8C%60vue.esm-browser.js%60%E6%96%87%E4%BB%B6%E5%B0%B1%E6%98%AF%E8%BF%99%E7%A7%8D%E6%A0%BC%E5%BC%8F%0A%20-%20%E9%99%A4%E4%BA%86vue.esm-browser.js%E6%96%87%E4%BB%B6%E5%A4%96%EF%BC%8C%E8%BF%98%E6%9C%89vue.esm-bundler.js%E7%AD%89%E5%B8%A6%E6%9C%89-bundler%E7%9A%84%E6%96%87%E4%BB%B6%EF%BC%8C%E8%BF%99%E7%B1%BB%E6%96%87%E4%BB%B6%E4%B8%BB%E8%A6%81%E6%98%AF%E6%8F%90%E4%BE%9B%E7%BB%99webpack%E6%88%96%E8%80%85rollup.js%E8%BF%99%E7%A7%8D%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E7%9A%84%EF%BC%8C%E5%9B%A0%E4%B8%BA%E8%BF%99%E9%87%8C%E4%B8%8D%E8%83%BD%E7%9B%B4%E6%8E%A5%E6%8A%8A__DEV__%E8%AE%BE%E7%BD%AE%E4%B8%BAtrue%E6%88%96%E8%80%85false%2C%E8%80%8C%E8%A6%81%E9%80%9A%E8%BF%87(process.env.NODE_ENV%20!%3D%3D%20'production')%E6%9D%A5%E6%9B%BF%E6%8D%A2__DEV__%E5%B8%B8%E9%87%8F%E3%80%82%0A%60%60%60js%0Aif(__DEV__)%20%7B%0A%20%20%20%20warn('xxx')%3B%0A%7D%0A%0A%2F%2F%20%E5%9C%A8%E5%B8%A6%E6%9C%89-bundler%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%AD%0Aif(process.env.NODE_ENV%20!%3D%3D%20'production')%20%7B%0A%20%20%20%20warn('xxx')%3B%0A%7D%0A%60%60%60%0A-%20%E5%90%8C%E6%A0%B7%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%9C%A8nodejs%E4%B8%AD%E9%80%9A%E8%BF%87require%E5%BC%95%E7%94%A8%E8%B5%84%E6%BA%90%EF%BC%8C%E5%BD%93%E8%BF%9B%E8%A1%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8CVue.js%E4%BB%A3%E7%A0%81%E5%9C%A8Node.js%E4%B8%AD%E8%BF%90%E8%A1%8C%EF%BC%8C%E8%80%8C%E9%9D%9E%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E8%BF%90%E8%A1%8C%E3%80%82%0A%0A%23%23%23%23%20%E7%89%B9%E6%80%A7%E5%BC%80%E5%85%B3%0A%3E%20%E6%8F%90%E4%BE%9Ba%2Cb%2Cc%E4%B8%89%E4%B8%AA%E5%AF%B9%E5%BA%94%E7%89%B9%E6%80%A7%E7%9A%84%E5%BC%80%E5%85%B3%EF%BC%8C%E7%94%A8%E6%88%B7%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%AE%BE%E7%BD%AEa%2Cb%2Cc%E4%B8%BAtrue%E6%88%96%E8%80%85false%E6%9D%A5%E4%BB%A3%E8%A1%A8%E5%BC%80%E5%90%AF%E6%88%96%E5%85%B3%E9%97%AD%E5%AF%B9%E5%BA%94%E7%9A%84%E7%89%B9%E6%80%A7%E3%80%82%0A%0A-%20%E5%88%A9%E7%94%A8rollup.js%E7%9A%84%E9%A2%84%E5%AE%9A%E4%B9%89%E5%B8%B8%E9%87%8F%E6%8F%92%E4%BB%B6%E6%9D%A5%E5%AE%9E%E7%8E%B0%0A%60%60%60js%0A%7B%0A%20%20%20%20__FEATURE_OPTIONS_API__%3A%20isBundlerESMBuild%20%3F%20%60__VUE_OPTIONS_API__%60%20%3A%20true%0A%7D%0A%60%60%60%0A%E5%9C%A8%E8%BF%99%E9%87%8C%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E4%BE%9B%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E7%9A%84%EF%BC%8C%E5%B0%B1%E4%BC%9A%E4%BD%BF%E7%94%A8__VUE_OPTIONS_API__%E5%B8%B8%E9%87%8F%EF%BC%8C%E8%80%8C__VUE_OPTIONS_API__%E6%98%AF%E7%94%A8%E6%9D%A5%E6%8F%8F%E8%BF%B0%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AFVue2%E4%B8%ADoptions%E5%86%99%E6%B3%95%E7%9A%84%E7%89%B9%E6%80%A7%E5%BC%80%E5%85%B3%E3%80%82%0A%0A%23%23%23%23%20%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%0A%0A-%20%E6%8F%90%E4%BE%9BregisterErrorHandler%E5%87%BD%E6%95%B0%EF%BC%8C%E7%94%A8%E6%88%B7%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E5%AE%83%E6%B3%A8%E5%86%8C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%EF%BC%8C%E7%84%B6%E5%90%8E%E5%9C%A8callWithErrorHandling%E5%87%BD%E6%95%B0%E5%86%85%E9%83%A8%E6%8D%95%E8%8E%B7%E9%94%99%E8%AF%AF%E5%90%8E%EF%BC%8C%E6%8A%8A%E9%94%99%E8%AF%AF%E4%BC%A0%E9%80%92%E7%BB%99%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%0A-%20%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%BA%90%E7%A0%81%E4%B8%AD%E6%90%9C%E7%B4%A2callWithErrorHandling%E5%87%BD%E6%95%B0%0A%0A%23%23%23%23%20%E8%89%AF%E5%A5%BD%E7%9A%84Typescript%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81%0A%0A%3E%20%E4%BD%BF%E7%94%A8TS%E7%BC%96%E5%86%99%E6%A1%86%E6%9E%B6%E5%92%8C%E6%A1%86%E6%9E%B6%E5%AF%B9TS%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81%E5%8F%8B%E5%A5%BD%E6%98%AF%E4%B8%A4%E4%BB%B6%E5%AE%8C%E5%85%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E4%BA%8B%0A%0A%3E%20runtime-core%2Fsrc%2FapiDefineComponent.ts%0A%0A%23%23%23%20%E7%AC%AC%E4%B8%89%E7%AB%A0%E3%80%8AVue.js3%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF%E3%80%8B%0A%0A%23%23%23%23%20%E6%B8%B2%E6%9F%93%E5%99%A8%0A%3E%20%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E4%BD%9C%E7%94%A8%E5%B0%B1%E6%98%AF%E6%8A%8A%E8%99%9A%E6%8B%9FDOM%E6%B8%B2%E6%9F%93%E4%B8%BA%E7%9C%9F%E5%AE%9EDOM(%E9%83%BD%E6%98%AF%E4%BD%BF%E7%94%A8%E4%B8%80%E4%BA%9B%E7%86%9F%E6%82%89%E7%9A%84DOM%E6%93%8D%E4%BD%9CAPI%E6%9D%A5%E5%AE%8C%E6%88%90%E6%B8%B2%E6%9F%93%E5%B7%A5%E4%BD%9C)%0A%0A%E6%B8%B2%E6%9F%93%E5%99%A8renderer%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%EF%BC%9A%0A-%20%E5%88%9B%E5%BB%BA%E5%85%83%E7%B4%A0%EF%BC%9A%E6%8A%8Avnode.tag%E4%BD%9C%E4%B8%BA%E6%A0%87%E7%AD%BE%E5%90%8D%E7%A7%B0%E6%9D%A5%E5%88%9B%E5%BB%BADOM%E5%85%83%E7%B4%A0%0A-%20%E4%B8%BA%E5%85%83%E7%B4%A0%E6%B7%BB%E5%8A%A0%E5%B1%9E%E6%80%A7%E5%92%8C%E4%BA%8B%E4%BB%B6%0A-%20%E5%A4%84%E7%90%86children%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E6%95%B0%E7%BB%84%E5%88%99%E9%80%92%E5%BD%92%E8%B0%83%E7%94%A8renderer%0A%0A%23%23%23%23%20%E7%BB%84%E4%BB%B6%E7%9A%84%E6%9C%AC%E8%B4%A8%0A%3E%20%E7%BB%84%E4%BB%B6%E5%B0%B1%E6%98%AF%E4%B8%80%E7%BB%84DOM%E5%85%83%E7%B4%A0%E7%9A%84%E5%B0%81%E8%A3%85%0A%0A-%20%E5%8F%AF%E4%BB%A5%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E6%9D%A5%E4%BB%A3%E8%A1%A8%E7%BB%84%E4%BB%B6%EF%BC%8C%E8%80%8C%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E5%B0%B1%E4%BB%A3%E8%A1%A8%E7%BB%84%E4%BB%B6%E8%A6%81%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%E3%80%82%0A-%20%E5%9B%A0%E6%AD%A4%E5%8F%AF%E4%BB%A5%E8%AE%A9%E8%99%9A%E6%8B%9FDOM%E5%AF%B9%E8%B1%A1%E4%B8%AD%E7%9A%84tag%E5%B1%9E%E6%80%A7%E6%9D%A5%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BD%86%E5%90%8C%E6%97%B6%E4%B8%BA%E4%BA%86%E8%83%BD%E5%A4%9F%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6%EF%BC%8C%E4%B9%9F%E9%9C%80%E8%A6%81%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E6%94%AF%E6%8C%81%E3%80%82%0A%60%60%60js%0Afunction%20renderer(vnode%2C%20container)%20%7B%0A%20%20%20%20if%20(typeof%20vnode.tag%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20mountElement(vnode%2C%20container)%3B%0A%20%20%20%20%7D%20else%20if%20(typeof%20vnode.tag%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20mountComponent(vnode%2C%20container)%3B%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20mountElement(vnode%2C%20container)%20%7B%0A%20%20%20%20const%20el%20%3D%20document.createElement(vnode.tag)%3B%0A%20%20%20%20for(const%20key%20in%20vnode.props)%20%7B%0A%20%20%20%20%20%20%20%20if%20(%2F%5Eon%2F.test(key))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20el.addEventListener(key.substr(2).toLowerCase()%2C%20vnode.props%5Bkey%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(typeof%20vnode.children%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20el.appendChild(document.createTextNode(vnode.children))%3B%0A%20%20%20%20%7D%20else%20if%20(Array.isArray(vnode.children))%20%7B%0A%20%20%20%20%20%20%20%20vnode.children.forEach(child%20%3D%3E%20renderer(child%2C%20el))%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20container.appendChild(el)%3B%0A%7D%0A%0Afunction%20mountComponent(vnode%2C%20container)%20%7B%0A%20%20%20%20const%20subtree%20%3D%20vnode.tag()%3B%0A%20%20%20%20renderer(subtree%2C%20container)%3B%0A%7D%0A%60%60%60%0A%0A-%20%E4%B8%BE%E4%B8%80%E5%8F%8D%E4%B8%89%EF%BC%9A%E7%BB%84%E4%BB%B6%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%98%AF%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%0A%60%60%60js%0Afunction%20renderer(vnode%2C%20container)%20%7B%0A%20%20%20%20if%20(typeof%20vnode.tag%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20mountElement(vnode%2C%20container)%3B%0A%20%20%20%20%7D%20else%20if%20(typeof%20vnode.tag%20%3D%3D%3D%20'object')%20%7B%0A%20%20%20%20%20%20%20%20mountComponent(vnode%2C%20container)%3B%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20mountComponent(vnode%2C%20container)%20%7B%0A%20%20%20%20const%20subtree%20%3D%20vnode.tag.render()%3B%0A%20%20%20%20renderer(subtree%2C%20container)%3B%0A%7D%0A%0A%60%60%60%0A%0A%23%23%23%23%20%E6%A8%A1%E7%89%88%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%0A%0A%3E%20%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%9A%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E5%B0%86%E6%A8%A1%E7%89%88%E7%BC%96%E8%AF%91%E4%B8%BA%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%0A%0A**%E6%97%A0%E8%AE%BA%E4%BD%BF%E7%94%A8%E6%A8%A1%E7%89%88%E8%BF%98%E6%98%AF%E6%89%8B%E5%86%99%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%EF%BC%8C%E5%AF%B9%E4%BA%8E%E4%B8%80%E4%B8%AA%E7%BB%84%E4%BB%B6%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%AE%83%E8%A6%81%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%E6%9C%80%E7%BB%88%E9%83%BD%E6%98%AF%E9%80%9A%E8%BF%87%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E4%BA%A7%E7%94%9F%E7%9A%84%EF%BC%8C%E7%84%B6%E5%90%8E%E6%B8%B2%E6%9F%93%E5%99%A8%E5%86%8D%E6%8A%8A%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E7%9A%84%E8%99%9A%E6%8B%9FDOM%E6%B8%B2%E6%9F%93%E4%B8%BA%E7%9C%9F%E5%AE%9EDOM%EF%BC%8C%E8%BF%99%E5%B0%B1%E6%98%AF%E6%A8%A1%E7%89%88%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86**%0A%0A%0A%23%23%23%23%20Vue.js%E6%98%AF%E5%90%84%E4%B8%AA%E6%A8%A1%E5%9D%97%E7%BB%84%E6%88%90%E7%9A%84%E6%9C%89%E6%9C%BA%E6%95%B4%E4%BD%93%0A%3E%20%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%BE%9D%E8%B5%96%E4%BA%8E%E6%B8%B2%E6%9F%93%E5%99%A8%EF%BC%8C%E6%A8%A1%E7%89%88%E7%9A%84%E7%BC%96%E8%AF%91%E4%BE%9D%E8%B5%96%E4%BA%8E%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%8C%E5%B9%B6%E4%B8%94%E7%BC%96%E8%AF%91%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81%E6%98%AF%E6%A0%B9%E6%8D%AE%E6%B8%B2%E6%9F%93%E5%99%A8%E5%92%8C%E8%99%9A%E6%8B%9FDOM%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%86%B3%E5%AE%9A%E7%9A%84%EF%BC%8C%E5%9B%A0%E6%AD%A4Vue%E7%9A%84%E5%90%84%E4%B8%AA%E6%A8%A1%E5%9D%97%E4%B9%8B%E9%97%B4%E6%98%AF%E4%BA%92%E7%9B%B8%E5%85%B3%E8%81%94%E3%80%81%E4%BA%92%E7%9B%B8%E5%88%B6%E7%BA%A6%E7%9A%84%EF%BC%8C%E5%85%B1%E5%90%8C%E6%9E%84%E6%88%90%E4%B8%80%E4%B8%AA%E6%9C%89%E6%9C%BA%E6%95%B4%E4%BD%93%E3%80%82%0A%0A-%20%E5%9C%A8%E7%BC%96%E8%AF%91%E5%99%A8%E9%87%8C%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BE%88%E5%AE%B9%E6%98%93%E5%8F%91%E7%8E%B0%E5%93%AA%E4%BA%9B%E5%86%85%E5%AE%B9%E6%98%AF%E5%8A%A8%E6%80%81%E7%9A%84%EF%BC%8C%E5%9B%A0%E6%AD%A4%E7%BC%96%E8%AF%91%E5%99%A8%E5%8F%AF%E4%BB%A5%E5%9C%A8%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%E7%9A%84%E6%97%B6%E5%80%99%E9%99%84%E5%B8%A6%E8%BF%99%E4%BA%9B%E4%BF%A1%E6%81%AF%EF%BC%8C%E4%BE%8B%E5%A6%82patchFlag%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9C%8B%E5%88%B0%E8%BF%99%E4%B8%AA%E6%A0%87%E8%AF%86%E6%97%B6%E5%B0%B1%E7%9F%A5%E9%81%93%E5%93%AA%E4%BA%9B%E5%86%85%E5%AE%B9%E6%98%AF%E5%8A%A8%E6%80%81%E7%9A%84%EF%BC%8C%E5%AF%B9%E4%BA%8E%E6%B8%B2%E6%9F%93%E5%99%A8%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%B0%B1%E7%9C%81%E5%8E%BB%E4%BA%86%E5%AF%BB%E6%89%BE%E5%8F%98%E6%9B%B4%E7%82%B9%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E3%80%82%0A%0A%0A%23%23%20%E7%AC%AC%E4%BA%8C%E7%AF%87%E3%80%8A%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E3%80%8B%0A%23%23%23%20%E7%AC%AC%E5%9B%9B%E7%AB%A0%E3%80%8A%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B%0A%3E%20%E5%BD%93%E8%AF%BB%E5%8F%96%E6%93%8D%E4%BD%9C%E5%8F%91%E7%94%9F%E6%97%B6%EF%BC%8C%E5%B0%86%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%94%B6%E9%9B%86%E5%88%B0%E2%80%9C%E6%A1%B6%E2%80%9D%E4%B8%AD%0A%3E%20%E5%BD%93%E8%AE%BE%E7%BD%AE%E6%93%8D%E4%BD%9C%E5%8F%91%E7%94%9F%E6%97%B6%EF%BC%8C%E4%BB%8E%E2%80%9C%E6%A1%B6%E2%80%9D%E4%B8%AD%E5%8F%96%E5%87%BA%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E5%B9%B6%E6%89%A7%E8%A1%8C%0A%0A%23%23%23%23%20%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E8%BF%99%E4%B8%AA%E2%80%9C%E6%A1%B6%E2%80%9D%0A%3E%20%E9%9C%80%E8%A6%81WeakMap(%E4%B8%8D%E6%98%AFMap)%0A%60%60%60js%0A%2F%2F%20%E5%AD%98%E5%82%A8%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E6%A1%B6%0Aconst%20bucket%20%3D%20new%20WeakMap()%3B%0A%0Aconst%20obj%20%3D%20new%20Proxy(data%2C%20%7B%0A%20%20%20%20get(target%2C%20key)%20%7B%0A%20%20%20%20%20%20%20%20if%20(!activeEffect)%20return%3B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%A0%B9%E6%8D%AEtarget%E4%BB%8E%E2%80%9C%E6%A1%B6%E2%80%9D%E4%B8%AD%E5%8F%96%E5%BE%97depsMap%EF%BC%8C%E5%AE%83%E4%B9%9F%E6%98%AF%E4%B8%80%E4%B8%AAMap%E7%B1%BB%E5%9E%8B%EF%BC%9Akey%20--%3E%20effects%0A%20%20%20%20%20%20%20%20let%20depsMap%20%3D%20bucket.get(target)%3B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%AD%98%E5%9C%A8depsMap%EF%BC%8C%E9%82%A3%E4%B9%88%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AAMap%E5%B9%B6%E4%B8%8Etarget%E5%85%B3%E8%81%94%0A%20%20%20%20%20%20%20%20if%20(!depsMap)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20bucket.set(target%2C%20(depsMap%20%3D%20new%20Map()))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%A0%B9%E6%8D%AEkey%E4%BB%8EdepsMap%E4%B8%AD%E8%8E%B7%E5%8F%96deps%EF%BC%8C%E5%AE%83%E6%98%AF%E4%B8%80%E4%B8%AASet%0A%20%20%20%20%20%20%20%20let%20deps%20%3D%20depsMap.get(key)%3B%0A%20%20%20%20%20%20%20%20if%20(!deps)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20depsMap.set(key%2C%20(deps%20%3D%20new%20Set()))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%9C%80%E5%90%8E%E5%B0%86%E5%BD%93%E5%89%8D%E6%BF%80%E6%B4%BB%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%B7%BB%E5%8A%A0%E5%88%B0%E2%80%9C%E6%A1%B6%E2%80%9C%E9%87%8C%0A%20%20%20%20%20%20%20%20deps.add(activeEffect)%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20return%20target%5Bkey%5D%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20%0A%20%20%20%20set(target%2C%20key%2C%20newVal)%20%7B%0A%20%20%20%20%20%20%20%20target%5Bkey%5D%20%3D%20newVal%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20const%20depsMap%20%3D%20bucket.get(target)%3B%0A%20%20%20%20%20%20%20%20if%20(!depsMap)%20return%3B%0A%20%20%20%20%20%20%20%20const%20effects%20%3D%20depsMap.get(key)%3B%0A%20%20%20%20%20%20%20%20effects%20%26%26%20effects.forEach(fn%20%3D%3E%20fn())%3B%0A%20%20%20%20%7D%0A%7D)%0A%60%60%60%0A%0A%23%23%23%23%20%E5%88%86%E6%94%AF%E5%88%87%E6%8D%A2%E4%B8%8Ecleanup%0A%60%60%60js%0Aconst%20data%20%3D%20%7B%20ok%3A%20true%2C%20text%3A%20'hello%20world'%20%7D%3B%0Aconst%20obj%20%3D%20new%20Proxy(data%2C%20%7B%20xxx%20%7D)%3B%0A%0Aeffect(function%20effectFn()%20%7B%0A%20%20%20%20document.body.innerText%20%3D%20obj.ok%20%3F%20obj.text%20%3A%20'not'%3B%0A%7D)%0A%0A%2F%2F%20%E8%BF%99%E9%87%8C%E5%9B%A0%E4%B8%BA%E5%90%8C%E6%97%B6%E6%9C%89obj.ok%E5%92%8Cobj.text%EF%BC%8C%E6%89%80%E4%BB%A5%E4%BC%9A%E5%90%8C%E6%97%B6%E6%94%B6%E9%9B%86%E4%B8%A4%E4%B8%AA%E4%BE%9D%E8%B5%96%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BD%86%E6%98%AF%E5%BD%93%E4%B8%8B%E4%B8%80%E6%AC%A1obj.ok%E4%B8%BAfalse%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E7%90%86%E5%BA%94%E7%BB%93%E6%9E%9C%E9%83%BD%E6%98%AF'not'%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%B8%8D%E7%AE%A1obj.text%E5%A6%82%E4%BD%95%E6%94%B9%E5%8F%98%E9%83%BD%E5%8F%AF%E4%BB%A5%E4%B8%8D%E7%94%A8%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BD%86%E4%BA%8B%E5%AE%9E%E4%B8%8A%E4%BC%9A%E9%87%8D%E6%96%B0%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E3%80%82%0A%2F%2F%20%E6%AF%8F%E6%AC%A1%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E7%90%86%E5%BA%94%E4%BC%9A%E9%87%8D%E6%96%B0%E8%BF%9B%E8%A1%8C%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86%EF%BC%8C%E8%BF%99%E6%97%B6%E6%9C%9F%E6%9C%9B%E4%B9%8B%E5%89%8Dobj.text%E7%BB%91%E5%AE%9A%E7%9A%84%E5%93%8D%E5%BA%94%E5%85%B3%E7%B3%BB%E8%A2%AB%E6%B8%85%E9%99%A4%E6%8E%89%EF%BC%8C%E4%BD%86%E4%BA%8B%E5%AE%9E%E4%B8%8A%E5%B9%B6%E6%B2%A1%E6%9C%89%EF%BC%8C%E5%AE%83%E9%81%97%E7%95%99%E4%B8%8B%E6%9D%A5%E4%BA%86%EF%BC%8C%E4%BB%8E%E8%80%8C%E5%AF%BC%E8%87%B4%E5%BD%93obj.ok%E4%B8%BAfalse%E6%97%B6%EF%BC%8Cobj.text%E7%9A%84%E6%94%B9%E5%8F%98%E4%B9%9F%E4%BC%9A%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%0A%2F%2F%20%E8%A6%81%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%AF%8F%E6%AC%A1%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%85%88%E6%8A%8A%E5%AE%83%E4%BB%8E%E6%89%80%E6%9C%89%E4%B8%8E%E4%B9%8B%E5%85%B3%E8%81%94%E7%9A%84%E4%BE%9D%E8%B5%96%E9%9B%86%E5%90%88%E4%B8%AD%E5%88%A0%E9%99%A4%EF%BC%8C%E5%8D%B3%E6%AF%8F%E6%AC%A1%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E5%85%88%E6%8A%8A%E4%BB%A5%E5%89%8D%E7%BB%91%E5%AE%9A%E7%9A%84%E5%85%B3%E7%B3%BB%E5%88%A0%E9%99%A4%EF%BC%8C%E7%84%B6%E5%90%8E%E9%87%8D%E6%96%B0%E7%BB%91%E5%AE%9A%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E4%B8%8D%E4%BC%9A%E5%AD%98%E5%9C%A8%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%E4%BA%86%0A%60%60%60%0A%0A%E8%A6%81%E5%B0%86%E4%B8%80%E4%B8%AA%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%BB%8E%E6%89%80%E6%9C%89%E4%B8%8E%E4%B9%8B%E5%85%B3%E8%81%94%E7%9A%84%E4%BE%9D%E8%B5%96%E9%9B%86%E5%90%88%E4%B8%AD%E7%A7%BB%E9%99%A4%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E6%98%8E%E7%A1%AE%E7%9F%A5%E9%81%93%E5%93%AA%E4%BA%9B%E4%BE%9D%E8%B5%96%E9%9B%86%E5%90%88%E4%B8%AD%E5%8C%85%E5%90%AB%E5%AE%83%EF%BC%8C%E5%9B%A0%E6%AD%A4%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E8%AE%BE%E8%AE%A1%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA%0A%0A%60%60%60js%0Alet%20activeEffect%0Afunction%20effect(fn)%20%7B%0A%20%20%20%20const%20effectFn%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93effectFn%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E5%B0%86%E5%85%B6%E8%AE%BE%E7%BD%AE%E4%B8%BA%E5%BD%93%E5%89%8D%E6%BF%80%E6%B4%BB%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20activeEffect%20%3D%20effectFn%0A%20%20%20%20%20%20%20%20fn()%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20activeEffect.deps%20%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E6%89%80%E6%9C%89%E4%B8%8E%E8%AF%A5%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9B%B8%E5%85%B3%E8%81%94%E7%9A%84%E4%BE%9D%E8%B5%96%E9%9B%86%E5%90%88%0A%20%20%20%20effectFn.deps%20%3D%20%5B%5D%0A%20%20%20%20effectFn()%0A%7D%0A%0A%2F%2F%20effectFn.deps%E5%A6%82%E4%BD%95%E6%94%B6%E9%9B%86%E7%9A%84%E4%BE%9D%E8%B5%96%0Afunction%20track(target%2C%20key)%20%7B%0A%20%20%20%20if%20(!activeEffect)%20return%3B%0A%20%20%20%20let%20depsMap%20%3D%20bucket.get(target)%3B%0A%20%20%20%20if%20(!depsMap)%20%7B%0A%20%20%20%20%20%20%20%20bucket.set(target%2C%20(depsMap%20%3D%20new%20Map()))%3B%0A%20%20%20%20%7D%0A%20%20%20%20let%20deps%20%3D%20depsMap.get(key)%3B%0A%20%20%20%20if%20(!deps)%20%7B%0A%20%20%20%20%20%20%20%20depsMap.set(key%2C%20(deps%20%3D%20new%20Set()))%3B%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20%E5%B0%86%E5%BD%93%E5%89%8D%E6%BF%80%E6%B4%BB%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%B7%BB%E5%8A%A0%E5%88%B0%E2%80%9C%E6%A1%B6%E2%80%9C%E9%87%8C%0A%20%20%20%20deps.add(activeEffect)%3B%0A%20%20%20%20%0A%20%20%20%20activeEffect.deps.push(deps)%3B%0A%0A%20%20%20%20return%20target%5Bkey%5D%3B%0A%7D%0A%0A%2F%2F%20%E6%9C%89%E4%BA%86%E8%BF%99%E4%B8%AA%E8%81%94%E7%B3%BB%E5%90%8E%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%AF%8F%E6%AC%A1%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E6%A0%B9%E6%8D%AEeffectFn.deps%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E7%9B%B8%E5%85%B3%E8%81%94%E7%9A%84%E4%BE%9D%E8%B5%96%E9%9B%86%E5%90%88%EF%BC%8C%E8%BF%9B%E8%80%8C%E5%B0%86%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%BB%8E%E4%BE%9D%E8%B5%96%E9%9B%86%E5%90%88%E4%B8%AD%E7%A7%BB%E9%99%A4%0Alet%20activeEffect%0Afunction%20effect(fn)%20%7B%0A%20%20%20%20const%20effectFn%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93effectFn%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E5%B0%86%E5%85%B6%E8%AE%BE%E7%BD%AE%E4%B8%BA%E5%BD%93%E5%89%8D%E6%BF%80%E6%B4%BB%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20cleanup(effectFn)%0A%20%20%20%20%20%20%20%20activeEffect%20%3D%20effectFn%0A%20%20%20%20%20%20%20%20fn()%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20activeEffect.deps%20%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E6%89%80%E6%9C%89%E4%B8%8E%E8%AF%A5%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9B%B8%E5%85%B3%E8%81%94%E7%9A%84%E4%BE%9D%E8%B5%96%E9%9B%86%E5%90%88%0A%20%20%20%20effectFn.deps%20%3D%20%5B%5D%0A%20%20%20%20effectFn()%0A%7D%0A%0Afunction%20cleanup(effectFn)%20%7B%0A%20%20%20%20for(let%20i%20%3D%200%3B%20i%20%3C%20effectFn.deps.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20const%20deps%20%3D%20effectFn.deps%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20deps.delete(effectFn)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20effectFn.deps.length%20%3D%200%3B%0A%7D%0A%0A%2F%2F%20%E7%9B%AE%E5%89%8D%E5%93%8D%E5%BA%94%E7%B3%BB%E7%BB%9F%E5%B7%B2%E7%BB%8F%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%BA%A7%E7%94%9F%E9%81%97%E7%95%99%E4%BA%86%EF%BC%8C%E4%BD%86%E6%98%AF%E5%9C%A8trigger%E4%B8%AD%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%97%A0%E9%99%90%E5%BE%AA%E7%8E%AF%E6%89%A7%E8%A1%8C%0Afunction%20trigger(target%2C%20key)%20%7B%0A%20%20%20%20const%20depsMap%20%3D%20bucket.get(target)%3B%0A%20%20%20%20if%20(!depsMap)%20return%0A%20%20%20%20const%20effects%20%3D%20depsMap.get(key)%3B%0A%20%20%20%20const%20effectsToRun%20%3D%20new%20Set(effects)%0A%20%20%20%20effectsToRun.forEach(effectFn%20%3D%3E%20effectFn())%0A%7D%0A%60%60%60%0A%0A%0A%23%23%23%23%20%E5%B5%8C%E5%A5%97%E7%9A%84effect%E4%B8%8Eeffect%E6%A0%88%0A%60%60%60js%0Aeffect(function%20effectFn1()%20%7B%0A%20%20%20%20effect(function%20effectFn2()%20%7B%0A%20%20%20%20%20%20%20%20%2F*%20...%20*%2F%0A%20%20%20%20%7D)%0A%7D)%0A%60%60%60%0A%3E%20%E5%9C%A8Vue.js%E4%B8%AD%EF%BC%8CVue.js%E7%9A%84%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E5%B0%B1%E6%98%AF%E5%9C%A8%E4%B8%80%E4%B8%AAeffect%E4%B8%AD%E6%89%A7%E8%A1%8C%E7%9A%84%0A%0A%60%60%60js%0A%2F%2F%20%E5%BD%93%E7%BB%84%E4%BB%B6%E5%8F%91%E7%94%9F%E5%B5%8C%E5%A5%97%E6%97%B6%EF%BC%8C%E5%B0%B1%E5%8F%91%E7%94%9F%E4%BA%86effect%E5%B5%8C%E5%A5%97%0Aconst%20Bar%20%3D%20%7B%0A%20%20%20%20render()%20%7B%20%2F*%20...%20*%2F%20%7D%3B%0A%7D%0Aconst%20Foo%20%3D%20%7B%0A%20%20%20%20render()%20%7B%0A%20%20%20%20%20%20%20%20return%20%3CBar%20%2F%3E%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E7%9B%B8%E5%BD%93%E4%BA%8E%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20Foo.render()%0A%20%20%20%20effect(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Bar.render()%0A%20%20%20%20%7D)%0A%7D)%0A%0A%2F%2F%20%E9%97%AE%E9%A2%98%0A%2F%2F%20%E5%9B%A0%E4%B8%BA%E5%85%A8%E5%B1%80%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AAactiveEffect%E5%AD%98%E5%82%A8%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E5%BD%93%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E5%8F%91%E7%94%9F%E5%B5%8C%E5%A5%97%E6%97%B6%EF%BC%8C%E5%86%85%E5%B1%82%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E6%89%A7%E8%A1%8C%E4%BC%9A%E8%A6%86%E7%9B%96activeEffect%E7%9A%84%E5%80%BC%EF%BC%8C%E5%B9%B6%E4%B8%94%E6%B0%B8%E8%BF%9C%E4%B8%8D%E4%BC%9A%E6%81%A2%E5%A4%8D%E5%88%B0%E5%8E%9F%E6%9D%A5%E7%9A%84%E5%80%BC%E3%80%82%E8%BF%99%E6%97%B6%E5%A6%82%E6%9E%9C%E5%90%8E%E9%9D%A2%E5%86%8D%E6%9C%89%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86%EF%BC%8C%E5%8D%B3%E4%BD%BF%E8%BF%99%E4%B8%AA%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E6%98%AF%E5%9C%A8%E5%A4%96%E5%B1%82%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%B8%AD%E8%AF%BB%E5%8F%96%E7%9A%84%EF%BC%8C%E5%AE%83%E4%BB%AC%E6%94%B6%E9%9B%86%E5%88%B0%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%B9%9F%E9%83%BD%E4%BC%9A%E6%98%AF%E5%86%85%E5%B1%82%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E3%80%82%0A%2F%2F%20%E8%A7%A3%E5%86%B3%0A%2F%2F%20%E9%9C%80%E8%A6%81%E4%B8%80%E4%B8%AA%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%A0%88effectStack%EF%BC%8C%E5%9C%A8%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E5%B0%86%E5%BD%93%E5%89%8D%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E5%8E%8B%E5%85%A5%E6%A0%88%E4%B8%AD%EF%BC%8C%E5%BE%85%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95%E5%90%8E%E5%B0%86%E5%85%B6%E4%BB%8E%E6%A0%88%E4%B8%AD%E5%BC%B9%E5%87%BA%EF%BC%8C%E5%B9%B6%E7%BB%88%E6%AD%A2%E8%AE%A9activeEffect%E6%8C%87%E5%90%91%E6%A0%88%E9%A1%B6%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%0Alet%20activeEffect%0Aconst%20effectStack%20%3D%20%5B%5D%0Afunction%20effect(fn)%20%7B%0A%20%20%20%20const%20effectFn%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20cleanup(effectFn)%0A%20%20%20%20%20%20%20%20activeEffect%20%3D%20effectFn%0A%20%20%20%20%20%20%20%20effectStack.push(effectFn)%0A%20%20%20%20%20%20%20%20fn()%0A%20%20%20%20%20%20%20%20effectStack.pop()%0A%20%20%20%20%20%20%20%20activeEffect%20%3D%20effectStack%5BeffectStack.length%20-%201%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20effectFn.deps%20%3D%20%5B%5D%0A%20%20%20%20effectFn()%0A%20%20%20%20%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E9%81%BF%E5%85%8D%E6%97%A0%E9%99%90%E9%80%92%E5%BD%92%E5%BE%AA%E7%8E%AF%0A%60%60%60js%0Aconst%20data%20%3D%20%7B%20foo%3A%201%20%7D%0Aconst%20obj%20%3D%20new%20Proxy(data%2C%20%7B%20%2F*%20...%20*%2F%20%7D)%0Aeffect(()%20%3D%3E%20obj.foo%2B%2B)%0A%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%EF%BC%8C%E6%97%A2%E4%BC%9A%E8%AF%BB%E5%8F%96obj.foo%EF%BC%8C%E4%B9%9F%E4%BC%9A%E8%AE%BE%E7%BD%AEobj.foo%EF%BC%8C%E8%BF%99%E5%B0%B1%E5%AF%BC%E8%87%B4%E4%BA%86%E6%A0%88%E6%BA%A2%E5%87%BA%0A%0A%2F%2F%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%0A%2F%2F%20%E5%9C%A8trigger%E5%8A%A8%E4%BD%9C%E5%8F%91%E7%94%9F%E6%97%B6%E5%A2%9E%E5%8A%A0%E5%AE%88%E5%8D%AB%E6%9D%A1%E4%BB%B6%EF%BC%9A%E5%A6%82%E6%9E%9Ctrigger%E8%A7%A6%E5%8F%91%E6%89%A7%E8%A1%8C%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%B8%8E%E5%BD%93%E5%89%8D%E6%AD%A3%E5%9C%A8%E6%89%A7%E8%A1%8C%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9B%B8%E5%90%8C%EF%BC%8C%E5%88%99%E4%B8%8D%E8%A7%A6%E5%8F%91%E6%89%A7%E8%A1%8C%0Afunction%20trigger(target%2C%20key)%20%7B%0A%20%20%20%20const%20depsMap%20%3D%20bucket.get(target)%3B%0A%20%20%20%20if%20(!depsMap)%20return%3B%0A%20%20%20%20const%20effects%20%3D%20depsMap.get(key)%3B%0A%20%20%20%20%0A%20%20%20%20const%20effectsToRun%20%3D%20new%20Set()%3B%20%20%20%0A%20%20%20%20effects%20%26%26%20effects.forEach((effectFn)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20if%20(effectFn%20!%3D%3D%20activeEffect)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20effectsToRun.add(effectFn)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%20%20%20%20%0A%20%20%20%20effectsToRun.forEach(effectFn%20%3D%3E%20effectFn())%0A%7D%0A%2F%2F%20%E8%BF%99%E6%A0%B7%E5%B0%B1%E8%83%BD%E9%81%BF%E5%85%8D%E6%97%A0%E9%99%90%E9%80%92%E5%BD%92%E8%B0%83%E7%94%A8%0A%60%60%60%0A%0A%23%23%23%23%20%E8%B0%83%E5%BA%A6%E6%89%A7%E8%A1%8C%0A%60%60%60js%0A%2F%2F%20%E4%B8%BAeffect%E5%87%BD%E6%95%B0%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E9%80%89%E9%A1%B9%E5%8F%82%E6%95%B0options%EF%BC%8C%E5%85%81%E8%AE%B8%E7%94%A8%E6%88%B7%E6%8C%87%E5%AE%9A%E8%B0%83%E5%BA%A6%E5%99%A8%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20console.log(obj.foo)%0A%7D%2C%20%7B%0A%20%20%20%20scheduler(fn)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%0A%7D)%0A%0A%2F%2F%20%E5%BA%94%E7%94%A8%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%BF%9E%E7%BB%AD%E4%B8%A4%E6%AC%A1%E6%9B%B4%E6%94%B9%EF%BC%8C%E5%8F%AA%E6%83%B3%E8%A6%81%E6%89%A7%E8%A1%8C%E6%9C%80%E5%90%8E%E4%B8%80%E6%AC%A1%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%0Aobj.foo%20%3D%201%3B%0Aobj.foo%2B%2B%0Aobj.foo%2B%2B%0A%2F%2F%203%0A%0Aconst%20jobQueue%20%3D%20new%20Set()%3B%0Aconst%20p%20%3D%20Promise.resolve()%3B%0A%0Alet%20isFlushing%20%3D%20false%3B%0Afunction%20flushJob()%20%7B%0A%20%20%20%20if%20(isFlushing)%20return%3B%0A%20%20%20%20isFlushing%20%3D%20true%3B%0A%20%20%20%20p.then(()%20%3D%3E%20jobQueue.forEach(job%20%3D%3E%20job()))%0A%20%20%20%20%20.finnally(()%20%3D%3E%20isFlushing%20%3D%20false)%0A%7D%0A%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20console.log(obj.foo)%0A%7D%2C%20%7B%0A%20%20%20%20scheduler(fn)%20%7B%0A%20%20%20%20%20%20%20%20jobQueue.add(fn)%3B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%B7%E6%96%B0%E9%98%9F%E5%88%97%0A%20%20%20%20%20%20%20%20flushJob()%3B%0A%20%20%20%20%7D%0A%7D)%0A%60%60%60%0A%0A%23%23%23%23%20%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7computed%E4%B8%8Elazy%0A%3E%20%E7%8E%B0%E5%9C%A8%E6%88%91%E4%BB%AC%E5%AE%9E%E7%8E%B0%E7%9A%84effect%E5%87%BD%E6%95%B0%E4%BC%9A%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C%E4%BC%A0%E9%80%92%E7%BB%99%E5%AE%83%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BD%86%E6%98%AF%E5%9C%A8%E6%9C%89%E4%BA%9B%E5%9C%BA%E6%99%AF%E4%B8%8B%E5%B9%B6%E4%B8%8D%E6%83%B3%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E5%9C%A8options%E4%B8%AD%E6%B7%BB%E5%8A%A0lazy%E5%B1%9E%E6%80%A7%0A%0A%60%60%60js%0A%2F%2F%20%E5%B0%86%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%EF%BC%8C%E8%AE%A9%E7%94%A8%E6%88%B7%E5%8F%AF%E4%BB%A5%E8%87%AA%E5%B7%B1%E5%86%B3%E5%AE%9A%E5%9C%A8%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%8E%BB%E8%B0%83%E7%94%A8%0Afunction%20effect(fn%2C%20options%3D%7B%7D)%20%7B%0A%20%20%20%20const%20effectFn%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20cleanup(effectFn)%0A%20%20%20%20%20%20%20%20activeEffect%20%3D%20effectFn%0A%20%20%20%20%20%20%20%20effectStack.push(effectFn)%0A%20%20%20%20%20%20%20%20fn()%0A%20%20%20%20%20%20%20%20effectStack.pop()%0A%20%20%20%20%20%20%20%20activeEffect%20%3D%20effectStack%5BeffectStack.length%20-%201%5D%0A%20%20%20%20%7D%0A%20%20%20%20effectFn.options%20%3D%20options%0A%20%20%20%20effectFn.deps%20%3D%20%5B%5D%0A%20%20%20%20if%20(!options.lazy)%20%7B%0A%20%20%20%20%20%20%20%20effectFn()%0A%20%20%20%20%7D%0A%20%20%20%20return%20effectFn%0A%7D%0A%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%0Afunction%20effect(fn%2C%20options%3D%7B%7D)%20%7B%0A%20%20%20%20const%20effectFn%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20cleanup(effectFn)%0A%20%20%20%20%20%20%20%20activeEffect%20%3D%20effectFn%0A%20%20%20%20%20%20%20%20effectStack.push(effectFn)%0A%20%20%20%20%20%20%20%20const%20res%20%3D%20fn()%0A%20%20%20%20%20%20%20%20effectStack.pop()%0A%20%20%20%20%20%20%20%20activeEffect%20%3D%20effectStack%5BeffectStack.length%20-%201%5D%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%BF%94%E5%9B%9E%0A%20%20%20%20%20%20%20%20return%20res%3B%0A%20%20%20%20%7D%0A%20%20%20%20effectFn.options%20%3D%20options%0A%20%20%20%20effectFn.deps%20%3D%20%5B%5D%0A%20%20%20%20if%20(!options.lazy)%20%7B%0A%20%20%20%20%20%20%20%20effectFn()%0A%20%20%20%20%7D%0A%20%20%20%20return%20effectFn%0A%7D%0A%0A%2F%2F%20%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E4%BA%86%0Afunction%20computed(getter)%20%7B%0A%20%20%20%20%2F%2F%20%E6%8A%8Agetter%E5%BD%93%E4%BD%9C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAlazy%E7%9A%84effect%0A%20%20%20%20const%20effectFn%20%3D%20effect(getter%2C%20%7B%20lazy%3A%20true%20%7D)%3B%0A%20%20%20%20const%20obj%20%3D%20%7B%0A%20%20%20%20%20%20%20%20get%20value()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20effectFn()%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20return%20obj%3B%0A%7D%0A%0A%2F%2F%20%E5%BA%94%E7%94%A8%0Aconst%20data%20%3D%20%7B%20foo%3A%201%2C%20bar%3A%202%20%7D%0Aconst%20obj%20%3D%20new%20Proxy(data%2C%20%7B%20%2F*%20...%20*%2F%20%7D)%0Aconst%20sumRes%20%3D%20computed(()%20%3D%3E%20obj.foo%20%2B%20obj.bar)%0A%0Aconsole.log(sumRes.value)%0A%0A%2F%2F%20%E4%BD%86%E6%98%AF%E7%8E%B0%E5%9C%A8%E7%9A%84%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E5%8F%AA%E5%81%9A%E5%88%B0%E4%BA%86%E6%87%92%E8%AE%A1%E7%AE%97%EF%BC%8C%E5%8F%AA%E6%9C%89%E7%9C%9F%E6%AD%A3%E8%AF%BB%E5%8F%96sumRes.value%E7%9A%84%E5%80%BC%E6%97%B6%EF%BC%8C%E6%89%8D%E4%BC%9A%E8%BF%9B%E8%A1%8C%E8%AE%A1%E7%AE%97%E5%B9%B6%E5%BE%97%E5%88%B0%E5%80%BC%E3%80%82%E4%BD%86%E6%98%AF%E8%BF%98%E5%81%9A%E4%B8%8D%E5%88%B0%E5%AF%B9%E5%80%BC%E8%BF%9B%E8%A1%8C%E7%BC%93%E5%AD%98%EF%BC%8C%E5%8D%B3%E4%BD%BF%E5%A4%9A%E6%AC%A1%E8%AE%BF%E9%97%AEsumRes.value%EF%BC%8C%E4%BC%9A%E5%AF%BC%E8%87%B4effectFn%E5%A4%9A%E6%AC%A1%E8%AE%A1%E7%AE%97%EF%BC%8C%E5%8D%B3%E4%BD%BFobj.foo%E5%92%8Cobj.bar%E5%B9%B6%E6%B2%A1%E6%9C%89%E6%94%B9%E5%8F%98%0Afunction%20computed(getter)%20%7B%0A%20%20%20%20%2F%2F%20%E7%94%A8%E6%9D%A5%E7%BC%93%E5%AD%98%E4%B8%8A%E4%B8%80%E6%AC%A1%E8%AE%A1%E7%AE%97%E7%9A%84%E5%80%BC%0A%20%20%20%20let%20value%0A%20%20%20%20%2F%2F%20dirty%E6%A0%87%E8%AF%86%EF%BC%8C%E7%94%A8%E6%9D%A5%E6%A0%87%E8%AF%86%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E8%AE%A1%E7%AE%97%E5%80%BC%EF%BC%8C%E4%B8%BAtrue%E5%88%99%E9%9C%80%E8%A6%81%0A%20%20%20%20let%20dirty%20%3D%20true%0A%0A%20%20%20%20%2F%2F%20%E6%8A%8Agetter%E5%BD%93%E4%BD%9C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAlazy%E7%9A%84effect%0A%20%20%20%20const%20effectFn%20%3D%20effect(getter%2C%20%7B%20lazy%3A%20true%20%7D)%3B%0A%20%20%20%20const%20obj%20%3D%20%7B%0A%20%20%20%20%20%20%20%20get%20value()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(dirty)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value%20%3D%20effectFn()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dirty%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20value%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20return%20obj%3B%0A%7D%0A%0A%2F%2F%20%E5%BD%93obj.foo%E6%88%96obj.bar%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E9%87%8D%E7%BD%AEdirty%E5%80%BC%E4%B8%BAtrue%0Afunction%20computed(getter)%20%7B%0A%20%20%20%20%2F%2F%20%E7%94%A8%E6%9D%A5%E7%BC%93%E5%AD%98%E4%B8%8A%E4%B8%80%E6%AC%A1%E8%AE%A1%E7%AE%97%E7%9A%84%E5%80%BC%0A%20%20%20%20let%20value%0A%20%20%20%20%2F%2F%20dirty%E6%A0%87%E8%AF%86%EF%BC%8C%E7%94%A8%E6%9D%A5%E6%A0%87%E8%AF%86%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E8%AE%A1%E7%AE%97%E5%80%BC%EF%BC%8C%E4%B8%BAtrue%E5%88%99%E9%9C%80%E8%A6%81%0A%20%20%20%20let%20dirty%20%3D%20true%0A%0A%20%20%20%20%2F%2F%20%E6%8A%8Agetter%E5%BD%93%E4%BD%9C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAlazy%E7%9A%84effect%0A%20%20%20%20const%20effectFn%20%3D%20effect(getter%2C%20%7B%0A%20%20%20%20%20%20%20%20lazy%3A%20true%2C%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%B7%BB%E5%8A%A0%E8%B0%83%E5%BA%A6%E5%99%A8%EF%BC%8C%E5%9C%A8%E8%B0%83%E5%BA%A6%E5%99%A8%E4%B8%AD%E5%B0%86dirty%E9%87%8D%E7%BD%AE%E4%B8%BAtrue%0A%20%20%20%20%20%20%20%20scheduler()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20dirty%20%3D%20true%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%20%20const%20obj%20%3D%20%7B%0A%20%20%20%20%20%20%20%20get%20value()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(dirty)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value%20%3D%20effectFn()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dirty%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20value%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20return%20obj%3B%0A%7D%0A%0A%2F%2F%20%E7%8E%B0%E5%9C%A8%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AA%E7%BC%BA%E9%99%B7%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%88%91%E4%BB%AC%E5%9C%A8%E5%8F%A6%E5%A4%96%E4%B8%80%E4%B8%AAeffect%E4%B8%AD%E8%AF%BB%E5%8F%96%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC%E6%97%B6%0A%2F%2F%20%E5%8E%9F%E5%9B%A0%EF%BC%9A%0A%2F%2F%20%E6%9C%AC%E8%B4%A8%E4%B8%8A%E8%BF%99%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AAeffect%E5%B5%8C%E5%A5%97%E3%80%82%E4%B8%80%E4%B8%AA%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E5%86%85%E9%83%A8%E6%8B%A5%E6%9C%89%E8%87%AA%E5%B7%B1%E7%9A%84effect%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%AE%83%E6%98%AF%E6%87%92%E6%89%A7%E8%A1%8C%E7%9A%84%E3%80%82%E5%A4%96%E5%B1%82%E7%9A%84effect%E4%B8%8D%E4%BC%9A%E8%A2%AB%E5%86%85%E5%B1%82effect%E4%B8%AD%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86%0Aconst%20sumRes%20%3D%20computed(()%20%3D%3E%20obj.foo%20%2B%20obj.bar)%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20console.log(sumRes.value)%0A%7D)%3B%0A%2F%2F%20%E5%BD%93obj.foo%E6%94%B9%E5%8F%98%E6%97%B6%EF%BC%8C%E5%B9%B6%E4%B8%8D%E4%BC%9A%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0effect%E6%89%A7%E8%A1%8C%0Aobj.foo%2B%2B%0A%0A%2F%2F%20%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%0A%2F%2F%20%E8%AF%BB%E5%8F%96%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC%E6%97%B6%EF%BC%8C%E6%89%8B%E5%8A%A8%E8%B0%83%E7%94%A8track%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E8%BF%BD%E8%B8%AA%EF%BC%8C%E5%BD%93%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E4%BE%9D%E8%B5%96%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E6%89%8B%E5%8A%A8%E8%B0%83%E7%94%A8trigger%E5%87%BD%E6%95%B0%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%0Afunction%20computed(getter)%20%7B%0A%20%20%20%20%2F%2F%20%E7%94%A8%E6%9D%A5%E7%BC%93%E5%AD%98%E4%B8%8A%E4%B8%80%E6%AC%A1%E8%AE%A1%E7%AE%97%E7%9A%84%E5%80%BC%0A%20%20%20%20let%20value%0A%20%20%20%20%2F%2F%20dirty%E6%A0%87%E8%AF%86%EF%BC%8C%E7%94%A8%E6%9D%A5%E6%A0%87%E8%AF%86%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E8%AE%A1%E7%AE%97%E5%80%BC%EF%BC%8C%E4%B8%BAtrue%E5%88%99%E9%9C%80%E8%A6%81%0A%20%20%20%20let%20dirty%20%3D%20true%0A%0A%20%20%20%20%2F%2F%20%E6%8A%8Agetter%E5%BD%93%E4%BD%9C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAlazy%E7%9A%84effect%0A%20%20%20%20const%20effectFn%20%3D%20effect(getter%2C%20%7B%0A%20%20%20%20%20%20%20%20lazy%3A%20true%2C%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%B7%BB%E5%8A%A0%E8%B0%83%E5%BA%A6%E5%99%A8%EF%BC%8C%E5%9C%A8%E8%B0%83%E5%BA%A6%E5%99%A8%E4%B8%AD%E5%B0%86dirty%E9%87%8D%E7%BD%AE%E4%B8%BAtrue%0A%20%20%20%20%20%20%20%20scheduler()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(!dirty)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20dirty%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20trigger(obj%2C%20'value')%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%3B%0A%20%20%20%20const%20obj%20%3D%20%7B%0A%20%20%20%20%20%20%20%20get%20value()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(dirty)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value%20%3D%20effectFn()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dirty%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20track(obj%2C%20'value')%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20value%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20return%20obj%3B%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20watch%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%0A%3E%20%E6%89%80%E8%B0%93watch%EF%BC%8C%E5%85%B6%E6%9C%AC%E8%B4%A8%E5%B0%B1%E6%98%AF%E8%A7%82%E6%B5%8B%E4%B8%80%E4%B8%AA%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%BD%93%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%E9%80%9A%E7%9F%A5%E5%B9%B6%E6%89%A7%E8%A1%8C%E5%93%8D%E5%BA%94%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%0A%3E%20%E5%AE%9E%E7%8E%B0%E6%9C%AC%E8%B4%A8%E4%B8%8A%E5%B0%B1%E6%98%AF%E5%88%A9%E7%94%A8%E4%BA%86effect%E4%BB%A5%E5%8F%8Aoptions.scheduler%E9%80%89%E9%A1%B9%0A%0A%60%60%60js%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8scheduler%E9%80%89%E9%A1%B9%EF%BC%8C%E5%BD%93%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E4%BC%9A%E8%A7%A6%E5%8F%91scheduler%E8%B0%83%E5%BA%A6%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%EF%BC%8C%E8%80%8C%E9%9D%9E%E7%9B%B4%E6%8E%A5%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20console.log(obj.foo)%0A%7D%2C%20%7B%0A%20%20%20%20scheduler()%20%7B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%0A%7D)%0A%0A%2F%2F%201.%E7%AE%80%E6%98%93%E7%89%88watch%0Afunction%20watch(source%2C%20cb)%20%7B%0A%20%20%20%20effect(()%20%3D%3E%20source.foo%2C%20%7B%0A%20%20%20%20%20%20%20%20scheduler()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%95%B0%E6%8D%AE%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E8%B0%83%E7%94%A8%E6%AF%81%E6%8E%89%E5%87%BD%E6%95%B0cb%0A%20%20%20%20%20%20%20%20%20%20%20%20cb()%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%0A%2F%2F%201%E4%B8%AD%E7%A1%AC%E7%BC%96%E7%A0%81%E4%BA%86source.foo%EF%BC%8C%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%B0%81%E8%A3%85%0A%0A%2F%2F%202.traverse%0Afunction%20watch(source%2C%20cb)%20%7B%0A%20%20%20%20effect(()%20%3D%3E%20traverse(source)%2C%20%7B%0A%20%20%20%20%20%20%20%20scheduler()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%95%B0%E6%8D%AE%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E8%B0%83%E7%94%A8%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0cb%0A%20%20%20%20%20%20%20%20%20%20%20%20cb()%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%2F%2F%20%E9%80%92%E5%BD%92%E8%AF%BB%E5%8F%96%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%BD%93%E4%BB%BB%E6%84%8F%E5%B1%9E%E6%80%A7%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%E9%83%BD%E8%83%BD%E5%A4%9F%E8%A7%A6%E5%8F%91%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%0Afunction%20traverse(value%2C%20seen%20%3D%20new%20Set())%20%7B%0A%20%20%20%20if%20(typeof%20value%20!%3D%3D%20'object'%20%7C%7C%20value%20%3D%3D%3D%20null%20%7C%7C%20seen.has(value))%20return%0A%20%20%20%20%0A%20%20%20%20seen.add(value)%0A%20%20%20%20for(const%20k%20in%20value)%20%7B%0A%20%20%20%20%20%20%20%20traverse(value%5Bk%5D%2C%20seen)%0A%20%20%20%20%7D%0A%20%20%20%20return%20value%0A%7D%0A%0A%2F%2F%203.watch%E6%8E%A5%E6%94%B6%E4%B8%80%E4%B8%AAgetter%E5%87%BD%E6%95%B0%0Afunction%20watch(source%2C%20cb)%20%7B%0A%20%20%20%20let%20getter%0A%20%20%20%20if%20(typeof%20source%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20source%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20()%20%3D%3E%20traverse(source)%0A%20%20%20%20%7D%0A%20%20%20%20effect(()%20%3D%3E%20getter()%2C%20%7B%0A%20%20%20%20%20%20%20%20scheduler()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%95%B0%E6%8D%AE%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E8%B0%83%E7%94%A8%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0cb%0A%20%20%20%20%20%20%20%20%20%20%20%20cb()%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%0A%2F%2F%204.%E5%9C%A8%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E4%B8%AD%E6%8B%BF%E5%88%B0%E6%96%B0%E5%80%BC%E5%92%8C%E6%97%A7%E5%80%BC%0Afunction%20watch(source%2C%20cb)%20%7B%0A%20%20%20%20let%20getter%0A%20%20%20%20if%20(typeof%20source%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20source%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20()%20%3D%3E%20traverse(source)%0A%20%20%20%20%7D%0A%20%20%20%20let%20oldValue%2C%20newValue%0A%20%20%20%20const%20effectFn%20%3D%20effect(()%20%3D%3E%20getter()%2C%20%7B%0A%20%20%20%20%20%20%20%20lazy%3A%20true%2C%0A%20%20%20%20%20%20%20%20scheduler()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E8%8E%B7%E5%8F%96%E6%96%B0%E5%80%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20newValue%20%3D%20effectFn()%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%95%B0%E6%8D%AE%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E8%B0%83%E7%94%A8%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0cb%0A%20%20%20%20%20%20%20%20%20%20%20%20cb(newValue%2C%20oldValue)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%9B%B4%E6%96%B0%E6%97%A7%E5%80%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20oldValue%20%3D%20newValue%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%20%20%20%20%2F%2F%20%E6%89%8B%E5%8A%A8%E8%B0%83%E7%94%A8%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%8B%BF%E5%88%B0%E6%97%A7%E5%80%BC%0A%20%20%20%20oldValue%20%3D%20effectFn()%0A%7D%0A%0A%2F%2F%205.%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C%E7%9A%84watch%0Awatch(obj%2C%20()%20%3D%3E%20%7B%20console.log('%E5%8F%98%E5%8C%96%E4%BA%86')%20%7D%2C%20%7B%0A%20%20%20%20immediate%3A%20true%0A%7D)%0Afunction%20watch(source%2C%20cb%2C%20options%20%3D%20%7B%7D)%20%7B%0A%20%20%20%20let%20getter%0A%20%20%20%20if%20(typeof%20source%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20source%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20()%20%3D%3E%20traverse(source)%0A%20%20%20%20%7D%0A%20%20%20%20let%20oldValue%2C%20newValue%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E6%8F%90%E5%8F%96scheduler%E8%B0%83%E5%BA%A6%E5%87%BD%E6%95%B0%E4%B8%BA%E4%B8%80%E4%B8%AA%E7%8B%AC%E7%AB%8B%E7%9A%84job%E5%87%BD%E6%95%B0%0A%20%20%20%20const%20job%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20newValue%20%3D%20effectFn()%3B%0A%20%20%20%20%20%20%20%20cb(newValue%2C%20oldValue)%3B%0A%20%20%20%20%20%20%20%20oldValue%20%3D%20newValue%3B%0A%20%20%20%20%7D%0A%20%20%20%20const%20effectFn%20%3D%20effect(()%20%3D%3E%20getter()%2C%20%7B%0A%20%20%20%20%20%20%20%20lazy%3A%20true%2C%0A%20%20%20%20%20%20%20%20scheduler%3A%20job%0A%20%20%20%20%7D)%0A%20%20%20%20if%20(options.immediate)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8Cjob%EF%BC%8C%E4%BB%8E%E8%80%8C%E8%A7%A6%E5%8F%91%E5%9B%9E%E8%B0%83%E6%89%A7%E8%A1%8C%0A%20%20%20%20%20%20%20%20job()%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%89%8B%E5%8A%A8%E8%B0%83%E7%94%A8%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%8B%BF%E5%88%B0%E6%97%A7%E5%80%BC%0A%20%20%20%20%20%20%20%20oldValue%20%3D%20effectFn()%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%206.%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%9A%84%E6%89%A7%E8%A1%8C%E6%97%B6%E6%9C%BA%0A%2F%2F%20%E9%80%9A%E8%BF%87flush%E9%80%89%E9%A1%B9%E6%9D%A5%E6%8C%87%E5%AE%9A%0Awatch(obj%2C%20()%20%3D%3E%20%7B%20console.log('%E5%8F%98%E5%8C%96%E4%BA%86')%20%7D%2C%20%7B%0A%20%20%20%20flush%3A%20'pre'%20%2F%2F%20%E8%BF%98%E5%8F%AF%E4%BB%A5%E6%8C%87%E5%AE%9A%20'post'%20%7C%20'sync'%0A%7D)%0A%2F%2F%20pre%E4%BB%A3%E8%A1%A8%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0%E5%89%8D%0A%2F%2F%20post%E4%BB%A3%E8%A1%A8%E8%B0%83%E5%BA%A6%E5%87%BD%E6%95%B0%E9%9C%80%E8%A6%81%E5%B0%86%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%94%BE%E5%88%B0%E4%B8%80%E4%B8%AA%E5%BE%AE%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%E4%B8%AD%EF%BC%8C%E5%B9%B6%E7%AD%89%E5%BE%85DOM%E6%9B%B4%E6%96%B0%E7%BB%93%E6%9D%9F%E5%90%8E%E5%86%8D%E6%89%A7%E8%A1%8C%0Afunction%20watch(source%2C%20cb%2C%20options%20%3D%20%7B%7D)%20%7B%0A%20%20%20%20let%20getter%0A%20%20%20%20if%20(typeof%20source%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20source%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20()%20%3D%3E%20traverse(source)%0A%20%20%20%20%7D%0A%20%20%20%20let%20oldValue%2C%20newValue%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E6%8F%90%E5%8F%96scheduler%E8%B0%83%E5%BA%A6%E5%87%BD%E6%95%B0%E4%B8%BA%E4%B8%80%E4%B8%AA%E7%8B%AC%E7%AB%8B%E7%9A%84job%E5%87%BD%E6%95%B0%0A%20%20%20%20const%20job%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20newValue%20%3D%20effectFn()%3B%0A%20%20%20%20%20%20%20%20cb(newValue%2C%20oldValue)%3B%0A%20%20%20%20%20%20%20%20oldValue%20%3D%20newValue%3B%0A%20%20%20%20%7D%0A%20%20%20%20const%20effectFn%20%3D%20effect(()%20%3D%3E%20getter()%2C%20%7B%0A%20%20%20%20%20%20%20%20lazy%3A%20true%2C%0A%20%20%20%20%20%20%20%20scheduler%3A%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(options.flush%20%3D%3D%3D%20'post')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20p%20%3D%20Promise.resolve()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20p.then(job)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20job()%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%20%20%20%20if%20(options.immediate)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8Cjob%EF%BC%8C%E4%BB%8E%E8%80%8C%E8%A7%A6%E5%8F%91%E5%9B%9E%E8%B0%83%E6%89%A7%E8%A1%8C%0A%20%20%20%20%20%20%20%20job()%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%89%8B%E5%8A%A8%E8%B0%83%E7%94%A8%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%8B%BF%E5%88%B0%E6%97%A7%E5%80%BC%0A%20%20%20%20%20%20%20%20oldValue%20%3D%20effectFn()%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E8%BF%87%E6%9C%9F%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%0A%3E%20%E7%AB%9E%E6%80%81%E9%97%AE%E9%A2%98%0A%60%60%60js%0Alet%20finalData%0Awatch(obj%2C%20async%20()%20%3D%3E%20%7B%0A%20%20%20%20const%20res%20%3D%20await%20fetch('%2Fpath%2Fto%2Frequest')%0A%20%20%20%20finalData%20%3D%20res%0A%7D)%0A%0A%2F%2F%20%E5%81%87%E8%AE%BE%E7%AC%AC%E4%B8%80%E6%AC%A1%E4%BF%AE%E6%94%B9obj%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9F%90%E4%B8%AA%E5%AD%97%E6%AE%B5%E5%80%BC%EF%BC%8C%E8%BF%99%E4%BC%9A%E5%AF%BC%E8%87%B4%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%90%8C%E6%97%B6%E5%8F%91%E9%80%81%E4%BA%86%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82A%0A%2F%2F%20%E5%9C%A8%E8%AF%B7%E6%B1%82A%E7%9A%84%E7%BB%93%E6%9E%9C%E8%BF%94%E5%9B%9E%E4%B9%8B%E5%89%8D%EF%BC%8C%E5%AF%B9obj%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9F%90%E4%B8%AA%E5%AD%97%E6%AE%B5%E8%BF%9B%E8%A1%8C%E7%AC%AC%E4%BA%8C%E6%AC%A1%E4%BF%AE%E6%94%B9%EF%BC%8C%E8%BF%99%E4%BC%9A%E5%AF%BC%E8%87%B4%E5%8F%91%E9%80%81%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AF%B7%E6%B1%82B%0A%2F%2F%20%E6%AD%A4%E6%97%B6A%E5%92%8CB%E9%83%BD%E5%9C%A8%E8%BF%9B%E8%A1%8C%E4%B8%AD%EF%BC%8C%E5%B9%B6%E4%B8%8D%E8%83%BD%E7%A1%AE%E5%AE%9A%E5%93%AA%E4%B8%80%E4%B8%AA%E8%AF%B7%E6%B1%82%E4%BC%9A%E5%85%88%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%AF%B7%E6%B1%82B%E5%85%88%E4%BA%8E%E8%AF%B7%E6%B1%82A%EF%BC%8C%E9%82%A3%E4%B9%88finalData%E6%9C%80%E5%90%8E%E5%AD%98%E5%82%A8%E7%9A%84%E4%BA%8BA%E8%AF%B7%E6%B1%82%E7%9A%84%E7%BB%93%E6%9E%9C%EF%BC%8C%E4%BD%86%E6%98%AF%E5%AE%9E%E9%99%85B%E8%AF%B7%E6%B1%82%E8%BF%94%E5%9B%9E%E7%9A%84%E6%95%B0%E6%8D%AE%E6%89%8D%E6%98%AF%22%E6%9C%80%E6%96%B0%E7%9A%84%22%0A%0A%2F%2F%20%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E4%B8%80%E4%B8%AA%E8%AE%A9%E5%89%AF%E4%BD%9C%E7%94%A8%E8%BF%87%E6%9C%9F%E7%9A%84%E6%89%8B%E6%AE%B5%0A%2F%2F%20%E5%9C%A8Vue.js%E4%B8%AD%EF%BC%8Cwatch%E5%87%BD%E6%95%B0%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E6%8E%A5%E5%8F%97%E7%AC%AC%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0onInvalidate%EF%BC%8C%E5%AE%83%E6%98%AF%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%8C%E7%B1%BB%E4%BC%BC%E4%BA%8E%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8onInvalidate%E5%87%BD%E6%95%B0%E6%B3%A8%E5%86%8C%E4%B8%80%E4%B8%AA%E5%9B%9E%E8%B0%83%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E4%BC%9A%E5%9C%A8%E5%BD%93%E5%89%8D%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E8%BF%87%E6%9C%9F%E6%97%B6%E6%89%A7%E8%A1%8C%EF%BC%9A%0Awatch(obj%2C%20async%20(newValue%2C%20oldValue%2C%20onInvalidate)%20%3D%3E%20%7B%0A%20%20%20%20let%20expired%20%3D%20false%0A%20%20%20%20%0A%20%20%20%20onInvalidate(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20expired%20%3D%20true%0A%20%20%20%20%7D)%0A%20%20%20%20%0A%20%20%20%20const%20res%20%3D%20await%20fetch('%2Fpath%2Fto%2Frequest')%0A%20%20%20%20if%20(!expired)%20%7B%0A%20%20%20%20%20%20%20%20finalData%20%3D%20res%0A%20%20%20%20%7D%0A%7D)%0A%0A%2F%2F%20%E5%8E%9F%E7%90%86%0Afunction%20watch(source%2C%20cb%2C%20options%20%3D%20%7B%7D)%20%7B%0A%20%20%20%20let%20getter%0A%20%20%20%20if%20(typeof%20source%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20source%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20getter%20%3D%20()%20%3D%3E%20traverse(source)%0A%20%20%20%20%7D%0A%20%20%20%20let%20oldValue%2C%20newValue%0A%20%20%20%20%2F%2F%20%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E7%9A%84%E8%BF%87%E6%9C%9F%E5%9B%9E%E8%B0%83%0A%20%20%20%20let%20cleanup%0A%20%20%20%20function%20onInvalidate(fn)%20%7B%0A%20%20%20%20%20%20%20%20cleanup%20%3D%20fn%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E6%8F%90%E5%8F%96scheduler%E8%B0%83%E5%BA%A6%E5%87%BD%E6%95%B0%E4%B8%BA%E4%B8%80%E4%B8%AA%E7%8B%AC%E7%AB%8B%E7%9A%84job%E5%87%BD%E6%95%B0%0A%20%20%20%20const%20job%20%3D%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20newValue%20%3D%20effectFn()%3B%0A%20%20%20%20%20%20%20%20if%20(cleanup)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20cleanup()%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20cb(newValue%2C%20oldValue%2C%20onInvalidate)%3B%0A%20%20%20%20%20%20%20%20oldValue%20%3D%20newValue%3B%0A%20%20%20%20%7D%0A%20%20%20%20const%20effectFn%20%3D%20effect(()%20%3D%3E%20getter()%2C%20%7B%0A%20%20%20%20%20%20%20%20lazy%3A%20true%2C%0A%20%20%20%20%20%20%20%20scheduler%3A%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(options.flush%20%3D%3D%3D%20'post')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20p%20%3D%20Promise.resolve()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20p.then(job)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20job()%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%20%20%20%20if%20(options.immediate)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8Cjob%EF%BC%8C%E4%BB%8E%E8%80%8C%E8%A7%A6%E5%8F%91%E5%9B%9E%E8%B0%83%E6%89%A7%E8%A1%8C%0A%20%20%20%20%20%20%20%20job()%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%89%8B%E5%8A%A8%E8%B0%83%E7%94%A8%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E6%8B%BF%E5%88%B0%E6%97%A7%E5%80%BC%0A%20%20%20%20%20%20%20%20oldValue%20%3D%20effectFn()%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%20%E7%AC%AC5%E7%AB%A0%E3%80%8A%E9%9D%9E%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%96%B9%E6%A1%88%E3%80%8B%0A%0A%23%23%23%23%20%E7%90%86%E8%A7%A3Proxy%E5%92%8CReflect%0A%3E%20Proxy%E5%8F%AF%E4%BB%A5%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%AE%83%E8%83%BD%E5%A4%9F%E5%AE%9E%E7%8E%B0%E5%AF%B9**%E5%85%B6%E4%BB%96%E5%AF%B9%E8%B1%A1**%E7%9A%84%E4%BB%A3%E7%90%86%EF%BC%8C%E5%AE%83%E5%85%81%E8%AE%B8%E6%88%91%E4%BB%AC**%E6%8B%A6%E6%88%AA**%E5%B9%B6**%E9%87%8D%E6%96%B0%E5%AE%9A%E4%B9%89**%E5%AF%B9%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%0A%3E%20Proxy%E5%8F%AA%E8%83%BD%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%EF%BC%8C%E4%B8%8D%E8%83%BD%E4%BB%A3%E7%90%86%E9%9D%9E%E5%AF%B9%E8%B1%A1%E5%80%BC(%E5%AD%97%E7%AC%A6%E4%B8%B2%E3%80%81%E5%B8%83%E5%B0%94%E5%80%BC...)%0A%0A%60%60%60js%0Aconst%20p%20%3D%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20get()%20%7B%7D%0A%20%20%20%20set()%20%7B%7D%0A%7D)%0Aconst%20p2%20%3D%20new%20Proxy(fn%2C%20%7B%0A%20%20%20%20%2F%2F%20%E4%BD%BF%E7%94%A8apply%E6%8B%A6%E6%88%AA%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%0A%20%20%20%20apply(target%2C%20thisArg%2C%20argArray)%20%7B%0A%20%20%20%20%20%20%20%20target.call(thisArg%2C%20...argArray)%0A%20%20%20%20%7D%0A%7D)%0A%60%60%60%0A%0A%3E%20Reflect%E6%98%AF%E4%B8%80%E4%B8%AA%E5%85%A8%E5%B1%80%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%85%B6%E4%B8%8B%E6%9C%89%E8%AE%B8%E5%A4%9A%E6%96%B9%E6%B3%95(Reflect.get()%2C%20Reflect.apply()...)%0A%3E%20Reflect%E5%8F%AF%E4%BB%A5%E6%8E%A5%E6%94%B6%E7%AC%AC%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0**receiver**%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%8A%8A%E5%AE%83%E7%90%86%E8%A7%A3%E4%B8%BA%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84this%0A%60%60%60js%0Aconst%20obj%20%3D%20%7B%20foo%3A%201%20%7D%0Aconsole.log(obj.foo)%20%2F%2F%201%0Aconsole.log(Reflect.get(obj%2C%20'foo'))%20%2F%2F%201%0A%0Aconst%20obj%20%3D%20%7B%20foo%3A%201%20%7D%0Aconsole.log(Reflect.get(obj%2C%20'foo'%2C%20%7B%20foo%3A%202%20%7D))%20%2F%2F%20%E8%BE%93%E5%87%BA2%E8%80%8C%E4%B8%8D%E6%98%AF1%0A%0A%2F%2F%20%E9%97%AE%E9%A2%98%0Aconst%20obj%20%3D%20%7B%0A%20%20%20%20foo%3A%201%2C%0A%20%20%20%20get%20bar()%20%7B%0A%20%20%20%20%20%20%20%20return%20this.foo%0A%20%20%20%20%7D%0A%7D%0Aconst%20p%20%3D%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20get(target%2C%20key)%20%7B%0A%20%20%20%20%20%20%20%20track(target%2C%20key)%0A%20%20%20%20%20%20%20%20return%20target%5Bkey%5D%0A%20%20%20%20%7D%2C%0A%20%20%20%20set(target%2C%20key%2C%20newVal)%20%7B%0A%20%20%20%20%20%20%20%20target%5Bkey%5D%20%3D%20newVal%0A%20%20%20%20%20%20%20%20trigger(target%2C%20key)%0A%20%20%20%20%7D%0A%7D)%0A%2F%2F%20%E8%BF%99%E9%87%8C%E8%AE%BF%E9%97%AEp.bar%EF%BC%8C%E4%BC%9A%E8%B0%83%E7%94%A8getter%E5%87%BD%E6%95%B0%EF%BC%8C%E8%80%8Cgetter%E5%87%BD%E6%95%B0%E8%AE%BF%E9%97%AE%E4%BA%86this.foo%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%88%91%E4%BB%AC%E8%AE%A4%E4%B8%BA%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E5%92%8Cfoo%E4%B9%8B%E9%97%B4%E4%B9%9F%E4%BC%9A%E5%BB%BA%E7%AB%8B%E8%81%94%E7%B3%BB%EF%BC%8C%E5%BD%93%E6%88%91%E4%BB%AC%E4%BF%AE%E6%94%B9p.foo%E6%97%B6%EF%BC%8C%E4%B9%9F%E4%BC%9A%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%0Aeffect(()%20%3D%3E%20%7B%20console.log(p.bar)%20%7D)%0A%2F%2F%20%E4%BD%86%E6%98%AF%E5%BD%93%E6%89%A7%E8%A1%8Cp.foo%2B%2B%E6%97%B6%EF%BC%8C%E5%B9%B6%E6%B2%A1%E6%9C%89%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%0Ap.foo%2B%2B%0A%0A%2F%2F%20%E5%8E%9F%E5%9B%A0%0A%2F%2F%20%E6%9C%80%E5%BC%80%E5%A7%8B%E8%AE%BF%E9%97%AEp.bar%E6%97%B6%EF%BC%8C%E9%80%9A%E8%BF%87target%5Bkey%5D%E8%BF%94%E5%9B%9E%EF%BC%8C%E5%B0%B1%E7%9B%B8%E5%BD%93%E4%BA%8Eobj.bar%EF%BC%8C%E5%9B%A0%E6%AD%A4%EF%BC%8C%E5%BD%93%E6%88%91%E4%BB%AC%E4%BD%BF%E7%94%A8p.bar%E8%AE%BF%E9%97%AEbar%E5%B1%9E%E6%80%A7%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%AE%83%E5%86%85%E9%83%A8this%E6%8C%87%E5%90%91%E7%9A%84%E6%98%AFobj%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%9C%80%E7%BB%88%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AFobj.foo%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AFp.foo%EF%BC%8C%E6%89%80%E6%9C%89%E5%B9%B6%E6%B2%A1%E6%9C%89%E5%BB%BA%E7%AB%8Bfoo%E5%92%8C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E8%81%94%E7%B3%BB%0A%0A%2F%2F%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%20Reflect%0Aconst%20p%20%3D%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20get(target%2C%20key%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20track(target%2C%20key)%0A%20%20%20%20%20%20%20%20return%20Reflect.get(target%2C%20key%2C%20receiver)%0A%20%20%20%20%7D%0A%7D)%0A%2F%2F%20%E8%BF%99%E9%87%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%B8%AD%E8%AE%BF%E9%97%AEp.bar%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%9C%A8%E8%BF%99%E9%87%8Creceiver%E5%B0%B1%E6%98%AFp%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BD%BF%E7%94%A8Reflect.get(target%2C%20key%2C%20receiver)%E8%AE%BF%E9%97%AE%EF%BC%8Cthis%E5%B0%B1%E4%BB%8E%E5%8E%9F%E6%9D%A5%E7%9A%84obj%E5%8F%98%E6%88%90%E4%BA%86%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1p%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%B0%B1%E5%BB%BA%E7%AB%8B%E4%BA%86%E5%93%8D%E5%BA%94%E5%BC%8F%E8%81%94%E7%B3%BB%0A%60%60%60%0A%0A%23%23%23%23%20Javascript%E5%AF%B9%E8%B1%A1%E5%8F%8AProxy%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%0A%3E%20%E5%9C%A8JavaScript%E4%B8%AD%E6%9C%89%E4%B8%A4%E7%A7%8D%E5%AF%B9%E8%B1%A1%EF%BC%8C%E4%B8%80%E7%A7%8D%E5%8F%AB**%E5%B8%B8%E8%A7%84%E5%AF%B9%E8%B1%A1**%EF%BC%8C%E4%B8%80%E7%A7%8D%E5%8F%AB%E5%81%9A**%E5%BC%82%E8%B4%A8%E5%AF%B9%E8%B1%A1**%0A%3E%20%E4%BB%BB%E4%BD%95%E4%B8%8D%E5%B1%9E%E4%BA%8E%E5%B8%B8%E8%A7%84%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AF%B9%E8%B1%A1%E9%83%BD%E6%98%AF%E5%BC%82%E8%B4%A8%E5%AF%B9%E8%B1%A1%0A%0A%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%88%86%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1obj%E6%98%AF%E6%99%AE%E9%80%9A%E5%AF%B9%E8%B1%A1%E8%BF%98%E6%98%AF%E5%87%BD%E6%95%B0%EF%BC%9A%0A%E5%AF%B9%E8%B1%A1%E5%BF%85%E8%A6%81%E7%9A%84%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%EF%BC%9A%0A-%20%5B%5BGetPrototypeOf%5D%5D%0A-%20%5B%5BSetPrototypeOf%5D%5D%0A-%20%5B%5BIsExtensible%5D%5D%0A-%20%5B%5BPreventExtensions%5D%5D%0A-%20%5B%5BGetOwnProperty%5D%5D%0A-%20%5B%5BDefineOwnProperty%5D%5D%0A-%20%5B%5BHasProperty%5D%5D%0A-%20%5B%5BGet%5D%5D%0A-%20%5B%5BSet%5D%5D%0A-%20%5B%5BDelete%5D%5D%0A-%20%5B%5BOwnPropertyKeys%5D%5D%0A%E9%99%A4%E6%AD%A4%E4%B9%8B%E5%A4%96%EF%BC%8C%E8%BF%98%E6%9C%89%E4%B8%A4%E4%B8%AA%E9%A2%9D%E5%A4%96%E7%9A%84%E5%BF%85%E8%A6%81%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%EF%BC%9A%0A-%20%5B%5BCall%5D%5D%0A-%20%5B%5BConstruct%5D%5D%0A%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E9%9C%80%E8%A6%81%E4%BD%9C%E4%B8%BA%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%EF%BC%8C%E9%82%A3%E4%B9%88%E8%BF%99%E4%B8%AA%E5%AF%B9%E8%B1%A1%E5%B0%B1%E5%BF%85%E9%A1%BB%E9%83%A8%E7%BD%B2%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%5B%5BCall%5D%5D%EF%BC%8C%E5%9B%A0%E6%AD%A4**%E5%87%BD%E6%95%B0%E5%AF%B9%E8%B1%A1%E4%BC%9A%E9%83%A8%E7%BD%B2%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%5B%5BCall%5D%5D%EF%BC%8C%E8%80%8C%E6%99%AE%E9%80%9A%E5%AF%B9%E8%B1%A1%E5%88%99%E4%B8%8D%E4%BC%9A**%0A%0A%0A%23%23%23%23%20%E5%A6%82%E4%BD%95%E4%BB%A3%E7%90%86Object%0A%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E5%AF%B9%E8%B1%A1%E6%89%80%E6%9C%89%E5%8F%AF%E8%83%BD%E7%9A%84%E8%AF%BB%E5%8F%96%E6%93%8D%E4%BD%9C%EF%BC%9A%0A-%20%E8%AE%BF%E9%97%AE%E5%B1%9E%E6%80%A7%EF%BC%9Aobj.foo%0A-%20%E5%88%A4%E6%96%AD%E5%AF%B9%E8%B1%A1%E6%88%96%E5%8E%9F%E5%9E%8B%E4%B8%8A%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E7%BB%99%E5%AE%9A%E7%9A%84key%EF%BC%9Akey%20in%20obj%0A-%20%E4%BD%BF%E7%94%A8for...in%E5%BE%AA%E7%8E%AF%E9%81%8D%E5%8E%86%E5%AF%B9%E8%B1%A1%EF%BC%9Afor(const%20key%20in%20obj)%20%7B%7D%0A%0A%E8%BF%99%E9%87%8C%E7%9A%84%E6%8B%A6%E6%88%AA%E6%96%B9%E5%BC%8F%EF%BC%9A%0A-%20%E8%AE%BF%E9%97%AE%E5%B1%9E%E6%80%A7%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8proxy%E7%9A%84get%E6%9D%A5%E6%8B%A6%E6%88%AA%0A-%20in%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84%E8%AE%BF%E9%97%AE%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87proxy%E7%9A%84has%E6%9D%A5%E6%8B%A6%E6%88%AA%0A-%20for....in%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87proxy%E7%9A%84ownKeys%E6%9D%A5%E6%8B%A6%E6%88%AA%0A%0A%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E9%92%88%E5%AF%B9%E4%B8%8D%E5%90%8C%E6%83%85%E5%86%B5%E8%BF%9B%E8%A1%8C%E6%8B%A6%E6%88%AA%EF%BC%9A%0A-%20%E4%BF%AE%E6%94%B9%EF%BC%9A%E4%BD%BF%E7%94%A8set%E6%AD%A3%E5%B8%B8%E6%8B%A6%E6%88%AA%0A-%20%E6%96%B0%E5%A2%9E%EF%BC%9A%E4%BD%BF%E7%94%A8set%EF%BC%8C%E8%AE%B0%E5%BD%95ITERATE_KEY%EF%BC%8C%E5%BD%93%E6%96%B0%E5%A2%9E%E5%B1%9E%E6%80%A7%E6%97%B6%EF%BC%8C%E8%A7%A6%E5%8F%91%E4%B8%8EITERATE_KEY%E7%9B%B8%E5%85%B3%E8%81%94%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%0A-%20%E5%88%A0%E9%99%A4%EF%BC%9A%E4%BD%BF%E7%94%A8deleteProperty%E6%8B%A6%E6%88%AA%EF%BC%8C%E5%8F%AA%E6%9C%89%E5%BD%93%E8%A2%AB%E5%88%A0%E9%99%A4%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E5%AF%B9%E8%B1%A1%E8%87%AA%E5%B7%B1%E7%9A%84%E5%B1%9E%E6%80%A7%E5%B9%B6%E4%B8%94%E6%88%90%E5%8A%9F%E5%88%A0%E9%99%A4%E6%97%B6%E6%89%8D%E8%A7%A6%E5%8F%91%E6%9B%B4%E6%96%B0%0A%0A%23%23%23%23%23%20%E5%90%88%E7%90%86%E5%9C%B0%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%0A%3E%20%E6%83%B3%E8%A6%81%E5%90%88%E7%90%86%E7%9A%84%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E6%98%8E%E7%A1%AE%E7%9A%84%E7%9F%A5%E9%81%93%E6%93%8D%E4%BD%9C%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%98%AFADD%E8%BF%98%E6%98%AFSET%E6%8A%91%E6%88%96%E6%98%AF%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C%E7%B1%BB%E5%9E%8B%EF%BC%8C%E4%BB%8E%E8%80%8C%E6%AD%A3%E7%A1%AE%E5%9C%B0%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%0A%0A-%20%E5%BD%93%E5%80%BC%E6%B2%A1%E6%9C%89%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E5%BA%94%E8%AF%A5%E4%B8%8D%E9%9C%80%E8%A6%81%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%0A-%20%E4%BB%8E%E5%8E%9F%E5%9E%8B%E4%B8%8A%E7%BB%A7%E6%89%BF%E5%B1%9E%E6%80%A7%E7%9A%84%E6%83%85%E5%86%B5%0A%60%60%60js%0Aconst%20obj%20%3D%20%7B%7D%0Aconst%20proto%20%3D%20%7B%20bar%3A%201%20%7D%0Aconst%20child%20%3D%20reactive(obj)%0Aconst%20parent%20%3D%20reactive(proto)%0AObject.setPrototypeOf(child%2C%20parent)%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20console.log(child.bar)%0A%7D)%0Achild.bar%20%3D%202%20%2F%2F%20%E4%BC%9A%E5%AF%BC%E8%87%B4%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E4%B8%A4%E6%AC%A1%0A%0A%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8Cchild.bar%E5%92%8Cparent.bar%E9%83%BD%E4%B8%8E%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E5%BB%BA%E7%AB%8B%E4%BA%86%E5%93%8D%E5%BA%94%E8%81%94%E7%B3%BB%0A%2F%2F%20%E5%BD%93%E6%89%A7%E8%A1%8Cchild.bar%20%3D%202%E6%97%B6%EF%BC%8Cchild.bar%E5%92%8Cparent.bar%E9%83%BD%E4%BC%9A%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%0A%60%60%60%0A%0A%23%23%23%23%23%20%E6%B5%85%E5%93%8D%E5%BA%94%E4%B8%8E%E6%B7%B1%E5%93%8D%E5%BA%94%0A%E7%9B%AE%E5%89%8D%E5%AE%9E%E7%8E%B0%E7%9A%84reactive%E6%98%AF%E6%B5%85%E5%93%8D%E5%BA%94%0A%60%60%60js%0Aconst%20obj%20%3D%20reactive(%7Bfoo%3A%20%7Bbar%3A%201%7D%7D)%0Aeffetc(()%20%3D%3E%20console.log(obj.foo.bar))%0A%0A%2F%2F%20%E4%B8%8D%E4%BC%9A%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%0Aobj.foo.bar%20%3D%202%0A%0A%2F%2F%20%E5%9B%A0%E6%AD%A4%E9%9C%80%E8%A6%81%E5%AF%B9Reflect.get%E8%BF%94%E5%9B%9E%E7%9A%84%E7%BB%93%E6%9E%9C%E5%81%9A%E4%B8%80%E5%B1%82%E5%8C%85%E8%A3%85%0Afunction%20reactive(obj)%20%7B%0A%20%20%20%20return%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20%20%20%20%20get(target%2C%20key%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(key%20%3D%3D%3D%20'raw')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20target%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20track(target%2C%20key)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20res%20%3D%20Reflect.get(target%2C%20key%2C%20receiver)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20res%20%3D%3D%3D%20'object'%20%26%26%20res%20!%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86%E7%BB%93%E6%9E%9C%E5%8C%85%E8%A3%85%E6%88%90%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20reactive(res)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%0A%2F%2F%20%E4%BD%86%E5%B9%B6%E4%B8%8D%E6%98%AF%E6%89%80%E6%9C%89%E6%97%B6%E5%88%BB%E9%83%BD%E9%9C%80%E8%A6%81%E6%B7%B1%E5%93%8D%E5%BA%94%EF%BC%8C%E8%BF%99%E5%B0%B1%E5%82%AC%E7%94%9F%E4%BA%86shallowReactive(%E5%8F%AA%E6%9C%89%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%AC%AC%E4%B8%80%E5%B1%82%E5%B1%9E%E6%80%A7%E6%98%AF%E5%93%8D%E5%BA%94%E7%9A%84)%0A%0Afunction%20createReactive(obj%2C%20isShallow%20%3D%20false)%20%7B%0A%20%20%20%20return%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20%20%20%20%20get(target%2C%20key%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(key%20%3D%3D%3D%20'raw')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20target%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20track(target%2C%20key)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20res%20%3D%20Reflect.get(target%2C%20key%2C%20receiver)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%B5%85%E5%93%8D%E5%BA%94%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isShallow)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20res%20%3D%3D%3D%20'object'%20%26%26%20res%20!%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86%E7%BB%93%E6%9E%9C%E5%8C%85%E8%A3%85%E6%88%90%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20reactive(res)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%0Afunction%20reactive(obj)%20%7B%0A%20%20%20%20return%20createReactive(obj)%0A%7D%0Afunction%20shallowReactive(obj)%20%7B%0A%20%20%20%20return%20createReactive(obj%2C%20true)%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%20%E5%8F%AA%E8%AF%BB%E5%92%8C%E6%B5%85%E5%8F%AA%E8%AF%BB%0A%60%60%60js%0Aconst%20obj%20%3D%20readonly(%7B%20foo%3A%201%20%7D)%0A%2F%2F%20%E5%B0%9D%E8%AF%95%E4%BF%AE%E6%94%B9%EF%BC%8C%E5%BE%97%E5%88%B0%E8%AD%A6%E5%91%8A%0Aobj.foo%20%3D%202%0A%0A%2F%2F%20%E5%90%8C%E6%A0%B7%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8createReactive%E5%87%BD%E6%95%B0%E6%9D%A5%E5%AE%9E%E7%8E%B0%0Afunction%20createReactive(obj%2C%20isShallow%20%3D%20false%2C%20isReadonly%20%3D%20false)%20%7B%0A%20%20%20%20return%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93%E7%84%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%98%AF%E5%8F%AA%E8%AF%BB%E7%9A%84%EF%BC%8C%E9%82%A3%E5%B0%B1%E6%84%8F%E5%91%B3%E7%9D%80%E4%BB%BB%E4%BD%95%E6%96%B9%E5%BC%8F%E9%83%BD%E4%B8%8D%E8%83%BD%E4%BF%AE%E6%94%B9%E5%AE%83%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%B9%9F%E6%B2%A1%E6%9C%89%E5%BF%85%E8%A6%81%E4%B8%BA%E5%8F%AA%E8%AF%BB%E6%95%B0%E6%8D%AE%E5%BB%BA%E7%AB%8B%E5%93%8D%E5%BA%94%E5%85%B3%E7%B3%BB%E3%80%82%0A%20%20%20%20%20%20%20%20get(target%2C%20key%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(key%20%3D%3D%3D%20'raw')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20target%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(!isReadonly)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20track(target%2C%20key)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20res%20%3D%20Reflect.get(target%2C%20key%2C%20receiver)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%B5%85%E5%93%8D%E5%BA%94%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isShallow)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20res%20%3D%3D%3D%20'object'%20%26%26%20res%20!%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86%E7%BB%93%E6%9E%9C%E5%8C%85%E8%A3%85%E6%88%90%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20reactive(res)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20set(target%2C%20key%2C%20newVal%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isReadonly)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20console.warn('%E5%8F%AA%E8%AF%BB')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20...%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20deleteProperty(target%2C%20key)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isReadonly)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20console.warn('%E5%8F%AA%E8%AF%BB')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20...%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%0A%2F%2F%20%E5%AE%9E%E7%8E%B0readonly%E5%87%BD%E6%95%B0%0Afunction%20readonly(obj)%20%7B%0A%20%20%20%20return%20createReactive(obj%2C%20false%2C%20true)%3B%0A%7D%0A%0A%2F%2F%20%E7%84%B6%E8%80%8C%E4%B8%8A%E9%9D%A2%E5%AE%9E%E7%8E%B0%E7%9A%84readonly%E5%8F%AA%E8%83%BD%E5%8F%AB%E5%81%9AshallowReadonly%0Aconst%20obj%20%3D%20readonly(%7B%20foo%3A%20%7B%20bar%3A%201%20%7D%20%7D)%0Aobj.foo.bar%20%3D%202%3B%20%2F%2F%20%E4%BB%8D%E7%84%B6%E5%8F%AF%E4%BB%A5%E4%BF%AE%E6%94%B9%0A%0A%2F%2F%20%E6%89%80%E4%BB%A5%E4%B8%BA%E4%BA%86%E5%AE%9E%E7%8E%B0%E6%B7%B1%E5%8F%AA%E8%AF%BB%EF%BC%8C%E9%9C%80%E8%A6%81%E5%9C%A8get%E6%8B%A6%E6%88%AA%E5%87%BD%E6%95%B0%E9%87%8C%E9%80%92%E5%BD%92%E5%9C%B0%E8%B0%83%E7%94%A8readonly%0Afunction%20createReactive(obj%2C%20isShallow%20%3D%20false%2C%20isReadonly%20%3D%20false)%20%7B%0A%20%20%20%20return%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93%E7%84%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%98%AF%E5%8F%AA%E8%AF%BB%E7%9A%84%EF%BC%8C%E9%82%A3%E5%B0%B1%E6%84%8F%E5%91%B3%E7%9D%80%E4%BB%BB%E4%BD%95%E6%96%B9%E5%BC%8F%E9%83%BD%E4%B8%8D%E8%83%BD%E4%BF%AE%E6%94%B9%E5%AE%83%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%B9%9F%E6%B2%A1%E6%9C%89%E5%BF%85%E8%A6%81%E4%B8%BA%E5%8F%AA%E8%AF%BB%E6%95%B0%E6%8D%AE%E5%BB%BA%E7%AB%8B%E5%93%8D%E5%BA%94%E5%85%B3%E7%B3%BB%E3%80%82%0A%20%20%20%20%20%20%20%20get(target%2C%20key%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(key%20%3D%3D%3D%20'raw')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20target%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(!isReadonly)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20track(target%2C%20key)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20res%20%3D%20Reflect.get(target%2C%20key%2C%20receiver)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%B5%85%E5%93%8D%E5%BA%94%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isShallow)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20res%20%3D%3D%3D%20'object'%20%26%26%20res%20!%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86%E7%BB%93%E6%9E%9C%E5%8C%85%E8%A3%85%E6%88%90%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20isReadonly%20%3F%20readonly(res)%20%3A%20reactive(res)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20set(target%2C%20key%2C%20newVal%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isReadonly)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20console.warn('%E5%8F%AA%E8%AF%BB')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20...%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20deleteProperty(target%2C%20key)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isReadonly)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20console.warn('%E5%8F%AA%E8%AF%BB')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20...%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%0Afunction%20shallowReadonly(obj)%20%7B%0A%20%20%20%20return%20createReactive(obj%2C%20true%2C%20true)%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E4%BB%A3%E7%90%86%E6%95%B0%E7%BB%84%0A%3E%20%E6%95%B0%E7%BB%84%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E5%BC%82%E8%B4%A8%E5%AF%B9%E8%B1%A1%EF%BC%8C%E8%BF%99%E6%98%AF%E5%9B%A0%E4%B8%BA%E6%95%B0%E7%BB%84%E5%AF%B9%E8%B1%A1%E7%9A%84%5B%5BDefineOwnProperty%5D%5D%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%E4%B8%8E%E5%B8%B8%E8%A7%84%E5%AF%B9%E8%B1%A1%E4%B8%8D%E5%90%8C%EF%BC%8C%E5%85%B6%E4%BB%96%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%E7%9B%B8%E5%90%8C%0A%0A%3E%20%E6%89%80%E6%9C%89%E5%AF%B9%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E6%88%96%E5%B1%9E%E6%80%A7%E7%9A%84%22%E8%AF%BB%E5%8F%96%22%E6%93%8D%E4%BD%9C%EF%BC%9A%0A%3E%20-%20%E9%80%9A%E8%BF%87%E7%B4%A2%E5%BC%95%E8%AE%BF%E9%97%AE%EF%BC%9Aarr%5B0%5D%0A%3E%20-%20%E8%AE%BF%E9%97%AE%E6%95%B0%E7%BB%84%E7%9A%84%E9%95%BF%E5%BA%A6%EF%BC%9Aarr.length%0A%3E%20-%20%E6%8A%8A%E6%95%B0%E7%BB%84%E4%BD%9C%E4%B8%BA%E5%AF%B9%E8%B1%A1%EF%BC%8C%E4%BD%BF%E7%94%A8for...in%E5%BE%AA%E7%8E%AF%E9%81%8D%E5%8E%86%0A%3E%20-%20%E4%BD%BF%E7%94%A8for...of%E8%BF%AD%E4%BB%A3%E9%81%8D%E5%8E%86%E6%95%B0%E7%BB%84%0A%3E%20-%20%E6%95%B0%E7%BB%84%E7%9A%84%E5%8E%9F%E5%9E%8B%E6%96%B9%E6%B3%95%EF%BC%8C%E5%A6%82concat%2Fjoin%2Fevery%2Fsome%2Ffind%2FfindIndex%2Fincludes%E7%AD%89%E4%B8%8D%E6%94%B9%E5%8F%98%E5%8E%9F%E6%95%B0%E7%BB%84%E7%9A%84%E5%8E%9F%E5%9E%8B%E6%96%B9%E6%B3%95%0A%0A%3E%20%E6%89%80%E6%9C%89%E5%AF%B9%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E6%88%96%E5%B1%9E%E6%80%A7%E7%9A%84%22%E8%AE%BE%E7%BD%AE%22%E6%93%8D%E4%BD%9C%EF%BC%9A%0A%3E%20-%20%E9%80%9A%E8%BF%87%E7%B4%A2%E5%BC%95%E8%AE%BF%E9%97%AE%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E4%BF%AE%E6%94%B9%3A%20arr%5B1%5D%20%3D%203%0A%3E%20-%20%E4%BF%AE%E6%94%B9%E6%95%B0%E7%BB%84%E9%95%BF%E5%BA%A6%EF%BC%9Aarr.length%20%3D%200%0A%3E%20-%20%E6%95%B0%E7%BB%84%E7%9A%84%E6%A0%88%E6%96%B9%E6%B3%95%EF%BC%9Apush%2Fpop%2Fshift%2Funshift%0A%3E%20-%20%E4%BF%AE%E6%94%B9%E5%8E%9F%E6%95%B0%E7%BB%84%E7%9A%84%E5%8E%9F%E5%9E%8B%E6%96%B9%E6%B3%95%EF%BC%9Asplice%2Ffill%2Fsort%0A%0A%60%60%60js%0Aconst%20arr%20%3D%20reactive(%5B'foo'%5D)%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20console.log(arr%5B0%5D)%0A%7D)%0A%0Aarr%5B0%5D%20%3D%20'bar'%20%2F%2F%20%E8%83%BD%E5%A4%9F%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%0A%0A%2F%2F%20%E4%B8%8A%E9%9D%A2%E9%80%9A%E8%BF%87%E7%B4%A2%E5%BC%95%E8%AF%BB%E5%8F%96%E6%88%96%E8%AE%BE%E7%BD%AE%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E7%9A%84%E5%80%BC%E6%97%B6%EF%BC%8C%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E7%9A%84get%2Fset%E6%8B%A6%E6%88%AA%E5%87%BD%E6%95%B0%E4%B9%9F%E4%BC%9A%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%B8%8D%E9%9C%80%E8%A6%81%E5%81%9A%E9%A2%9D%E5%A4%96%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%B0%B1%E8%83%BD%E5%A4%9F%E8%AE%A9%E6%95%B0%E7%BB%84%E7%B4%A2%E5%BC%95%E7%9A%84%E8%AF%BB%E5%8F%96%E5%92%8C%E8%AE%BE%E7%BD%AE%E6%93%8D%E4%BD%9C%E6%98%AF%E5%93%8D%E5%BA%94%E5%BC%8F%E7%9A%84%0A%0A%2F%2F%20%E4%BD%86%E9%80%9A%E8%BF%87%E7%B4%A2%E5%BC%95%E8%AE%BE%E7%BD%AE%E6%95%B0%E7%BB%84%E7%9A%84%E5%85%83%E7%B4%A0%E5%80%BC%E4%B8%8E%E8%AE%BE%E7%BD%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7%E5%80%BC%E4%BB%8D%E7%84%B6%E5%AD%98%E5%9C%A8%E6%A0%B9%E6%9C%AC%E4%B8%8A%E7%9A%84%E4%B8%8D%E5%90%8C%EF%BC%8C%E8%BF%99%E6%97%B6%E5%9B%A0%E4%B8%BA%E6%95%B0%E7%BB%84%E5%AF%B9%E8%B1%A1%E9%83%A8%E7%BD%B2%E7%9A%84%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%5B%5BDefineOwnProperty%5D%5D%E4%B8%8D%E5%90%8C%E4%BA%8E%E5%B8%B8%E8%A7%84%E5%AF%B9%E8%B1%A1%E3%80%82%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E5%BD%93%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%E7%B4%A2%E5%BC%95%E5%80%BC%E8%AE%BE%E7%BD%AE%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%E7%9A%84%E5%80%BC%E6%97%B6%EF%BC%8C%E4%BC%9A%E6%89%A7%E8%A1%8C%E6%95%B0%E7%BB%84%E5%AF%B9%E8%B1%A1%E6%89%80%E9%83%A8%E7%BD%B2%E7%9A%84%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%5B%5BSet%5D%5D%EF%BC%8C%E8%BF%99%E4%B8%80%E6%AD%A5%E4%B8%8E%E8%AE%BE%E7%BD%AE%E5%B8%B8%E8%A7%84%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7%E5%80%BC%E4%B8%80%E6%A0%B7%EF%BC%8C%E6%A0%B9%E6%8D%AE%E8%A7%84%E8%8C%83%E5%8F%AF%E7%9F%A5%EF%BC%8C%5B%5BSet%5D%5D%E5%85%B6%E5%AE%9E%E4%BE%9D%E8%B5%96%E4%BA%8E%5B%5BDefineOwnProperty%5D%5D%0A%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%B4%A2%E5%BC%95%E5%80%BC%E5%A4%A7%E4%BA%8E%E6%95%B0%E7%BB%84%E5%BD%93%E5%89%8D%E7%9A%84%E9%95%BF%E5%BA%A6%EF%BC%8C%E9%82%A3%E4%B9%88%E8%A6%81%E6%9B%B4%E6%96%B0%E6%95%B0%E7%BB%84%E7%9A%84length%E5%B1%9E%E6%80%A7%0Aconst%20arr%20%3D%20reactive(%5B'foo'%5D)%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20console.log(arr.length)%0A%7D)%0Aarr%5B1%5D%20%3D%20'bar'%20%2F%2F%20%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%95%B0%E7%BB%84%E7%9A%84%E9%95%BF%E5%BA%A6%E5%8F%98%E4%B8%BA2%0A%0A%2F%2F%201.%E6%89%80%E4%BB%A5%E4%BF%AE%E6%94%B9set%E6%8B%A6%E6%88%AA%E5%87%BD%E6%95%B0%0Afunction%20createReactive(obj%2C%20isShallow%20%3D%20false%2C%20isReadonly%20%3D%20false)%20%7B%0A%20%20%20%20return%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20%20%20%20%20set(target%2C%20key%2C%20newVal%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isReadonly)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20console.warn('%E5%8F%AA%E8%AF%BB')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20oldVal%20%3D%20target%5Bkey%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%A4%E6%96%AD%E6%98%AF%E4%BF%AE%E6%94%B9%E8%BF%98%E6%98%AF%E6%96%B0%E5%A2%9E%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20type%20%3D%20Array.isArray(target)%20%3F%20Number(key)%20%3C%20target.length%20%3F%20'SET'%20%3A%20'ADD'%20%3A%20Object.prototype.hasOwnProperty.call(target%2C%20key)%20%3F%20'SET'%20%3A%20'ADD'%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20res%20%3D%20Reflect.set(target%2C%20key%2C%20newVal%2C%20receiver)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(target%20%3D%3D%3D%20receiver.raw)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(oldVal%20!%3D%3D%20newVal%20%26%26%20(oldVal%20%3D%3D%3D%20oldVal%20%7C%7C%20newVal%20%3D%3D%3D%20newVal))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20trigger(target%2C%20key%2C%20type)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20...%0A%20%20%20%20)%20%20%20%20%20%20%0A%7D%0A%0Afunction%20trigger(target%2C%20key%2C%20type)%20%7B%0A%20%20%20%20const%20depsMap%20%3D%20bucket.get(target)%3B%0A%20%20%20%20if%20(!depsMap)%20return%0A%20%20%20%20%0A%20%20%20%20...%0A%20%20%20%20if%20(type%20%3D%3D%3D%20'ADD'%20%26%26%20Array.isArray(target))%20%7B%0A%20%20%20%20%20%20%20%20const%20lengthEffects%20%3D%20depsMap.get('length')%0A%20%20%20%20%20%20%20%20lengthEffects%20%26%26%20lengthEffects.forEach(effectFn%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(effectFn%20!%3D%3D%20activeEffect)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20effectsToRun.add(effectFn)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%7D%0A%20%20%20%20...%0A%7D%0A%0A%2F%2F%202.%E5%90%8C%E6%A0%B7%E4%BF%AE%E6%94%B9length%E4%B9%9F%E4%BC%9A%E9%9A%90%E5%BC%8F%E5%9C%B0%E5%BD%B1%E5%93%8D%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0%0Afunction%20createReactive(obj%2C%20isShallow%20%3D%20false%2C%20isReadonly%20%3D%20false)%20%7B%0A%20%20%20%20return%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20%20%20%20%20set(target%2C%20key%2C%20newVal%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isReadonly)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20console.warn('%E5%8F%AA%E8%AF%BB')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20oldVal%20%3D%20target%5Bkey%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%A4%E6%96%AD%E6%98%AF%E4%BF%AE%E6%94%B9%E8%BF%98%E6%98%AF%E6%96%B0%E5%A2%9E%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20type%20%3D%20Array.isArray(target)%20%3F%20Number(key)%20%3C%20target.length%20%3F%20'SET'%20%3A%20'ADD'%20%3A%20Object.prototype.hasOwnProperty.call(target%2C%20key)%20%3F%20'SET'%20%3A%20'ADD'%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20res%20%3D%20Reflect.set(target%2C%20key%2C%20newVal%2C%20receiver)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(target%20%3D%3D%3D%20receiver.raw)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(oldVal%20!%3D%3D%20newVal%20%26%26%20(oldVal%20%3D%3D%3D%20oldVal%20%7C%7C%20newVal%20%3D%3D%3D%20newVal))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A2%9E%E5%8A%A0%E7%AC%AC%E5%9B%9B%E4%B8%AA%E5%8F%82%E6%95%B0%EF%BC%8C%E5%8D%B3%E8%A7%A6%E5%8F%91%E5%93%8D%E5%BA%94%E7%9A%84%E6%96%B0%E5%80%BC%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20trigger(target%2C%20key%2C%20type%2C%20newVal)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20...%0A%20%20%20%20)%20%20%20%20%20%20%0A%7D%0A%0Afunction%20trigger(target%2C%20key%2C%20type)%20%7B%0A%20%20%20%20const%20depsMap%20%3D%20bucket.get(target)%3B%0A%20%20%20%20if%20(!depsMap)%20return%0A%20%20%20%20%0A%20%20%20%20...%0A%20%20%20%20if%20(type%20%3D%3D%3D%20'ADD'%20%26%26%20Array.isArray(target))%20%7B%0A%20%20%20%20%20%20%20%20const%20lengthEffects%20%3D%20depsMap.get('length')%0A%20%20%20%20%20%20%20%20lengthEffects%20%26%26%20lengthEffects.forEach(effectFn%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(effectFn%20!%3D%3D%20activeEffect)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20effectsToRun.add(effectFn)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%AF%B9%E4%BA%8E%E7%B4%A2%E5%BC%95%E5%A4%A7%E4%BA%8E%E6%88%96%E7%AD%89%E4%BA%8E%E6%96%B0%E7%9A%84length%E5%80%BC%E7%9A%84%E5%85%83%E7%B4%A0%0A%20%20%20%20%2F%2F%20%E9%9C%80%E8%A6%81%E6%8A%8A%E6%89%80%E6%9C%89%E7%9B%B8%E5%85%B3%E8%81%94%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E5%8F%96%E5%87%BA%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0effectsToRun%E4%B8%AD%E5%BE%85%E6%89%A7%E8%A1%8C%0A%20%20%20%20if%20(Array.isArray(target)%20%26%26%20key%20%3D%3D%3D%20'length')%20%7B%0A%20%20%20%20%20%20%20%20depsMap.forEach((effects%2C%20key)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(key%20%3E%3D%20newVal)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20effects.forEach((effectFn)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(effectFn%20!%3D%3D%20activeEffect)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20effectsToRun.add(effectFn)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%7D%0A%20%20%20%20...%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%20%E9%81%8D%E5%8E%86%E6%95%B0%E7%BB%84%0A%0A%60%60%60js%0Aconst%20arr%20%3D%20reactive(%5B'foo'%5D)%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20for(const%20key%20in%20arr)%20%7B%0A%20%20%20%20%20%20%20%20console.log(key)%20%2F%2F%200%0A%20%20%20%20%7D%0A%7D)%0A%60%60%60%0A%0A-%20for...in%E5%BE%AA%E7%8E%AF%0A%3E%20%E6%88%91%E4%BB%AC%E5%BA%94%E8%AF%A5%E5%B0%BD%E9%87%8F%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8for...in%E5%BE%AA%E7%8E%AF%E9%81%8D%E5%8E%86%E6%95%B0%E7%BB%84%0A%0A%60%60%60js%0A%2F%2F%20%E4%BD%BF%E7%94%A8for...in%E9%81%8D%E5%8E%86%E5%BE%AA%E7%8E%AF%E6%95%B0%E7%BB%84%E4%B8%8E%E9%81%8D%E5%8E%86%E5%B8%B8%E8%A7%84%E5%AF%B9%E8%B1%A1%E5%B9%B6%E6%97%A0%E5%B7%AE%E5%BC%82%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%90%8C%E6%A0%B7%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8ownKeys%E6%8B%A6%E6%88%AA%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E6%8B%A6%E6%88%AA%0A%0A%2F%2F%20%E5%AF%B9%E4%BA%8E%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E5%AF%B9%E8%B1%A1%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%8F%AA%E6%9C%89%E5%BD%93%E6%B7%BB%E5%8A%A0%E6%88%96%E5%88%A0%E9%99%A4%E5%B1%9E%E6%80%A7%E5%80%BC%E6%97%B6%E6%89%8D%E4%BC%9A%E9%87%8D%E6%96%B0%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BD%86%E6%98%AF%E5%AF%B9%E4%BA%8E%E6%95%B0%E7%BB%84%E6%9D%A5%E8%AF%B4%E6%9C%89%E6%89%80%E4%B8%8D%E5%90%8C%EF%BC%9A%0A%2F%2F%201.%20%E6%B7%BB%E5%8A%A0%E6%96%B0%E5%85%83%E7%B4%A0%EF%BC%9A%20arr%5B100%5D%20%3D%20bar%0A%2F%2F%202.%20%E4%BF%AE%E6%94%B9%E6%95%B0%E7%BB%84%E9%95%BF%E5%BA%A6%EF%BC%9Aarr.length%20%3D%200%0A%2F%2F%20%E6%9C%AC%E8%B4%A8%E6%9D%A5%E8%AF%B4%E9%83%BD%E6%98%AF%E4%BF%AE%E6%94%B9%E4%BA%86%E6%95%B0%E7%BB%84%E7%9A%84length%0A%0Afunction%20createReactive(obj%2C%20isShallow%20%3D%20false%2C%20isReadonly%20%3D%20false)%20%7B%0A%20%20%20%20return%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20%20%20%20%20ownKeys(target)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20track(target%2C%20Array.isArray(target)%20%3F%20'length'%20%3A%20ITERATE_KEY)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20Reflect.ownKeys(target)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%60%60%60%0A%0A-%20for...of%E5%BE%AA%E7%8E%AF%0A%3E%20for..of%E6%98%AF%E7%94%A8%E6%9D%A5%E9%81%8D%E5%8E%86%E5%8F%AF%E8%BF%AD%E4%BB%A3%E5%AF%B9%E8%B1%A1%E7%9A%84%0A%3E%20%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%E5%AE%9E%E7%8E%B0%E4%BA%86Symbol.iterator%E6%96%B9%E6%B3%95%EF%BC%8C%E9%82%A3%E4%B9%88%E8%BF%99%E4%B8%AA%E5%AF%B9%E8%B1%A1%E5%B0%B1%E6%98%AF%E5%8F%AF%E4%BB%A5%E8%BF%AD%E4%BB%A3%E7%9A%84%0A%3E%20%E6%95%B0%E7%BB%84%E5%86%85%E5%BB%BA%E4%BA%86Symbol.iterator%E6%96%B9%E6%B3%95%0A%0A%60%60%60js%0Aconst%20arr%20%3D%20%5B1%2C2%2C3%2C4%5D%0Aconst%20itr%20%3D%20arr%5BSymbol.iterator%5D()%0A%0Aitr.next()%20%2F%2F%20%7B%20value%3A%201%2C%20done%3A%20false%20%7D%0Aitr.next()%20%2F%2F%20%7B%20value%3A%202%2C%20done%3A%20false%20%7D%0A...%0A%0A%2F%2F%20%E8%BF%AD%E4%BB%A3%E6%95%B0%E7%BB%84%E6%97%B6%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E5%9C%A8%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%B8%8E%E6%95%B0%E7%BB%84%E7%9A%84%E9%95%BF%E5%BA%A6%E5%92%8C%E7%B4%A2%E5%BC%95%E4%B9%8B%E9%97%B4%E5%BB%BA%E7%AB%8B%E5%93%8D%E5%BA%94%E8%81%94%E7%B3%BB%EF%BC%8C%E5%B0%B1%E8%83%BD%E5%A4%9F%E5%AE%9E%E7%8E%B0%E5%93%8D%E5%BA%94%E5%BC%8F%E7%9A%84for...of%E8%BF%AD%E4%BB%A3%0A%2F%2F%20%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%EF%BC%8C%E5%9C%A8%E4%B8%8D%E5%A2%9E%E5%8A%A0%E4%BB%BB%E4%BD%95%E4%BB%A3%E7%A0%81%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E4%B9%9F%E8%83%BD%E5%A4%9F%E8%AE%A9%E6%95%B0%E7%BB%84%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%96%B9%E6%B3%95%E6%AD%A3%E7%A1%AE%E5%9C%B0%E5%B7%A5%E4%BD%9C%0A%0Afunction%20createReactive(obj%2C%20isShallow%20%3D%20false%2C%20isReadonly%20%3D%20false)%20%7B%0A%20%20%20%20return%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93%E7%84%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%98%AF%E5%8F%AA%E8%AF%BB%E7%9A%84%EF%BC%8C%E9%82%A3%E5%B0%B1%E6%84%8F%E5%91%B3%E7%9D%80%E4%BB%BB%E4%BD%95%E6%96%B9%E5%BC%8F%E9%83%BD%E4%B8%8D%E8%83%BD%E4%BF%AE%E6%94%B9%E5%AE%83%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%B9%9F%E6%B2%A1%E6%9C%89%E5%BF%85%E8%A6%81%E4%B8%BA%E5%8F%AA%E8%AF%BB%E6%95%B0%E6%8D%AE%E5%BB%BA%E7%AB%8B%E5%93%8D%E5%BA%94%E5%85%B3%E7%B3%BB%E3%80%82%0A%20%20%20%20%20%20%20%20get(target%2C%20key%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(key%20%3D%3D%3D%20'raw')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20target%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9Ckey%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%98%AFsymbol%EF%BC%8C%E5%88%99%E4%B8%8D%E8%BF%9B%E8%A1%8C%E8%BF%BD%E8%B8%AA%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(!isReadonly%20%26%26%20typeof%20key%20!%3D%3D%20'symbol')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20track(target%2C%20key)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20res%20%3D%20Reflect.get(target%2C%20key%2C%20receiver)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%B5%85%E5%93%8D%E5%BA%94%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(isShallow)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20res%20%3D%3D%3D%20'object'%20%26%26%20res%20!%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86%E7%BB%93%E6%9E%9C%E5%8C%85%E8%A3%85%E6%88%90%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20isReadonly%20%3F%20readonly(res)%20%3A%20reactive(res)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D)%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%20%E6%95%B0%E7%BB%84%E7%9A%84%E6%9F%A5%E6%89%BE%E6%96%B9%E6%B3%95%0A%60%60%60js%0A%2F%2F%20%E9%97%AE%E9%A2%98%E4%B8%80%0Aconst%20obj%20%3D%20%5B%5D%0Aconst%20arr%20%3D%20reactive(%5Bobj%5D)%0A%2F%2F%20%E8%BF%99%E9%87%8C%E8%BE%93%E5%87%BAfalse%2C%E6%98%AF%E5%9B%A0%E4%B8%BA%E9%80%92%E5%BD%92%E5%88%9B%E5%BB%BAreactive%E6%97%B6%EF%BC%8C%E9%83%BD%E4%BC%9A%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%8D%B3%E4%BD%BF%E5%8F%82%E6%95%B0Obj%E6%98%AF%E7%9B%B8%E5%90%8C%E7%9A%84%EF%BC%8C%E6%AF%8F%E6%AC%A1%E8%B0%83%E7%94%A8reactive%E5%87%BD%E6%95%B0%E6%97%B6%EF%BC%8C%E4%B9%9F%E4%BC%9A%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%0Aconsole.log(arr.includes(arr%5B0%5D))%0A%0A%2F%2F%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%0A%2F%2F%20%E4%BD%BF%E7%94%A8reactiveMap%2C%E9%80%9A%E8%BF%87%E5%8E%9F%E5%A7%8B%E5%AF%B9%E8%B1%A1%E5%AF%BB%E6%89%BE%E4%B9%8B%E5%89%8D%E5%88%9B%E5%BB%BA%E7%9A%84%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%89%BE%E5%88%B0%E4%BA%86%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%E5%B7%B2%E6%9C%89%E7%9A%84%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%0Aconst%20reactiveMap%20%3D%20new%20Map()%0A%0Afunction%20reactive(obj)%20%7B%0A%20%20%20%20const%20existionProxy%20%3D%20reactiveMap.get(obj)%0A%20%20%20%20if%20(existionProxy)%20return%20existionProxy%0A%20%20%20%20%0A%20%20%20%20const%20proxy%20%3D%20createReactive(obj)%0A%20%20%20%20reactiveMap.set(obj%2C%20proxy)%0A%20%20%20%20return%20proxy%0A%7D%0A%0A%2F%2F%20%E9%97%AE%E9%A2%98%E4%BA%8C%0Aconst%20obj%20%3D%20%7B%7D%0Aconst%20arr%20%3D%20reactive(%5Bobj%5D)%0A%2F%2F%20%E8%BF%99%E6%98%AF%E5%9B%A0%E4%B8%BAincludes%E5%86%85%E9%83%A8this%E6%8C%87%E5%90%91%E7%9A%84%E6%98%AF%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1arr%EF%BC%8C%E5%9C%A8%E8%8E%B7%E5%8F%96%E5%85%83%E7%B4%A0%E6%97%B6%E7%94%A8%E6%9D%A5%E6%AF%94%E8%BE%83%E7%9A%84%E4%B9%9F%E6%98%AF%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%EF%BC%8C%E6%89%80%E4%BB%A5%E4%B8%8D%E8%83%BD%E5%8C%B9%E9%85%8D%E5%88%B0%E5%8E%9F%E5%A7%8B%E5%AF%B9%E8%B1%A1obj%0Aconsole.log(arr.includes(obj))%20%2F%2F%20false%0A%0A%2F%2F%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%0A%2F%2F%20%E9%87%8D%E5%86%99includes%E6%96%B9%E6%B3%95%0Aconst%20originMethod%20%3D%20Array.prototype.includes%0Aconst%20arrayInstrumentations%20%3D%20%7B%0A%20%20%20%20includes%3A%20function(...args)%20%7B%0A%20%20%20%20%20%20%20%20let%20res%20%3D%20originMethod.apply(this%2C%20args)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20if%20(res%20%3D%3D%3D%20false)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E9%80%9A%E8%BF%87%E5%8E%9F%E5%A7%8B%E5%80%BC%E5%86%8D%E5%8E%BB%E6%9F%A5%E6%89%BE%0A%20%20%20%20%20%20%20%20%20%20%20%20res%20%3D%20originMethod.apply(this.raw%2C%20args)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20return%20res%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20createReactive(obj%2C%20isShallow%20%3D%20false%2C%20isReadonly%20%3D%20false)%20%7B%0A%20%20%20%20return%20new%20Proxy(obj%2C%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%BD%BF%E7%94%A8includes%E6%97%B6%E4%BC%9A%E8%A7%A6%E5%8F%91get%E6%8B%A6%E6%88%AA%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20get(target%2C%20key%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(key%20%3D%3D%3D%20'raw')%20return%20target%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E4%BD%BF%E7%94%A8%E9%87%8D%E5%86%99%E7%9A%84includes%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(Array.isArray(target)%20%26%26%20arrayInstrumentation.hasOwnProperty(key))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20Reflect.get(arrayInstrumentation%2C%20key%2C%20receiver)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%20%E9%9A%90%E5%BC%8F%E4%BF%AE%E6%94%B9%E6%95%B0%E7%BB%84%E9%95%BF%E5%BA%A6%E7%9A%84%E5%8E%9F%E5%9E%8B%E6%96%B9%E6%B3%95%0A%3E%20push%2Fpop%2Fshift%2Funshift%2Fsplice%0A%0A%60%60%60js%0Aconst%20arr%20%3D%20reactive(%5B%5D)%0Aeffect(()%20%3D%3E%20arr.push(1))%0A%0Aeffect(()%20%3D%3E%20arr.push(2))%0A%2F%2F%20%E8%BF%99%E9%87%8C%E4%BC%9A%E5%87%BA%E7%8E%B0%E6%A0%88%E6%BA%A2%E5%87%BA%EF%BC%8C%E5%9B%A0%E4%B8%BA%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%89%A7%E8%A1%8Carr.push%E6%97%B6%EF%BC%8C%E4%BC%9A%E8%A7%A6%E5%8F%91length%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%8F%88%E4%BC%9A%E6%89%A7%E8%A1%8C%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0arr.push(1)%EF%BC%8C%E5%A6%82%E6%AD%A4%E4%B8%80%E6%9D%A5%E5%B0%B1%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%A0%88%E6%BA%A2%E5%87%BA%0A%0A%2F%2F%20%E9%97%AE%E9%A2%98%E7%9A%84%E5%8E%9F%E5%9B%A0%E6%98%AFpush%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E4%BC%9A%E9%97%B4%E6%8E%A5%E8%AF%BB%E5%8F%96length%E5%B1%9E%E6%80%A7%0A%2F%2F%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%8C%E5%B1%8F%E8%94%BD%E5%AF%B9length%E5%B1%9E%E6%80%A7%E7%9A%84%E8%AF%BB%E5%8F%96%0A%2F%2F%20%E9%87%8D%E5%86%99push%0A%0Alet%20shouldTrack%20%3D%20true%0Aconst%20originMethod%20%3D%20Array.prototype.push%0AarrayInstrumentations%5B'push'%5D%20%3D%20function(...args)%20%7B%0A%20%20%20%20shouldTrack%20%3D%20false%0A%20%20%20%20let%20res%20%3D%20originMethod.apply(this%2C%20args)%0A%20%20%20%20shouldTrack%20%3D%20true%0A%20%20%20%20return%20res%3B%0A%7D%0A%0A%2F%2F%20%E5%9C%A8push%E9%BB%98%E8%AE%A4%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E7%A6%81%E6%AD%A2%E8%BF%BD%E8%B8%AA%0Afunction%20track(target%2C%20key)%20%7B%0A%20%20%20%20if%20(!activeEffect%20%7C%7C%20!shouldTrack)%20return%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E4%BB%A3%E7%90%86Set%E5%92%8CMap%0A%0A%0A%23%23%23%23%23%20%E5%BB%BA%E7%AB%8B%E7%9B%B8%E5%BA%94%E5%85%B3%E7%B3%BB%0A%0A%23%23%23%23%23%20%E9%81%BF%E5%85%8D%E6%B1%A1%E6%9F%93%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%0A%0A%0A%23%23%23%23%23%20%E5%A4%84%E7%90%86forEach%0A%0A%0A%23%23%23%23%23%20%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%96%B9%E6%B3%95%0A%60%60%60js%0Aconst%20p%20%3D%20reactive(new%20Map(%5B%0A%20%20%20%20%5B'key1'%2C%20'value1'%5D%2C%0A%20%20%20%20%5B'key2'%2C%20'value2'%5D%0A%5D))%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20for(const%20%5Bkey%2C%20value%5D%20of%20p)%20%7B%0A%20%20%20%20%20%20%20%20console.log(key%2C%20value)%0A%20%20%20%20%7D%0A%7D)%0A%0Ap.set('key3'%2C%20'value3')%0A%0A%2F%2F%20%E6%8A%A5%E9%94%99%EF%BC%8Cp%E6%98%AF%E4%B8%8D%E5%8F%AF%E8%BF%AD%E4%BB%A3%E7%9A%84%0A%2F%2F%20%E5%8E%9F%E5%9B%A0%EF%BC%9A%0A%2F%2F%20%E4%BD%BF%E7%94%A8%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%97%B6%EF%BC%8C%E4%BC%9A%E8%AF%95%E5%9B%BE%E4%BB%8E%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%E4%B8%8A%E8%AF%BB%E5%8F%96p%5BSymbol.iterator%5D%E5%B1%9E%E6%80%A7%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%93%8D%E4%BD%9C%E4%BC%9A%E8%A7%A6%E5%8F%91get%E6%8B%A6%E6%88%AA%E5%87%BD%E6%95%B0%0A%2F%2F%20%E8%A7%A3%E5%86%B3%0A%2F%2F%20%E6%8A%8ASymbol.iterator%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%94%BE%E5%88%B0mutableInstrumentations%E4%B8%AD%0A%0Aconst%20mutableInstrumentations%20%3D%20%7B%0A%20%20%20%20%5BSymbol.iterator%5D()%20%7B%0A%20%20%20%20%20%20%20%20const%20target%20%3D%20this.row%0A%20%20%20%20%20%20%20%20const%20itr%20%3D%20target%5BSymbol.iterator%5D()%0A%20%20%20%20%20%20%20%20return%20itr%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%BF%AD%E4%BB%A3%E5%80%BC%E4%B9%9F%E6%98%AF%E8%A2%AB%E4%BB%A3%E7%90%86%E7%9A%84%EF%BC%8C%E4%B9%9F%E9%9C%80%E8%A6%81%E5%B0%86%E5%85%B6%E5%8C%85%E8%A3%85%E6%88%90%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%0Aconst%20mutableInstrumentatioins%20%3D%20%7B%0A%20%20%20%20%5BSymbol.iterator%5D()%20%7B%0A%20%20%20%20%20%20%20%20const%20target%20%3D%20this.row%0A%20%20%20%20%20%20%20%20const%20itr%20%3D%20target%5BSymbol.iterator%5D()%0A%20%20%20%20%20%20%20%20const%20wrap%20%3D%20(val)%20%3D%3E%20typeof%20val%20%3D%3D%3D%20'object'%20%26%26%20val%20!%3D%3D%20null%20%3F%20reactive(val)%20%3A%20val%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8track%E5%87%BD%E6%95%B0%E5%BB%BA%E7%AB%8B%E5%93%8D%E5%BA%94%E8%81%94%E7%B3%BB%0A%20%20%20%20%20%20%20%20track(target%2C%20ITERATE_KEY)%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20next()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20%7B%20value%2C%20done%20%7D%20%3D%20itr.next()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value%3A%20value%20%3F%20%5Bwrap(value%5B0%5D)%2C%20wrap(value%5B1%5D)%5D%20%3A%20value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20done%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E5%9B%A0%E4%B8%BAp.entries%E4%B8%8Ep%5BSymbol.iterator%5D%E7%AD%89%E4%BB%B7%EF%BC%8C%E6%89%80%E4%BB%A5%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E5%90%8C%E6%A0%B7%E7%9A%84%E4%BB%A3%E7%A0%81%E6%9D%A5%E5%AE%9E%E7%8E%B0%E5%AF%B9p.entries%E7%9A%84%E6%8B%A6%E6%88%AA%EF%BC%8C%E4%BD%86%E6%98%AF%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%EF%BC%8Cp.entries%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E6%98%AF%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E4%B8%80%E4%B8%AA%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%AF%B9%E8%B1%A1%0A%60%60%60%0A%0A%23%23%23%23%23%20values%E4%B8%8Ekeys%E6%96%B9%E6%B3%95%0A%0Akeys%E4%B8%8Evalues%E7%95%A5%E5%BE%AE%E4%B8%8D%E5%90%8C%EF%BC%8Ckeys%E5%8F%AA%E9%9C%80%E8%A6%81%E7%BB%91%E5%AE%9Akey%E5%92%8C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E5%85%B3%E7%B3%BB%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%B8%8D%E9%9C%80%E8%A6%81%E5%9C%A8SET%E4%BF%AE%E6%94%B9%E5%80%BC%E8%80%8C%E6%B2%A1%E6%9C%89%E4%BF%AE%E6%94%B9key%E7%9A%84%E6%97%B6%E5%80%99%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%0A%0A%23%23%23%23%20%E6%80%BB%E7%BB%93%0A-%20%E4%BD%BF%E7%94%A8proxy%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%0A-%20%E5%9B%A0%E4%B8%BA%E8%AE%BF%E9%97%AE%E5%99%A8%E5%B1%9E%E6%80%A7%E7%9A%84this%E6%8C%87%E5%90%91%E9%97%AE%E9%A2%98%EF%BC%8C%E4%BD%BF%E7%94%A8Reflect.*%E4%BF%AE%E5%A4%8D%0A-%20%E5%B8%B8%E8%A7%84%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%BC%82%E8%B4%A8%E5%AF%B9%E8%B1%A1%0A-%20%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%BB%A3%E7%90%86%0A-%20%E6%B7%B1%E5%93%8D%E5%BA%94%E4%B8%8E%E6%B5%85%E5%93%8D%E5%BA%94%EF%BC%8C%E6%B7%B1%E5%8F%AA%E8%AF%BB%E4%B8%8E%E6%B5%85%E5%8F%AA%E8%AF%BB%0A-%20%E6%95%B0%E7%BB%84%E7%9A%84%E4%BB%A3%E7%90%86%0A-%20Map%E3%80%81Set%E3%80%81WeakMap%E3%80%81WeakSet%E7%9A%84%E4%BB%A3%E7%90%86%0A%0A%23%23%23%20%E7%AC%AC6%E7%AB%A0%E3%80%8A%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%96%B9%E6%A1%88%E3%80%8B%0A%0A%3E%20%E5%9C%A8JavaScript%E4%B8%AD%EF%BC%8C%E5%8E%9F%E5%A7%8B%E5%80%BC%E6%98%AF%E6%8C%89%E5%80%BC%E4%BC%A0%E9%80%92%E7%9A%84%EF%BC%8C%E8%80%8C%E9%9D%9E%E6%8C%89%E5%BC%95%E7%94%A8%E4%BC%A0%E9%80%92%E3%80%82%E8%BF%99%E6%84%8F%E5%91%B3%E7%9D%80%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E6%8E%A5%E6%94%B6%E5%8E%9F%E5%A7%8B%E5%80%BC%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0%EF%BC%8C%E9%82%A3%E4%B9%88%E5%BD%A2%E5%8F%82%E4%B8%8E%E5%AE%9E%E5%8F%82%E4%B9%8B%E9%97%B4%E6%B2%A1%E6%9C%89%E5%BC%95%E7%94%A8%E5%85%B3%E7%B3%BB%EF%BC%8C%E5%AE%83%E4%BB%AC%E6%98%AF%E4%B8%A4%E4%B8%AA%E5%AE%8C%E5%85%A8%E7%8B%AC%E7%AB%8B%E7%9A%84%E5%80%BC%EF%BC%8C%E5%AF%B9%E5%BD%A2%E5%8F%82%E7%9A%84%E4%BF%AE%E6%94%B9%E4%B8%8D%E4%BC%9A%E5%BD%B1%E5%93%8D%E5%88%B0%E5%AE%9E%E5%8F%82%E3%80%82%0A%3E%20JavaScript%E4%B8%AD%E7%9A%84Proxy%E6%97%A0%E6%B3%95%E6%8F%90%E4%BE%9B%E5%AF%B9%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E4%BB%A3%E7%90%86%EF%BC%8C%E5%9B%A0%E6%AD%A4%E6%83%B3%E8%A6%81%E5%B0%86%E5%8E%9F%E5%A7%8B%E5%80%BC%E5%8F%98%E6%88%90%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B0%B1%E5%BF%85%E9%A1%BB%E5%AF%B9%E5%85%B6%E5%81%9A%E4%B8%80%E5%B1%82%E5%8C%85%E8%A3%B9%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AFref%0A%0A%0A%60%60%60js%0A%2F%2F%20%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%AAref%E5%87%BD%E6%95%B0%0Afunction%20ref(val)%20%7B%0A%20%20%20%20const%20wrapper%20%3D%20%7B%0A%20%20%20%20%20%20%20%20value%3A%20val%0A%20%20%20%20%7D%0A%20%20%20%20return%20reactive(wrapper)%0A%7D%0A%0Aconst%20refVal%20%3D%20ref(1)%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20console.log(refVal.value)%0A%7D)%0A%2F%2F%20%E4%BF%AE%E6%94%B9%E5%80%BC%E8%83%BD%E5%A4%9F%E8%A7%A6%E5%8F%91%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%0ArefVal.value%20%3D%202%0A%0A%2F%2F%201.%E9%97%AE%E9%A2%98%0A%2F%2F%20%E5%A6%82%E4%BD%95%E5%8C%BA%E5%88%86refVal%E6%98%AF%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%8C%85%E8%A3%B9%E5%AF%B9%E8%B1%A1%EF%BC%8C%E8%BF%98%E6%98%AF%E4%B8%80%E4%B8%AA%E9%9D%9E%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%0Aconst%20refVal1%20%3D%20ref(1)%0Aconst%20refVal2%20%3D%20reactive(%7Bvalue%3A%201%7D)%0A%0A%2F%2F%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%0Afunction%20ref(val)%20%7B%0A%20%20%20%20const%20wrapper%20%3D%20%7B%0A%20%20%20%20%20%20%20%20value%3A%20val%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20%E4%BD%BF%E7%94%A8Object.defineProperty%E5%9C%A8wrapper%E5%AF%B9%E8%B1%A1%E4%B8%8A%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%8F%AF%E6%9E%9A%E4%B8%BE%E7%9A%84%E5%B1%9E%E6%80%A7__v_isRef%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%80%BC%E4%B8%BAtrue%0A%20%20%20%20Object.defineProperty(wrapper%2C%20'__v_isRef'%2C%20%7B%0A%20%20%20%20%20%20%20%20value%3A%20true%0A%20%20%20%20%7D)%0A%20%20%20%20%0A%20%20%20%20return%20reactive(wrapper)%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E5%93%8D%E5%BA%94%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98%0A%3E%20ref%E9%99%A4%E4%BA%86%E8%83%BD%E5%A4%9F%E7%94%A8%E4%BA%8E%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%96%B9%E6%A1%88%E4%B9%8B%E5%A4%96%EF%BC%8C%E8%BF%98%E8%83%BD%E7%94%A8%E6%9D%A5%E8%A7%A3%E5%86%B3%E5%93%8D%E5%BA%94%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98%E3%80%82%0A%0A%60%60%60js%0A%2F%2F%20%E5%93%8D%E5%BA%94%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98%0Aexport%20default%20%7B%0A%20%20%20%20setup()%20%7B%0A%20%20%20%20%20%20%20%20const%20obj%20%3D%20reactive(%7B%20foo%3A%201%2C%20bar%3A%202%20%7D)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20...obj%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%E6%8E%A5%E7%9D%80%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%A8%A1%E7%89%88%E4%B8%AD%E8%AE%BF%E9%97%AE%0A%60%60%60html%0A%3Ctemplate%3E%0A%20%20%20%20%3Cp%3E%7B%7Bfoo%7D%7D%20%2F%20%7B%7Bbar%7D%7D%3C%2Fp%3E%0A%3C%2Ftemplate%3E%0A%60%60%60%0A%E4%BD%86%E6%98%AF%E8%BF%99%E4%B9%88%E5%81%9A%20%E4%BC%9A%E5%AF%BC%E8%87%B4%E5%93%8D%E5%BA%94%E4%B8%A2%E5%A4%B1%EF%BC%9A%E5%BD%93%E6%88%91%E4%BB%AC%E4%BF%AE%E6%94%B9%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%80%BC%E6%97%B6%EF%BC%8C%E4%B8%8D%E4%BC%9A%E8%A7%A6%E5%8F%91%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%EF%BC%8C%E8%BF%99%E6%98%AF%E7%94%B1%E4%BA%8E%E5%B1%95%E5%BC%80%E8%BF%90%E7%AE%97%E7%AC%A6(...)%E5%AF%BC%E8%87%B4%E7%9A%84%EF%BC%9A%0A%60%60%60js%0Areturn%20%7B%0A%20%20%20%20...obj%0A%7D%0A%2F%2F%20%E7%AD%89%E4%BB%B7%E4%BA%8E%0Areturn%20%7B%0A%20%20%20%20foo%3A%201%2C%0A%20%20%20%20bar%3A%202%0A%7D%0A%2F%2F%20%E8%BF%99%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E8%BF%94%E5%9B%9E%E4%BA%86%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%AE%83%E4%B8%8D%E5%85%B7%E5%A4%87%E4%BB%BB%E4%BD%95%E5%93%8D%E5%BA%94%E5%BC%8F%E8%83%BD%E5%8A%9B%E3%80%82%0A%60%60%60%0A%0A-%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%0A%60%60%60js%0Aconst%20obj%20%3D%20reactive(%7B%20foo%3A%201%2C%20bar%3A%202%20%7D)%0A%0A%2F%2F%20%E5%BD%93%E8%AF%BB%E5%8F%96%E5%80%BC%E6%97%B6%EF%BC%8C%E5%85%B6%E5%AE%9E%E8%AF%BB%E5%8F%96%E7%9A%84%E4%BA%8Bobj%E5%AF%B9%E8%B1%A1%E4%B8%8B%E7%9B%B8%E5%BA%94%E7%9A%84%E5%B1%9E%E6%80%A7%E5%80%BC%0Aconst%20newObj%20%3D%20%7B%0A%20%20%20%20foo%3A%20%7B%0A%20%20%20%20%20%20%20%20get%20value()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20obj.foo%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20bar%3A%20%7B%0A%20%20%20%20%20%20%20%20get%20value()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20obj.bar%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%A7%82%E5%AF%9FnewObj%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E5%AE%83%E7%9A%84%E7%BB%93%E6%9E%84%E5%AD%98%E5%9C%A8%E7%9B%B8%E4%BC%BC%E4%B9%8B%E5%A4%84%EF%BC%9A%0A%2F%2F%20%E8%BF%99%E6%A0%B7%E5%8F%AF%E4%BB%A5%E5%B0%86%E8%BF%99%E7%A7%8D%E7%BB%93%E6%9E%84%E6%8A%BD%E8%B1%A1%E5%87%BA%E6%9D%A5%E5%B9%B6%E5%B0%81%E8%A3%85%E6%88%90%E5%87%BD%E6%95%B0%0Afunction%20toRef(obj%2C%20key)%20%7B%0A%20%20%20%20const%20wrapper%20%3D%20%7B%0A%20%20%20%20%20%20%20%20get%20value()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20obj%5Bkey%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20wrapper%0A%7D%0A%0Afunction%20toRefs(obj)%20%7B%0A%20%20%20%20const%20ret%20%3D%20%7B%7D%0A%20%20%20%20for%20(const%20key%20in%20obj)%20%7B%0A%20%20%20%20%20%20%20%20ret%5Bkey%5D%20%3D%20toRef(obj%2C%20key)%0A%20%20%20%20%7D%0A%20%20%20%20return%20ret%0A%7D%0A%0A%2F%2F%20%E4%B8%BA%E4%BA%86%E6%A6%82%E5%BF%B5%E4%B8%8A%E7%BB%9F%E4%B8%80%EF%BC%8C%E4%BC%9A%E5%B0%86%E9%80%9A%E8%BF%87toRef%E6%88%96toRefs%E8%BD%AC%E6%8D%A2%E5%90%8E%E5%BE%97%E5%88%B0%E7%9A%84%E7%BB%93%E6%9E%9C%E8%A7%86%E4%B8%BA%E7%9C%9F%E6%AD%A3%E7%9A%84ref%E6%95%B0%E6%8D%AE%0Afunction%20toRef(obj%2C%20key)%20%7B%0A%20%20%20%20const%20wrapper%20%3D%20%7B%0A%20%20%20%20%20%20%20%20get%20value()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20obj%5Bkey%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20%E4%BD%BF%E7%94%A8Object.defineProperty%E5%9C%A8wrapper%E5%AF%B9%E8%B1%A1%E4%B8%8A%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%8F%AF%E6%9E%9A%E4%B8%BE%E7%9A%84%E5%B1%9E%E6%80%A7__v_isRef%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%80%BC%E4%B8%BAtrue%0A%20%20%20%20Object.defineProperty(wrapper%2C%20'__v_isRef'%2C%20%7B%0A%20%20%20%20%20%20%20%20value%3A%20true%0A%20%20%20%20%7D)%0A%20%20%20%20return%20wrapper%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E8%87%AA%E5%8A%A8%E8%84%B1ref%0A%E9%97%AE%E9%A2%98%EF%BC%9AtoRefs%E4%BC%9A%E6%8A%8A%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E7%AC%AC%E4%B8%80%E5%B1%82%E5%B1%9E%E6%80%A7%E5%80%BC%E8%BD%AC%E6%8D%A2%E4%B8%BAref%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%BF%85%E9%A1%BB%E9%80%9A%E8%BF%87value%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E5%80%BC%0A%60%60%60js%0Aconst%20obj%20%3D%20reactive(%7B%20foo%3A%201%20%7D)%0A%0Aconst%20newObj%20%3D%20%7B%20...toRefs(obj)%20%7D%0AnewObj.foo.value%20%2F%2F%201%0A%60%60%60%0A%0A%3E%20%E8%87%AA%E5%8A%A8%E8%84%B1ref%EF%BC%8C%E6%8C%87%E7%9A%84%E6%98%AF%E5%B1%9E%E6%80%A7%E7%9A%84%E8%AE%BF%E9%97%AE%E8%A1%8C%E4%B8%BA%EF%BC%8C%E5%8D%B3%E5%A6%82%E6%9E%9C%E8%AF%BB%E5%8F%96%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E4%B8%80%E4%B8%AAref%EF%BC%8C%E5%88%99%E7%9B%B4%E6%8E%A5%E5%B0%86%E8%AF%A5ref%E5%AF%B9%E5%BA%94%E7%9A%84value%E5%B1%9E%E6%80%A7%E5%80%BC%E8%BF%94%E5%9B%9E%0A%0A%60%60%60js%0A%2F%2F%20%E8%A6%81%E5%AE%9E%E7%8E%B0%E6%AD%A4%E5%8A%9F%E8%83%BD%EF%BC%8C%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8Proxy%E4%B8%BAnewObj%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1%0Afunction%20proxyRefs(target)%20%7B%0A%20%20%20%20return%20new%20Proxy(target%2C%20%7B%0A%20%20%20%20%20%20%20%20get(target%2C%20key%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20value%20%3D%20Reflect.get(target%2C%20key%2C%20receiver)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20value.__v_isRef%20%3F%20value.value%20%3A%20value%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%0Aconst%20newObj%20%3D%20proxyRefs(%7B%20...toRefs(obj)%20%7D)%0A%0A%2F%2F%20%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E5%9C%A8%E7%BC%96%E5%86%99%E7%BB%84%E4%BB%B6%E6%97%B6%EF%BC%8Csetup%E5%87%BD%E6%95%B0%E6%89%80%E8%BF%94%E5%9B%9E%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%9A%E4%BC%A0%E9%80%92%E7%BB%99proxyRefs%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%EF%BC%8C%E8%BF%99%E4%B9%9F%E5%B0%B1%E6%98%AF%E4%B8%BA%E4%BB%80%E4%B9%88%E5%9C%A8%E6%A8%A1%E7%89%88%E4%B8%AD%E6%88%91%E4%BB%AC%E4%B8%8D%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87value%E5%B1%9E%E6%80%A7%E6%9D%A5%E8%AE%BF%E9%97%AE%0A%0A%2F%2F%20%E5%90%8C%E7%90%86%EF%BC%8C%E8%AE%BE%E7%BD%AE%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC%E4%B9%9F%E5%BA%94%E8%AF%A5%E6%9C%89%E8%87%AA%E5%8A%A8%E4%B8%BAref%E8%AE%BE%E7%BD%AE%E5%80%BC%E7%9A%84%E8%83%BD%E5%8A%9B%0Afunction%20proxyRefs(target)%20%7B%0A%20%20%20%20return%20new%20Proxy(target%2C%20%7B%0A%20%20%20%20%20%20%20%20get(target%2C%20key%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20value%20%3D%20Reflect.get(target%2C%20key%2C%20receiver)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20value.__v_isRef%20%3F%20value.value%20%3A%20value%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20set(target%2C%20key%2C%20newValue%2C%20receiver)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20value%20%3D%20target%5Bkey%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(value.__v_isRef)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value.value%20%3D%20newValue%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20Reflect.set(target%2C%20key%2C%20newValue%2C%20receiver)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%0A%2F%2F%20%E8%87%AA%E5%8A%A8%E8%84%B1ref%E4%B8%8D%E4%BB%85%E5%87%BA%E7%8E%B0%E5%9C%A8setup%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E4%B8%AD%EF%BC%8C%E5%90%8C%E6%A0%B7%E4%B9%9F%E5%AD%98%E5%9C%A8reactive%E5%87%BD%E6%95%B0%0Aconst%20count%20%3D%20ref(0)%0Aconst%20obj%20%3D%20reactive(%7B%20count%20%7D)%0A%0Aobj.count%20%2F%2F%200%0A%2F%2F%20%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8Cobj.count%E6%9C%AC%E5%BA%94%E8%AF%A5%E6%98%AF%E4%B8%80%E4%B8%AAref%EF%BC%8C%E4%BD%86%E7%94%B1%E4%BA%8E%E8%87%AA%E5%8A%A8%E8%84%B1ref%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%97%A0%E9%A1%BB%E4%BD%BF%E7%94%A8value%E5%B1%9E%E6%80%A7%0A%0A%60%60%60%0A%0A%23%23%20%E7%AC%AC%E4%B8%89%E7%AF%87%E3%80%8A%E6%B8%B2%E6%9F%93%E5%99%A8%E3%80%8B%0A%23%23%23%20%E7%AC%AC7%E7%AB%A0%E3%80%8A%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E3%80%8B%0A%0A%60%60%60js%0Afunction%20renderer(domString%2C%20container)%20%7B%0A%20%20%20%20container.innerHtml%20%3D%20domString%3B%0A%7D%0Aconst%20ref%20%3D%20ref(1)%0Aeffect(()%20%3D%3E%20%7B%0A%20%20%20%20renderer(%60%3Ch1%3E%24%7Bcount.value%7D%3C%2Fh1%3E%60%2C%20document.getElementById('app'))%0A%7D)%0Acount.value%2B%2B%0A%2F%2F%20%E4%BF%AE%E6%94%B9count.value%E5%80%BC%E6%97%B6%EF%BC%8C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%BC%9A%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%AE%8C%E6%88%90%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%0A%60%60%60%0A%0A%23%23%23%23%20%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%0A%3E%20%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E6%8A%8A%E8%99%9A%E6%8B%9FDOM%E6%B8%B2%E6%9F%93%E4%B8%BA%E7%89%B9%E5%AE%9A%E5%B9%B3%E5%8F%B0%E4%B8%8A%E7%9A%84%E7%9C%9F%E5%AE%9E%E5%85%83%E7%B4%A0%0A%3E%20%E8%99%9A%E6%8B%9FDOM%E6%98%AF%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84%EF%BC%8C%E8%BF%99%E6%A3%B5%E6%A0%91%E4%B8%AD%E7%9A%84%E4%BB%BB%E4%BD%95%E4%B8%80%E4%B8%AAvnode%E8%8A%82%E7%82%B9%E9%83%BD%E5%8F%AF%E4%BB%A5%E6%98%AF%E4%B8%80%E9%A2%97%E5%AD%90%E6%A0%91%EF%BC%8C%E5%9B%A0%E6%AD%A4vnode%E5%92%8Cvdom%E6%9C%89%E6%97%B6%E5%8F%AF%E4%BB%A5%E6%9B%BF%E6%8D%A2%E4%BD%BF%E7%94%A8%E3%80%82%0A%3E%20%E6%B8%B2%E6%9F%93%E5%99%A8%E6%8A%8A%E8%99%9A%E6%8B%9FDOM%E8%8A%82%E7%82%B9%E6%B8%B2%E6%9F%93%E4%B8%BA%E7%9C%9F%E5%AE%9E%E8%8A%82%E7%82%B9%E7%9A%84%E8%BF%87%E7%A8%8B%E5%8F%AB%E5%81%9A**%E6%8C%82%E8%BD%BD**%0A%0A%60%60%60js%0Afunction%20createRenderer()%20%7B%0A%20%20%20%20function%20render(vnode%2C%20container)%20%7B%0A%20%20%20%20%20%20%20%20...%0A%20%20%20%20%7D%0A%20%20%20%20return%20render%3B%0A%7D%0A%2F%2F%20%E8%BF%99%E9%87%8C%E4%BD%BF%E7%94%A8createRender%E6%9D%A5%E5%88%9B%E5%BB%BA%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%9A%0A%2F%2F%20%E6%B8%B2%E6%9F%93%E5%99%A8%E4%B8%8E%E6%B8%B2%E6%9F%93%E4%B8%8D%E5%90%8C%EF%BC%8C%E6%B8%B2%E6%9F%93%E5%99%A8%E6%98%AF%E6%9B%B4%E5%8A%A0%E5%AE%BD%E6%B3%9B%E7%9A%84%E6%A6%82%E5%BF%B5%EF%BC%8C%E5%AE%83%E5%8C%85%E5%90%AB%E6%B8%B2%E6%9F%93%EF%BC%8C%E6%B8%B2%E6%9F%93%E5%99%A8%E4%B8%8D%E4%BB%85%E5%8F%AF%E4%BB%A5%E7%94%A8%E6%9D%A5%E6%B8%B2%E6%9F%93%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E7%94%A8%E6%9D%A5%E6%BF%80%E6%B4%BB%E5%B7%B2%E6%9C%89%E7%9A%84DOM%E5%85%83%E7%B4%A0%0A%0Afunction%20createRenderer()%20%7B%0A%20%20%20%20function%20render(vnode%2C%20container)%20%7B%0A%20%20%20%20%20%20%20%20...%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%0A%20%20%20%20function%20hydrate(vnode%2C%20container)%20%7B%0A%20%20%20%20%20%20%20%20...%0A%20%20%20%20%7D%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20render%2C%0A%20%20%20%20%20%20%20%20hydrate%2C%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E6%B8%B2%E6%9F%93%E5%99%A8%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%0Aconst%20renderer%20%3D%20createRenderer()%0A%2F%2F%20%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%0Arenderer.render(oldVnode%2C%20document.querySelector('%23app'))%0A%2F%2F%20%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%0Arenderer.render(newVnode%2C%20document.querySelector('%23app'))%0A%2F%2F%20%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E6%8C%82%E5%9C%A8vnode%EF%BC%8C%E4%BD%86%E6%98%AF%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%E4%BC%9A%E4%BD%BF%E7%94%A8newVnode%E4%B8%8E%E4%B8%8A%E4%B8%80%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%9A%84oldVnode%E8%BF%9B%E8%A1%8C%E6%AF%94%E8%BE%83%EF%BC%8C%E8%AF%95%E5%9B%BE%E6%89%BE%E5%88%B0%E5%B9%B6%E6%9B%B4%E6%96%B0%E5%8F%98%E6%9B%B4%E7%82%B9%EF%BC%8C%E8%BF%99%E4%B8%AA%E8%BF%87%E7%A8%8B%E5%8F%AB%E5%81%9A%22%E6%89%93%E8%A1%A5%E4%B8%81%22(patch)%0A%0Afunction%20createRenderer()%20%7B%0A%20%20%20%20function%20render(vnode%2C%20container)%20%7B%0A%20%20%20%20%20%20%20%20if%20(vnode)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%96%B0vnode%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%B0%86%E5%85%B6%E4%B8%8E%E6%97%A7vnode%E4%B8%80%E8%B5%B7%E4%BC%A0%E7%BB%99patch%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(container._vnode%2C%20vnode%2C%20container)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%97%A7vnode%E5%AD%98%E5%9C%A8%E4%B8%94%E6%96%B0vnode%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%B0%B1%E7%9B%B4%E6%8E%A5%E5%8D%B8%E8%BD%BD%E9%A1%B5%E9%9D%A2%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(container._vnode)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20container.innerHTML%20%3D%20''%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%8A%8Avnode%E5%AD%98%E5%82%A8%E5%88%B0container._vnode%E4%B8%8B%EF%BC%8C%E5%8D%B3%E5%90%8E%E7%BB%AD%E7%9A%84%E6%97%A7vnode%0A%20%20%20%20%20%20%20%20container._vnode%20%3D%20vnode%0A%20%20%20%20%7D%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20render%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20n1%3A%E6%97%A7vnode%EF%BC%9Bn2%3A%E6%96%B0vnode%EF%BC%9Bcontainer%3A%E5%AE%B9%E5%99%A8%0A%2F%2F%20%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%B8%B2%E6%9F%93%E6%97%B6%EF%BC%8Cn1%E6%98%AFundefined%EF%BC%8C%E5%9B%A0%E6%AD%A4%E7%9B%B4%E6%8E%A5%E6%8C%82%E8%BD%BD%EF%BC%8C%E6%89%80%E4%BB%A5patch%E5%87%BD%E6%95%B0%E4%B8%8D%E4%BB%85%E5%8F%AF%E4%BB%A5%E7%94%A8%E6%9D%A5%E6%89%93%E8%A1%A5%E4%B8%81%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E6%8C%82%E8%BD%BD%0Afunction%20patch(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20%2F%2F%20...%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E5%99%A8%0A%0A%60%60%60js%0Afunction%20createRenderer()%20%7B%0A%20%20%20%20function%20patch(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20%20%20%20%20if%20(!n1)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%B2%A1%E6%9C%89%E6%97%A7%E8%8A%82%E7%82%B9%E5%B0%B1%E7%9B%B4%E6%8E%A5%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20mountElement(n2%2C%20container)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20function%20mountElement(vnode%2C%20container)%20%7B%0A%20%20%20%20%20%20%20%20const%20el%20%3D%20document.createElement(vnode.type)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20if%20(typeof%20vnode.children%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20el.textContent%20%3D%20vnode.children%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20container.appendChild(el)%0A%20%20%20%20%7D%0A%20%20%20%20function%20render(vnode%2C%20container)%20%7B%0A%20%20%20%20%20%20%20%20if%20(vnode)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%96%B0vnode%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%B0%86%E5%85%B6%E4%B8%8E%E6%97%A7vnode%E4%B8%80%E8%B5%B7%E4%BC%A0%E7%BB%99patch%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(container._vnode%2C%20vnode%2C%20container)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%97%A7vnode%E5%AD%98%E5%9C%A8%E4%B8%94%E6%96%B0vnode%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%B0%B1%E7%9B%B4%E6%8E%A5%E5%8D%B8%E8%BD%BD%E9%A1%B5%E9%9D%A2%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(container._vnode)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20container.innerHTML%20%3D%20''%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%8A%8Avnode%E5%AD%98%E5%82%A8%E5%88%B0container._vnode%E4%B8%8B%EF%BC%8C%E5%8D%B3%E5%90%8E%E7%BB%AD%E7%9A%84%E6%97%A7vnode%0A%20%20%20%20%20%20%20%20container._vnode%20%3D%20vnode%0A%20%20%20%20%7D%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20render%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%BF%99%E9%87%8C%E5%A6%82%E6%9E%9C%E4%BD%BF%E7%94%A8mountElement%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%8E%89%E4%BA%86%E5%A4%A7%E9%87%8F%E5%9F%BA%E4%BA%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84API%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%A6%81%E8%AE%BE%E8%AE%A1%E9%80%9A%E7%94%A8%E6%B8%B2%E6%9F%93%E5%99%A8%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E5%B0%86%E8%BF%99%E4%BA%9B%E7%89%B9%E6%9C%89%E7%9A%84API%E6%8A%BD%E7%A6%BB%0A%0Aconst%20renderer%20%3D%20createRenderer(%7B%0A%20%20%20%20createElement(tag)%20%7B%0A%20%20%20%20%7D%2C%0A%20%20%20%20setElementText(el%2C%20text)%20%7B%0A%20%20%20%20%0A%20%20%20%20%7D%2C%0A%20%20%20%20insert(el%2C%20parent%2C%20anchor%20%3D%20null)%20%7B%0A%20%20%20%20%0A%20%20%20%20%7D%0A%7D)%3B%0A%0Afunction%20createRenderer(options)%20%7B%0A%20%20%20%20const%20%7B%0A%20%20%20%20%20%20%20%20createElement%2C%0A%20%20%20%20%20%20%20%20insert%2C%0A%20%20%20%20%20%20%20%20setElementText%2C%0A%20%20%20%20%7D%20%3D%20options%0A%20%20%20%20function%20mountElement(vnode%2C%20container)%20%7B%7D%0A%20%20%20%20function%20patch(n1%2C%20n2%2C%20contaner)%20%7B%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%20%E7%AC%AC8%E7%AB%A0%E3%80%8A%E6%8C%82%E8%BD%BD%E4%B8%8E%E6%9B%B4%E6%96%B0%E3%80%8B%0A%3E%20HTML%20Attributes%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E8%AE%BE%E7%BD%AE%E4%B8%8E%E4%B9%8B%E5%AF%B9%E5%BA%94%E7%9A%84DOM%20Properties%E7%9A%84%E5%88%9D%E5%A7%8B%E5%80%BC%0A%0A%23%23%23%23%20%E6%AD%A3%E7%A1%AE%E5%9C%B0%E8%AE%BE%E7%BD%AE%E5%85%83%E7%B4%A0%E5%B1%9E%E6%80%A7%0A%60%60%60js%0Afunction%20mountElement(vnode%2C%20container)%20%7B%0A%20%20%20%20const%20el%20%3D%20createElement(vnode.type)%0A%20%20%20%20%0A%20%20%20%20if%20(vnode.props)%20%7B%0A%20%20%20%20%20%20%20%20for%20(const%20key%20in%20vnode.props)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20if%20(key%20in%20el)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20type%20%3D%20typeof%20el%5Bkey%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20value%20%3D%20vnode.props%5Bkey%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(type%20%3D%3D%3D%20'boolean'%20%26%26%20value%20%3D%3D%3D%20'')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el%5Bkey%5D%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el%5Bkey%5D%20%3D%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20el.setAttribute(key%2C%20vnode.props%5Bkey%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20insert(el%2C%20container)%0A%7D%0A%0A%2F%2F%20%E9%97%AE%E9%A2%98%0A%2F%2F%20%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%BB%8D%E7%84%B6%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98%EF%BC%8C%E5%9B%A0%E4%B8%BA%E6%9C%89%E4%B8%80%E4%BA%9BDOM%20Properties%E6%97%B6%E5%8F%AA%E8%AF%BB%E7%9A%84%0A%3Cform%20id%3D%22form1%22%20%2F%3E%0A%3Cinput%20form%3D%22form1%22%20%2F%3E%0A%2F%2F%20el.form%E6%98%AF%E5%8F%AA%E8%AF%BB%E7%9A%84%EF%BC%8C%E8%BF%99%E6%97%B6%E5%8F%AA%E8%83%BD%E9%80%9A%E8%BF%87setAttribute%E5%87%BD%E6%95%B0%E6%9D%A5%E8%AE%BE%E7%BD%AE%E5%AE%83%0A%0Afunction%20shouldSetAsProps(el%2C%20key%2C%20value)%20%7B%0A%20%20%20%20if%20(key%20%3D%3D%3D%20'form'%20%26%26%20el.tagName%20%3D%3D%3D%20'INPUT')%20return%20false%0A%20%20%20%20return%20key%20in%20el%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20class%E7%9A%84%E5%A4%84%E7%90%86%0A%E8%AE%BE%E7%BD%AEclass%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A%0A-%20el.className%0A-%20el.setAttribute%0A-%20el.classList%0A%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F%E4%B8%AD%EF%BC%8Cel.className%E7%9A%84%E6%80%A7%E8%83%BD%E6%9C%80%E4%BC%98%EF%BC%8C%E6%89%80%E4%BB%A5%E9%87%87%E7%94%A8%E6%AD%A4%E6%96%B9%E6%B3%95%0A%60%60%60js%0Aif%20(key%20%3D%3D%3D%20'class')%20%7B%0A%20%20%20%20el.className%20%3D%20nextValue%20%7C%7C%20''%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E5%8D%B8%E8%BD%BD%E6%93%8D%E4%BD%9C%0A%3E%20%E5%8D%B8%E8%BD%BD%E6%93%8D%E4%BD%9C%E5%8F%91%E7%94%9F%E5%9C%A8%E6%9B%B4%E6%96%B0%E9%98%B6%E6%AE%B5%EF%BC%8C%E6%9B%B4%E6%96%B0%E6%8C%87%E7%9A%84%E6%98%AF%E5%9C%A8%E5%88%9D%E6%AC%A1%E6%8C%82%E8%BD%BD%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%90%8E%E7%BB%AD%E6%B8%B2%E6%9F%93%E4%BC%9A%E8%A7%A6%E5%8F%91%E6%9B%B4%E6%96%B0%0A%3E%20%E4%B9%8B%E5%89%8D%E9%80%9A%E8%BF%87%E4%BD%BF%E7%94%A8innerHTML%20%3D%20''%E6%9D%A5%E5%8D%B8%E8%BD%BD%E6%98%AF%E4%B8%8D%E4%B8%A5%E8%B0%A8%E7%9A%84%EF%BC%9A%0A%3E%20-%20%E5%AE%B9%E5%99%A8%E7%9A%84%E5%86%85%E5%AE%B9%E5%8F%AF%E8%83%BD%E6%98%AF%E7%94%B1%E6%9F%90%E4%B8%AA%E6%88%96%E5%A4%9A%E4%B8%AA%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E7%9A%84%EF%BC%8C%E5%BD%93%E5%8D%B8%E8%BD%BD%E6%93%8D%E4%BD%9C%E5%8F%91%E7%94%9F%E6%97%B6%E5%BA%94%E8%AF%A5%E6%AD%A3%E7%A1%AE%E5%9C%B0%E8%B0%83%E7%94%A8%E8%BF%99%E4%BA%9B%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%87%BD%E6%95%B0%0A%3E%20-%20%E5%8D%B3%E4%BD%BF%E5%86%85%E5%AE%B9%E4%B8%8D%E6%98%AF%E7%94%B1%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E7%9A%84%EF%BC%8C%E6%9C%89%E7%9A%84%E5%85%83%E7%B4%A0%E5%AD%98%E5%9C%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4%EF%BC%8C%E5%BA%94%E8%AF%A5%E5%9C%A8%E5%8D%B8%E8%BD%BD%E6%93%8D%E4%BD%9C%E5%8F%91%E7%94%9F%E6%97%B6%E6%AD%A3%E7%A1%AE%E6%89%A7%E8%A1%8C%E5%AF%B9%E5%BA%94%E7%9A%84%E6%8C%87%E4%BB%A4%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%0A%3E%20-%20innerHTML%E4%B8%8D%E4%BC%9A%E7%A7%BB%E9%99%A4%E7%BB%91%E5%AE%9A%E5%9C%A8DOM%E5%85%83%E7%B4%A0%E4%B8%8A%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%0A%0A%60%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%8D%B8%E8%BD%BD%E6%96%B9%E5%BC%8F%E6%98%AF%EF%BC%8C%E6%A0%B9%E6%8D%AEvnode%E5%AF%B9%E8%B1%A1%E8%8E%B7%E5%8F%96%E4%B8%8E%E5%85%B6%E7%9B%B8%E5%85%B3%E8%81%94%E7%9A%84%E7%9C%9F%E5%AE%9EDOM%E5%85%83%E7%B4%A0%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BD%BF%E7%94%A8%E5%8E%9F%E7%94%9FDOM%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95%E5%B0%86%E8%AF%A5DOM%E5%85%83%E7%B4%A0%E7%A7%BB%E9%99%A4%60%0A%0A%60%60%60js%0Afunction%20mountElement(vnode%2C%20container)%20%7B%0A%20%20%20%20%2F%2F%20%E8%AE%A9vnode.el%E5%BC%95%E7%94%A8%E7%9C%9F%E5%AE%9EDOM%E5%85%83%E7%B4%A0%0A%20%20%20%20const%20el%20%3D%20vnode.el%20%3D%20createElement(vnode.type)%0A%20%20%20%20%2F%2F%20...%0A%7D%0A%0Afunction%20render(vnode%2C%20container)%20%7B%0A%20%20%20%20if%20(vnode)%20%7B%0A%20%20%20%20%20%20%20%20patch(container._vnode%2C%20vnode%2C%20container)%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20if%20(container._vnode)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%A0%B9%E6%8D%AEvnode%E8%8E%B7%E5%8F%96%E8%A6%81%E5%8D%B8%E8%BD%BD%E7%9A%84%E7%9C%9F%E5%AE%9EDOM%E5%85%83%E7%B4%A0%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20el%20%3D%20container._vnode.el%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%8E%B7%E5%8F%96el%E7%9A%84%E7%88%B6%E5%85%83%E7%B4%A0%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20parent%20%3D%20el.parentNode%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(parent)%20parent.removeChild(el)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20unmount(container._vnode)%20%E5%B0%81%E8%A3%85%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20container._vnode%20%3D%20vnode%0A%7D%0A%0A%2F%2F%20%E5%B0%81%E8%A3%85%E5%88%B0unmount%0Afunction%20unmount(vnode)%20%7B%0A%20%20%20%20const%20parent%20%3D%20vnode.parentNode%0A%20%20%20%20if%20(parent)%20parent.removeChild(vnode.el)%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E5%8C%BA%E5%88%86vnode%E7%9A%84%E7%B1%BB%E5%9E%8B%0A%0A%3E%20%E5%BD%93vnode%E5%89%8D%E5%90%8Etype%E4%B8%8D%E4%B8%80%E8%87%B4%E6%97%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%85%88%E5%8D%B8%E8%BD%BD%E6%97%A7%E8%8A%82%E7%82%B9%EF%BC%8C%E7%84%B6%E5%90%8E%E6%8C%82%E8%BD%BD%E6%96%B0%E8%8A%82%E7%82%B9%0A%60%60%60js%0Afunction%20patch(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20if%20(n1%20%26%26%20n1.type%20!%3D%3D%20n2.type)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%9B%B4%E6%8E%A5%E5%8D%B8%E8%BD%BD%E6%97%A7%E7%9A%84vnode%0A%20%20%20%20%20%20%20%20unmount(n1)%3B%0A%20%20%20%20%20%20%20%20n1%20%3D%20null%0A%20%20%20%20%7D%0A%20%20%20%20const%20%7B%20type%20%7D%20%3D%20n2%0A%20%20%20%20if%20(typeof%20type%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20if%20(!n1)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20mountElement(n2%2C%20container)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%9B%B4%E6%96%B0%0A%20%20%20%20%20%20%20%20%20%20%20%20patchElement(n1%2C%20n2)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20if%20(typeof%20type%20%3D%3D%3D%20'object')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20n2.type%E6%8F%8F%E8%BF%B0%E7%9A%84%E6%98%AF%E7%BB%84%E4%BB%B6%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20'xxx')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A4%84%E7%90%86%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B%E7%9A%84vnode%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%A4%84%E7%90%86%0A%3E%20%E7%BA%A6%E5%AE%9A%EF%BC%8C%E5%9C%A8vnode.props%E5%AF%B9%E8%B1%A1%E4%B8%AD%EF%BC%8C%E5%87%A1%E6%98%AF%E4%BB%A5%E5%AD%97%E7%AC%A6%E4%B8%B2on%E5%BC%80%E5%A4%B4%E7%9A%84%E5%B1%9E%E6%80%A7%E9%83%BD%E8%A7%86%E4%BD%9C%E4%BA%8B%E4%BB%B6%0A%0A%60%60%60js%0A%2F%2F%20%E5%9C%A8patchprops%E4%B8%AD%E8%B0%83%E7%94%A8addEventlistener%E6%9D%A5%E7%BB%91%E5%AE%9A%E4%BA%8B%E4%BB%B6%0Afunction%20patchProps(el%2C%20key%2C%20prevValue%2C%20nextValue)%20%7B%0A%20%20%20%20if%20(%2F%5Eon%2F.test(key))%20%7B%0A%20%20%20%20%20%20%20%20const%20name%20%3D%20key.slice(2).toLowerCase()%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%A7%BB%E9%99%A4%E4%B8%8A%E4%B8%80%E6%AC%A1%E7%BB%91%E5%AE%9A%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20prevValue%20%26%26%20el.removeEventListener(name%2C%20prevValue)%0A%20%20%20%20%20%20%20%20el.addEventListener(name%2C%20nextValue)%0A%20%20%20%20%7D%20else%20if%20(key%20%3D%3D%3D%20'class')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(shouldSetAsProps(el%2C%20key%2C%20nextValue))%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E4%BD%BF%E7%94%A8invokers%E6%9D%A5%E5%B0%81%E8%A3%85%0Afunction%20patchProps(el%2C%20key%2C%20prevValue%2C%20nextValue)%20%7B%0A%20%20%20%20if%20(%2F%5Eon%2F.test(key))%20%7B%0A%20%20%20%20%20%20%20%20const%20invokers%20%3D%20el._vei%20%7C%7C%20(el._vel%20%3D%20%7B%7D)%0A%20%20%20%20%20%20%20%20let%20invoker%20%3D%20invokers%5Bkey%5D%0A%20%20%20%20%20%20%20%20const%20name%20%3D%20key.slice(2).toLowerCase()%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20if%20(nextValue)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(!invoker)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20invoker%20%3D%20el._vei%5Bkey%5D%20%3D%20(e)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(Array.isArray(invoker.value))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20invoker.value.forEach(fn%20%3D%3E%20fn(e))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20invoker.value(e)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20invoker.value%20%3D%20nextValue%0A%20%20%20%20%20%20%20%20%20%20%20%20el.addEventListener(name%2C%20invoker)%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(invoker)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20el.removeEventListener(name%2C%20invoker)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20if%20(key%20%3D%3D%3D%20'class')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(shouldSetAsProps(el%2C%20key%2C%20nextValue))%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E4%BA%8B%E4%BB%B6%E5%86%92%E6%B3%A1%E4%B8%8E%E6%9B%B4%E6%96%B0%E6%97%B6%E6%9C%BA%E9%97%AE%E9%A2%98%0A%0A%3E%20%E9%80%9A%E8%BF%87%E6%AF%94%E8%BE%83%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91%E6%97%B6%E9%97%B4%E5%92%8C%E4%BA%8B%E4%BB%B6%E5%86%92%E6%B3%A1%E6%97%B6%E9%97%B4%E6%9D%A5%E5%86%B3%E5%AE%9A%E4%BA%8B%E4%BB%B6%E6%89%A7%E8%A1%8C%0A%3E%20%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91%E6%97%B6%E7%9A%84%E4%BA%8B%E4%BB%B6%EF%BC%8C%E5%92%8C%E4%BA%8B%E4%BB%B6%E9%87%8D%E6%96%B0%E7%BB%91%E5%AE%9A%E5%90%8E%EF%BC%8C%E5%86%92%E6%B3%A1%E8%A7%A6%E5%8F%91%E7%9A%84%E6%97%B6%E9%97%B4%E5%81%9A%E6%AF%94%E8%BE%83%0A%0A%23%23%23%23%20%E6%9B%B4%E6%96%B0%E5%AD%90%E8%8A%82%E7%82%B9%0A%0A%23%23%23%23%20%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%E5%92%8C%E6%B3%A8%E9%87%8A%E8%8A%82%E7%82%B9%0A%0A%23%23%23%23%20Fragment%0A%3E%20%E5%A4%9A%E6%A0%B9%E8%8A%82%E7%82%B9%E6%A8%A1%E7%89%88%0A%3E%20%E5%92%8C%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%E4%B8%8E%E6%B3%A8%E9%87%8A%E8%8A%82%E7%82%B9%E7%B1%BB%E4%BC%BC%EF%BC%8C%E7%89%87%E6%AE%B5%E4%B9%9F%E6%B2%A1%E6%9C%89%E6%89%80%E8%B0%93%E7%9A%84%E6%A0%87%E7%AD%BE%E5%90%8D%E7%A7%B0%0A%0A%60%60%60js%0Aconst%20vnode%20%3D%20%7B%0A%20%20%20%20type%3A%20Fragment%2C%0A%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20type%3A%20'li'%2C%20children%3A%20'1'%20%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20type%3A%20'li'%2C%20children%3A%20'2'%20%7D%2C%0A%20%20%20%20%5D%0A%7D%0A%0Afunction%20patch(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20if%20(n1%20%26%26%20n1.type%20!%3D%3D%20n2.type)%20%7B%0A%20%20%20%20%20%20%20%20unmount(n1)%0A%20%20%20%20%20%20%20%20n1%20%3D%20null%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20type%20%7D%20%3D%20n2%0A%20%20%20%20if%20(typeof%20type%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Text)%20%7B%20%2F%2F%20Text%20%3D%20Symbol()%20%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20%2F%2F%20..%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Fragment)%20%7B%20%2F%2F%20Fragment%20%3D%20Symbol()%20%E7%89%87%E6%AE%B5%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20if%20(!n1)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%97%A7vnode%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%88%99%E5%8F%AA%E9%9C%80%E8%A6%81%E5%B0%86Fragment%E7%9A%84children%E9%80%90%E4%B8%AA%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20n2.children.forEach(c%20%3D%3E%20patch(null%2C%20c%2C%20container))%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E6%97%A7vnode%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%88%99%E5%8F%AA%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0Fragment%E7%9A%84Children%0A%20%20%20%20%20%20%20%20%20%20%20%20patchChildren(n1%2C%20n2%2C%20container)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%EF%BC%8C%E5%8D%B8%E8%BD%BD%E8%8A%82%E7%82%B9%E4%B9%9F%E9%9C%80%E8%A6%81%E6%94%AF%E6%8C%81Fragment%0Afunction%20unmount(vnode)%20%7B%0A%20%20%20%20if%20(vnode.type%20%3D%3D%3D%20Fragment)%20%7B%0A%20%20%20%20%20%20%20%20vnode.children.forEach(c%20%3D%3E%20unmount(c))%0A%20%20%20%20%20%20%20%20return%0A%20%20%20%20%7D%0A%20%20%20%20const%20parent%20%3D%20vnode.el.parentNode%0A%20%20%20%20if%20(parent)%20%7B%0A%20%20%20%20%20%20%20%20parent.removeChild(vnode.el)%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E6%80%BB%E7%BB%93%0A-%20%E4%B8%BA%E5%85%83%E7%B4%A0%E8%AE%BE%E7%BD%AE%E5%B1%9E%E6%80%A7%EF%BC%8C%E4%B8%8D%E8%83%BD%E6%80%BB%E4%BD%BF%E7%94%A8setAttribute%E6%88%96%E8%80%85%E9%80%9A%E8%BF%87%E5%85%83%E7%B4%A0%E7%9A%84DOM%20Properties%E6%9D%A5%E8%AE%BE%E7%BD%AE%0A-%20%E7%89%B9%E6%AE%8A%E5%B1%9E%E6%80%A7%E7%9A%84%E5%A4%84%E7%90%86%EF%BC%8C%E5%A6%82class%2Cstyle%0A-%20%E5%8D%B8%E8%BD%BD%E7%BB%84%E4%BB%B6%E4%B8%8D%E8%83%BD%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8innerHTML%2C%E9%9C%80%E8%A6%81%E8%A7%A6%E5%8F%91%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E3%80%81%E6%8C%87%E4%BB%A4%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E3%80%81%E7%A7%BB%E9%99%A4DOM%E5%85%83%E7%B4%A0%E4%B8%8A%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%0A-%20vnode%E7%B1%BB%E5%9E%8B%E5%8C%BA%E5%88%86%0A-%20vnode%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%0A-%20%E4%BA%8B%E4%BB%B6%E4%B8%8E%E6%9B%B4%E6%96%B0%E6%97%B6%E6%9C%BA%E7%9A%84%E9%97%AE%E9%A2%98%0A-%20%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%B4%E6%96%B0%0A-%20Fragment%E3%80%81%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%E3%80%81%E6%B3%A8%E9%87%8A%E8%8A%82%E7%82%B9%E7%9A%84%E5%AE%9E%E7%8E%B0%0A%0A%23%23%23%20%E7%AC%AC9%E7%AB%A0%E3%80%8A%E7%AE%80%E5%8D%95Diff%E7%AE%97%E6%B3%95%E3%80%8B%0A%0A%23%23%23%23%20%E5%87%8F%E5%B0%91DOM%E6%93%8D%E4%BD%9C%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80%0A%0A%60%60%60js%0Afunction%20patchChildren(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20if%20(typeof%20n2.children%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(Array.isArray(n2.children))%20%7B%0A%20%20%20%20%20%20%20%20const%20oldChildren%20%3D%20n1.children%3B%0A%20%20%20%20%20%20%20%20const%20newChildren%20%3D%20n2.children%3B%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%200%3B%20i%20%3C%20oldChildren.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(oldChildren%5Bi%5D%2C%20newChildren%5Bi%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E5%9C%A8%E9%81%8D%E5%8E%86%E6%96%B0%E6%97%A7%E8%8A%82%E7%82%B9%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%B8%8D%E8%83%BD%E6%80%BB%E6%98%AF%E9%81%8D%E5%8E%86%E6%97%A7%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E6%88%96%E8%80%85%E6%96%B0%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%EF%BC%8C%E5%BA%94%E8%AF%A5%E9%81%8D%E5%8E%86%E5%85%B6%E4%B8%AD%E9%95%BF%E5%BA%A6%E8%BE%83%E7%9F%AD%E7%9A%84%E9%82%A3%E4%B8%80%E7%BB%84%E3%80%82%E6%8E%A5%E7%9D%80%E5%86%8D%E6%AF%94%E8%BE%83%E6%96%B0%E6%97%A7%E4%B8%A4%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E9%95%BF%E5%BA%A6%EF%BC%8C%E5%88%A4%E6%96%AD%E9%9C%80%E8%A6%81%E6%8C%82%E8%BD%BD%E8%BF%98%E6%98%AF%E5%8D%B8%E8%BD%BD%0Afunction%20patchChildren(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20if%20(typeof%20n2.children%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(Array.isArray(n2.children))%20%7B%0A%20%20%20%20%20%20%20%20const%20oldChildren%20%3D%20n1.children%3B%0A%20%20%20%20%20%20%20%20const%20newChildren%20%3D%20n2.children%3B%0A%20%20%20%20%20%20%20%20const%20oldLen%20%3D%20oldChildren.length%0A%20%20%20%20%20%20%20%20const%20newLen%20%3D%20newChildren.length%0A%20%20%20%20%20%20%20%20const%20commonLength%20%3D%20Math.min(oldLen%2C%20newLen)%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%200%3B%20i%20%3C%20commonLength%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(oldChildren%5Bi%5D%2C%20newChildren%5Bi%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20if%20(newLen%20%3E%20oldLen)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20for(let%20i%20%3D%20commonLength%3B%20i%20%3C%20newLen%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20newChildren%5Bi%5D%2C%20container)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(oldLen%20%3E%20newLen)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20for(let%20i%20%3D%20commonLength%3B%20i%20%3C%20oldLen%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unmount(oldChildren%5Bi%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20DOM%E5%A4%8D%E7%94%A8%E4%B8%8Ekey%E7%9A%84%E4%BD%9C%E7%94%A8%0A%3E%20%E4%B9%8B%E5%89%8D%E7%9A%84%E5%81%9A%E6%B3%95%E5%8F%AF%E4%BB%A5%E5%87%8F%E5%B0%91DOM%E6%93%8D%E4%BD%9C%E7%9A%84%E6%AC%A1%E6%95%B0%EF%BC%8C%E4%BD%86%E8%BF%99%E7%A7%8D%E6%96%B9%E5%BC%8F%E4%BB%8D%E7%84%B6%E5%AD%98%E5%9C%A8%E5%8F%AF%E4%BC%98%E5%8C%96%E7%9A%84%E7%A9%BA%E9%97%B4%0A%60%60%60js%0A%5B%0A%20%20%20%20%7B%20type%3A%20'p'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'div'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'span'%20%7D%0A%5D%20%2F%2F%20oldChildren%0A%0A%5B%0A%20%20%20%20%7B%20type%3A%20'span'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'p'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'div'%20%7D%0A%5D%20%2F%2F%20newChildren%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E6%8C%89%E7%85%A7%E4%B9%8B%E5%89%8D%E7%9A%84%E5%81%9A%E6%B3%95%EF%BC%8C%E8%BF%99%E9%87%8C%E9%9C%80%E8%A6%81%E6%89%A7%E8%A1%8C6%E6%AC%A1DOM%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%AF%8F%E6%AC%A1%E9%83%BD%E9%9C%80%E8%A6%81%E5%85%88%E5%8D%B8%E8%BD%BD%E5%86%8D%E6%8C%82%E8%BD%BD%0A%2F%2F%20%E4%BD%86%E6%98%AF%E8%A7%82%E5%AF%9F%E5%8F%91%E7%8E%B0%EF%BC%8C%E4%B8%A4%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E4%BB%85%E4%BB%85%E6%98%AF%E9%A1%BA%E5%BA%8F%E4%B8%8D%E5%90%8C%EF%BC%8C%E6%89%80%E4%BB%A5%E6%9C%80%E4%BC%98%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F%E6%98%AF%EF%BC%8C%E9%80%9A%E8%BF%87DOM%E7%9A%84%E7%A7%BB%E5%8A%A8%E6%9D%A5%E5%AE%8C%E6%88%90%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%B4%E6%96%B0%0A%2F%2F%20%E4%BD%86%E6%98%AF%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E6%96%B0%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E5%B0%B1%E6%98%AF%E4%B9%8B%E5%89%8D%E5%87%BA%E7%8E%B0%E7%9A%84%E6%97%A7%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E5%91%A2%EF%BC%8C%E8%BF%99%E6%97%B6%E5%80%99%E5%B0%B1%E9%9C%80%E8%A6%81%E5%BC%95%E5%85%A5%E9%A2%9D%E5%A4%96%E7%9A%84key%E6%9D%A5%E4%BD%9C%E4%B8%BAvnode%E7%9A%84%E6%A0%87%E8%AF%86%0A%0A%5B%0A%20%20%20%20%7B%20type%3A%20'p'%2C%20children%3A%20'1'%2C%20key%3A%201%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'p'%2C%20children%3A%20'2'%2C%20key%3A%202%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'p'%2C%20children%3A%20'3'%2C%20key%3A%203%20%7D%0A%5D%20%2F%2F%20oldChildren%0A%0A%5B%0A%20%20%20%20%7B%20type%3A%20'p'%2C%20children%3A%20'3'%2C%20key%3A%203%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'p'%2C%20children%3A%20'1'%2C%20key%3A%201%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'p'%2C%20children%3A%20'2'%2C%20key%3A%202%20%7D%0A%5D%20%2F%2F%20newChildren%0A%0A%2F%2F%20key%E5%B1%9E%E6%80%A7%E5%B0%B1%E5%83%8F%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E7%9A%84%E2%80%9C%E8%BA%AB%E4%BB%BD%E8%AF%81%E2%80%9D%EF%BC%8C%E5%8F%AA%E8%A6%81%E4%B8%A4%E4%B8%AA%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E7%9A%84type%E5%B1%9E%E6%80%A7%E5%80%BC%E5%92%8Ckey%E5%B1%9E%E6%80%A7%E5%80%BC%E9%83%BD%E7%9B%B8%E5%90%8C%EF%BC%8C%E9%82%A3%E4%B9%88%E6%88%91%E4%BB%AC%E5%B0%B1%E8%AE%A4%E4%B8%BA%E5%AE%83%E4%BB%AC%E6%98%AF%E7%9B%B8%E5%90%8C%E7%9A%84%0A%2F%2F%20%E5%B0%B1%E7%AE%97DOM%E5%8F%AF%E4%BB%A5%E5%A4%8D%E7%94%A8%EF%BC%8C%E6%9C%89%E6%97%B6%E4%B9%9F%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E6%9B%B4%E6%96%B0%EF%BC%8C%E5%9B%A0%E4%B8%BADOM%E7%9A%84%E5%86%85%E5%AE%B9%E5%8F%AF%E8%83%BD%E6%94%B9%E5%8F%98%E4%BA%86%0A%0A%2F%2F%20%E5%8F%8C%E9%87%8Dfor%E5%BE%AA%E7%8E%AF%E5%AF%BB%E6%89%BE%E7%9B%B8%E5%90%8CDOM%0Afor(let%20i%20%3D%200%3B%20i%20%3C%20newChildren.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20const%20newVnode%20%3D%20newChildren%5Bi%5D%0A%20%20%20%20for(let%20j%20%3D%200%3B%20j%20%3C%20oldChildren.length%3B%20j%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20const%20oldVnode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20%20%20%20%20if%20(newVnode.key%20%3D%3D%3D%20oldVnode.key)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%8F%AF%E4%BB%A5%E5%A4%8D%E7%94%A8%EF%BC%8C%E4%BD%86%E4%BB%8D%E7%84%B6%E9%9C%80%E8%A6%81%E8%B0%83%E7%94%A8patch%E5%87%BD%E6%95%B0%E6%9B%B4%E6%96%B0%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(oldVnode%2C%20newVnode%2C%20container)%0A%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E6%89%BE%E5%88%B0%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%E7%9A%84%E5%85%83%E7%B4%A0%0A%0A%0A%23%23%23%23%20%E5%A6%82%E4%BD%95%E7%A7%BB%E5%8A%A8%E5%85%83%E7%B4%A0%0A%E6%AF%8F%E6%AC%A1%E6%96%B0%E6%97%A7%E8%8A%82%E7%82%B9%E6%AF%94%E8%BE%83%E6%97%B6%EF%BC%8C%E5%AD%98%E5%82%A8%E9%81%87%E5%88%B0%E7%9A%84%E6%9C%80%E5%A4%A7%E7%9A%84%E6%97%A7%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E7%B4%A2%E5%BC%95%EF%BC%8C%E7%84%B6%E5%90%8E%E5%90%8E%E9%9D%A2%E6%AF%8F%E6%AC%A1%E6%AF%94%E8%BE%83%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%AF%94%E8%BF%99%E4%B8%AA%E7%B4%A2%E5%BC%95%E5%B0%8F%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%0A%0A%0A%23%23%23%23%20%E6%B7%BB%E5%8A%A0%E6%96%B0%E5%85%83%E7%B4%A0%0A%0A%0A%23%23%23%23%20%E7%A7%BB%E9%99%A4%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E5%85%83%E7%B4%A0%0A%0A%3E%20%E5%BD%93%E5%9F%BA%E6%9C%AC%E7%9A%84%E6%9B%B4%E6%96%B0%E7%BB%93%E6%9D%9F%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E9%81%8D%E5%8E%86%E6%97%A7%E7%9A%84%E4%B8%80%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%EF%BC%8C%E7%84%B6%E5%90%8E%E5%8E%BB%E6%96%B0%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E4%B8%AD%E5%AF%BB%E6%89%BE%E5%85%B7%E6%9C%89%E7%9B%B8%E5%90%8Ckey%E7%9A%84%E8%8A%82%E7%82%B9%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%89%BE%E4%B8%8D%E5%88%B0%EF%BC%8C%E5%88%99%E8%AF%B4%E6%98%8E%E5%BA%94%E8%AF%A5%E5%88%A0%E9%99%A4%E8%AF%A5%E8%8A%82%E7%82%B9%0A%60%60%60js%0Afor%20(let%20i%20%3D%200%3B%20i%20%3C%20oldChildren.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20const%20oldVnode%20%3D%20oldChildren%5Bi%5D%0A%20%20%20%20%0A%20%20%20%20const%20has%20%3D%20newChildren.find(vnode%20%3D%3E%20vnode.key%20%3D%3D%3D%20oldVnode.key)%0A%20%20%20%20if%20(!has)%20%7B%0A%20%20%20%20%20%20%20%20unmount(oldVnode)%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E6%80%BB%E7%BB%93%0A-%20%E7%AE%80%E5%8D%95diff%E7%9A%84%E6%A0%B8%E5%BF%83%EF%BC%9A%0A%20%20%20%20-%20%E6%8B%BF%E6%96%B0%E7%9A%84%E4%B8%80%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%20%E4%B8%AD%E7%9A%84%E8%8A%82%E7%82%B9%E5%8E%BB%E6%97%A7%E7%9A%84%E4%B8%80%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E4%B8%AD%E5%AF%BB%E6%89%BE%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E8%8A%82%E7%82%B9%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%89%BE%E5%88%B0%E4%BA%86%E5%B0%B1%E8%AE%B0%E5%BD%95%E8%AF%A5%E8%8A%82%E7%82%B9%E7%9A%84%E4%BD%8D%E7%BD%AE%EF%BC%8C%E6%8A%8A%E8%BF%99%E4%B8%AA%E4%BD%8D%E7%BD%AE%E7%B4%A2%E5%BC%95%E7%A7%B0%E4%B8%BA%E6%9C%80%E5%A4%A7%E7%B4%A2%E5%BC%95%0A%20%20%20%20-%20%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E7%B4%A2%E5%BC%95%E5%80%BC%E5%B0%8F%E4%BA%8E%E6%9C%80%E5%A4%A7%E7%B4%A2%E5%BC%95%EF%BC%8C%E5%88%99%E8%AF%B4%E6%98%8E%E8%AF%A5%E8%8A%82%E7%82%B9%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%0A%0A%0A%23%23%23%20%E7%AC%AC10%E7%AB%A0%E3%80%8A%E5%8F%8C%E7%AB%AFDiff%E7%AE%97%E6%B3%95%E3%80%8B%0A%3E%20%E4%B8%8A%E4%B8%80%E7%AB%A0%E7%9A%84%E7%AE%80%E5%8D%95Diff%E7%AE%97%E6%B3%95%E4%BB%8D%E7%84%B6%E5%AD%98%E5%9C%A8%E5%BE%88%E5%A4%9A%E7%BC%BA%E9%99%B7%EF%BC%8C%E8%BF%99%E4%BA%9B%E7%BC%BA%E9%99%B7%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%8F%8C%E7%AB%AFDiff%E7%AE%97%E6%B3%95%E8%A7%A3%E5%86%B3%0A%3E%20%E7%AE%80%E5%8D%95Diff%E7%AE%97%E6%B3%95%E7%9A%84%E9%97%AE%E9%A2%98%E5%9C%A8%E4%BA%8E%E5%AF%B9DOM%E7%9A%84%E7%A7%BB%E5%8A%A8%E6%93%8D%E4%BD%9C%E5%B9%B6%E4%B8%8D%E6%98%AF%E6%9C%80%E4%BC%98%E7%9A%84%0A%0A%23%23%23%23%20%E5%8F%8C%E7%AB%AF%E6%AF%94%E8%BE%83%E7%9A%84%E5%8E%9F%E7%90%86%0A%0A%E5%9C%A8%E5%8F%8C%E7%AB%AF%E6%AF%94%E8%BE%83%E4%B8%AD%EF%BC%8C%E6%AF%8F%E4%B8%80%E8%BD%AE%E6%AF%94%E8%BE%83%E9%83%BD%E5%88%86%E4%B8%BA%E5%9B%9B%E4%B8%AA%E6%AD%A5%E9%AA%A4%EF%BC%9A%0A-%20%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%8C%E6%AF%94%E8%BE%83%E6%97%A7%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E5%92%8C%E6%96%B0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%0A%20%20%20%20%E5%A6%82%E6%9E%9C%E5%AE%83%E4%BB%AC%E7%9A%84key%E7%9B%B8%E5%90%8C%EF%BC%8C%E9%82%A3%E4%B9%88%E8%AF%B4%E6%98%8E%E5%8F%AF%E4%BB%A5%E5%A4%8D%E7%94%A8%0A-%20%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%8C%E6%AF%94%E8%BE%83%E6%97%A7%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E5%92%8C%E6%96%B0%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%0A%20%20%20%20%E5%A6%82%E6%9E%9C%E5%AE%83%E4%BB%AC%E7%9A%84key%E7%9B%B8%E5%90%8C%EF%BC%8C%E9%82%A3%E4%B9%88%E8%AF%B4%E6%98%8E%E5%8F%AF%E4%BB%A5%E5%A4%8D%E7%94%A8%0A-%20%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%8C%E6%AF%94%E8%BE%83%E6%97%A7%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E5%92%8C%E6%96%B0%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%0A%20%20%20%20%E5%A6%82%E6%9E%9C%E5%AE%83%E4%BB%AC%E7%9A%84key%E7%9B%B8%E5%90%8C%EF%BC%8C%E9%82%A3%E4%B9%88%E8%AF%B4%E6%98%8E%E5%8F%AF%E4%BB%A5%E5%A4%8D%E7%94%A8%EF%BC%8C%E9%9C%80%E8%A6%81%E5%B0%86%E6%97%A7%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E7%A7%BB%E5%8A%A8%E5%88%B0%E6%97%A7%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E5%90%8E%E9%9D%A2%EF%BC%8C%E7%84%B6%E5%90%8E%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95....%0A-%20%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%8C%E6%AF%94%E8%BE%83%E6%97%A7%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E5%92%8C%E6%96%B0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%0A%20%20%20%20%E5%A6%82%E6%9E%9C%E5%AE%83%E4%BB%AC%E7%9A%84key%E7%9B%B8%E5%90%8C%EF%BC%8C%E9%82%A3%E4%B9%88%E8%AF%B4%E6%98%8E%E5%8F%AF%E4%BB%A5%E5%A4%8D%E7%94%A8%EF%BC%8C%E5%B0%B1%E5%B0%86%E6%97%A7%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E7%A7%BB%E5%8A%A8%E5%88%B0%E6%97%A7%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E5%89%8D%E9%9D%A2%EF%BC%8C%E7%84%B6%E5%90%8E%E6%9B%B4%E6%96%B0%E7%B4%A2%E5%BC%95%EF%BC%9AoldEndVNode%20%3D%20oldChildren%5B--oldEndIdx%5D%EF%BC%9BnewStartVNode%20%3D%20newChildren%5B%2B%2BnewStartIdx%5D%0A%20%20%20%20%0A%60%E8%BF%99%E5%9B%9B%E6%AD%A5%E7%9A%84%E6%AF%94%E8%BE%83%E9%9C%80%E8%A6%81%E5%B0%81%E8%A3%85%E5%88%B0%E4%B8%80%E4%B8%AAwhile%E5%BE%AA%E7%8E%AF%E4%B8%AD%60%0A%0A%60%60%60js%0A%2F%2F%20%E5%A4%B4%E9%83%A8%E7%B4%A2%E5%BC%95%E5%80%BC%E8%A6%81%E5%B0%8F%E4%BA%8E%E5%B0%BE%E9%83%A8%E7%B4%A2%E5%BC%95%E5%80%BC%0Awhile(oldStartIdx%20%3C%3D%20oldEndIdx%20%26%26%20newStartIdx%20%3C%3D%20newEndIdx)%20%7B%0A%20%20%20%20if%20(oldStartVnode.key%20%3D%3D%3D%20newStartVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%B8%80%E6%AD%A5%0A%20%20%20%20%20%20%20%20%2F%2F%20%E9%83%BD%E5%9C%A8%E5%A4%B4%E9%83%A8%EF%BC%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81patch%0A%20%20%20%20%20%20%20%20patch(oldStartVnode%2C%20newStartVNode%2C%20container)%0A%20%20%20%20%20%20%20%20oldStartVNode%20%3D%20oldChildren%5B%2B%2BoldStartIdx%5D%0A%20%20%20%20%20%20%20%20newStartVNode%20%3D%20newChildren%5B%2B%2BnewStartIdx%5D%0A%20%20%20%20%7D%20else%20if%20(oldEndVnode.key%20%3D%3D%3D%20newEndVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%BA%8C%E6%AD%A5%0A%20%20%20%20%20%20%20%20%2F%2F%20%E9%83%BD%E5%9C%A8%E5%B0%BE%E9%83%A8%EF%BC%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81patch%0A%20%20%20%20%20%20%20%20patch(oldEndVNode%2C%20newEndVNode%2C%20container)%0A%20%20%20%20%20%20%20%20oldEndVNode%20%3D%20oldChildren%5B--oldEndIdx%5D%0A%20%20%20%20%20%20%20%20newEndVNode%20%3D%20newChildren%5B--newEndIdx%5D%0A%20%20%20%20%7D%20else%20if%20(oldStartVnode.key%20%3D%3D%3D%20newEndVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%B8%89%E6%AD%A5%0A%20%20%20%20%20%20%20%20patch(oldStartVnode%2C%20newEndVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20insert(oldStartVNode.el%2C%20container%2C%20oldEndVNode.el.nextSibling)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20oldStartVNode%20%3D%20oldChildren%5B%2B%2BoldStartIdx%5D%0A%20%20%20%20%20%20%20%20newEndVNode%20%3D%20newChildren%5B--newEndIdx%5D%0A%20%20%20%20%7D%20else%20if%20(oldEndVnode.key%20%3D%3D%3D%20newStartVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E5%9B%9B%E6%AD%A5%0A%20%20%20%20%20%20%20%20patch(oldEndVNode%2C%20newStartVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20insert(oldEndVNode.el%2C%20container%2C%20oldStartVNode.el)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20oldEndVNode%20%3D%20oldChildren%5B--oldEndIdx%5D%0A%20%20%20%20%20%20%20%20newStartVNode%20%3D%20newChildren%5B%2B%2BnewStartIdx%5D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E5%8F%8C%E7%AB%AF%E6%AF%94%E8%BE%83%E7%9A%84%E4%BC%98%E5%8A%BF%0A%5B1%2C%202%2C%203%5D%E5%88%B0%5B3%2C%201%2C%202%5D%E7%AE%80%E5%8D%95Diff%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%E4%B8%A4%E6%AC%A1DOM%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8F%8C%E7%AB%AF%E6%AF%94%E8%BE%83%E5%8F%AA%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%E4%B8%80%E6%AC%A1%0A%0A%23%23%23%23%20%E9%9D%9E%E7%90%86%E6%83%B3%E7%8A%B6%E5%86%B5%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F%0A%3E%20%E7%90%86%E6%83%B3%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E6%AF%8F%E4%B8%80%E8%BD%AE%E9%83%BD%E4%BC%9A%E5%91%BD%E4%B8%AD%E5%9B%9B%E4%B8%AA%E6%AD%A5%E9%AA%A4%E4%B8%AD%E7%9A%84%E4%B8%80%E4%B8%AA%0A%3E%20%E5%9C%A8%E4%B8%8D%E7%90%86%E6%83%B3%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E6%B2%A1%E6%9C%89%E5%91%BD%E4%B8%AD%E5%9B%9B%E4%B8%AA%E6%AD%A5%E9%AA%A4%EF%BC%8C%E5%8F%AA%E8%83%BD%E6%B7%BB%E5%8A%A0%E9%A2%9D%E5%A4%96%E6%AD%A5%E9%AA%A4%E6%9D%A5%E5%A4%84%E7%90%86%0A%3E%20%E9%A2%9D%E5%A4%96%E6%AD%A5%E9%AA%A4%E5%B0%B1%E6%98%AF%E5%B0%9D%E8%AF%95%E7%9C%8B%E7%9C%8B%E9%9D%9E%E5%A4%B4%E9%83%A8%E3%80%81%E9%9D%9E%E5%B0%BE%E9%83%A8%E7%9A%84%E8%8A%82%E7%82%B9%E8%83%BD%E5%90%A6%E5%A4%8D%E7%94%A8%EF%BC%8C%E6%8B%BF%E6%96%B0%E7%9A%84%E4%B8%80%E7%BB%84%E8%8A%82%E7%82%B9%E4%B8%AD%E7%9A%84%E5%A4%B4%E9%83%A8%E8%8A%82%E7%82%B9%E5%8E%BB%E6%97%A7%E7%9A%84%E4%B8%80%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E4%B8%AD%E5%AF%BB%E6%89%BE%0A%0A%60%60%60js%0Awhile(oldStartIdx%20%3C%3D%20oldEndIdx%20%26%26%20newStartIdx%20%3C%3D%20newEndIdx)%20%7B%0A%20%20%20%20if%20(!oldStartVNode)%20%7B%0A%20%20%20%20%20%20%20%20oldStartVNode%20%3D%20oldChildren%5B%2B%2BoldStartIdx%5D%0A%20%20%20%20%7D%20else%20if%20(!oldEndVNode)%20%7B%0A%20%20%20%20%20%20%20%20oldEndVNode%20%3D%20oldChildren%5B--oldEndIdx%5D%0A%20%20%20%20%7D%20else%20if%20(oldStartVnode.key%20%3D%3D%3D%20newStartVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%B8%80%E6%AD%A5%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20if%20(oldEndVnode.key%20%3D%3D%3D%20newEndVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%BA%8C%E6%AD%A5%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20if%20(oldStartVnode.key%20%3D%3D%3D%20newEndVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%B8%89%E6%AD%A5%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20if%20(oldEndVnode.key%20%3D%3D%3D%20newStartVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E5%9B%9B%E6%AD%A5%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20const%20idxInOld%20%3D%20oldChildren.findIndex(node%20%3D%3E%20node.key%20%3D%3D%3D%20newStartVNode.key)%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%83%BD%E6%89%BE%E5%88%B0%E8%8A%82%E7%82%B9%EF%BC%8C%E8%80%8C%E4%B8%94%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%E8%8A%82%E7%82%B9%E5%88%B0%E5%A4%B4%E9%83%A8%EF%BC%8C%E6%B3%A8%E6%84%8F%E8%BF%99%E9%87%8C%E4%B8%8D%E6%98%AF%20%3E%3D%200%0A%20%20%20%20%20%20%20%20if%20(idxInOld%20%3E%200)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20vnodeToMove%20%3D%20oldChildren%5BidxInOld%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(vnodeToMove%2C%20newStartVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20insert(vnodeToMove.el%2C%20container%2C%20oldStartVNode.el)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E7%94%B1%E4%BA%8EidxInOld%E4%BD%8D%E7%BD%AE%E5%B7%B2%E7%BB%8F%E7%A7%BB%E5%8A%A8%E5%88%B0%E4%BA%86%E5%88%AB%E5%A4%84%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%B0%86%E5%85%B6%E8%AE%BE%E4%B8%BAundefined%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%EF%BC%8C%E5%BD%93%E6%97%A7%E8%8A%82%E7%82%B9%E4%B8%AD%E7%9A%84%E8%8A%82%E7%82%B9%E8%A2%AB%E8%AE%BE%E7%BD%AE%E4%B8%BAundefined%E5%90%8E%EF%BC%8C%E4%B8%8B%E6%AC%A1%E6%AF%94%E8%BE%83%E9%81%87%E5%88%B0%E6%97%B6%EF%BC%8C%E7%9B%B4%E6%8E%A5%E8%B7%B3%E8%BF%87%0A%20%20%20%20%20%20%20%20%20%20%20%20oldChildren%5BidxInOld%5D%20%3D%20undefined%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%9B%B4%E6%96%B0newStartIdx%E5%88%B0%E4%B8%8B%E4%B8%80%E4%B8%AA%E4%BD%8D%E7%BD%AE%0A%20%20%20%20%20%20%20%20%20%20%20%20newStartVNode%20%3D%20newChildren%5B%2B%2BnewStartIdx%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%60%60%60%0A%0A%0A%23%23%23%23%20%E6%B7%BB%E5%8A%A0%E6%96%B0%E5%85%83%E7%B4%A0%0A%3E%20%E5%9C%A8%E5%BE%AA%E7%8E%AF%E4%B8%AD%EF%BC%8C%E6%97%A2%E6%B2%A1%E6%9C%89%E5%8C%B9%E9%85%8D%E5%88%B04%E4%B8%AA%E6%AD%A5%E9%AA%A4%EF%BC%8C%E4%B9%9F%E4%B8%8D%E8%83%BD%E5%9C%A8%E6%96%B0%E8%8A%82%E7%82%B9%E4%B8%AD%E6%89%BE%E5%88%B0%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E6%97%A7%E8%8A%82%E7%82%B9%EF%BC%8C%E8%BF%99%E5%B0%B1%E8%AF%B4%E6%98%8E%E8%BF%99%E4%B8%AA%E8%8A%82%E7%82%B9%E6%98%AF%E4%B8%80%E4%B8%AA%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9%EF%BC%8C%E8%BF%99%E6%97%B6%E5%8F%AA%E9%9C%80%E8%A6%81%E5%B0%86%E5%85%B6%E6%8C%82%E8%BD%BD%E5%88%B0%E5%BD%93%E5%89%8D%E5%A4%B4%E9%83%A8%E8%8A%82%E7%82%B9%E4%B9%8B%E5%89%8D%E5%B0%B1%E5%8F%AF%E4%BB%A5%0A%0A%60%60%60js%0Awhile(oldStartIdx%20%3C%3D%20oldEndIdx%20%26%26%20newStartIdx%20%3C%3D%20newEndIdx)%20%7B%0A%20%20%20%20if%20(!oldStartVNode)%20%7B%0A%20%20%20%20%20%20%20%20oldStartVNode%20%3D%20oldChildren%5B%2B%2BoldStartIdx%5D%0A%20%20%20%20%7D%20else%20if%20(!oldEndVNode)%20%7B%0A%20%20%20%20%20%20%20%20oldEndVNode%20%3D%20oldChildren%5B--oldEndIdx%5D%0A%20%20%20%20%7D%20else%20if%20(oldStartVnode.key%20%3D%3D%3D%20newStartVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%B8%80%E6%AD%A5%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20if%20(oldEndVnode.key%20%3D%3D%3D%20newEndVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%BA%8C%E6%AD%A5%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20if%20(oldStartVnode.key%20%3D%3D%3D%20newEndVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E4%B8%89%E6%AD%A5%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20if%20(oldEndVnode.key%20%3D%3D%3D%20newStartVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%AC%AC%E5%9B%9B%E6%AD%A5%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20const%20idxInOld%20%3D%20oldChildren.findIndex(node%20%3D%3E%20node.key%20%3D%3D%3D%20newStartVNode.key)%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%83%BD%E6%89%BE%E5%88%B0%E8%8A%82%E7%82%B9%EF%BC%8C%E8%80%8C%E4%B8%94%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%E8%8A%82%E7%82%B9%E5%88%B0%E5%A4%B4%E9%83%A8%EF%BC%8C%E6%B3%A8%E6%84%8F%E8%BF%99%E9%87%8C%E4%B8%8D%E6%98%AF%20%3E%3D%200%0A%20%20%20%20%20%20%20%20if%20(idxInOld%20%3E%200)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20vnodeToMove%20%3D%20oldChildren%5BidxInOld%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(vnodeToMove%2C%20newStartVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20insert(vnodeToMove.el%2C%20container%2C%20oldStartVNode.el)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E7%94%B1%E4%BA%8EidxInOld%E4%BD%8D%E7%BD%AE%E5%B7%B2%E7%BB%8F%E7%A7%BB%E5%8A%A8%E5%88%B0%E4%BA%86%E5%88%AB%E5%A4%84%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%B0%86%E5%85%B6%E8%AE%BE%E4%B8%BAundefined%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%EF%BC%8C%E5%BD%93%E6%97%A7%E8%8A%82%E7%82%B9%E4%B8%AD%E7%9A%84%E8%8A%82%E7%82%B9%E8%A2%AB%E8%AE%BE%E7%BD%AE%E4%B8%BAundefined%E5%90%8E%EF%BC%8C%E4%B8%8B%E6%AC%A1%E6%AF%94%E8%BE%83%E9%81%87%E5%88%B0%E6%97%B6%EF%BC%8C%E7%9B%B4%E6%8E%A5%E8%B7%B3%E8%BF%87%0A%20%20%20%20%20%20%20%20%20%20%20%20oldChildren%5BidxInOld%5D%20%3D%20undefined%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%9B%B4%E6%96%B0newStartIdx%E5%88%B0%E4%B8%8B%E4%B8%80%E4%B8%AA%E4%BD%8D%E7%BD%AE%0A%20%20%20%20%20%20%20%20%20%20%20%20newStartVNode%20%3D%20newChildren%5B%2B%2BnewStartIdx%5D%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20newStartVNode%2C%20container%2C%20oldStartVNode.el)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E4%BD%86%E6%98%AF%E8%BF%99%E6%A0%B7%E8%BF%98%E6%98%AF%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98%EF%BC%9A%0A%2F%2F%20%0A%0Awhile(oldStartIdx%20%3C%3D%20oldEndIdx%20%26%26%20newStartIdx%20%3C%3D%20newEndIdx)%20%7B%0A%20%20%20%20%2F%2F%20%E3%80%82%E3%80%82%E3%80%82%0A%7D%0A%0A%2F%2F%20%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9D%9F%E5%90%8E%E6%A3%80%E6%9F%A5%E7%B4%A2%E5%BC%95%E5%80%BC%E7%9A%84%E6%83%85%E5%86%B5%0A%2F%2F%20%E6%97%A7%E7%9A%84%E7%BB%93%E6%9D%9F%EF%BC%8C%E6%96%B0%E7%9A%84%E7%B4%A2%E5%BC%95%E8%BF%98%E6%9C%89%E9%97%AE%E9%A2%98%0Aif%20(oldEndIdx%20%3C%20oldStartIdx%20%26%26%20newStartIdx%20%3C%3D%20newEndIdx)%20%7B%0A%20%20%20%20%2F%2F%20%E6%8A%8A%E5%90%8E%E9%9D%A2%E7%9A%84%E4%BE%9D%E6%AC%A1%E6%8F%92%E5%85%A5%E5%88%B0%E6%97%A7%E8%8A%82%E7%82%B9%E7%9A%84%E6%9C%80%E5%90%8E%0A%20%20%20%20for(let%20i%20%3D%20newStartIdx%3B%20i%20%3C%3D%20newEndIdx%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20patch(null%2C%20newChildren%5Bi%5D%2C%20container%2C%20oldStartVNode.el)%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E7%A7%BB%E9%99%A4%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E5%85%83%E7%B4%A0%0A%0A%60%60%60js%0Awhile(oldStartIdx%20%3C%3D%20oldEndIdx%20%26%26%20newStartIdx%20%3C%3D%20newEndIdx)%20%7B%0A%20%20%20%20%2F%2F%20%E3%80%82%E3%80%82%E3%80%82%0A%7D%0A%0A%2F%2F%20%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9D%9F%E5%90%8E%E6%A3%80%E6%9F%A5%E7%B4%A2%E5%BC%95%E5%80%BC%E7%9A%84%E6%83%85%E5%86%B5%0A%2F%2F%20%E6%97%A7%E7%9A%84%E7%BB%93%E6%9D%9F%EF%BC%8C%E6%96%B0%E7%9A%84%E7%B4%A2%E5%BC%95%E8%BF%98%E6%9C%89%E9%97%AE%E9%A2%98%0Aif%20(oldEndIdx%20%3C%20oldStartIdx%20%26%26%20newStartIdx%20%3C%3D%20newEndIdx)%20%7B%0A%20%20%20%20%2F%2F%20%E6%8A%8A%E5%90%8E%E9%9D%A2%E7%9A%84%E4%BE%9D%E6%AC%A1%E6%8F%92%E5%85%A5%E5%88%B0%E6%97%A7%E8%8A%82%E7%82%B9%E7%9A%84%E6%9C%80%E5%90%8E%0A%20%20%20%20for(let%20i%20%3D%20newStartIdx%3B%20i%20%3C%3D%20newEndIdx%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20patch(null%2C%20newChildren%5Bi%5D%2C%20container%2C%20oldStartVNode.el)%0A%20%20%20%20%7D%0A%7D%20else%20if%20(newEndIdx%20%3C%20newStartidx%20%26%26%20oldStartIdx%20%3C%3D%20oldEndIdx)%20%7B%0A%20%20%20%20%2F%2F%20%E7%A7%BB%E9%99%A4%0A%20%20%20%20for(let%20i%20%3D%20oldStartIdx%3B%20i%20%3C%20oldEndIdx%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20unmount(oldChildren%5Bi%5D)%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E6%80%BB%E7%BB%93%0A-%20%E5%8F%8C%E7%AB%AFDiff%E7%9A%84%E4%BC%98%E5%8A%BF%E5%9C%A8%E4%BA%8E%EF%BC%8C%E5%AF%B9%E4%BA%8E%E5%90%8C%E6%A0%B7%E7%9A%84%E6%9B%B4%E6%96%B0%E5%9C%BA%E6%99%AF%EF%BC%8C%E6%89%A7%E8%A1%8C%E7%9A%84DOM%E7%A7%BB%E5%8A%A8%E6%93%8D%E4%BD%9C%E6%AC%A1%E6%95%B0%E6%9B%B4%E5%B0%91%0A%0A%0A%23%23%23%20%E7%AC%AC11%E7%AB%A0%E3%80%8A%E5%BF%AB%E9%80%9FDiff%E7%AE%97%E6%B3%95%E3%80%8B%0A%3E%20%E6%9C%80%E9%95%BF%E9%80%92%E5%BD%92%E5%AD%90%E5%BA%8F%E5%88%97%0A%0A%23%23%23%23%20%E7%9B%B8%E5%90%8C%E7%9A%84%E5%89%8D%E7%BD%AE%E5%85%83%E7%B4%A0%E5%92%8C%E5%90%8E%E7%BD%AE%E5%85%83%E7%B4%A0%0A%3E%20%E5%BF%AB%E9%80%9Fdiff%E5%8C%85%E5%90%AB%E9%A2%84%E5%A4%84%E7%90%86%E6%AD%A5%E9%AA%A4%0A%3E%20-%20%E5%88%A4%E6%96%AD%E4%B8%A4%E4%B8%AA%E8%8A%82%E7%82%B9%E6%98%AF%E5%90%A6%E5%85%A8%E7%AD%89%EF%BC%8C%E5%85%A8%E7%AD%89%E5%88%99%E4%B8%8D%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%0A%3E%20-%20%E5%8F%AF%E4%BB%A5%E5%8E%BB%E6%8E%89%E7%9B%B8%E5%90%8C%E7%9A%84%E5%89%8D%E7%BC%80%E8%8A%82%E7%82%B9%E6%88%96%E5%90%8E%E7%BC%80%E8%8A%82%E7%82%B9%0A%0A%60%60%60js%0Afunction%20patchKeyedChildren(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20const%20newChildren%20%3D%20n2.children%3B%0A%20%20%20%20const%20oldChildren%20%3D%20n1.children%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%B0%B1%E5%AE%8C%E6%88%90%E4%BA%86%E5%AF%B9%E5%89%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%B4%E6%96%B0%0A%20%20%20%20%2F%2F%20%E7%B4%A2%E5%BC%95j%E6%8C%87%E5%90%91%E6%96%B0%E6%97%A7%E4%B8%A4%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E5%BC%80%E5%A4%B4%0A%20%20%20%20let%20j%20%3D%200%0A%20%20%20%20let%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20let%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%AA%E7%8E%AF%E5%90%91%E5%90%8E%E9%81%8D%E5%8E%86%E7%9B%B4%E5%88%B0%E9%81%87%E5%88%B0%E6%8B%A5%E6%9C%89%E4%B8%8D%E5%90%8Ckey%E7%9A%84%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20j%2B%2B%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%AE%8C%E6%88%90%E5%AF%B9%E5%90%8E%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E5%A4%84%E7%90%86%0A%20%20%20%20let%20oldEnd%20%3D%20oldChildren.length%20-%201%0A%20%20%20%20let%20newEnd%20%3D%20newChildren.length%20-%201%0A%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20oldEnd--%0A%20%20%20%20%20%20%20%20newEnd--%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%BF%99%E9%87%8C%E4%BC%9A%E6%9C%89%E4%B8%A4%E4%B8%AA%E6%9D%A1%E4%BB%B6%0A%2F%2F%20%E6%9D%A1%E4%BB%B6%E4%B8%80%EF%BC%9AoldEnd%20%3C%20j%EF%BC%8C%E8%AF%B4%E6%98%8E%E6%97%A7%E8%8A%82%E7%82%B9%E8%A2%AB%E5%A4%84%E7%90%86%E5%AE%8C%E6%AF%95%E4%BA%86%0A%2F%2F%20%E6%9D%A1%E4%BB%B6%E4%BA%8C%EF%BC%9AnewEnd%20%3E%3D%20j%EF%BC%8C%E8%AF%B4%E6%98%8E%E5%9C%A8%E9%A2%84%E5%A4%84%E7%90%86%E5%90%8E%EF%BC%8C%E5%9C%A8%E6%96%B0%E7%9A%84%E8%8A%82%E7%82%B9%E4%B8%AD%E4%BB%8D%E7%84%B6%E6%9C%89%E6%9C%AA%E8%A2%AB%E5%A4%84%E7%90%86%E7%9A%84%E8%8A%82%E7%82%B9%EF%BC%8C%E8%BF%99%E4%BA%9B%E9%81%97%E7%95%99%E7%9A%84%E8%8A%82%E7%82%B9%E5%B0%86%E8%A2%AB%E8%A7%86%E4%BD%9C%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9%0A%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E6%9D%A1%E4%BB%B6%E4%B8%80%E5%92%8C%E6%9D%A1%E4%BB%B6%E4%BA%8C%E5%90%8C%E6%97%B6%E6%88%90%E7%AB%8B%EF%BC%8C%E8%AF%B4%E6%98%8E%E5%9C%A8%E6%96%B0%E7%9A%84%E4%B8%80%E7%BB%84%E8%8A%82%E7%82%B9%E4%B8%AD%EF%BC%8C%E5%AD%98%E5%9C%A8%E9%81%97%E7%95%99%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%BF%99%E4%BA%9B%E8%8A%82%E7%82%B9%E9%83%BD%E6%98%AF%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%B0%86%E5%85%B6%E6%8C%82%E8%BD%BD%E5%88%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E4%BD%8D%E7%BD%AE%0A%0Afunction%20patchKeyedChildren(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20const%20newChildren%20%3D%20n2.children%3B%0A%20%20%20%20const%20oldChildren%20%3D%20n1.children%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%B0%B1%E5%AE%8C%E6%88%90%E4%BA%86%E5%AF%B9%E5%89%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%B4%E6%96%B0%0A%20%20%20%20%2F%2F%20%E7%B4%A2%E5%BC%95j%E6%8C%87%E5%90%91%E6%96%B0%E6%97%A7%E4%B8%A4%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E5%BC%80%E5%A4%B4%0A%20%20%20%20let%20j%20%3D%200%0A%20%20%20%20let%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20let%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%AA%E7%8E%AF%E5%90%91%E5%90%8E%E9%81%8D%E5%8E%86%E7%9B%B4%E5%88%B0%E9%81%87%E5%88%B0%E6%8B%A5%E6%9C%89%E4%B8%8D%E5%90%8Ckey%E7%9A%84%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20j%2B%2B%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%AE%8C%E6%88%90%E5%AF%B9%E5%90%8E%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E5%A4%84%E7%90%86%0A%20%20%20%20let%20oldEnd%20%3D%20oldChildren.length%20-%201%0A%20%20%20%20let%20newEnd%20%3D%20newChildren.length%20-%201%0A%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20oldEnd--%0A%20%20%20%20%20%20%20%20newEnd--%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20j%20--%3E%20newEnd%E4%B9%8B%E9%97%B4%E7%9A%84%E8%8A%82%E7%82%B9%E5%BA%94%E4%BD%9C%E4%B8%BA%E6%96%B0%E8%8A%82%E7%82%B9%E6%8F%92%E5%85%A5%0A%20%20%20%20if%20(j%20%3E%20oldEnd%20%26%26%20j%20%3C%3D%20newEnd)%20%7B%0A%20%20%20%20%20%20%20%20const%20anchorIndex%20%3D%20newEnd%20%2B%201%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%A4%E6%96%AD%E9%94%9A%E7%82%B9%E6%98%AF%E5%90%A6%E6%98%AF%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0%0A%20%20%20%20%20%20%20%20const%20anchor%20%3D%20anchorIndex%20%3C%20newChildren.length%20%3F%20newChildren%5BanchorIndex%5D.el%20%3A%20null%0A%20%20%20%20%20%20%20%20while(j%20%3C%3D%20newEnd)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20newChildren%5Bj%2B%2B%5D%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20if%20(j%20%3E%20newEnd%20%26%26%20j%20%3C%3D%20oldEnd)%20%7B%0A%20%20%20%20%2F%2F%20j%20--%3E%20oldEnd%E4%B9%8B%E9%97%B4%E7%9A%84%E8%8A%82%E7%82%B9%E5%BA%94%E8%AF%A5%E8%A2%AB%E5%8D%B8%E8%BD%BD%0A%20%20%20%20%20%20%20%20while(j%20%3C%3D%20oldEnd)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20unmount(oldChildren%5Bj%2B%2B%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8CDOM%E7%A7%BB%E5%8A%A8%E6%93%8D%E4%BD%9C%0A%0A%E6%9E%84%E9%80%A0source%E6%95%B0%E7%BB%84%EF%BC%8C%E9%95%BF%E5%BA%A6%E4%B8%BA%E5%89%A9%E4%B8%8B%E7%9A%84%E6%96%B0%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E9%95%BF%E5%BA%A6%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%80%BC%E9%83%BD%E4%B8%BA-1%0A%3E%20source%E6%95%B0%E7%BB%84%E5%B0%86%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8**%E6%96%B0%E7%9A%84%E4%B8%80%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E4%B8%AD%E7%9A%84%E8%8A%82%E7%82%B9%E5%9C%A8%E6%97%A7%E7%9A%84%E4%B8%80%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE%E7%B4%A2%E5%BC%95%EF%BC%8C%E5%90%8E%E9%9D%A2%E5%B0%86%E4%BC%9A%E4%BD%BF%E7%94%A8%E5%AE%83%E8%AE%A1%E7%AE%97%E5%87%BA%E4%B8%80%E4%B8%AA%E6%9C%80%E9%95%BF%E9%80%92%E5%BD%92%E5%AD%90%E5%BA%8F%E5%88%97%EF%BC%8C%E5%B9%B6%E7%94%A8%E4%BA%8E%E8%BE%85%E5%8A%A9%E5%AE%8C%E6%88%90DOM%E7%A7%BB%E5%8A%A8%E7%9A%84%E6%93%8D%E4%BD%9C**%0A%3E%20%E5%BF%AB%E9%80%9FDiff%E7%AE%97%E6%B3%95%E5%88%A4%E6%96%AD%E8%8A%82%E7%82%B9%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%E7%9A%84%E6%96%B9%E6%B3%95%E4%B8%8E%E7%AE%80%E5%8D%95Diff%E7%AE%97%E6%B3%95%E7%B1%BB%E4%BC%BC%0A%0A%60%60%60js%0Afunction%20patchKeyedChildren(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20const%20newChildren%20%3D%20n2.children%3B%0A%20%20%20%20const%20oldChildren%20%3D%20n1.children%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%B0%B1%E5%AE%8C%E6%88%90%E4%BA%86%E5%AF%B9%E5%89%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%B4%E6%96%B0%0A%20%20%20%20%2F%2F%20%E7%B4%A2%E5%BC%95j%E6%8C%87%E5%90%91%E6%96%B0%E6%97%A7%E4%B8%A4%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E5%BC%80%E5%A4%B4%0A%20%20%20%20let%20j%20%3D%200%0A%20%20%20%20let%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20let%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%AA%E7%8E%AF%E5%90%91%E5%90%8E%E9%81%8D%E5%8E%86%E7%9B%B4%E5%88%B0%E9%81%87%E5%88%B0%E6%8B%A5%E6%9C%89%E4%B8%8D%E5%90%8Ckey%E7%9A%84%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20j%2B%2B%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%AE%8C%E6%88%90%E5%AF%B9%E5%90%8E%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E5%A4%84%E7%90%86%0A%20%20%20%20let%20oldEnd%20%3D%20oldChildren.length%20-%201%0A%20%20%20%20let%20newEnd%20%3D%20newChildren.length%20-%201%0A%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20oldEnd--%0A%20%20%20%20%20%20%20%20newEnd--%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%BF%99%E9%87%8C%E4%BC%9A%E6%9C%89%E4%B8%A4%E4%B8%AA%E6%9D%A1%E4%BB%B6%0A%2F%2F%20%E6%9D%A1%E4%BB%B6%E4%B8%80%EF%BC%9AoldEnd%20%3C%20j%EF%BC%8C%E8%AF%B4%E6%98%8E%E6%97%A7%E8%8A%82%E7%82%B9%E8%A2%AB%E5%A4%84%E7%90%86%E5%AE%8C%E6%AF%95%E4%BA%86%0A%2F%2F%20%E6%9D%A1%E4%BB%B6%E4%BA%8C%EF%BC%9AnewEnd%20%3E%3D%20j%EF%BC%8C%E8%AF%B4%E6%98%8E%E5%9C%A8%E9%A2%84%E5%A4%84%E7%90%86%E5%90%8E%EF%BC%8C%E5%9C%A8%E6%96%B0%E7%9A%84%E8%8A%82%E7%82%B9%E4%B8%AD%E4%BB%8D%E7%84%B6%E6%9C%89%E6%9C%AA%E8%A2%AB%E5%A4%84%E7%90%86%E7%9A%84%E8%8A%82%E7%82%B9%EF%BC%8C%E8%BF%99%E4%BA%9B%E9%81%97%E7%95%99%E7%9A%84%E8%8A%82%E7%82%B9%E5%B0%86%E8%A2%AB%E8%A7%86%E4%BD%9C%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9%0A%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E6%9D%A1%E4%BB%B6%E4%B8%80%E5%92%8C%E6%9D%A1%E4%BB%B6%E4%BA%8C%E5%90%8C%E6%97%B6%E6%88%90%E7%AB%8B%EF%BC%8C%E8%AF%B4%E6%98%8E%E5%9C%A8%E6%96%B0%E7%9A%84%E4%B8%80%E7%BB%84%E8%8A%82%E7%82%B9%E4%B8%AD%EF%BC%8C%E5%AD%98%E5%9C%A8%E9%81%97%E7%95%99%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%BF%99%E4%BA%9B%E8%8A%82%E7%82%B9%E9%83%BD%E6%98%AF%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%B0%86%E5%85%B6%E6%8C%82%E8%BD%BD%E5%88%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E4%BD%8D%E7%BD%AE%0A%0Afunction%20patchKeyedChildren(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20const%20newChildren%20%3D%20n2.children%3B%0A%20%20%20%20const%20oldChildren%20%3D%20n1.children%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%B0%B1%E5%AE%8C%E6%88%90%E4%BA%86%E5%AF%B9%E5%89%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%B4%E6%96%B0%0A%20%20%20%20%2F%2F%20%E7%B4%A2%E5%BC%95j%E6%8C%87%E5%90%91%E6%96%B0%E6%97%A7%E4%B8%A4%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E5%BC%80%E5%A4%B4%0A%20%20%20%20let%20j%20%3D%200%0A%20%20%20%20let%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20let%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%AA%E7%8E%AF%E5%90%91%E5%90%8E%E9%81%8D%E5%8E%86%E7%9B%B4%E5%88%B0%E9%81%87%E5%88%B0%E6%8B%A5%E6%9C%89%E4%B8%8D%E5%90%8Ckey%E7%9A%84%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20j%2B%2B%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%AE%8C%E6%88%90%E5%AF%B9%E5%90%8E%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E5%A4%84%E7%90%86%0A%20%20%20%20let%20oldEnd%20%3D%20oldChildren.length%20-%201%0A%20%20%20%20let%20newEnd%20%3D%20newChildren.length%20-%201%0A%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20oldEnd--%0A%20%20%20%20%20%20%20%20newEnd--%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20j%20--%3E%20newEnd%E4%B9%8B%E9%97%B4%E7%9A%84%E8%8A%82%E7%82%B9%E5%BA%94%E4%BD%9C%E4%B8%BA%E6%96%B0%E8%8A%82%E7%82%B9%E6%8F%92%E5%85%A5%0A%20%20%20%20if%20(j%20%3E%20oldEnd%20%26%26%20j%20%3C%3D%20newEnd)%20%7B%0A%20%20%20%20%20%20%20%20const%20anchorIndex%20%3D%20newEnd%20%2B%201%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%A4%E6%96%AD%E9%94%9A%E7%82%B9%E6%98%AF%E5%90%A6%E6%98%AF%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0%0A%20%20%20%20%20%20%20%20const%20anchor%20%3D%20anchorIndex%20%3C%20newChildren.length%20%3F%20newChildren%5BanchorIndex%5D.el%20%3A%20null%0A%20%20%20%20%20%20%20%20while(j%20%3C%3D%20newEnd)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20newChildren%5Bj%2B%2B%5D%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20if%20(j%20%3E%20newEnd%20%26%26%20j%20%3C%3D%20oldEnd)%20%7B%0A%20%20%20%20%2F%2F%20j%20--%3E%20oldEnd%E4%B9%8B%E9%97%B4%E7%9A%84%E8%8A%82%E7%82%B9%E5%BA%94%E8%AF%A5%E8%A2%AB%E5%8D%B8%E8%BD%BD%0A%20%20%20%20%20%20%20%20while(j%20%3C%3D%20oldEnd)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20unmount(oldChildren%5Bj%2B%2B%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%2F%2F%20%E5%A4%84%E7%90%86%E9%9D%9E%E7%90%86%E6%83%B3%E6%83%85%E5%86%B5%0A%20%20%20%20%20%20%20%20const%20count%20%3D%20newEnd%20-%20j%20%2B%201%0A%20%20%20%20%20%20%20%20const%20source%20%3D%20new%20Array(count).fill(-1)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%B5%B7%E5%A7%8B%E7%B4%A2%E5%BC%95%0A%20%20%20%20%20%20%20%20const%20oldStart%20%3D%20j%0A%20%20%20%20%20%20%20%20const%20newStart%20%3D%20j%0A%20%20%20%20%20%20%20%20let%20moved%20%3D%20false%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%B1%BB%E4%BC%BC%E4%BA%8E%E6%99%AE%E9%80%9Adiff%E4%B8%AD%E7%9A%84lastIndex%0A%20%20%20%20%20%20%20%20let%20pos%20%3D%200%0A%20%20%20%20%20%20%20%20const%20keyIndex%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%20newStart%3B%20i%20%3C%3D%20newEnd%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20keyIndex%5BnewChildren%5Bi%5D.key%5D%20%3D%20i%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%96%B0%E5%A2%9Epatched%E5%8F%98%E9%87%8F%EF%BC%8C%E4%BB%A3%E8%A1%A8%E6%9B%B4%E6%96%B0%E8%BF%87%E7%9A%84%E8%8A%82%E7%82%B9%E6%95%B0%E9%87%8F%0A%20%20%20%20%20%20%20%20let%20patched%20%3D%200%3B%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%20oldStart%3B%20i%20%3C%3D%20oldEnd%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5Bi%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E6%9B%B4%E6%96%B0%E8%BF%87%E7%9A%84%E8%8A%82%E7%82%B9%E6%95%B0%E9%87%8F%E5%B0%8F%E4%BA%8E%E7%AD%89%E4%BA%8E%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0%E7%9A%84%E8%8A%82%E7%82%B9%E6%95%B0%E9%87%8F%EF%BC%8C%E5%88%99%E6%89%A7%E8%A1%8C%E6%9B%B4%E6%96%B0%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(patched%20%3C%3D%20count)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20k%20%3D%20keyIndex%5BoldVNode.key%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20k%20!%3D%3D%20'undefined')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5Bk%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patched%2B%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20source%5Bk%20-%20newStart%5D%20%3D%20i%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(k%20%3C%20pos)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20moved%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pos%20%3D%20k%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unmount(oldVNode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unmount(oldVNode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E5%A6%82%E4%BD%95%E7%A7%BB%E5%8A%A8%E5%85%83%E7%B4%A0%0A%0A%60%60%60js%0Afunction%20patchKeyedChildren(n1%2C%20n2%2C%20container)%20%7B%0A%20%20%20%20const%20newChildren%20%3D%20n2.children%3B%0A%20%20%20%20const%20oldChildren%20%3D%20n1.children%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%B0%B1%E5%AE%8C%E6%88%90%E4%BA%86%E5%AF%B9%E5%89%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%B4%E6%96%B0%0A%20%20%20%20%2F%2F%20%E7%B4%A2%E5%BC%95j%E6%8C%87%E5%90%91%E6%96%B0%E6%97%A7%E4%B8%A4%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E5%BC%80%E5%A4%B4%0A%20%20%20%20let%20j%20%3D%200%0A%20%20%20%20let%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20let%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BE%AA%E7%8E%AF%E5%90%91%E5%90%8E%E9%81%8D%E5%8E%86%E7%9B%B4%E5%88%B0%E9%81%87%E5%88%B0%E6%8B%A5%E6%9C%89%E4%B8%8D%E5%90%8Ckey%E7%9A%84%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20j%2B%2B%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5Bj%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5Bj%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%AE%8C%E6%88%90%E5%AF%B9%E5%90%8E%E7%BD%AE%E8%8A%82%E7%82%B9%E7%9A%84%E5%A4%84%E7%90%86%0A%20%20%20%20let%20oldEnd%20%3D%20oldChildren.length%20-%201%0A%20%20%20%20let%20newEnd%20%3D%20newChildren.length%20-%201%0A%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20while(oldVNode.key%20%3D%3D%3D%20newVNode.key)%20%7B%0A%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20oldEnd--%0A%20%20%20%20%20%20%20%20newEnd--%0A%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5BoldEnd%5D%0A%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5BnewEnd%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20j%20--%3E%20newEnd%E4%B9%8B%E9%97%B4%E7%9A%84%E8%8A%82%E7%82%B9%E5%BA%94%E4%BD%9C%E4%B8%BA%E6%96%B0%E8%8A%82%E7%82%B9%E6%8F%92%E5%85%A5%0A%20%20%20%20if%20(j%20%3E%20oldEnd%20%26%26%20j%20%3C%3D%20newEnd)%20%7B%0A%20%20%20%20%20%20%20%20const%20anchorIndex%20%3D%20newEnd%20%2B%201%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%A4%E6%96%AD%E9%94%9A%E7%82%B9%E6%98%AF%E5%90%A6%E6%98%AF%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0%0A%20%20%20%20%20%20%20%20const%20anchor%20%3D%20anchorIndex%20%3C%20newChildren.length%20%3F%20newChildren%5BanchorIndex%5D.el%20%3A%20null%0A%20%20%20%20%20%20%20%20while(j%20%3C%3D%20newEnd)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20newChildren%5Bj%2B%2B%5D%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20if%20(j%20%3E%20newEnd%20%26%26%20j%20%3C%3D%20oldEnd)%20%7B%0A%20%20%20%20%2F%2F%20j%20--%3E%20oldEnd%E4%B9%8B%E9%97%B4%E7%9A%84%E8%8A%82%E7%82%B9%E5%BA%94%E8%AF%A5%E8%A2%AB%E5%8D%B8%E8%BD%BD%0A%20%20%20%20%20%20%20%20while(j%20%3C%3D%20oldEnd)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20unmount(oldChildren%5Bj%2B%2B%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%2F%2F%20%E5%A4%84%E7%90%86%E9%9D%9E%E7%90%86%E6%83%B3%E6%83%85%E5%86%B5%0A%20%20%20%20%20%20%20%20const%20count%20%3D%20newEnd%20-%20j%20%2B%201%0A%20%20%20%20%20%20%20%20const%20source%20%3D%20new%20Array(count).fill(-1)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%B5%B7%E5%A7%8B%E7%B4%A2%E5%BC%95%0A%20%20%20%20%20%20%20%20const%20oldStart%20%3D%20j%0A%20%20%20%20%20%20%20%20const%20newStart%20%3D%20j%0A%20%20%20%20%20%20%20%20let%20moved%20%3D%20false%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%B1%BB%E4%BC%BC%E4%BA%8E%E6%99%AE%E9%80%9Adiff%E4%B8%AD%E7%9A%84lastIndex%0A%20%20%20%20%20%20%20%20let%20pos%20%3D%200%0A%20%20%20%20%20%20%20%20const%20keyIndex%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%20newStart%3B%20i%20%3C%3D%20newEnd%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20keyIndex%5BnewChildren%5Bi%5D.key%5D%20%3D%20i%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%96%B0%E5%A2%9Epatched%E5%8F%98%E9%87%8F%EF%BC%8C%E4%BB%A3%E8%A1%A8%E6%9B%B4%E6%96%B0%E8%BF%87%E7%9A%84%E8%8A%82%E7%82%B9%E6%95%B0%E9%87%8F%0A%20%20%20%20%20%20%20%20let%20patched%20%3D%200%3B%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%20oldStart%3B%20i%20%3C%3D%20oldEnd%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20oldVNode%20%3D%20oldChildren%5Bi%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E6%9B%B4%E6%96%B0%E8%BF%87%E7%9A%84%E8%8A%82%E7%82%B9%E6%95%B0%E9%87%8F%E5%B0%8F%E4%BA%8E%E7%AD%89%E4%BA%8E%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0%E7%9A%84%E8%8A%82%E7%82%B9%E6%95%B0%E9%87%8F%EF%BC%8C%E5%88%99%E6%89%A7%E8%A1%8C%E6%9B%B4%E6%96%B0%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(patched%20%3C%3D%20count)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20k%20%3D%20keyIndex%5BoldVNode.key%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20k%20!%3D%3D%20'undefined')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20newVNode%20%3D%20newChildren%5Bk%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patch(oldVNode%2C%20newVNode%2C%20container)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patched%2B%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20source%5Bk%20-%20newStart%5D%20%3D%20i%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(k%20%3C%20pos)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20moved%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pos%20%3D%20k%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unmount(oldVNode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unmount(oldVNode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20if%20(moved)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9Cmoved%E4%B8%BAtrue%EF%BC%8C%E5%88%99%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8CDOM%E7%A7%BB%E5%8A%A8%E6%93%8D%E4%BD%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E4%B8%BA%E4%BA%86%E7%A7%BB%E5%8A%A8DOM%EF%BC%8C%E9%9C%80%E8%A6%81%E5%85%88%E6%A0%B9%E6%8D%AEsource%E8%AE%A1%E7%AE%97%E5%87%BA%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82source%E4%B8%BA%5B0%2C8%2C4%2C12%5D%EF%BC%8C%E7%BB%93%E6%9E%9C%E5%B0%B1%E4%B8%BA%5B0%2C8%2C12%5D%E6%88%96%E8%80%85%5B0%2C4%2C12%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20seq%20%3D%20lis(source)%20%2F%2F%20%E8%AE%A1%E7%AE%97%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97%EF%BC%8C%E8%BF%99%E9%87%8C%E5%BE%97%E5%88%B0%E7%9A%84%E5%85%83%E7%B4%A0%E6%98%AF%E5%9C%A8source%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE%E7%B4%A2%E5%BC%95%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E4%B8%BA%E4%BA%86%E5%AE%8C%E6%88%90%E8%8A%82%E7%82%B9%E7%9A%84%E7%A7%BB%E5%8A%A8%EF%BC%8C%E8%BF%98%E9%9C%80%E8%A6%81%E5%88%9B%E5%BB%BA%E4%B8%A4%E4%B8%AA%E7%B4%A2%E5%BC%95%E5%80%BCi%E5%92%8Cs%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20i%E6%8C%87%E5%90%91%E6%96%B0%E7%9A%84%E4%B8%80%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E4%B8%AD%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20s%E6%8C%87%E5%90%91%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97%E4%B8%AD%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20s%20%3D%20seq.length%20-%201%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20i%20%3D%20count%20-%201%0A%20%20%20%20%20%20%20%20%20%20%20%20for(i%3B%20i%20%3E%3D%200%3B%20i--)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(source%5Bi%5D%20%3D%3D%3D%20-1)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%AF%B4%E6%98%8E%E7%B4%A2%E5%BC%95%E4%B8%BAi%E7%9A%84%E8%8A%82%E7%82%B9%E6%98%AF%E6%96%B0%E8%8A%82%E7%82%B9%EF%BC%8C%E5%BA%94%E8%AF%A5%E5%B0%86%E5%85%B6%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20pos%20%3D%20i%20%2B%20newStart%20%2F%2F%20%E8%AF%A5%E8%8A%82%E7%82%B9%E5%9C%A8%E6%96%B0children%E4%B8%AD%E7%9A%84%E7%9C%9F%E5%AE%9E%E4%BD%8D%E7%BD%AE%E7%B4%A2%E5%BC%95%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20newVNode%20%3D%20newChildren%5Bpos%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%AF%A5%E8%8A%82%E7%82%B9%E7%9A%84%E4%B8%8B%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E4%BD%8D%E7%BD%AE%E7%B4%A2%E5%BC%95%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20nextPos%20%3D%20pos%20%2B%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20anchor%20%3D%20nextPos%20%3C%20newChildren.length%20%3F%20newChildren%5BnextPos%5D.el%20%3A%20null%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20newVnode%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(i%20!%3D%3D%20seq%5Bs%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E8%8A%82%E7%82%B9%E7%9A%84%E7%B4%A2%E5%BC%95i%E4%B8%8D%E7%AD%89%E4%BA%8Eseq%5Bs%5D%E7%9A%84%E5%80%BC%EF%BC%8C%E8%AF%B4%E6%98%8E%E8%AF%A5%E8%8A%82%E7%82%B9%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%AF%A5%E8%8A%82%E7%82%B9%E5%9C%A8%E6%96%B0%E7%9A%84%E4%B8%80%E7%BB%84%E5%AD%90%E8%8A%82%E7%82%B9%E4%B8%AD%E7%9A%84%E7%9C%9F%E5%AE%9E%E4%BD%8D%E7%BD%AE%E7%B4%A2%E5%BC%95%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%B0%B1%E6%98%AF%E4%B8%80%E6%AD%A5%E5%88%B0%E4%BD%8D%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%B0%86%E8%8A%82%E7%82%B9%E6%8F%92%E5%85%A5%E5%88%B0%E6%9C%80%E5%90%8E%E6%AD%A3%E7%A1%AE%E7%9A%84%E4%BD%8D%E7%BD%AE%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20pos%20%3D%20i%20%2B%20newStart%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20newVNode%20%3D%20newChildren%5Bpos%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%AF%A5%E8%8A%82%E7%82%B9%E7%9A%84%E4%B8%8B%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E4%BD%8D%E7%BD%AE%E7%B4%A2%E5%BC%95%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20nextPos%20%3D%20pos%20%2B%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20anchor%20%3D%20nextPos%20%3C%20newChildren.length%20%3F%20newChildren%5BnextPos%5D.el%20%3A%20null%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20insert(newVNode.el%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93i%20%3D%3D%3D%20seq%5Bs%5D%E6%97%B6%EF%BC%8C%E8%AF%B4%E6%98%8E%E8%AF%A5%E8%8A%82%E7%82%B9%E4%B8%8D%E9%9C%80%E8%A6%81%E7%A7%BB%E5%8A%A8%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%8F%AA%E9%9C%80%E8%A6%81%E8%AE%A9s%E6%8C%87%E5%90%91%E5%89%8D%E9%9D%A2%E4%B8%80%E4%B8%AA%E4%BD%8D%E7%BD%AE%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20s--%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%20%E7%AC%AC%E5%9B%9B%E7%AF%87%E3%80%8A%E7%BB%84%E4%BB%B6%E5%8C%96%E3%80%8B%0A%0A%23%23%23%20%E7%AC%AC12%E7%AB%A0%E3%80%8A%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E3%80%8B%0A%0A%3E%20%E4%B8%BA%E4%BA%86%E8%AE%A9%E6%B8%B2%E6%9F%93%E5%99%A8%E8%83%BD%E5%A4%9F%E5%A4%84%E7%90%86%E7%BB%84%E4%BB%B6%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%EF%BC%8C%E8%BF%98%E9%9C%80%E8%A6%81%E5%9C%A8patch%E5%87%BD%E6%95%B0%E4%B8%AD%E5%AF%B9%E7%BB%84%E4%BB%B6%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%0A%0A%60%60%60js%0Afunction%20patch(n1%2C%20n2%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20if%20(n1%20%26%26%20n1.type%20!%3D%3D%20n2.type)%20%7B%0A%20%20%20%20%20%20%20%20unmount(n1)%3B%0A%20%20%20%20%20%20%20%20n1%20%3D%20null%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20type%20%7D%20%3D%20n2%0A%20%20%20%20if%20(typeof%20type%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Text)%20%7B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Fragment)%20%7B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%20else%20if%20(typeof%20type%20%3D%3D%3D%20'object')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%BB%84%E4%BB%B6%E5%A4%84%E7%90%86%0A%20%20%20%20%20%20%20%20if%20(!n1)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%8C%82%E8%BD%BD%E7%BB%84%E4%BB%B6%0A%20%20%20%20%20%20%20%20%20%20%20%20mountElement(n2%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%9B%B4%E6%96%B0%E7%BB%84%E4%BB%B6%0A%20%20%20%20%20%20%20%20%20%20%20%20patchComponent(n1%2C%20n2%2C%20anchor)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%3E%20%E6%B8%B2%E6%9F%93%E5%99%A8%E6%9C%89%E8%83%BD%E5%8A%9B%E5%A4%84%E7%90%86%E7%BB%84%E4%BB%B6%E5%90%8E%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E8%AE%BE%E8%AE%A1%E7%BB%84%E4%BB%B6%E5%9C%A8%E7%94%A8%E6%88%B7%E5%B1%82%E9%9D%A2%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%82%E4%B8%80%E4%B8%AA%E7%BB%84%E4%BB%B6%E5%BF%85%E9%A1%BB%E5%8C%85%E5%90%AB%E4%B8%80%E4%B8%AA%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%EF%BC%8C%E5%8D%B3render%E5%87%BD%E6%95%B0%EF%BC%8C%E5%B9%B6%E4%B8%94%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E5%BA%94%E8%AF%A5%E6%98%AF%E8%99%9A%E6%8B%9FDOM%0A%0A%60%60%60js%0A%2F%2F%20%E6%B8%B2%E6%9F%93%E5%99%A8%E4%B8%AD%E7%9C%9F%E6%AD%A3%E5%AE%8C%E6%88%90%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%98%AFmountComponent%E5%87%BD%E6%95%B0%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20const%20componentOptions%20%3D%20vnode.type%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20render%20%7D%20%3D%20componentOptions%0A%20%20%20%20%0A%20%20%20%20const%20subTree%20%3D%20render()%0A%20%20%20%20%0A%20%20%20%20patch(null%2C%20subTree%2C%20container%2C%20anchor)%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E7%BB%84%E4%BB%B6%E7%8A%B6%E6%80%81%E4%B8%8E%E8%87%AA%E6%9B%B4%E6%96%B0%0A%0A%60%60%60js%0Aconst%20MyComponent%20%3D%20%7B%0A%20%20%20%20name%3A%20'MyComponent'%2C%0A%20%20%20%20data()%20%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20foo%3A%20'hello%20world'%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20render()%20%7B%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'div'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20children%3A%20%60foo%E7%9A%84%E5%80%BC%E6%98%AF%24%7Bthis.foo%7D%60%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20const%20componentOptions%20%3D%20vnode.type%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20render%20%7D%20%3D%20componentOptions%0A%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%0A%20%20%20%20const%20state%20%3D%20reactive(data())%0A%20%20%20%20%0A%20%20%20%20effect(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%B8%80%E6%97%A6%E7%BB%84%E4%BB%B6%E8%87%AA%E8%BA%AB%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%EF%BC%8C%E7%BB%84%E4%BB%B6%E5%B0%B1%E4%BC%9A%E8%87%AA%E5%8A%A8%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20const%20subTree%20%3D%20render.call(state%2C%20state)%0A%20%20%20%20%0A%20%20%20%20%20%20%20%20patch(null%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%7D)%0A%0A%7D%0A%0A%2F%2F%20%E9%97%AE%E9%A2%98%0A%2F%2F%20%E7%94%B1%E4%BA%8Eeffect%E6%98%AF%E5%90%8C%E6%AD%A5%E7%9A%84%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%BD%93%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%BC%9A%E5%90%8C%E6%AD%A5%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E5%A4%9A%E6%AC%A1%EF%BC%8C%E8%BF%99%E5%AE%9E%E9%99%85%E6%98%AF%E6%B2%A1%E6%9C%89%E5%BF%85%E8%A6%81%E7%9A%84%E3%80%82%E4%B8%BA%E6%AD%A4%E9%9C%80%E8%A6%81%E4%B8%80%E4%B8%AA%E8%B0%83%E5%BA%A6%E5%99%A8%EF%BC%8C%E5%BD%93%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E4%B8%8D%E4%BC%9A%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C%E5%AE%83%EF%BC%8C%E8%80%8C%E6%98%AF%E5%B0%86%E5%AE%83%E7%BC%93%E5%86%B2%E5%88%B0%E5%BE%AE%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%EF%BC%8C%E7%AD%89%E5%88%B0%E6%89%A7%E8%A1%8C%E6%A0%88%E6%B8%85%E7%A9%BA%E5%90%8E%EF%BC%8C%E5%86%8D%E5%8F%96%E5%87%BA%E6%9D%A5%E6%89%A7%E8%A1%8C%E3%80%82%0A%0Aconst%20queue%20%3D%20new%20Set()%0A%2F%2F%20%E4%B8%80%E4%B8%AA%E6%A0%87%E5%BF%97%EF%BC%8C%E4%BB%A3%E8%A1%A8%E6%98%AF%E5%90%A6%E6%AD%A3%E5%9C%A8%E5%88%B7%E6%96%B0%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%0Alet%20isFlushing%20%3D%20false%0A%2F%2F%20%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AB%8B%E5%8D%B3resolve%E7%9A%84Promise%E5%AE%9E%E4%BE%8B%0Aconst%20p%20%3D%20Promise.resolve()%0A%0Afunction%20queueJob(job)%20%7B%0A%20%20%20%20queue.add(job)%0A%20%20%20%20if%20(!isFlushing)%20%7B%0A%20%20%20%20%20%20%20%20isFlushing%20%3D%20true%0A%20%20%20%20%20%20%20%20p.then(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20queue.forEach(job%20%3D%3E%20job())%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20finnaly%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20isFlushing%20%3D%20false%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20queue.length%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20const%20componentOptions%20%3D%20vnode.type%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20render%20%7D%20%3D%20componentOptions%0A%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%0A%20%20%20%20const%20state%20%3D%20reactive(data())%0A%20%20%20%20%0A%20%20%20%20effect(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%B8%80%E6%97%A6%E7%BB%84%E4%BB%B6%E8%87%AA%E8%BA%AB%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%EF%BC%8C%E7%BB%84%E4%BB%B6%E5%B0%B1%E4%BC%9A%E8%87%AA%E5%8A%A8%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20const%20subTree%20%3D%20render.call(state%2C%20state)%0A%20%20%20%20%0A%20%20%20%20%20%20%20%20patch(null%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%7D%2C%20%7B%0A%20%20%20%20%20%20%20%20scheduler%3A%20queueJob%0A%20%20%20%20%7D)%0A%0A%7D%0A%2F%2F%20%E8%BF%99%E9%87%8C%E5%BD%93%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E5%89%AF%E4%BD%9C%E7%94%A8%E5%87%BD%E6%95%B0%E4%B8%8D%E4%BC%9A%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C%EF%BC%8C%E8%80%8C%E6%98%AF%E4%BC%9A%E8%A2%ABqueueJob%E5%87%BD%E6%95%B0%E8%B0%83%E5%BA%A6%0A%2F%2F%20%E4%BD%86%E6%98%AF%E4%B8%8A%E9%9D%A2%E4%BB%A3%E7%A0%81%E8%BF%98%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98%EF%BC%8Cpatch%E6%97%B6%EF%BC%8C%E6%AF%8F%E6%AC%A1%E6%9B%B4%E6%96%B0%E9%83%BD%E4%BC%9A%E8%BF%9B%E8%A1%8C%E5%85%A8%E6%96%B0%E7%9A%84%E6%8C%82%E8%BD%BD%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E6%89%93%E8%A1%A5%E4%B8%81%E3%80%82%E4%B8%BA%E6%AD%A4%EF%BC%8C%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%EF%BC%8C%E7%94%A8%E5%AE%83%E6%9D%A5%E7%BB%B4%E6%8A%A4%E7%BB%84%E4%BB%B6%E6%95%B4%E4%B8%AA%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%B8%B2%E6%9F%93%E5%99%A8%E6%89%8D%E8%83%BD%E5%A4%9F%E5%9C%A8%E6%AD%A3%E7%A1%AE%E7%9A%84%E6%97%B6%E6%9C%BA%E6%89%A7%E8%A1%8C%E5%90%88%E9%80%82%E7%9A%84%E6%93%8D%E4%BD%9C%E3%80%82%0A%60%60%60%0A%0A%23%23%23%23%20%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E4%B8%8E%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%0A%3E%20%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E6%9C%AC%E8%B4%A8%E4%B8%8A%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E9%9B%86%E5%90%88(%E6%88%96%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1)%EF%BC%8C%E5%AE%83%E7%BB%B4%E6%8A%A4%E7%9D%80%E7%BB%84%E4%BB%B6%E8%BF%90%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E4%BF%A1%E6%81%AF%0A%3E%20%E4%BE%8B%E5%A6%82%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%87%BD%E6%95%B0%E3%80%81%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E7%9A%84%E5%AD%90%E6%A0%91%0A%0A%60%60%60js%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20const%20componentOptions%20%3D%20vnode.type%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%0A%20%20%20%20const%20state%20%3D%20reactive(data())%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20render%2C%20data%2C%20beforeCreate%2C%20created%2C%20beforeMount%2C%20mounted%2C%20beforeUpdate%2C%20updated%20%7D%20%3D%20componentOptions%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8beforeCreate%E9%92%A9%E5%AD%90%0A%20%20%20%20beforeCreate%20%26%26%20beforeCreate()%0A%20%20%20%20%0A%20%20%20%20const%20instance%20%3D%20%7B%0A%20%20%20%20%20%20%20%20state%2C%20%2F%2F%20%E7%BB%84%E4%BB%B6%E8%87%AA%E8%BA%AB%E7%9A%84%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%8D%B3data%0A%20%20%20%20%20%20%20%20isMounted%3A%20false%2C%20%2F%2F%20%E4%B8%80%E4%B8%AA%E5%B8%83%E5%B0%94%E5%80%BC%EF%BC%8C%E7%94%A8%E6%9D%A5%E8%A1%A8%E7%A4%BA%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E8%A2%AB%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20subTree%3A%20null%20%2F%2F%20%E7%BB%84%E4%BB%B6%E6%89%80%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E5%8D%B3%E5%AD%90%E6%A0%91%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%B0%86%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E8%AE%BE%E7%BD%AE%E5%88%B0vnode%E4%B8%8A%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%90%8E%E7%BB%AD%E6%9B%B4%E6%96%B0%0A%20%20%20%20vnode.component%20%3D%20instance%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8created%E9%92%A9%E5%AD%90%0A%20%20%20%20created%20%26%26%20created.call(state)%0A%20%20%20%20%0A%20%20%20%20effect(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%B8%80%E6%97%A6%E7%BB%84%E4%BB%B6%E8%87%AA%E8%BA%AB%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%EF%BC%8C%E7%BB%84%E4%BB%B6%E5%B0%B1%E4%BC%9A%E8%87%AA%E5%8A%A8%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20const%20subTree%20%3D%20render.call(state%2C%20state)%0A%20%20%20%20%20%20%20%20if%20(!instance.isMounted)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8beforeMount%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20beforeMount%20%26%26%20beforeMount.call(state)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%9D%E6%AC%A1%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20instance.isMounted%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8mounted%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20mounted%20%26%26%20mounted.call(state)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8beforeUpdate%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20beforeUpdate%20%26%26%20beforeUpdate.call(state)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93isMounted%E4%B8%BAtrue%E6%97%B6%EF%BC%8C%E8%AF%B4%E6%98%8E%E7%BB%84%E4%BB%B6%E5%B7%B2%E7%BB%8F%E8%A2%AB%E6%8C%82%E8%BD%BD%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E5%AE%8C%E6%88%90%E8%87%AA%E6%9B%B4%E6%96%B0%E5%8D%B3%E5%8F%AF%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%89%80%E4%BB%A5%E8%B0%83%E7%94%A8patch%E5%87%BD%E6%95%B0%E6%97%B6%EF%BC%8C%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E4%B8%BA%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%B8%80%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%9A%84%E5%AD%90%E6%A0%91%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(instance.subTree%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8updated%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20updated%20%26%26%20updated.call(state)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%9B%B4%E6%96%B0%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%AD%90%E6%A0%91%0A%20%20%20%20%20%20%20%20instance.subTree%20%3D%20subTree%0A%20%20%20%20%7D%2C%20%7B%0A%20%20%20%20%20%20%20%20scheduler%3A%20queueJob%0A%20%20%20%20%7D)%0A%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20props%E4%B8%8E%E7%BB%84%E4%BB%B6%E7%9A%84%E8%A2%AB%E5%8A%A8%E6%9B%B4%E6%96%B0%0A%3E%20%E5%9C%A8%E8%99%9A%E6%8B%9FDOM%E5%B1%82%E9%9D%A2%EF%BC%8C%E7%BB%84%E4%BB%B6%E7%9A%84props%E4%B8%8E%E6%99%AE%E9%80%9AHTML%E6%A0%87%E7%AD%BE%E7%9A%84%E5%B1%9E%E6%80%A7%E5%B7%AE%E5%88%AB%E4%B8%8D%E5%A4%A7%0A%0A%60%60%60js%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20const%20componentOptions%20%3D%20vnode.type%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%0A%20%20%20%20const%20state%20%3D%20reactive(data())%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20render%2C%20data%2C%20props%2C%20propsOptions%2C%20beforeCreate%2C%20created%2C%20beforeMount%2C%20mounted%2C%20beforeUpdate%2C%20updated%20%7D%20%3D%20componentOptions%0A%20%20%20%20%0A%20%20%20%20const%20%5Bprops%2C%20attrs%5D%20%3D%20resolveProps(propsOptions%2C%20vnode.props)%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8beforeCreate%E9%92%A9%E5%AD%90%0A%20%20%20%20beforeCreate%20%26%26%20beforeCreate()%0A%20%20%20%20%0A%20%20%20%20const%20instance%20%3D%20%7B%0A%20%20%20%20%20%20%20%20state%2C%20%2F%2F%20%E7%BB%84%E4%BB%B6%E8%87%AA%E8%BA%AB%E7%9A%84%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%8D%B3data%0A%20%20%20%20%20%20%20%20props%3A%20shallowReactive(props)%2C%20%2F%2F%20%E5%B0%86props%E5%8C%85%E8%A3%85%E6%88%90shallowReactive%0A%20%20%20%20%20%20%20%20isMounted%3A%20false%2C%20%2F%2F%20%E4%B8%80%E4%B8%AA%E5%B8%83%E5%B0%94%E5%80%BC%EF%BC%8C%E7%94%A8%E6%9D%A5%E8%A1%A8%E7%A4%BA%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E8%A2%AB%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20subTree%3A%20null%20%2F%2F%20%E7%BB%84%E4%BB%B6%E6%89%80%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E5%8D%B3%E5%AD%90%E6%A0%91%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%B0%86%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E8%AE%BE%E7%BD%AE%E5%88%B0vnode%E4%B8%8A%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%90%8E%E7%BB%AD%E6%9B%B4%E6%96%B0%0A%20%20%20%20vnode.component%20%3D%20instance%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8created%E9%92%A9%E5%AD%90%0A%20%20%20%20created%20%26%26%20created.call(state)%0A%20%20%20%20%0A%20%20%20%20effect(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%B8%80%E6%97%A6%E7%BB%84%E4%BB%B6%E8%87%AA%E8%BA%AB%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%EF%BC%8C%E7%BB%84%E4%BB%B6%E5%B0%B1%E4%BC%9A%E8%87%AA%E5%8A%A8%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20const%20subTree%20%3D%20render.call(state%2C%20state)%0A%20%20%20%20%20%20%20%20if%20(!instance.isMounted)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8beforeMount%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20beforeMount%20%26%26%20beforeMount.call(state)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%9D%E6%AC%A1%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20instance.isMounted%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8mounted%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20mounted%20%26%26%20mounted.call(state)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8beforeUpdate%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20beforeUpdate%20%26%26%20beforeUpdate.call(state)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93isMounted%E4%B8%BAtrue%E6%97%B6%EF%BC%8C%E8%AF%B4%E6%98%8E%E7%BB%84%E4%BB%B6%E5%B7%B2%E7%BB%8F%E8%A2%AB%E6%8C%82%E8%BD%BD%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E5%AE%8C%E6%88%90%E8%87%AA%E6%9B%B4%E6%96%B0%E5%8D%B3%E5%8F%AF%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%89%80%E4%BB%A5%E8%B0%83%E7%94%A8patch%E5%87%BD%E6%95%B0%E6%97%B6%EF%BC%8C%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E4%B8%BA%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%B8%80%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%9A%84%E5%AD%90%E6%A0%91%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(instance.subTree%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8updated%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20updated%20%26%26%20updated.call(state)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%9B%B4%E6%96%B0%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%AD%90%E6%A0%91%0A%20%20%20%20%20%20%20%20instance.subTree%20%3D%20subTree%0A%20%20%20%20%7D%2C%20%7B%0A%20%20%20%20%20%20%20%20scheduler%3A%20queueJob%0A%20%20%20%20%7D)%0A%0A%7D%0A%0Afunction%20resolveProps(options%2C%20propsData)%20%7B%0A%20%20%20%20const%20props%20%3D%20%7B%7D%0A%20%20%20%20const%20attrs%20%3D%20%7B%7D%0A%20%20%20%20%2F%2F%20%E9%81%8D%E5%8E%86%E4%B8%BA%E7%BB%84%E4%BB%B6%E4%BC%A0%E9%80%92%E7%9A%84props%E6%95%B0%E6%8D%AE%0A%20%20%20%20for(const%20key%20in%20propsData)%20%7B%0A%20%20%20%20%20%20%20%20if%20(key%20in%20options)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E4%B8%BA%E7%BB%84%E4%BB%B6%E4%BC%A0%E9%80%92%E7%9A%84props%E6%95%B0%E6%8D%AE%E5%9C%A8%E7%BB%84%E4%BB%B6%E8%87%AA%E8%BA%AB%E7%9A%84props%E9%80%89%E9%A1%B9%E4%B8%AD%E6%9C%89%E5%AE%9A%E4%B9%89%EF%BC%8C%E5%88%99%E5%B0%86%E5%85%B6%E8%A7%86%E4%B8%BA%E5%90%88%E6%B3%95%E7%9A%84props%0A%20%20%20%20%20%20%20%20%20%20%20%20props%5Bkey%5D%20%3D%20propsData%5Bkey%5D%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%90%A6%E5%88%99%E5%B0%86%E5%85%B6%E4%BD%9C%E4%B8%BAattrs%0A%20%20%20%20%20%20%20%20%20%20%20%20attrs%5Bkey%5D%20%3D%20propsData%5Bkey%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20%5Bprops%2C%20attrs%5D%0A%7D%0A%0A%2F%2F%20props%E6%95%B0%E6%8D%AE%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E8%A7%A6%E5%8F%91%E7%88%B6%E7%BB%84%E4%BB%B6%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%0A%2F%2F%20%E7%88%B6%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0%E6%97%B6%E4%BC%9A%E8%B0%83%E7%94%A8patchComponent%E5%87%BD%E6%95%B0%E6%9D%A5%E5%AE%8C%E6%88%90%E5%AD%90%E7%BB%84%E4%BB%B6%E7%9A%84%E6%9B%B4%E6%96%B0%E3%80%82%E8%BF%99%E7%A7%8D%E6%9B%B4%E6%96%B0%E5%8F%AB%E5%81%9A%E5%AD%90%E7%BB%84%E4%BB%B6%E7%9A%84%E8%A2%AB%E5%8A%A8%E6%9B%B4%E6%96%B0%EF%BC%8C%E5%BD%93%E8%A2%AB%E5%8A%A8%E6%9B%B4%E6%96%B0%E6%97%B6%EF%BC%9A%0A%2F%2F%201.%E6%A3%80%E6%B5%8B%E5%AD%90%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E7%9C%9F%E7%9A%84%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AD%90%E7%BB%84%E4%BB%B6%E7%9A%84props%E5%8F%AF%E8%83%BD%E6%98%AF%E4%B8%8D%E5%8F%98%E7%9A%84%0A%2F%2F%202.%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0%EF%BC%8C%E5%88%99%E6%9B%B4%E6%96%B0%E5%AD%90%E7%BB%84%E4%BB%B6%E7%9A%84props%E3%80%81slots%E7%AD%89%E5%86%85%E5%AE%B9%0A%60%60%60%0A%0A%23%23%23%23%20setup%E5%87%BD%E6%95%B0%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E5%AE%9E%E7%8E%B0%0A%3E%20setup%E5%87%BD%E6%95%B0%E4%B8%BB%E8%A6%81%E7%94%A8%E4%BA%8E%E9%85%8D%E5%90%88%E7%BB%84%E5%90%88%E5%BC%8FAPI%EF%BC%8C%E4%B8%BA%E7%94%A8%E6%88%B7%E6%8F%90%E4%BE%9B%E4%B8%80%E4%B8%AA%E5%9C%B0%E6%96%B9%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%BB%BA%E7%AB%8B%E7%BB%84%E5%90%88%E9%80%BB%E8%BE%91%E3%80%81%E5%88%9B%E5%BB%BA%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E3%80%81%E5%88%9B%E5%BB%BA%E9%80%9A%E7%94%A8%E5%87%BD%E6%95%B0%E3%80%81%E6%B3%A8%E5%86%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E7%AD%89%E8%83%BD%E5%8A%9B%E3%80%82%0A%0A%E5%9C%A8%E7%BB%84%E4%BB%B6%E7%9A%84%E6%95%B4%E4%B8%AA%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%AD%EF%BC%8Csetup%E5%87%BD%E6%95%B0%E5%8F%AA%E4%BC%9A%E5%9C%A8%E8%A2%AB%E6%8C%82%E8%BD%BD%E6%97%B6%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%EF%BC%8C%E5%AE%83%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E5%8F%AF%E4%BB%A5%E6%9C%89%E4%B8%A4%E7%A7%8D%E6%83%85%E5%86%B5%EF%BC%9A%0A-%20%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%8C%E8%AF%A5%E5%87%BD%E6%95%B0%E5%B0%86%E4%BD%9C%E4%B8%BA%E7%BB%84%E4%BB%B6%E7%9A%84render%E5%87%BD%E6%95%B0%E3%80%82%E8%BF%99%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%B8%B8%E7%94%A8%E4%BA%8E%E7%BB%84%E4%BB%B6%E4%B8%8D%E6%98%AF%E4%BB%A5%E6%A8%A1%E7%89%88%E6%9D%A5%E8%A1%A8%E8%BE%BE%E5%85%B6%E6%B8%B2%E6%9F%93%E5%86%85%E5%AE%B9%E7%9A%84%E6%83%85%E5%86%B5%0A%60%60%60js%0Aconst%20Comp%20%3D%20%7B%0A%20%20%20%20setup()%20%7B%0A%20%20%20%20%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20type%3A%20'div'%2C%20children%3A%20'hello'%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A-%20%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%EF%BC%8C%E8%AF%A5%E5%AF%B9%E8%B1%A1%E4%B8%AD%E5%8C%85%E5%90%AB%E7%9A%84%E6%95%B0%E6%8D%AE%E5%B0%86%E6%9A%B4%E9%9C%B2%E7%BB%99%E6%A8%A1%E7%89%88%E4%BD%BF%E7%94%A8%0A%0A%E5%8F%A6%E5%A4%96setup%E5%87%BD%E6%95%B0%E6%8E%A5%E6%94%B6%E4%B8%A4%E4%B8%AA%E5%8F%82%E6%95%B0%E3%80%82%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E6%97%B6props%E6%95%B0%E6%8D%AE%E5%AF%B9%E8%B1%A1%EF%BC%8C%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E4%B9%9F%E6%98%AF%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1%EF%BC%8C%E9%80%9A%E5%B8%B8%E7%A7%B0%E4%B8%BAsetupContext%0A%60%60%60js%0Aconst%20Comp%20%3D%20%7B%0A%20%20%20%20props%3A%20%7B%0A%20%20%20%20%20%20%20%20foo%3A%20String%0A%20%20%20%20%7D%2C%0A%20%20%20%20setup(props%2C%20setupContext)%20%7B%0A%20%20%20%20%20%20%20%20props.foo%0A%20%20%20%20%20%20%20%20const%20%7B%20slots%2C%20emit%2C%20attrs%2C%20expose%20%7D%20%3D%20setupContext%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%0A%60%E9%80%9A%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E4%B8%8D%E5%BB%BA%E8%AE%AE%E5%B0%86setup%E4%B8%8EVue.js2%E4%B8%AD%E7%9A%84%E7%BB%84%E4%BB%B6%E9%80%89%E9%A1%B9%E6%B7%B7%E5%90%88%E4%BD%BF%E7%94%A8%60%0A%0A%60%60%60js%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20const%20componentOptions%20%3D%20vnode.type%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%BE%97%E5%88%B0%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%0A%20%20%20%20const%20state%20%3D%20reactive(data())%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20render%2C%20data%2C%20props%2C%20propsOptions%2C%20beforeCreate%2C%20created%2C%20beforeMount%2C%20mounted%2C%20beforeUpdate%2C%20updated%2C%20setup%20%7D%20%3D%20componentOptions%0A%20%20%20%20%0A%20%20%20%20const%20%5Bprops%2C%20attrs%5D%20%3D%20resolveProps(propsOptions%2C%20vnode.props)%0A%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8beforeCreate%E9%92%A9%E5%AD%90%0A%20%20%20%20beforeCreate%20%26%26%20beforeCreate()%0A%20%20%20%20%0A%20%20%20%20const%20instance%20%3D%20%7B%0A%20%20%20%20%20%20%20%20state%2C%20%2F%2F%20%E7%BB%84%E4%BB%B6%E8%87%AA%E8%BA%AB%E7%9A%84%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%8D%B3data%0A%20%20%20%20%20%20%20%20props%3A%20shallowReactive(props)%2C%20%2F%2F%20%E5%B0%86props%E5%8C%85%E8%A3%85%E6%88%90shallowReactive%0A%20%20%20%20%20%20%20%20isMounted%3A%20false%2C%20%2F%2F%20%E4%B8%80%E4%B8%AA%E5%B8%83%E5%B0%94%E5%80%BC%EF%BC%8C%E7%94%A8%E6%9D%A5%E8%A1%A8%E7%A4%BA%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E8%A2%AB%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20subTree%3A%20null%20%2F%2F%20%E7%BB%84%E4%BB%B6%E6%89%80%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E5%8D%B3%E5%AD%90%E6%A0%91%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20setupContext%20%3D%20%7B%20attrs%20%7D%0A%20%20%20%20const%20setupResult%20%3D%20setup(shallowReadonly(instance.props)%2C%20setupContext)%0A%20%20%20%20let%20setupState%20%3D%20null%0A%20%20%20%20if%20(typeof%20setupResult%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20if%20(render)%20console.error('setup%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%EF%BC%8Crender%E9%80%89%E9%A1%B9%E5%B0%86%E8%A2%AB%E5%BF%BD%E7%95%A5')%0A%20%20%20%20%20%20%20%20render%20%3D%20setupResult%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%BD%9C%E4%B8%BA%E6%95%B0%E6%8D%AE%E8%B5%8B%E5%80%BC%0A%20%20%20%20%20%20%20%20setupState%20%3D%20setupContext%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%B0%86%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E8%AE%BE%E7%BD%AE%E5%88%B0vnode%E4%B8%8A%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%90%8E%E7%BB%AD%E6%9B%B4%E6%96%B0%0A%20%20%20%20vnode.component%20%3D%20instance%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8created%E9%92%A9%E5%AD%90%0A%20%20%20%20created%20%26%26%20created.call(state)%0A%20%20%20%20%0A%20%20%20%20effect(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%B8%80%E6%97%A6%E7%BB%84%E4%BB%B6%E8%87%AA%E8%BA%AB%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%EF%BC%8C%E7%BB%84%E4%BB%B6%E5%B0%B1%E4%BC%9A%E8%87%AA%E5%8A%A8%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20const%20subTree%20%3D%20render.call(state%2C%20state)%0A%20%20%20%20%20%20%20%20if%20(!instance.isMounted)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8beforeMount%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20beforeMount%20%26%26%20beforeMount.call(state)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%9D%E6%AC%A1%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20instance.isMounted%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8mounted%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20mounted%20%26%26%20mounted.call(state)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8beforeUpdate%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20beforeUpdate%20%26%26%20beforeUpdate.call(state)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93isMounted%E4%B8%BAtrue%E6%97%B6%EF%BC%8C%E8%AF%B4%E6%98%8E%E7%BB%84%E4%BB%B6%E5%B7%B2%E7%BB%8F%E8%A2%AB%E6%8C%82%E8%BD%BD%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E5%AE%8C%E6%88%90%E8%87%AA%E6%9B%B4%E6%96%B0%E5%8D%B3%E5%8F%AF%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%89%80%E4%BB%A5%E8%B0%83%E7%94%A8patch%E5%87%BD%E6%95%B0%E6%97%B6%EF%BC%8C%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E4%B8%BA%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%B8%80%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%9A%84%E5%AD%90%E6%A0%91%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(instance.subTree%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8updated%E9%92%A9%E5%AD%90%0A%20%20%20%20%20%20%20%20%20%20%20%20updated%20%26%26%20updated.call(state)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%9B%B4%E6%96%B0%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%AD%90%E6%A0%91%0A%20%20%20%20%20%20%20%20instance.subTree%20%3D%20subTree%0A%20%20%20%20%7D%2C%20%7B%0A%20%20%20%20%20%20%20%20scheduler%3A%20queueJob%0A%20%20%20%20%7D)%0A%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E7%BB%84%E4%BB%B6%E4%BA%8B%E4%BB%B6%E4%B8%8Eemit%E7%9A%84%E5%AE%9E%E7%8E%B0%0A%3E%20emit%E7%94%A8%E6%9D%A5%E5%8F%91%E5%B0%84%E7%BB%84%E4%BB%B6%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6%0A%3E%20%E5%9C%A8%E5%85%B7%E4%BD%93%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%8A%EF%BC%8C%E5%8F%91%E5%B0%84%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6%E7%9A%84%E6%9C%AC%E8%B4%A8%E5%B0%B1%E6%98%AF%E6%A0%B9%E6%8D%AE%E4%BA%8B%E4%BB%B6%E5%90%8D%E7%A7%B0%E5%8E%BBprops%E6%95%B0%E6%8D%AE%E5%AF%B9%E8%B1%A1%E4%B8%AD%E5%AF%BB%E6%89%BE%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E5%B9%B6%E6%89%A7%E8%A1%8C%0A%0A%0A%23%23%23%23%20%E6%8F%92%E6%A7%BD%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%0A%60%60%60html%0A%3Ctemplate%3E%0A%20%20%20%20%3Cheader%3E%3Cslot%20name%3D%22header%22%2F%3E%3C%2Fheader%3E%0A%20%20%20%20%3Cdiv%3E%0A%20%20%20%20%20%20%20%20%3Cslot%20name%3D%22body%22%2F%3E%0A%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3Cfooter%3E%3Cslot%20name%3D%22footer%22%20%2F%3E%3C%2Ffooter%3E%0A%3C%2Ftemplate%3E%0A%60%60%60%0A%0A%23%23%23%23%20%E6%B3%A8%E5%86%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%0A%3E%20onMounted%E3%80%81onUpdated%0A%0A%60%60%60js%0Alet%20currentInstance%20%3D%20null%0Afunction%20setCurrentInstance(instance)%20%7B%0A%20%20%20%20currentInstance%20%3D%20instance%0A%7D%0A%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20%2F%2F%20...%0A%20%20%20%20%0A%20%20%20%20const%20instance%20%3D%20%7B%0A%20%20%20%20%20%20%20%20state%2C%20%0A%20%20%20%20%20%20%20%20props%3A%20shallowReactive(props)%2C%0A%20%20%20%20%20%20%20%20isMounted%3A%20false%2C%0A%20%20%20%20%20%20%20%20subTree%3A%20null%2C%0A%20%20%20%20%20%20%20%20slots%2C%0A%20%20%20%20%20%20%20%20mounted%3A%20%5B%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20setupContext%20%3D%20%7B%20attrs%2C%20emit%2C%20slots%20%7D%0A%20%20%20%20setCurrentInstance(instance)%0A%20%20%20%20const%20setupResult%20%3D%20setup(shallowReadonly(instance.props)%2C%20setupContext)%0A%20%20%20%20setCurrentInstance(null)%0A%20%20%20%20%0A%20%20%20%20effect(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20const%20subTree%20%3D%20render.call(renderContext%2C%20renderContext)%0A%20%20%20%20%20%20%20%20if%20(!instance.isMounted)%20%7B%0A%20%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20instance.mounted%20%26%26%20instance.mounted.forEach(hook%20%3D%3E%20hook.call(renderContext))%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D)%0A%7D%0A%0A%2F%2F%20onMounted%0Afunction%20onMounted(fn)%20%7B%0A%20%20%20%20if%20(currentInstance)%20%7B%0A%20%20%20%20%20%20%20%20currentInstance.mounted.push(fn)%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20console.error('onMounted%E5%87%BD%E6%95%B0%E5%8F%AA%E8%83%BD%E5%9C%A8setup%E4%B8%AD%E8%B0%83%E7%94%A8')%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E6%80%BB%E7%BB%93%0A%0A%0A%23%23%23%20%E7%AC%AC13%E7%AB%A0%E3%80%8A%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E4%B8%8E%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%E3%80%8B%0A%0A%3E%20%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%EF%BC%9A%E4%BB%A5%E5%BC%82%E6%AD%A5%E7%9A%84%E6%96%B9%E5%BC%8F%E5%8A%A0%E8%BD%BD%E5%B9%B6%E6%B8%B2%E6%9F%93%E4%B8%80%E4%B8%AA%E7%BB%84%E4%BB%B6%0A%3E%20%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%EF%BC%9A%E4%BD%BF%E7%94%A8%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8%E8%AF%A5%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E4%BD%9C%E4%B8%BA%E7%BB%84%E4%BB%B6%E8%A6%81%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E7%89%B9%E7%82%B9%E6%98%AF%E6%97%A0%E7%8A%B6%E6%80%81%E3%80%81%E7%BC%96%E5%86%99%E7%AE%80%E5%8D%95%E4%B8%94%E7%9B%B4%E8%A7%82%0A%3E%20vue2%E4%B8%AD%EF%BC%8C%E7%9B%B8%E6%AF%94%E6%9C%89%E7%8A%B6%E6%80%81%E7%BB%84%E4%BB%B6%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%E5%85%B7%E6%9C%89%E6%98%8E%E6%98%BE%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8A%BF%EF%BC%8C%E4%BD%86%E5%9C%A8vue3%E4%B8%AD%EF%BC%8C%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%E4%B8%8E%E6%9C%89%E7%8A%B6%E6%80%81%E7%BB%84%E4%BB%B6%E7%9A%84%E6%80%A7%E8%83%BD%E5%B7%AE%E8%B7%9D%E4%B8%8D%E5%A4%A7%0A%0A%0A%23%23%23%23%20%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E8%A6%81%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98%0A%60%60%60js%0A%2F%2F%20%E5%90%8C%E6%AD%A5%E6%B8%B2%E6%9F%93%0Aimport%20App%20from%20'.%2Fapp.vue'%0AcreateApp(App).mount('%23app')%0A%0A%2F%2F%20%E5%BC%82%E6%AD%A5%E6%B8%B2%E6%9F%93%0Aconst%20loader%20%3D%20()%20%3D%3E%20import('App.vue')%0Aloader().then(App%20%3D%3E%20createApp(App).mount('%23app%0A'))%0A%0A%2F%2F%20%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E4%B8%80%E4%B8%AA%E7%BB%84%E4%BB%B6%0A%3Ctemplate%3E%0A%20%20%20%20%3CComA%20%2F%3E%0A%20%20%20%20%3Ccomponent%20%3Ais%3D%22asyncComp%22%20%2F%3E%0A%3C%2Ftemplate%3E%0A%3Cscript%3E%0Aimport%20%7B%20shallowRef%20%7D%20from%20'vue'%0Aimport%20CompA%20from%20'ComA.vue'%0A%0Aexport%20default%20%7B%0A%20%20%20%20components%3A%20%7B%0A%20%20%20%20%20%20%20%20CompA%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20setup()%20%7B%0A%20%20%20%20%20%20%20%20const%20asyncComp%20%3D%20shallowRef(null)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20import('CompB.vue').then(CompB%20%3D%3E%20asyncComp.value%20%3D%20CompB)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20asyncComp%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%0A%3E%20%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E6%9C%AC%E8%B4%A8%E4%B8%8A%E6%98%AF%E9%80%9A%E8%BF%87%E5%B0%81%E8%A3%85%E6%89%8B%E6%AE%B5%E6%9D%A5%E5%AE%9E%E7%8E%B0%E5%8F%8B%E5%A5%BD%E7%9A%84%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3%EF%BC%8C%E4%BB%8E%E8%80%8C%E9%99%8D%E4%BD%8E%E7%94%A8%E6%88%B7%E5%B1%82%E9%9D%A2%E7%9A%84%E4%BD%BF%E7%94%A8%E5%A4%8D%E6%9D%82%E5%BA%A6%0A%0A%60%60%60js%0Aexport%20default%20%7B%0A%20%20%20%20components%3A%20%7B%0A%20%20%20%20%20%20%20%20AsyncComp%3A%20defineAsyncComponent(()%20%3D%3E%20import('CompA'))%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E4%BD%BF%E7%94%A8defineAsyncComponent%E6%9D%A5%E5%AE%9A%E4%B9%89%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%B9%B6%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8components%E6%9D%A5%E6%B3%A8%E5%86%8C%E5%AE%83%0A%2F%2F%20defineAsyncComponent%E6%98%AF%E4%B8%80%E4%B8%AA%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%0A%0Afunction%20defineAsyncComponent(loader)%20%7B%0A%20%20%20%20%2F%2F%20%E4%B8%80%E4%B8%AA%E5%8F%98%E9%87%8F%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%BB%84%E4%BB%B6%0A%20%20%20%20let%20InnerComp%20%3D%20null%0A%20%20%20%20%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20name%3A%20'AsyncComponentWrapper'%2C%0A%20%20%20%20%20%20%20%20setup()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20loaded%20%3D%20ref(false)%0A%20%20%20%20%20%20%20%20%20%20%20%20loader().then(c%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20InnerComp%20%3D%20c%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20loaded.value%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%88%90%E5%8A%9F%E5%B0%B1%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%90%A6%E5%88%99%E6%B8%B2%E6%9F%93%E4%B8%80%E4%B8%AA%E5%8D%A0%E4%BD%8D%E5%86%85%E5%AE%B9%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20loaded.value%20%3F%20%7B%20type%3A%20InnerComp%20%7D%20%3A%20%7B%20type%3A%20Text%2C%20children%3A%20''%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20defineAsyncComponent%E5%87%BD%E6%95%B0%E6%9C%AC%E8%B4%A8%E4%B8%8A%E6%98%AF%E4%B8%80%E4%B8%AA%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%AE%83%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8C%85%E8%A3%85%E7%BB%84%E4%BB%B6%0A%2F%2F%20%E5%8C%85%E8%A3%85%E7%BB%84%E4%BB%B6%E4%BC%9A%E6%A0%B9%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%9A%84%E7%8A%B6%E6%80%81%E6%9D%A5%E5%86%B3%E5%AE%9A%E6%B8%B2%E6%9F%93%E4%BB%80%E4%B9%88%E5%86%85%E5%AE%B9%E3%80%82%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%88%90%E5%8A%9F%E5%B0%B1%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%90%A6%E5%88%99%E6%B8%B2%E6%9F%93%E4%B8%80%E4%B8%AA%E5%8D%A0%E4%BD%8D%E5%86%85%E5%AE%B9%0A%2F%2F%20%E9%80%9A%E5%B8%B8%E5%8D%A0%E4%BD%8D%E5%86%85%E5%AE%B9%E6%98%AF%E4%B8%80%E4%B8%AA%E6%B3%A8%E9%87%8A%E8%8A%82%E7%82%B9%E3%80%82%E7%BB%84%E4%BB%B6%E6%B2%A1%E6%9C%89%E8%A2%AB%E5%8A%A0%E8%BD%BD%E6%88%90%E5%8A%9F%E6%97%B6%EF%BC%8C%E9%A1%B5%E9%9D%A2%E4%B8%AD%E4%BC%9A%E6%B8%B2%E6%9F%93%E4%B8%80%E4%B8%AA%E6%B3%A8%E9%87%8A%E8%8A%82%E7%82%B9%E6%9D%A5%E5%8D%A0%E4%BD%8D%0A%60%60%60%0A%0A%23%23%23%23%20%E8%B6%85%E6%97%B6%E4%B8%8EError%E7%BB%84%E4%BB%B6%0A%3E%20%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E9%80%9A%E5%B8%B8%E4%BB%A5%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E7%9A%84%E5%BD%A2%E5%BC%8F%E8%BF%9B%E8%A1%8C%E5%8A%A0%E8%BD%BD%EF%BC%8C%E6%97%A2%E7%84%B6%E5%AD%98%E5%9C%A8%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%EF%BC%8C%E5%B0%B1%E8%A6%81%E8%80%83%E8%99%91%E7%BD%91%E9%80%9F%E8%BE%83%E6%85%A2%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E5%B0%A4%E5%85%B6%E5%9C%A8%E5%BC%B1%E7%BD%91%E7%8E%AF%E5%A2%83%E4%B8%8B%EF%BC%8C%E5%9B%A0%E6%AD%A4%E9%9C%80%E8%A6%81%E4%B8%BA%E7%94%A8%E6%88%B7%E6%8F%90%E4%BE%9B%E6%8C%87%E5%AE%9A%E8%B6%85%E6%97%B6%E6%97%B6%E9%95%BF%E7%9A%84%E8%83%BD%E5%8A%9B%EF%BC%8C%E5%BD%93%E5%8A%A0%E8%BD%BD%E7%BB%84%E4%BB%B6%E7%9A%84%E6%97%B6%E9%97%B4%E8%B6%85%E8%BF%87%E4%BA%86%E6%8C%87%E5%AE%9A%E6%97%B6%E9%95%BF%E5%90%8E%EF%BC%8C%E4%BC%9A%E8%A7%A6%E5%8F%91%E8%B6%85%E6%97%B6%E9%94%99%E8%AF%AF%E3%80%82%E8%BF%99%E6%97%B6%E5%A6%82%E6%9E%9C%E9%85%8D%E7%BD%AE%E4%BA%86Error%E7%BB%84%E4%BB%B6%EF%BC%8C%E4%BC%9A%E6%B8%B2%E6%9F%93%E8%AF%A5%E7%BB%84%E4%BB%B6%0A%0A%60%60%60js%0Aconst%20AsyncComp%20%3D%20defineAsyncComponent(%7B%0A%20%20%20%20loader%3A%20()%20%3D%3E%20import('CompA.vue')%2C%0A%20%20%20%20timeout%3A%202000%2C%0A%20%20%20%20errorComponent%3A%20MyErrorComp%0A%7D)%0A%0Afunction%20defineAsyncComponent(options)%20%7B%0A%20%20%20%20%2F%2F%20options%E6%98%AF%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%8C%E5%B0%86%E5%85%B6%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%BA%E9%85%8D%E7%BD%AE%E9%A1%B9%0A%20%20%20%20if%20(typeof%20options%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20options%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20loader%3A%20options%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20loader%20%7D%20%3D%20options%0A%0A%20%20%20%20%2F%2F%20%E4%B8%80%E4%B8%AA%E5%8F%98%E9%87%8F%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%BB%84%E4%BB%B6%0A%20%20%20%20let%20InnerComp%20%3D%20null%0A%20%20%20%20%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20name%3A%20'AsyncComponentWrapper'%2C%0A%20%20%20%20%20%20%20%20setup()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20loaded%20%3D%20ref(false)%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20timeout%20%3D%20ref(false)%0A%20%20%20%20%20%20%20%20%20%20%20%20loader().then(c%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20InnerComp%20%3D%20c%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20loaded.value%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20timer%20%3D%20null%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(options.timeout)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20timer%20%3D%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20timeout.value%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%20options.timeout)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20onUnmounted(()%20%3D%3E%20clearTimeout(timer))%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20placeholder%20%3D%20%7B%20type%3A%20Text%2C%20children%3A%20''%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(loaded.value)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20type%3A%20InnerComp%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(timeout.value)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E8%B6%85%E6%97%B6%E4%B8%94%E5%AD%98%E5%9C%A8%E9%94%99%E8%AF%AF%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%88%99%E6%B8%B2%E6%9F%93%E8%AF%A5%E7%BB%84%E4%BB%B6%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20options.errorComponent%20%3F%20%7B%20type%3A%20options.errorComponent%20%7D%20%3A%20placeholder%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20placeholder%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E5%B8%8C%E6%9C%9B%E6%9C%89%E6%9B%B4%E5%AE%8C%E5%96%84%E7%9A%84%E6%9C%BA%E5%88%B6%E6%9D%A5%E5%A4%84%E7%90%86%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%8F%91%E7%94%9F%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%9A%0A%2F%2F%201.%E5%BD%93%E9%94%99%E8%AF%AF%E5%8F%91%E7%94%9F%E6%97%B6%EF%BC%8C%E6%8A%8A%E9%94%99%E8%AF%AF%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BAError%E7%BB%84%E4%BB%B6%E7%9A%84props%E4%BC%A0%E9%80%92%E8%BF%87%E5%8E%BB%0A%2F%2F%202.%E9%99%A4%E4%BA%86%E8%B6%85%E6%97%B6%E5%A4%96%EF%BC%8C%E6%9C%89%E8%83%BD%E5%8A%9B%E5%A4%84%E7%90%86%E5%85%B6%E4%BB%96%E5%8E%9F%E5%9B%A0%E5%AF%BC%E8%87%B4%E7%9A%84%E5%8A%A0%E8%BD%BD%E9%94%99%E8%AF%AF%EF%BC%8C%E4%BE%8B%E5%A6%82%E7%BD%91%E7%BB%9C%E5%A4%B1%E8%B4%A5%0A%0Afunction%20defineAsyncComponent(options)%20%7B%0A%20%20%20%20%2F%2F%20options%E6%98%AF%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%8C%E5%B0%86%E5%85%B6%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%BA%E9%85%8D%E7%BD%AE%E9%A1%B9%0A%20%20%20%20if%20(typeof%20options%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20options%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20loader%3A%20options%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20loader%20%7D%20%3D%20options%0A%0A%20%20%20%20%2F%2F%20%E4%B8%80%E4%B8%AA%E5%8F%98%E9%87%8F%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%BB%84%E4%BB%B6%0A%20%20%20%20let%20InnerComp%20%3D%20null%0A%20%20%20%20%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20name%3A%20'AsyncComponentWrapper'%2C%0A%20%20%20%20%20%20%20%20setup()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20loaded%20%3D%20ref(false)%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20error%20%3D%20shallowRef(null)%0A%20%20%20%20%20%20%20%20%20%20%20%20loader().then(c%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20InnerComp%20%3D%20c%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20loaded.value%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D).catch(err%20%3D%3E%20error.value%20%3D%20err)%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20timer%20%3D%20null%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(options.timeout)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20timer%20%3D%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%B6%85%E6%97%B6%E5%90%8E%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E5%A4%8D%E5%88%B6%E7%BB%99error.value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20err%20%3D%20new%20Error('Async%20component%20timed%20out%20after%20....')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20error.value%20%3D%20err%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%20options.timeout)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20onUnmounted(()%20%3D%3E%20clearTimeout(timer))%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20placeholder%20%3D%20%7B%20type%3A%20Text%2C%20children%3A%20''%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(loaded.value)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20type%3A%20InnerComp%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(error.value%20%26%26%20options.errorComponent)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E9%94%99%E8%AF%AF%E4%B8%94%E5%AD%98%E5%9C%A8%E9%94%99%E8%AF%AF%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%88%99%E6%B8%B2%E6%9F%93%E8%AF%A5%E7%BB%84%E4%BB%B6%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20type%3A%20options.errorComponent%2C%20props%3A%20%7B%20error%3A%20error.value%20%7D%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20placeholder%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E5%BB%B6%E8%BF%9F%E4%B8%8ELoading%E7%BB%84%E4%BB%B6%0A%3E%20%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E5%8F%97%E7%BD%91%E7%BB%9C%E5%BD%B1%E5%93%8D%E5%A4%A7%EF%BC%8C%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E5%8F%AF%E8%83%BD%E5%BE%88%E6%85%A2%E5%8F%AF%E8%83%BD%E5%BE%88%E5%BF%AB%E3%80%82%E8%BF%99%E6%97%B6%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%B1%95%E7%A4%BALoading%E7%BB%84%E4%BB%B6%E6%9D%A5%E6%8F%90%E4%BE%9B%E6%9B%B4%E5%A5%BD%E7%9A%84%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%E3%80%82%E4%BD%86%E6%98%AF%E5%B1%95%E7%A4%BALoading%E7%BB%84%E4%BB%B6%E7%9A%84%E6%97%B6%E6%9C%BA%E6%98%AF%E4%B8%80%E4%B8%AA%E9%9C%80%E8%A6%81%E4%BB%94%E7%BB%86%E8%80%83%E8%99%91%E7%9A%84%E9%97%AE%E9%A2%98%0A%3E%20%E9%80%9A%E5%B8%B8%EF%BC%8C%E5%9C%A8%E5%BC%80%E5%A7%8B%E5%8A%A0%E8%BD%BD%E6%97%B6%E6%B8%B2%E6%9F%93Loading%E7%BB%84%E4%BB%B6%EF%BC%8C%E4%BD%86%E6%98%AF%E5%A6%82%E6%9E%9C%E7%BD%91%E7%BB%9C%E8%89%AF%E5%A5%BD%EF%BC%8C%E8%BF%99%E4%BC%9A%E5%AF%BC%E8%87%B4%E5%88%9A%E6%B8%B2%E6%9F%93%E7%9A%84Loading%E7%BB%84%E4%BB%B6%E7%AB%8B%E9%A9%AC%E8%A2%AB%E5%8D%B8%E8%BD%BD%EF%BC%8C%E8%BF%99%E4%BC%9A%E5%AF%BC%E8%87%B4%E9%97%AA%E7%83%81%EF%BC%8C%E4%BD%93%E9%AA%8C%E4%B8%8D%E5%A5%BD%E3%80%82%E5%9B%A0%E6%AD%A4%EF%BC%8C%E9%9C%80%E8%A6%81%E4%B8%BALoading%E7%BB%84%E4%BB%B6%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AA%E5%BB%B6%E8%BF%9F%E5%B1%95%E7%A4%BA%E7%9A%84%E6%97%B6%E9%97%B4%0A%3E%20%E4%BE%8B%E5%A6%82%E5%BD%93%E8%B6%85%E8%BF%87200ms%E6%B2%A1%E6%9C%89%E5%AE%8C%E6%88%90%E5%8A%A0%E8%BD%BD%EF%BC%8C%E6%89%8D%E5%B1%95%E7%A4%BALoading%E7%BB%84%E4%BB%B6%E3%80%82%E8%BF%99%E6%A0%B7%EF%BC%8C%E5%AF%B9%E4%BA%8E%E5%9C%A8200ms%E5%86%85%E8%83%BD%E5%A4%9F%E5%AE%8C%E6%88%90%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%83%85%E5%86%B5%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%B0%B1%E9%81%BF%E5%85%8D%E4%BA%86%E9%97%AA%E7%83%81%E9%97%AE%E9%A2%98%E7%9A%84%E5%87%BA%E7%8E%B0%0A%0A%60%60%60js%0A%2F%2F%20%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1%0AdefineAsyncComponent(%7B%0A%20%20%20%20loader%3A%20()%20%3D%3E%20new%20Promise(r%20%3D%3E%20%7B%20%2F*%20...*%2F%20%7D)%2C%0A%20%20%20%20%2F%2F%20%E5%BB%B6%E8%BF%9F200ms%E5%B1%95%E7%A4%BALoading%E7%BB%84%E4%BB%B6%0A%20%20%20%20delay%3A%20200%2C%0A%20%20%20%20loadingComponent%3A%20%7B%0A%20%20%20%20%20setup()%20%7B%0A%20%20%20%20%20%20%20%20return%20%7B%20type%3A%20'h2'%2C%20children%3A%20'Loading...'%20%7D%0A%20%20%20%20%20%7D%20%20%20%0A%20%20%20%20%7D%0A%7D)%0A%0A%0A%2F%2F%20%E5%AE%9E%E7%8E%B0%0Afunction%20defineAsyncComponent(options)%20%7B%0A%20%20%20%20%2F%2F%20options%E6%98%AF%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%8C%E5%B0%86%E5%85%B6%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%BA%E9%85%8D%E7%BD%AE%E9%A1%B9%0A%20%20%20%20if%20(typeof%20options%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20options%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20loader%3A%20options%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20loader%20%7D%20%3D%20options%0A%0A%20%20%20%20%2F%2F%20%E4%B8%80%E4%B8%AA%E5%8F%98%E9%87%8F%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E7%9A%84%E7%BB%84%E4%BB%B6%0A%20%20%20%20let%20InnerComp%20%3D%20null%0A%20%20%20%20%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20name%3A%20'AsyncComponentWrapper'%2C%0A%20%20%20%20%20%20%20%20setup()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20loaded%20%3D%20ref(false)%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20error%20%3D%20shallowRef(null)%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20loading%20%3D%20ref(false)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20loadingTimer%20%3D%20null%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(options.delay)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20loadingTimer%20%3D%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20loading.value%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%20options.delay)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20loading.value%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20loader().then(c%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20InnerComp%20%3D%20c%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20loaded.value%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D).catch(err%20%3D%3E%20error.value%20%3D%20err)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.finally(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20loading.value%20%3D%20false%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20clearTimeout(loadingTimer)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20timer%20%3D%20null%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(options.timeout)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20timer%20%3D%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%B6%85%E6%97%B6%E5%90%8E%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E5%A4%8D%E5%88%B6%E7%BB%99error.value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20err%20%3D%20new%20Error('Async%20component%20timed%20out%20after%20....')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20error.value%20%3D%20err%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%20options.timeout)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20onUnmounted(()%20%3D%3E%20clearTimeout(timer))%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20placeholder%20%3D%20%7B%20type%3A%20Text%2C%20children%3A%20''%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(loaded.value)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20type%3A%20InnerComp%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(error.value%20%26%26%20options.errorComponent)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E9%94%99%E8%AF%AF%E4%B8%94%E5%AD%98%E5%9C%A8%E9%94%99%E8%AF%AF%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%88%99%E6%B8%B2%E6%9F%93%E8%AF%A5%E7%BB%84%E4%BB%B6%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20type%3A%20options.errorComponent%2C%20props%3A%20%7B%20error%3A%20error.value%20%7D%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(loading.value%20%26%26%20options.loadingComponent)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20type%3A%20options.loadingComponent%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20placeholder%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%0A%3E%20%E9%87%8D%E8%AF%95%E6%8C%87%E7%9A%84%E6%98%AF%E5%BD%93%E5%8A%A0%E8%BD%BD%E5%87%BA%E9%94%99%E6%97%B6%EF%BC%8C%E6%9C%89%E8%83%BD%E5%8A%9B%E9%87%8D%E6%96%B0%E5%8F%91%E8%B5%B7%E5%8A%A0%E8%BD%BD%E7%BB%84%E4%BB%B6%E7%9A%84%E8%AF%B7%E6%B1%82%0A%0A%60%60%60js%0A%2F%2F%20%E6%A8%A1%E6%8B%9F%E6%8E%A5%E5%8F%A3%E8%AF%B7%E6%B1%82%E5%A4%B1%E8%B4%A5%0Afunction%20fetch()%20%7B%0A%20%20%20%20return%20new%20Promise((resolve%2C%20reject)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20setTimeout(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20reject('err')%0A%20%20%20%20%20%20%20%20%7D%2C%201000)%0A%20%20%20%20%7D)%0A%7D%0A%0Afunction%20load(onError)%20%7B%0A%20%20%20%20const%20p%20%3D%20fetch()%0A%20%20%20%20%0A%20%20%20%20return%20p.catch(err%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20return%20new%20Promise((resolve%2C%20reject)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20retry%20%3D%20()%20%3D%3E%20resolve(load(onError))%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20fail%20%3D%20()%20%3D%3E%20reject(err)%0A%20%20%20%20%20%20%20%20%20%20%20%20onError(retry%2C%20fail)%0A%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%7D)%0A%7D%0A%0A%2F%2F%20%E8%B0%83%E7%94%A8load%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%0Aload(%0A%20%20%20%20(retry)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20retry()%0A%20%20%20%20%7D%0A).then(res%20%3D%3E%20%7B%0A%20%20%20%20console.log(res)%0A%7D)%0A%60%60%60%0A%0A%23%23%23%23%20%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%0A%3E%20%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%E6%9C%AC%E8%B4%A8%E4%B8%8A%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E5%87%BD%E6%95%B0%EF%BC%8C%E8%AF%A5%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E6%98%AF%E8%99%9A%E6%8B%9FDOM%0A%3E%20%E5%9C%A8Vue3%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%EF%BC%8C%E4%B8%BB%E8%A6%81%E6%98%AF%E5%9B%A0%E4%B8%BA%E5%AE%83%E7%9A%84%E7%AE%80%E5%8D%95%E6%80%A7%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E5%9B%A0%E4%B8%BA%E5%AE%83%E7%9A%84%E6%80%A7%E8%83%BD%E5%A5%BD%E3%80%82%E8%BF%99%E6%98%AF%E5%9B%A0%E4%B8%BA%E5%9C%A8vue3%E4%B8%AD%EF%BC%8C%E5%8D%B3%E4%BD%BF%E6%98%AF%E6%9C%89%E7%8A%B6%E6%80%81%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%85%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E6%80%A7%E8%83%BD%E6%B6%88%E8%80%97%E4%B9%9F%E9%9D%9E%E5%B8%B8%E5%B0%8F%0A%0A%60%60%60js%0A%2F%2F%20%E5%9C%A8%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3%E5%B1%82%EF%BC%8C%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E8%BF%94%E5%9B%9E%E8%99%9A%E6%8B%9FDOM%E7%9A%84%E5%87%BD%E6%95%B0%0A%2F%2F%20%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%E6%B2%A1%E6%9C%89%E8%87%AA%E8%BA%AB%E7%8A%B6%E6%80%81%EF%BC%8C%E4%BD%86%E5%AE%83%E4%BB%8D%E7%84%B6%E5%8F%AF%E4%BB%A5%E6%8E%A5%E6%94%B6%E7%94%B1%E5%A4%96%E9%83%A8%E4%BC%A0%E5%85%A5%E7%9A%84props%0Afunction%20MyFuncComp(props)%20%7B%0A%20%20%20%20return%20%7B%20type%3A%20'h1'%2C%20children%3A%20props.title%20%7D%0A%7D%0A%2F%2F%20%E5%AE%9A%E4%B9%89props%0AMyFuncComp.props%20%3D%20%7B%0A%20%20%20%20title%3A%20String%0A%7D%0A%0A%0A%2F%2F%20patch%E5%87%BD%E6%95%B0%E7%9A%84%E6%94%AF%E6%8C%81%E9%9D%9E%E5%B8%B8%E7%AE%80%E5%8D%95%0Afunction%20patch(n1%2C%20n2%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20if%20(n1%20%26%26%20n1.type%20!%3D%3D%20n2.type)%20%7B%0A%20%20%20%20%20%20%20%20unmount(n1)%0A%20%20%20%20%20%20%20%20n1%20%3D%20null%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20type%20%7D%20%3D%20n2%0A%20%20%20%20%0A%20%20%20%20if%20(typeof%20type%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Text)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Fragment)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(typeof%20type%20%3D%3D%3D%20'object'%20%7C%7C%20typeof%20type%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20object%E6%98%AF%E6%9C%89%E7%8A%B6%E6%80%81%E7%BB%84%E4%BB%B6%EF%BC%8Cfunction%E6%98%AF%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%BB%96%E4%BB%AC%E9%83%BD%E5%8F%AF%E4%BB%A5%E7%94%A8mountComponent%E5%87%BD%E6%95%B0%E6%9D%A5%E5%AE%8C%E6%88%90%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%94%A8patchComponent%E5%87%BD%E6%95%B0%E6%9D%A5%E6%9B%B4%E6%96%B0%0A%20%20%20%20%20%20%20%20if%20(!n1)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20mountComponent(n2%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patchComponent(n1%2C%20n2%2C%20anchor)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20const%20isFunctional%20%3D%20typeof%20vnode.type%20%3D%3D%3D%20'function'%0A%20%20%20%20%0A%20%20%20%20let%20componentOptions%20%3D%20vnode.type%0A%20%20%20%20if%20(isFunctional)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E6%98%AF%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%88%99%E5%B0%86vnode.type%E4%BD%9C%E4%B8%BA%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%EF%BC%8C%E5%B0%86vnode.type.props%E4%BD%9C%E4%B8%BAprops%E9%80%89%E9%A1%B9%E5%AE%9A%E4%B9%89%E5%8D%B3%E5%8F%AF%0A%20%20%20%20%20%20%20%20componentOptions%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20render%3A%20vnode.type%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20props%3A%20vnode.type.props%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87isFunctional%E5%8F%98%E9%87%8F%E5%AE%9E%E7%8E%B0%E9%80%89%E6%8B%A9%E6%80%A7%E5%9C%B0%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%BB%E8%BE%91%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AF%B9%E4%BA%8E%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%AE%83%E6%97%A0%E9%A1%BB%E5%88%9D%E5%A7%8B%E5%8C%96data%E4%BB%A5%E5%8F%8A%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%92%A9%E5%AD%90%E3%80%82%E4%BB%8E%E8%BF%99%E9%87%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%87%BA%EF%BC%8C%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%80%A7%E8%83%BD%E6%B6%88%E8%80%97%E5%B0%8F%E4%BA%8E%E6%9C%89%E7%8A%B6%E6%80%81%E7%BB%84%E4%BB%B6%0A%60%60%60%0A%0A%23%23%23%23%20%E6%80%BB%E7%BB%93%0A-%20%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%0A%20%20%20%20-%20%E5%85%81%E8%AE%B8%E7%94%A8%E6%88%B7%E6%8C%87%E5%AE%9A%E5%8A%A0%E8%BD%BD%E5%87%BA%E9%94%99%E7%9A%84%E7%BB%84%E4%BB%B6%0A%20%20%20%20-%20%E5%85%81%E8%AE%B8%E7%94%A8%E6%88%B7%E6%8C%87%E5%AE%9ALoading%E7%BB%84%E4%BB%B6%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%B1%95%E7%A4%BA%E8%AF%A5%E7%BB%84%E4%BB%B6%E7%9A%84%E5%BB%B6%E8%BF%9F%E6%97%B6%E9%97%B4%0A%20%20%20%20-%20%E5%85%81%E8%AE%B8%E7%94%A8%E6%88%B7%E8%AE%BE%E7%BD%AE%E5%8A%A0%E8%BD%BD%E7%BB%84%E4%BB%B6%E7%9A%84%E8%B6%85%E6%97%B6%E6%97%B6%E9%95%BF%0A%20%20%20%20-%20%E7%BB%84%E4%BB%B6%E5%8A%A0%E8%BD%BD%E5%A4%B1%E8%B4%A5%E6%97%B6%E6%8F%90%E4%BE%9B%E9%87%8D%E8%AF%95%E7%9A%84%E8%83%BD%E5%8A%9B%0A%0A-%20%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%0A%0A%0A%23%23%23%20%E7%AC%AC14%E7%AB%A0%E3%80%8A%E5%86%85%E5%BB%BA%E7%BB%84%E4%BB%B6%E5%92%8C%E6%A8%A1%E5%9D%97%E3%80%8B%0A%0A%23%23%23%23%20KeepAlive%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%0A%0A%23%23%23%23%23%20%E7%BB%84%E4%BB%B6%E7%9A%84%E6%BF%80%E6%B4%BB%E4%B8%8E%E5%A4%B1%E7%81%B5%0A%3E%20KeepAlive%E7%BB%84%E4%BB%B6%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E4%B8%80%E4%B8%AA%E7%BB%84%E4%BB%B6%E8%A2%AB%E9%A2%91%E7%B9%81%E5%9C%B0%E9%94%80%E6%AF%81%2F%E9%87%8D%E5%BB%BA%0A%0A%60%60%60html%0A%3Ctemplate%3E%0A%20%20%20%20%3CTab%20v-if%3D%22currentTab%20%3D%3D%3D%201%22%20%3E...%3C%2FTab%3E%0A%20%20%20%20%3CTab%20v-if%3D%22currentTab%20%3D%3D%3D%202%22%20%3E...%3C%2FTab%3E%0A%20%20%20%20%3CTab%20v-if%3D%22currentTab%20%3D%3D%3D%203%22%20%3E...%3C%2FTab%3E%0A%3C%2Ftemplate%3E%0A%0A%3C!--%20%E6%A0%B9%E6%8D%AEcurrentTab%E5%80%BC%E7%9A%84%E4%B8%8D%E5%90%8C%EF%BC%8C%E4%BC%9A%E6%B8%B2%E6%9F%93%E4%B8%8D%E5%90%8C%E7%9A%84Tab%E7%BB%84%E4%BB%B6%E3%80%82%E5%BD%93%E7%94%A8%E6%88%B7%E9%A2%91%E7%B9%81%E5%88%87%E6%8D%A2Tab%E4%BC%9A%E5%AF%BC%E8%87%B4%E4%B8%8D%E5%81%9C%E5%9C%B0%E5%8D%B8%E8%BD%BD%E5%B9%B6%E9%87%8D%E5%BB%BA%E5%AF%B9%E5%BA%94%E7%9A%84%3CTab%3E%E7%BB%84%E4%BB%B6%EF%BC%8C%E4%B8%BA%E4%BA%86%E9%81%BF%E5%85%8D%E4%BA%A7%E7%94%9F%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8KeepAlive%E7%BB%84%E4%BB%B6%E6%9D%A5%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%20--%3E%0A%0A%3Ctemplate%3E%0A%20%20%20%20%3CKeepAlive%3E%0A%20%20%20%20%20%20%20%20%3CTab%20v-if%3D%22currentTab%20%3D%3D%3D%201%22%20%3E...%3C%2FTab%3E%0A%20%20%20%20%20%20%20%20%3CTab%20v-if%3D%22currentTab%20%3D%3D%3D%202%22%20%3E...%3C%2FTab%3E%0A%20%20%20%20%20%20%20%20%3CTab%20v-if%3D%22currentTab%20%3D%3D%3D%203%22%20%3E...%3C%2FTab%3E%0A%20%20%20%20%3C%2FKeepAlive%3E%0A%3C%2Ftemplate%3E%0A%3C!--%20%E8%BF%99%E6%A0%B7%E6%97%A0%E8%AE%BA%E6%80%8E%E6%A0%B7%E5%88%87%E6%8D%A2Tab%EF%BC%8C%E9%83%BD%E4%B8%8D%E4%BC%9A%E9%A2%91%E7%B9%81%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E9%94%80%E6%AF%81%20--%3E%0A%60%60%60%0A%0A%3E%20KeepAlive%E7%BB%84%E4%BB%B6%E7%9A%84%E6%9C%AC%E8%B4%A8%E6%98%AF%E7%BC%93%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%8C%E5%86%8D%E5%8A%A0%E4%B8%8A%E7%89%B9%E6%AE%8A%E7%9A%84%E6%8C%82%E8%BD%BD%2F%E5%8D%B8%E8%BD%BD%E9%80%BB%E8%BE%91%0A%3E%20KeepAlive%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%E9%9C%80%E8%A6%81%E6%B8%B2%E6%9F%93%E5%99%A8%E5%B1%82%E9%9D%A2%E7%9A%84%E6%94%AF%E6%8C%81%E3%80%82%E8%BF%99%E6%98%AF%E5%9B%A0%E4%B8%BA%E8%A2%ABKeepAlive%E7%9A%84%E7%BB%84%E4%BB%B6%E5%9C%A8%E5%8D%B8%E8%BD%BD%E6%97%B6%EF%BC%8C%E4%B8%8D%E8%83%BD%E7%9C%9F%E7%9A%84%E5%B0%86%E5%85%B6%E5%8D%B8%E8%BD%BD%EF%BC%8C%E5%90%A6%E5%88%99%E5%B0%B1%E6%97%A0%E6%B3%95%E7%BB%B4%E6%8C%81%E7%BB%84%E4%BB%B6%E7%9A%84%E5%BD%93%E5%89%8D%E7%8A%B6%E6%80%81%E4%BA%86%E3%80%82%0A%3E%20%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%81%9A%E6%B3%95%E6%98%AF%EF%BC%8C%E5%B0%86%E8%A2%ABKeepAlive%E7%9A%84%E7%BB%84%E4%BB%B6%E4%BB%8E%E5%8E%9F%E5%AE%B9%E5%99%A8%E6%90%AC%E8%BF%90%E5%88%B0%E5%8F%A6%E5%A4%96%E4%B8%80%E4%B8%AA%E9%9A%90%E8%97%8F%E7%9A%84%E5%AE%B9%E5%99%A8%E4%B8%AD%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%81%87%22%E5%8D%B8%E8%BD%BD%22%E3%80%82%E5%BD%93%E8%A2%AB%E6%90%AC%E8%BF%90%E5%88%B0%E9%9A%90%E8%97%8F%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%84%E7%BB%84%E4%BB%B6%E9%9C%80%E8%A6%81%E5%86%8D%E6%AC%A1%E8%A2%AB%22%E6%8C%82%E8%BD%BD%22%E6%97%B6%EF%BC%8C%E4%B9%9F%E4%B8%8D%E8%83%BD%E6%89%A7%E8%A1%8C%E7%9C%9F%E6%AD%A3%E7%9A%84%E6%8C%82%E8%BD%BD%E9%80%BB%E8%BE%91%EF%BC%8C%E8%80%8C%E5%BA%94%E8%AF%A5%E6%8A%8A%E8%AF%A5%E7%BB%84%E4%BB%B6%E4%BB%8E%E9%9A%90%E8%97%8F%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%86%8D%E6%90%AC%E8%BF%90%E5%88%B0%E5%8E%9F%E5%AE%B9%E5%99%A8%E3%80%82%E8%BF%99%E4%B8%AA%E8%BF%87%E7%A8%8B%E5%AF%B9%E5%BA%94%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%8C%E5%8D%B3activated%E5%92%8Cdeactivated%0A%0A%0A%60%60%60js%0A%2F%2F%20%E5%9F%BA%E6%9C%AC%E7%9A%84KeepAlive%E7%BB%84%E4%BB%B6%0A%0Aconst%20KeepAlive%20%3D%20%7B%0A%20%20%20%20%2F%2F%20KeepAlive%E7%BB%84%E4%BB%B6%E7%8B%AC%E6%9C%89%E7%9A%84%E5%B1%9E%E6%80%A7%EF%BC%8C%E7%94%A8%E4%BD%9C%E6%A0%87%E8%AF%86%0A%20%20%20%20__isKeepAlive%3A%20true%2C%0A%20%20%20%20setup(props%2C%20%7B%20slots%20%7D)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%BC%93%E5%AD%98%E5%AF%B9%E8%B1%A1%0A%20%20%20%20%20%20%20%20%2F%2F%20key%3A%20vnode.type%0A%20%20%20%20%20%20%20%20%2F%2F%20value%3A%20vnode%0A%20%20%20%20%20%20%20%20const%20cache%20%3D%20new%20Map()%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93%E5%89%8DKeepAlive%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E4%BE%8B%0A%20%20%20%20%20%20%20%20const%20instance%20%3D%20currentInstance%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%AF%B9%E4%BA%8EKeepAlive%E7%BB%84%E4%BB%B6%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%AE%83%E7%9A%84%E5%AE%9E%E4%BE%8B%E4%B8%8A%E5%AD%98%E5%9C%A8%E7%89%B9%E6%AE%8A%E7%9A%84keepAliveCtx%E5%AF%B9%E8%B1%A1%EF%BC%8C%E8%AF%A5%E5%AF%B9%E8%B1%A1%E7%94%B1%E6%B8%B2%E6%9F%93%E5%99%A8%E6%B3%A8%E5%85%A5%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%AF%A5%E5%AF%B9%E8%B1%A1%E4%BC%9A%E6%9A%B4%E9%9C%B2%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%EF%BC%8C%E5%85%B6%E4%B8%ADmove%E5%87%BD%E6%95%B0%E7%94%A8%E6%9D%A5%E5%B0%86%E4%B8%80%E6%AE%B5DOM%E7%A7%BB%E5%8A%A8%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E4%B8%AD%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20const%20%7B%20move%2C%20createElement%20%7D%20%3D%20instance.keepAliveCtx%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%9B%E5%BB%BA%E9%9A%90%E8%97%8F%E5%AE%B9%E5%99%A8%0A%20%20%20%20%20%20%20%20const%20storageContainer%20%3D%20createElement('div')%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20KeepAlive%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E4%BE%8B%E4%B8%8A%E4%BC%9A%E8%A2%AB%E6%B7%BB%E5%8A%A0%E4%B8%A4%E4%B8%AA%E5%86%85%E9%83%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E5%88%86%E5%88%AB%E6%98%AF_deActivate%E5%92%8C_activate%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%BF%99%E4%B8%A4%E4%B8%AA%E5%87%BD%E6%95%B0%E4%BC%9A%E5%9C%A8%E6%B8%B2%E6%9F%93%E5%99%A8%E4%B8%AD%E8%A2%AB%E8%B0%83%E7%94%A8%0A%20%20%20%20%20%20%20%20instance._deActivate%20%3D%20(vnode)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20move(vnode%2C%20storageContainer)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20instance._activate%20%3D%20(vnode%2C%20container%2C%20anchor)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20move(vnode%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20KeepAlive%E7%9A%84%E9%BB%98%E8%AE%A4%E6%8F%92%E6%A7%BD%E5%B0%B1%E6%98%AF%E8%A6%81%E8%A2%ABKeepAlive%E7%9A%84%E7%BB%84%E4%BB%B6%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20rawVNode%20%3D%20slots.default()%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%98%AF%E7%BB%84%E4%BB%B6%EF%BC%8C%E7%9B%B4%E6%8E%A5%E6%B8%B2%E6%9F%93%E5%8D%B3%E5%8F%AF%EF%BC%8C%E5%9B%A0%E4%B8%BA%E9%9D%9E%E7%BB%84%E4%BB%B6%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E6%97%A0%E6%B3%95%E8%A2%ABKeepAlive%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20rawVNode.type%20!%3D%3D%20'object')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20rawVNode%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E6%8C%82%E8%BD%BD%E6%97%B6%E5%85%88%E8%8E%B7%E5%8F%96%E7%BC%93%E5%AD%98%E7%9A%84%E7%BB%84%E4%BB%B6vnode%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20cachedVNode%20%3D%20cache.get(rawVNode.type)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(cachedVNode)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E6%9C%89%E7%BC%93%E5%AD%98%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E5%88%99%E8%AF%B4%E6%98%8E%E4%B8%8D%E5%BA%94%E8%AF%A5%E6%89%A7%E8%A1%8C%E6%8C%82%E8%BD%BD%EF%BC%8C%E8%80%8C%E5%BA%94%E8%AF%A5%E6%89%A7%E8%A1%8C%E6%BF%80%E6%B4%BB%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E7%BB%A7%E6%89%BF%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20rawVNode.component%20%3D%20cachedVNode.component%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8vnode%E4%B8%8A%E6%B7%BB%E5%8A%A0keptAlive%E5%B1%9E%E6%80%A7%EF%BC%8C%E6%A0%87%E8%AE%B0%E4%B8%BAtrue%EF%BC%8C%E9%81%BF%E5%85%8D%E6%B8%B2%E6%9F%93%E5%99%A8%E9%87%8D%E6%96%B0%E6%8C%82%E8%BD%BD%E5%AE%83%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20rawVNode.keptAlive%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E7%BC%93%E5%AD%98%EF%BC%8C%E5%88%99%E5%B0%86%E5%85%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%BC%93%E5%AD%98%E4%B8%AD%EF%BC%8C%E8%BF%99%E6%A0%B7%E4%B8%8B%E6%AC%A1%E6%BF%80%E6%B4%BB%E7%BB%84%E4%BB%B6%E6%97%B6%E5%B0%B1%E4%B8%8D%E4%BC%9A%E6%89%A7%E8%A1%8C%E6%96%B0%E7%9A%84%E6%8C%82%E8%BD%BD%E5%8A%A8%E4%BD%9C%E4%BA%86%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cache.set(rawVNode.type%2C%20rawVNode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E7%BB%84%E4%BB%B6vnode%E4%B8%8A%E6%B7%BB%E5%8A%A0shouldKeepAlive%E5%B1%9E%E6%80%A7%EF%BC%8C%E5%B9%B6%E6%A0%87%E8%AE%B0%E4%B8%BAtrue%EF%BC%8C%E9%81%BF%E5%85%8D%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9C%9F%E7%9A%84%E5%B0%86%E7%BB%84%E4%BB%B6%E5%8D%B8%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20rawVNode.shouldKeepAlive%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86KeepAlive%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E4%BE%8B%E4%B9%9F%E6%B7%BB%E5%8A%A0%E5%88%B0vnode%E4%B8%8A%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%9C%A8%E6%B8%B2%E6%9F%93%E5%99%A8%E4%B8%AD%E8%AE%BF%E9%97%AE%0A%20%20%20%20%20%20%20%20%20%20%20%20rawVNode.keepAliveInstance%20%3D%20instance%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6vnode%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20rawVNode%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%60%60%60%0A%0A%3E%20%E4%B8%8E%E6%99%AE%E9%80%9A%E7%BB%84%E4%BB%B6%E7%9A%84%E4%B8%80%E4%B8%AA%E8%BE%83%E5%A4%A7%E7%9A%84%E5%8C%BA%E5%88%AB%E5%9C%A8%E4%BA%8E%EF%BC%8CKeepAlive%E7%BB%84%E4%BB%B6%E4%B8%8E%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E7%BB%93%E5%90%88%E9%9D%9E%E5%B8%B8%E6%B7%B1%E3%80%82%0A%3E%20KeepAlive%E7%BB%84%E4%BB%B6%E4%BC%9A%E5%9C%A8%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%E7%9A%84vnode%E7%9A%84%E5%AF%B9%E8%B1%A1%E4%B8%8A%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%BA%9B%E6%A0%87%E8%AE%B0%E5%B1%9E%E6%80%A7%EF%BC%9A%0A%3E%20-%20shouldKeepAlive%3A%20%E5%BD%93%E6%B8%B2%E6%9F%93%E5%99%A8%E5%8D%B8%E8%BD%BD%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%E6%97%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%A3%80%E6%9F%A5%E8%AF%A5%E5%B1%9E%E6%80%A7%E5%BE%97%E7%9F%A5%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%E9%9C%80%E8%A6%81%E8%A2%ABKeepAlive%EF%BC%8C%E5%9B%A0%E6%AD%A4%E8%B0%83%E7%94%A8_deactivate%E5%87%BD%E6%95%B0%0A%3E%20-%20keepAliveInstance%3A%20%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%E7%9A%84vnode%E5%AF%B9%E8%B1%A1%E4%BC%9A%E6%8C%81%E6%9C%89KeepAlive%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%9C%A8unmount%E5%87%BD%E6%95%B0%E4%B8%AD%E4%BC%9A%E9%80%9A%E8%BF%87keepAliveInstance%E6%9D%A5%E8%AE%BF%E9%97%AE_deActivate%E5%87%BD%E6%95%B0%0A%3E%20keptAlive%3A%20%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%E5%A6%82%E6%9E%9C%E5%B7%B2%E7%BB%8F%E8%A2%AB%E7%BC%93%E5%AD%98%E8%BF%87%EF%BC%8C%E8%BF%98%E4%BC%9A%E4%B8%BA%E5%85%B6%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AAkeptAlive%E6%A0%87%E8%AE%B0%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%BD%93%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%E6%97%B6%EF%BC%8C%E6%B8%B2%E6%9F%93%E5%99%A8%E5%B9%B6%E4%B8%8D%E6%88%B7%E9%87%8D%E6%96%B0%E6%8C%82%E8%BD%BD%E5%AE%83%EF%BC%8C%E8%80%8C%E6%98%AF%E8%B0%83%E7%94%A8_activate%E5%87%BD%E6%95%B0%0A%0A%0A%60%60%60js%0Afunction%20patch(n1%2C%20n2%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20if%20(n1%20%26%26%20n1.type%20!%3D%3D%20n2.type)%20%7B%0A%20%20%20%20%20%20%20%20unmount(n1)%0A%20%20%20%20%20%20%20%20n1%20%3D%20null%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20type%20%7D%20%3D%20n2%0A%20%20%20%20%0A%20%20%20%20if%20(typeof%20type%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Text)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Fragment)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(typeof%20type%20%3D%3D%3D%20'object'%20%7C%7C%20typeof%20type%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20object%E6%98%AF%E6%9C%89%E7%8A%B6%E6%80%81%E7%BB%84%E4%BB%B6%EF%BC%8Cfunction%E6%98%AF%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%BB%96%E4%BB%AC%E9%83%BD%E5%8F%AF%E4%BB%A5%E7%94%A8mountComponent%E5%87%BD%E6%95%B0%E6%9D%A5%E5%AE%8C%E6%88%90%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%94%A8patchComponent%E5%87%BD%E6%95%B0%E6%9D%A5%E6%9B%B4%E6%96%B0%0A%20%20%20%20%20%20%20%20if%20(!n1)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(n2.keptAlive)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20n2.keepAliveInstance._activate(n2%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mountComponent(n2%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patchComponent(n1%2C%20n2%2C%20anchor)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%3E%20%E5%A4%B1%E6%B4%BB%E7%9A%84%E6%9C%AC%E8%B4%A8%E6%98%AF%E5%B0%86%E7%BB%84%E4%BB%B6%E6%89%80%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%E7%A7%BB%E5%8A%A8%E5%88%B0%E9%9A%90%E8%97%8F%E5%AE%B9%E5%99%A8%E4%B8%AD%EF%BC%8C%E8%80%8C%E6%BF%80%E6%B4%BB%E7%9A%84%E6%9C%AC%E8%B4%A8%E6%98%AF%E5%B0%86%E7%BB%84%E4%BB%B6%E6%89%80%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%E4%BB%8E%E9%9A%90%E8%97%8F%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%90%AC%E5%9B%9E%E5%8E%9F%E6%9D%A5%E7%9A%84%E5%AE%B9%E5%99%A8%0A%0A%60%60%60js%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20%2F%2F%20....%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20const%20instance%20%3D%20%7B%0A%20%20%20%20%20%20%20%20state%2C%0A%20%20%20%20%20%20%20%20props%3A%20shallowReactive(props)%2C%0A%20%20%20%20%20%20%20%20isMounted%3A%20false%2C%0A%20%20%20%20%20%20%20%20subTree%3A%20null%2C%0A%20%20%20%20%20%20%20%20slots%2C%0A%20%20%20%20%20%20%20%20mounted%3A%20%5B%5D%2C%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%8F%AA%E6%9C%89KeepAlive%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E4%BE%8B%E4%B8%8B%E4%BC%9A%E6%9C%89keepAliveCtx%E5%B1%9E%E6%80%A7%0A%20%20%20%20%20%20%20%20keepAliveCtx%3A%20null%2C%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E6%A3%80%E6%9F%A5%E5%BD%93%E5%89%8D%E8%A6%81%E6%8C%82%E8%BD%BD%E7%9A%84%E7%BB%84%E4%BB%B6%E6%98%AF%E5%90%A6%E6%98%AFKeepAlive%E7%BB%84%E4%BB%B6%0A%20%20%20%20const%20isKeepAlive%20%3D%20vnode.type.__isKeepAlive%0A%20%20%20%20%0A%20%20%20%20if%20(isKeepAlive)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8KeepAlive%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E4%B8%8A%E6%B7%BB%E5%8A%A0KeepAliveCtx%E5%AF%B9%E8%B1%A1%0A%20%20%20%20%20%20%20%20instance.keepAliveCtx%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20move(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20insert(vnode.component.subTree.el%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20createElement%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20....%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%20include%E5%92%8Cexclude%0A%0A%3E%20%E5%9C%A8%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8CKeepAlive%E4%BC%9A%E5%AF%B9%E6%89%80%E6%9C%89%E7%9A%84%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%E8%BF%9B%E8%A1%8C%E7%BC%93%E5%AD%98%E3%80%82%E4%BD%86%E6%9C%89%E6%97%B6%E5%80%99%E7%94%A8%E6%88%B7%E6%9C%9F%E6%9C%9B%E5%8F%AA%E7%BC%93%E5%AD%98%E7%89%B9%E5%AE%9A%E7%BB%84%E4%BB%B6%E3%80%82%0A%3E%20%E4%B8%BA%E4%BA%86%E4%BD%BF%E7%94%A8%E6%88%B7%E8%83%BD%E5%A4%9F%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%93%E5%AD%98%E8%A7%84%E5%88%99%EF%BC%8C%E9%9C%80%E8%A6%81%E8%AE%A9KeepAlive%E7%BB%84%E4%BB%B6%E6%94%AF%E6%8C%81%E4%B8%A4%E4%B8%AAProps%EF%BC%8C%E5%88%86%E5%88%AB%E6%98%AFinclude%E5%92%8Cexclude%0A%3E%20include%E7%94%A8%E6%9D%A5%E6%98%BE%E7%A4%BA%E5%9C%B0%E9%85%8D%E7%BD%AE%E5%BA%94%E8%AF%A5%E8%A2%AB%E7%BC%93%E5%AD%98%E7%9A%84%E7%BB%84%E4%BB%B6%EF%BC%8C%E8%80%8Cexclude%E7%94%A8%E6%9D%A5%E6%98%BE%E7%A4%BA%E5%9C%B0%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BA%94%E8%AF%A5%E8%A2%AB%E7%BC%93%E5%AD%98%E7%9A%84%E7%BB%84%E4%BB%B6%0A%0A%60%60%60js%0Aconst%20KeepAlive%20%3D%20%7B%0A%20%20%20%20__isKeepAlive%3A%20true%2C%0A%20%20%20%20props%3A%20%7B%0A%20%20%20%20%20%20%20%20include%3A%20RegExp%2C%0A%20%20%20%20%20%20%20%20exclude%3A%20RegExp%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20setup(props%2C%20%7B%20slots%20%7D)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20include%E5%92%8Cexclude%E5%8F%AA%E6%8E%A5%E6%94%B6%E6%AD%A3%E5%88%99%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%80%BC%EF%BC%8C%E4%BB%96%E4%BC%9A%E6%A0%B9%E6%8D%AE%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%E7%9A%84%E5%90%8D%E7%A7%B0(name%E5%B1%9E%E6%80%A7)%E8%BF%9B%E8%A1%8C%E5%8C%B9%E9%85%8D%0A%0Aconst%20KeepAlive%20%3D%20%7B%0A%20%20%20%20__isKeepAlive%3A%20true%2C%0A%20%20%20%20props%3A%20%7B%0A%20%20%20%20%20%20%20%20include%3A%20RegExp%2C%0A%20%20%20%20%20%20%20%20exclude%3A%20RegExp%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20setup(props%2C%20%7B%20slots%20%7D)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20rawVNode%20%3D%20slots.default()%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20rawVNode.type%20!%3D%3D%20'object')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20rawVNode%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20name%20%3D%20rawVNode.type.name%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%AF%B9name%E8%BF%9B%E8%A1%8C%E5%8C%B9%E9%85%8D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9Cname%E6%97%A0%E6%B3%95%E8%A2%ABinclude%E5%8C%B9%E9%85%8D%E6%88%96%E8%80%85%E8%83%BD%E8%A2%ABexclude%E5%8C%B9%E9%85%8D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(name%20%26%26%20(props.include%20%26%26%20!props.include.test(name))%20%7C%7C%20(props.exclude%20%26%26%20props.exclude.test(name)))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E7%9B%B4%E6%8E%A5%E6%B8%B2%E6%9F%93%E5%86%85%E9%83%A8%E7%BB%84%E4%BB%B6%EF%BC%8C%E4%B8%8D%E8%BF%9B%E8%A1%8C%E5%90%8E%E7%BB%AD%E6%93%8D%E4%BD%9C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20rawVNode%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%20%E7%BC%93%E5%AD%98%E7%AE%A1%E7%90%86%0A%0A%3E%20%E5%89%8D%E9%9D%A2%E4%BD%BF%E7%94%A8%E4%B8%80%E4%B8%AAmap%E6%9D%A5%E7%AE%A1%E7%90%86%E7%BC%93%E5%AD%98%0A%0A%60%60%60js%0Aconst%20cache%20%3D%20new%20Map()%0A%2F%2F%20%E9%94%AE%E6%98%AF%E7%BB%84%E4%BB%B6%E9%80%89%E9%A1%B9%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%8D%B3vnode.type%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC%EF%BC%8C%E8%80%8C%E8%AF%A5map%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%80%BC%E6%98%AF%E7%94%A8%E4%BA%8E%E6%8F%8F%E8%BF%B0%E7%BB%84%E4%BB%B6%E7%9A%84vnode%E5%AF%B9%E8%B1%A1%E3%80%82%0A%2F%2F%20%E7%94%B1%E4%BA%8E%E7%94%A8%E4%BA%8E%E6%8F%8F%E8%BF%B0%E7%BB%84%E4%BB%B6%E7%9A%84vnode%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%9C%A8%E5%AF%B9%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%BC%95%E7%94%A8(vnode.component)%EF%BC%8C%E6%89%80%E4%BB%A5%E7%BC%93%E5%AD%98%E7%94%A8%E4%BA%8E%E6%8F%8F%E8%BF%B0%E7%BB%84%E4%BB%B6%E7%9A%84Vnode%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B0%B1%E7%AD%89%E4%BB%B7%E4%BA%8E%E7%BC%93%E5%AD%98%E4%BA%86%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%0A%60%60%60%0A%0A%3E%20%E5%A6%82%E6%9E%9C%E7%BC%93%E5%AD%98%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%88%99%E7%BB%A7%E6%89%BF%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%B9%B6%E5%B0%86%E7%94%A8%E4%BA%8E%E6%8F%8F%E8%BF%B0%E7%BB%84%E4%BB%B6%E7%9A%84vnode%E5%AF%B9%E8%B1%A1%E6%A0%87%E8%AE%B0%E4%B8%BAkeptAlive%2C%E8%BF%99%E6%A0%B7%E6%B8%B2%E6%9F%93%E5%99%A8%E5%B0%B1%E4%B8%8D%E4%BC%9A%E9%87%8D%E6%96%B0%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%0A%3E%20%E5%A6%82%E6%9E%9C%E7%BC%93%E5%AD%98%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%88%99%E8%AE%BE%E7%BD%AE%E7%BC%93%E5%AD%98%0A%0A**%E8%BF%99%E9%87%8C%E7%9A%84%E9%97%AE%E9%A2%98%E5%9C%A8%E4%BA%8E%EF%BC%8C%E5%BD%93%E7%BC%93%E5%AD%98%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%80%BB%E6%98%AF%E4%BC%9A%E8%AE%BE%E7%BD%AE%E6%96%B0%E7%9A%84%E7%BC%93%E5%AD%98%E3%80%82%E8%BF%99%E4%BC%9A%E5%AF%BC%E8%87%B4%E7%BC%93%E5%AD%98%E4%B8%8D%E6%96%AD%E5%A2%9E%E5%8A%A0%EF%BC%8C%E5%8D%A0%E7%94%A8%E5%A4%A7%E9%87%8F%E5%86%85%E5%AD%98%E3%80%82%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%8C%E5%BF%85%E9%A1%BB%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AA%E7%BC%93%E5%AD%98%E9%98%88%E5%80%BC%EF%BC%8C%E5%BD%93%E7%BC%93%E5%AD%98%E6%95%B0%E9%87%8F%E8%B6%85%E8%BF%87%E6%8C%87%E5%AE%9A%E9%98%88%E5%80%BC%E6%97%B6%E5%AF%B9%E7%BC%93%E5%AD%98%E8%BF%9B%E8%A1%8C%E4%BF%AE%E5%89%AA**%0A%0A-%20%E8%80%8C%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E4%BF%AE%E5%89%AA%E6%88%90%E4%BA%86%E6%96%B0%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9A%0A%0Avue%E9%87%87%E7%94%A8%E7%9A%84%E4%BF%AE%E5%89%AA%E7%AD%96%E7%95%A5%E5%8F%AB%E5%81%9A%E2%80%9C%E6%9C%80%E6%96%B0%E4%B8%80%E6%AC%A1%E8%AE%BF%E9%97%AE%E2%80%9D%0A%0A%60%60%60html%0A%3CKeepAlive%20%3Amax%3D%222%22%3E%0A%20%20%20%20%3Ccomponent%20%3Ais%3D%22dynamicCom%22%20%2F%3E%0A%3C%2FKeepAlive%3E%0A%0A%3C!--%0A%20%20%20%20%E5%A6%82%E6%9E%9C%E6%9C%89%E4%B8%89%E4%B8%AA%E7%BB%84%E4%BB%B6%EF%BC%8C%E8%80%8C%E7%BC%93%E5%AD%98%E5%AE%B9%E9%87%8F%E4%B8%BA2%0A%20%20%20%201.%E5%88%9D%E5%A7%8B%E6%B8%B2%E6%9F%93Comp1%EF%BC%8C%E6%B7%BB%E5%8A%A0%E7%BC%93%E5%AD%98%EF%BC%8C%E7%BC%93%E5%AD%98%E9%98%9F%E5%88%97%5BComp1%5D%EF%BC%8C%E6%9C%80%E6%96%B0%E4%B8%80%E6%AC%A1%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AFComP1%0A%20%20%20%202.%E5%88%87%E6%8D%A2%E5%88%B0Comp2%EF%BC%8C%E6%B7%BB%E5%8A%A0%E7%BC%93%E5%AD%98%EF%BC%8C%E7%BC%93%E5%AD%98%E9%98%9F%E5%88%97%E4%B8%BA%5BComp1%2C%20Comp2%5D%2C%E6%9C%80%E6%96%B0%E4%B8%80%E6%AC%A1%E8%AE%BF%E9%97%AE%E6%98%AFComp2%0A%20%20%20%203.%E5%88%87%E6%8D%A2%E5%88%B0Comp3%2C%20%E7%BC%93%E5%AD%98%E5%AE%B9%E9%87%8F%E5%B7%B2%E6%BB%A1%EF%BC%8C%E9%9C%80%E8%A6%81%E4%BF%AE%E5%89%AA%EF%BC%8C%E6%9C%80%E6%96%B0%E4%B8%80%E6%AC%A1%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AFComp2%2C%E5%9B%A0%E6%AD%A4Comp1%E8%A2%AB%E4%BF%AE%E5%89%AA%EF%BC%8C%E7%BC%93%E5%AD%98%E9%98%9F%E5%88%97%5BComp2%2C%20Comp3%5D%EF%BC%8C%E6%9C%80%E6%96%B0%E4%B8%80%E6%AC%A1%E8%AE%BF%E9%97%AE%E7%9A%84%E6%98%AFComp3%0A%20%20%20%20%0A--%3E%0A%60%60%60%0A%0A%60vue%E4%B8%BA%E4%BA%86%E7%94%A8%E6%88%B7%E5%8F%AF%E4%BB%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%EF%BC%8C%E6%96%B0%E5%A2%9E%E4%BA%86cache%E6%8E%A5%E5%8F%A3%60%0A%60%60%60html%0A%3CKeepAlive%20%3Acache%3D%22cache%22%3E%0A%20%20%20%20%3CComp%2F%3E%0A%3C%2FKeepAlive%3E%0A%0Aconst%20_cache%20%3D%20new%20Map()%0Aconst%20cache%3A%20KeepAliveCache%20%3D%20%7B%0A%20%20%20%20get(key)%20%7B%0A%20%20%20%20%20%20%20%20_cache.get(key)%0A%20%20%20%20%7D%2C%0A%20%20%20%20set(key%2C%20value)%20%7B%0A%20%20%20%20%20%20%20%20_cache.set(key%2C%20value)%0A%20%20%20%20%7D%2C%0A%20%20%20%20delete(key)%20%7B%0A%20%20%20%20%20%20%20%20_cache.delete(key)%0A%20%20%20%20%7D%2C%0A%20%20%20%20forEach(fn)%20%7B%0A%20%20%20%20%20%20%20%20_cache.forEach(fn)%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%0A%7D%0A%60%60%60%0A%3E%20%E5%9C%A8KeepAlive%E7%BB%84%E4%BB%B6%E7%9A%84%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E4%B8%AD%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%94%A8%E6%88%B7%E6%8F%90%E4%BE%9B%E4%BA%86%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E7%BC%93%E5%AD%98%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%88%99%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E8%AF%A5%E7%BC%93%E5%AD%98%E5%AE%9E%E4%BE%8B%E6%9D%A5%E7%AE%A1%E7%90%86%E7%BC%93%E5%AD%98%E3%80%82%0A%0A%0A%23%23%23%23%20Teleport%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%0A%0A%23%23%23%23%23%20Teleport%E7%BB%84%E4%BB%B6%E8%A6%81%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98%0A%3E%20%E9%80%9A%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E5%9C%A8%E5%B0%86%E8%99%9A%E6%8B%9FDOM%E6%B8%B2%E6%9F%93%E4%B8%BA%E7%9C%9F%E5%AE%9EDOM%E6%97%B6%EF%BC%8C%E6%9C%80%E7%BB%88%E6%B8%B2%E6%9F%93%E5%87%BA%E6%9D%A5%E7%9A%84%E7%9C%9F%E5%AE%9EDOM%E7%9A%84%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84%E4%B8%8E%E8%99%9A%E6%8B%9FDOM%E7%9A%84%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84%E4%B8%80%E8%87%B4%0A%3E%20Teleport%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%B0%86%E6%8C%87%E5%AE%9A%E5%86%85%E5%AE%B9%E6%B8%B2%E6%9F%93%E5%88%B0%E7%89%B9%E5%AE%9A%E5%AE%B9%E5%99%A8%E4%B8%AD%EF%BC%8C%E8%80%8C%E4%B8%8D%E5%8F%97DOM%E5%B1%82%E7%BA%A7%E7%9A%84%E9%99%90%E5%88%B6%0A%0A%60%60%60html%0A%3Ctemplate%3E%0A%20%20%20%20%3CTeleport%20to%3D%22body%22%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20class%3D%22overlay%22%3E%3C%2Fdiv%3E%0A%20%20%20%20%3C%2FTeleport%3E%0A%3C%2Ftemplate%3E%0A%3C!--%20%20%E9%80%9A%E8%BF%87%E4%B8%BATeleport%E7%BB%84%E4%BB%B6%E6%8C%87%E5%AE%9A%E6%B8%B2%E6%9F%93%E7%9B%AE%E6%A0%87body%EF%BC%8C%E5%8D%B3to%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC%EF%BC%8C%E8%AF%A5%E7%BB%84%E4%BB%B6%E5%B0%B1%E4%BC%9A%E7%9B%B4%E6%8E%A5%E6%8A%8A%E5%AE%83%E7%9A%84%E6%8F%92%E6%A7%BD%E5%86%85%E5%AE%B9%E6%B8%B2%E6%9F%93%E5%88%B0body%E4%B8%8B%20--%3E%0A%60%60%60%0A%0A%0A%23%23%23%23%23%20%E5%AE%9E%E7%8E%B0Teleport%E7%BB%84%E4%BB%B6%0A%3E%20%E4%B8%8EKeepAlive%E7%BB%84%E4%BB%B6%E4%B8%80%E6%A0%B7%EF%BC%8CTeleport%E7%BB%84%E4%BB%B6%E4%B9%9F%E9%9C%80%E8%A6%81%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E5%BA%95%E5%B1%82%E6%94%AF%E6%8C%81%E3%80%82%0A%3E%20%E8%A6%81%E5%B0%86Teleport%E7%BB%84%E4%BB%B6%E7%9A%84%E6%B8%B2%E6%9F%93%E9%80%BB%E8%BE%91%E4%BB%8E%E6%B8%B2%E6%9F%93%E5%99%A8%E4%B8%AD%E5%88%86%E7%A6%BB%E5%87%BA%E6%9D%A5%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%81%9A%E7%9A%84%E5%A5%BD%E5%A4%84%E6%98%AF%0A%3E%20-%20%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E6%B8%B2%E6%9F%93%E5%99%A8%E9%80%BB%E8%BE%91%E4%BB%A3%E7%A0%81%E8%86%A8%E8%83%80%0A%3E%20-%20%E5%BD%93%E7%94%A8%E6%88%B7%E6%B2%A1%E6%9C%89%E4%BD%BF%E7%94%A8Teleport%E7%BB%84%E4%BB%B6%E6%97%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8Tree-Shaking%E6%9C%BA%E5%88%B6%E5%88%A0%E9%99%A4%E6%97%A0%E7%94%A8%E7%9A%84Teleport%E4%BB%A3%E7%A0%81%0A%0A%60%60%60js%0Afunction%20patch(n1%2C%20n2%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20if%20(n1%20%26%26%20n1.type%20!%3D%3D%20n2.type)%20%7B%0A%20%20%20%20%20%20%20%20unmount(n1)%3B%0A%20%20%20%20%20%20%20%20n1%20%3D%20null%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20const%20%7B%20type%20%7D%20%3D%20n2%3B%0A%20%20%20%20if%20(typeof%20type%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Text)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20Fragment)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%20else%20if%20(typeof%20type%20%3D%3D%3D%20'object'%20%26%26%20type.__isTeleport)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%BB%84%E4%BB%B6%E4%B8%AD%E5%A6%82%E6%9E%9C%E5%AD%98%E5%9C%A8__isTeleport%E6%A0%87%E8%AF%86%EF%BC%8C%E9%82%A3%E4%B9%88%E5%AE%83%E6%98%AFTeleport%E7%BB%84%E4%BB%B6%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8Teleport%E7%BB%84%E4%BB%B6%E9%80%89%E9%A1%B9%E4%B8%AD%E7%9A%84process%E5%87%BD%E6%95%B0%E5%B0%86%E6%8E%A7%E5%88%B6%E6%9D%83%E4%BA%A4%E6%8E%A5%E5%87%BA%E5%8E%BB%0A%20%20%20%20%20%20%20%20%2F%2F%20%E4%BC%A0%E9%80%92%E7%BB%99process%E5%87%BD%E6%95%B0%E7%9A%84%E7%AC%AC%E4%BA%94%E4%B8%AA%E5%8F%82%E6%95%B0%E6%98%AF%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%0A%20%20%20%20%20%20%20%20type.process(n1%2C%20n2%2C%20container%2C%20anchor%2C%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patch%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20patchChildren%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20unmount%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20move(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20insert(vnode.component%20%3F%20vnode.component.subTree.el%20%3A%20vnode.el%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%7D%20else%20if%20(typeof%20type%20%3D%3D%3D%20'object'%20%7C%7C%20typeof%20type%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%BF%99%E9%87%8C%E8%B0%83%E7%94%A8process%E5%B0%86%E6%B8%B2%E6%9F%93%E6%8E%A7%E5%88%B6%E6%9D%83%E4%BA%A4%E6%8E%A5%E5%87%BA%E5%8E%BB%EF%BC%8C%E8%BF%99%E5%B0%B1%E5%AE%9E%E7%8E%B0%E4%BA%86%E6%B8%B2%E6%9F%93%E9%80%BB%E8%BE%91%E7%9A%84%E5%88%86%E7%A6%BB%0A%0A%2F%2F%20Teleport%E8%AE%BE%E8%AE%A1%E8%99%9A%E6%8B%9FDOM%0A%2F*%0A%3CTeleport%20to%3D%22body%22%3E%0A%20%20%20%20%3Ch1%3Etitle%3C%2Fh1%3E%0A%20%20%20%20%3Cp%3Econtent%3C%2Fp%3E%0A%3C%2FTeleport%3E%0A%E7%9B%B4%E6%8E%A5%E5%B0%86%E5%85%B6%E5%AD%90%E8%8A%82%E7%82%B9%E7%BC%96%E8%AF%91%E4%B8%BA%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%E5%8D%B3%E5%8F%AF%0A%0Afunction%20render()%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20Teleport%2C%0A%20%20%20%20%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20type%3A%20'h1'%2C%20children%3A%20'title'%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20type%3A%20'p'%2C%20children%3A%20'content'%20%7D%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%7D%0A%7D%0A%0A*%2F%0A%0A%0A%2F%2F%20%E5%AE%9E%E7%8E%B0Teleport%E7%BB%84%E4%BB%B6%0Aconst%20Teleport%20%3D%20%7B%0A%20%20%20%20__isTeleport%3A%20true%2C%0A%20%20%20%20process(n1%2C%20n2%2C%20container%2C%20anchor%2C%20internals)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E8%BF%99%E9%87%8C%E5%A4%84%E7%90%86%E6%B8%B2%E6%9F%93%E9%80%BB%E8%BE%91%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%20%E9%80%9A%E8%BF%87internals%E5%8F%82%E6%95%B0%E5%8F%96%E5%BE%97%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E5%86%85%E9%83%A8%E6%96%B9%E6%B3%95%0A%20%20%20%20%20%20%20%20const%20%7B%20patch%2C%20patchChildren%2C%20move%20%7D%20%3D%20internals%0A%20%20%20%20%20%20%20%20if%20(!n1)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20target%20%3D%20typeof%20n2.props.to%20%3D%3D%3D%20'string'%20%3F%20document.querySelector(n2.props.to)%20%3A%20n2.props.to%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20n2.children.forEach(c%20%3D%3E%20patch(null%2C%20c%2C%20target%2C%20anchor))%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%9B%B4%E6%96%B0%0A%20%20%20%20%20%20%20%20%20%20%20%20patchChildren(n1%2C%20n2%2C%20container)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E6%96%B0%E6%97%A7to%E5%8F%82%E6%95%B0%E7%9A%84%E5%80%BC%E4%B8%8D%E5%90%8C%EF%BC%8C%E5%88%99%E9%9C%80%E8%A6%81%E5%AF%B9%E5%86%85%E5%AE%B9%E8%BF%9B%E8%A1%8C%E7%A7%BB%E5%8A%A8%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(n2.props.to%20!%3D%3D%20n1.props.to)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20newTarget%20%3D%20typeof%20n2.props.to%20%3D%3D%3D%20'string'%20%3F%20document.querySelector(n2.props.to)%20%3A%20n2.props.to%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E7%A7%BB%E5%8A%A8%E5%88%B0%E6%96%B0%E5%AE%B9%E5%99%A8%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20n2.children.forEach(c%20%3D%3E%20move(c%2C%20newTarget))%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%0A%23%23%23%23%20Transition%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%0A%0A%3E%20Transition%E7%BB%84%E4%BB%B6%E4%B8%8E%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E7%BB%93%E5%90%88%E6%9B%B4%E5%8A%A0%E7%B4%A7%E5%AF%86%0A%0A%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%EF%BC%9A%0A-%20%E5%BD%93DOM%E5%85%83%E7%B4%A0%E8%A2%AB%E6%8C%82%E8%BD%BD%E6%97%B6%EF%BC%8C%E5%B0%86%E5%8A%A8%E6%95%88%E9%99%84%E5%8A%A0%E5%88%B0%E8%AF%A5DOM%E5%85%83%E7%B4%A0%E4%B8%8A%0A-%20%E5%BD%93DOM%E5%85%83%E7%B4%A0%E8%A2%AB%E5%8D%B8%E8%BD%BD%E6%97%B6%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%AB%8B%E5%8D%B3%E5%8D%B8%E8%BD%BDDOM%E5%85%83%E7%B4%A0%EF%BC%8C%E8%80%8C%E6%98%AF%E7%AD%89%E5%88%B0%E9%99%84%E5%8A%A0%E5%88%B0%E8%AF%A5DOM%E5%85%83%E7%B4%A0%E4%B8%8A%E7%9A%84%E5%8A%A8%E6%95%88%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90%E5%90%8E%E5%86%8D%E5%8D%B8%E8%BD%BD%E5%AE%83%0A%0A%23%23%23%23%23%20%E5%8E%9F%E7%94%9FDOM%E7%9A%84%E8%BF%87%E6%B8%A1%0A%0A%E8%BF%9B%E5%9C%BA%E8%BF%87%E5%BA%A6%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9A%0A%3E%20%E4%BB%8E%E5%88%9B%E5%BB%BADOM%E5%85%83%E7%B4%A0%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E5%88%B0%E6%8A%8ADOM%E5%85%83%E7%B4%A0%E6%B7%BB%E5%8A%A0%E5%88%B0body%E5%89%8D%EF%BC%8C%E6%95%B4%E4%B8%AA%E8%BF%87%E7%A8%8B%E5%8F%AF%E4%BB%A5%E8%A7%86%E4%BD%9CbeforeEnter%E9%98%B6%E6%AE%B5%0A%3E%20%E5%9C%A8%E6%8A%8ADOM%E5%85%83%E7%B4%A0%E6%B7%BB%E5%8A%A0%E5%88%B0body%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%88%99%E5%8F%AF%E4%BB%A5%E8%A7%86%E4%BD%9Center%E9%98%B6%E6%AE%B5%0A%60%60%60css%0A.enter-from%20%7B%0A%20%20%20%20transform%3A%20translateX(200px)%0A%7D%0A.enter-active%20%7B%0A%20%20%20%20transition%3A%20transform%201s%20ease-in-out%3B%0A%7D%0A.enter-to%20%7B%0A%20%20%20%20transform%3A%20translateX(0)%0A%7D%0A%60%60%60%0A%0A-%20beforeEnter%E9%98%B6%E6%AE%B5%EF%BC%8C%E6%B7%BB%E5%8A%A0enter-from%E5%92%8Center-active%E7%B1%BB%0A-%20enter%E9%98%B6%E6%AE%B5%EF%BC%8C%E5%9C%A8%E4%B8%8B%E4%B8%80%E5%B8%A7%E4%B8%AD%E7%A7%BB%E9%99%A4enter-from%E7%B1%BB%EF%BC%8C%E6%B7%BB%E5%8A%A0enter-to%E7%B1%BB%0A-%20%E8%BF%9B%E5%9C%BA%E5%8A%A8%E6%95%88%E7%BB%93%E6%9D%9F%EF%BC%8C%E7%A7%BB%E9%99%A4enter-to%E5%92%8Center-active%E7%B1%BB%0A%0A%E7%A6%BB%E5%9C%BA%E8%BF%87%E5%BA%A6%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9A%0A%0A%60%60%60css%0A.leave-from%20%7B%0A%20%20%20%20transform%3A%20translateX(0)%0A%7D%0A.leave-to%20%7B%0A%20%20%20%20transform%3A%20translateX(200px)%0A%7D%0A.leave-active%20%7B%0A%20%20%20%20transition%3A%20transform%202s%20ease-out%0A%7D%0A%60%60%60%0A%0A%3E%20%E5%BD%93%E5%85%83%E7%B4%A0%E8%A2%AB%E5%8D%B8%E8%BD%BD%E6%97%B6%EF%BC%8C%E4%B8%8D%E8%A6%81%E5%B0%86%E5%85%B6%E7%AB%8B%E5%8D%B3%E5%8D%B8%E8%BD%BD%EF%BC%8C%E8%80%8C%E6%98%AF%E7%AD%89%E5%BE%85%E8%BF%87%E6%B8%A1%E6%95%88%E6%9E%9C%E7%BB%93%E6%9D%9F%E5%90%8E%E5%86%8D%E5%8D%B8%E8%BD%BD%E3%80%82%0A%3E%20%E9%9C%80%E8%A6%81%E6%8A%8A%E7%94%A8%E4%BA%8E%E5%8D%B8%E8%BD%BDDOM%E5%85%83%E7%B4%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E5%B0%81%E8%A3%85%E5%88%B0%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E4%B8%AD%EF%BC%8C%E8%AF%A5%E5%87%BD%E6%95%B0%E4%BC%9A%E7%AD%89%E5%BE%85%E8%BF%87%E6%B8%A1%E6%95%88%E6%9E%9C%E7%BB%93%E6%9D%9F%E5%90%8E%E8%A2%AB%E8%B0%83%E7%94%A8%0A%0A%60%60%60js%0Ael.addEventListener('click'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%2F%2F%20%E5%B0%81%E8%A3%85%E5%8D%B8%E8%BD%BD%E5%87%BD%E6%95%B0%0A%20%20%20%20const%20performRemove%20%3D%20()%20%3D%3E%20el.parentNode.removeChild(el)%0A%20%20%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%E5%88%9D%E5%A7%8B%E7%8A%B6%E6%80%81%0A%20%20%20%20el.classList.add('leave-from')%0A%20%20%20%20el.classList.add('leave-active')%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%BC%BA%E5%88%B6reflow%EF%BC%9A%E4%BD%BF%E5%88%9D%E5%A7%8B%E7%8A%B6%E6%80%81%E7%94%9F%E6%95%88%0A%20%20%20%20document.body.offsetHeight%0A%20%20%20%20%0A%20%20%20%20requestAnimationFrame(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20requestAnimationFrame(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20el.classList.remove('leave-from')%0A%20%20%20%20%20%20%20%20%20%20%20%20el.classList.add('leave-to')%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20el.addEventListener('transitionend'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.remove('leave-to')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.remove('leave-active')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%BF%87%E6%B8%A1%E5%AE%8C%E5%90%8E%EF%BC%8C%E8%B0%83%E7%94%A8%E7%A7%BB%E9%99%A4%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20performRemove()%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%7D)%0A%7D)%0A%60%60%60%0A%0A%23%23%23%23%23%20%E5%AE%9E%E7%8E%B0Transition%E7%BB%84%E4%BB%B6%0A%0A%60%60%60js%0A%2F%2F%20Transition%E7%BB%84%E4%BB%B6%E5%9C%A8%E8%99%9A%E6%8B%9FDOM%E5%B1%82%E9%9D%A2%E7%9A%84%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F%0A%2F*%0A%3Ctemplate%3E%0A%20%20%20%20%3CTransition%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%3E%E8%BF%87%E6%B8%A1%E5%85%83%E7%B4%A0%3C%2Fdiv%3E%0A%20%20%20%20%3C%2FTransition%3E%0A%3C%2Ftemplate%3E%0A%0A%E7%BC%96%E8%AF%91%E5%90%8E%EF%BC%9A%0Afunction%20render()%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20Transition%2C%0A%20%20%20%20%20%20%20%20children%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20default()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%20type%3A%20'div'%2C%20children%3A%20'%E8%BF%87%E6%B8%A1%E5%85%83%E7%B4%A0'%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0ATransition%E7%BB%84%E4%BB%B6%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E8%A2%AB%E7%BC%96%E8%AF%91%E4%B8%BA%E9%BB%98%E8%AE%A4%E6%8F%92%E6%A7%BD%EF%BC%8C%E8%BF%99%E4%B8%8E%E6%99%AE%E9%80%9A%E7%BB%84%E4%BB%B6%E7%9A%84%E8%A1%8C%E4%B8%BA%E4%B8%80%E8%87%B4%0A*%2F%0A%0A%0A%2F%2F%20%E5%AE%9E%E7%8E%B0Transition%0A%2F%2F%20%E4%B8%BB%E8%A6%81%E4%BD%9C%E7%94%A8%E6%98%AF%E5%9C%A8%E8%BF%87%E6%B8%A1%E5%85%83%E7%B4%A0%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E4%B8%8A%E6%B7%BB%E5%8A%A0transition%E7%9B%B8%E5%85%B3%E7%9A%84%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%0Aconst%20Transition%20%3D%20%7B%0A%20%20%20%20name%3A%20'Transition'%2C%0A%20%20%20%20setup(props%2C%20%7B%20slots%20%7D)%20%7B%0A%20%20%20%20%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20innerVNode%20%3D%20slots.default()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20innerVNode.transition%20%3D%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20beforeEnter(el)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%9D%E5%A7%8B%E7%8A%B6%E6%80%81%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.add('enter-from')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.add('enter-active')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20enter(el)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%9C%A8%E4%B8%8B%E4%B8%80%E5%B8%A7%E5%88%87%E6%8D%A2%E5%88%B0%E7%BB%93%E6%9D%9F%E7%8A%B6%E6%80%81%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20nextFrame(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.remove('enter-from')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.add('enter-to')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.addEventListener('transitionend'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.remove('enter-to')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.remove('enter-active')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20leave(el%2C%20performRemove)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%E7%A6%BB%E5%9C%BA%E8%BF%87%E5%BA%A6%E7%9A%84%E5%88%9D%E5%A7%8B%E7%8A%B6%E6%80%81%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.add('leave-from')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.add('leave-active')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%BC%BA%E5%88%B6reflow%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20document.body.offsetHeight%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20nextFrame(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.remove('leave-from')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.add('leave-to')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.addEventListener('transitionend'%2C%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.remove('leave-to')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20el.classList.remove('leave-active')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20performRemove()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20innerVNode%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E6%B8%B2%E6%9F%93%E5%99%A8%E5%9C%A8%E6%B8%B2%E6%9F%93%E9%9C%80%E8%A6%81%E8%BF%87%E6%B8%A1%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%9C%A8%E5%90%88%E9%80%82%E7%9A%84%E6%97%B6%E6%9C%BA%E8%B0%83%E7%94%A8%E9%99%84%E5%8A%A0%E5%88%B0%E8%AF%A5%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E4%B8%8A%E7%9A%84%E8%BF%87%E6%B8%A1%E7%9B%B8%E5%85%B3%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%EF%BC%8C%E5%85%B7%E4%BD%93%E4%BD%93%E7%8E%B0%E5%9C%A8mountElement%E5%87%BD%E6%95%B0%E4%BB%A5%E5%8F%8Aunmount%E5%87%BD%E6%95%B0%E4%B8%AD%0Afunction%20mountElement(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20const%20el%20%3D%20vnode.el%20%3D%20createElement(vnode.type)%0A%20%20%20%20%0A%20%20%20%20if%20(typeof%20vnode.children%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20setElementText(el%2C%20vnode.children)%0A%20%20%20%20%7D%20else%20if%20(Array.isArray(vnode.children))%20%7B%0A%20%20%20%20%20%20%20%20vnode.children.forEach(child%20%3D%3E%20patch(null%2C%20child%2C%20el))%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(vnode.props)%20%7B%0A%20%20%20%20%20%20%20%20for(const%20key%20in%20vnode.props)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patchProps(el%2C%20key%2C%20null%2C%20vnode.props%5Bkey%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%88%A4%E6%96%ADVNode%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E8%BF%87%E6%B8%A1%0A%20%20%20%20const%20needTransition%20%3D%20vnode.transition%0A%20%20%20%20if%20(needTransition)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8transition.beforeEnter%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20vnode.transition.beforeEnter(el)%0A%20%20%20%20%7D%0A%20%20%20%20insert(el%2C%20container%2C%20anchor)%0A%20%20%20%20if%20(needTransition)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8transition.enter%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20vnode.transition.enter(el)%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20unmount(vnode)%20%7B%0A%20%20%20%20%2F%2F%20%E5%88%A4%E6%96%ADVNode%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E8%BF%87%E6%B8%A1%0A%20%20%20%20const%20needTransition%20%3D%20vnode.transition%0A%20%20%20%20if%20(vnode.type%20%3D%3D%3D%20Fragment)%20%7B%0A%20%20%20%20%20%20%20%20vnode.children.forEach(c%20%3D%3E%20unmount(c))%0A%20%20%20%20%20%20%20%20return%0A%20%20%20%20%7D%20else%20if%20(typeof%20vnode.type%20%3D%3D%3D%20'object')%20%7B%0A%20%20%20%20%20%20%20%20if%20(vnode.shouldKeepAlive)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20vnode.keepAliveInstance._deActivate(vnode)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20unmount(vnode.component.subTree)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20return%0A%20%20%20%20%7D%0A%20%20%20%20const%20parent%20%3D%20vnode.el.parentNode%0A%20%20%20%20if%20(parent)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%81%E8%A3%85%E5%8D%B8%E8%BD%BD%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20const%20performRemove%20%3D%20()%20%3D%3E%20parent.removeChild(vnode.el)%0A%20%20%20%20%20%20%20%20if%20(needTransition)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20vnode.transition.leave(vnode.el%2C%20performRemove)%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20performRemove()%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E6%80%BB%E7%BB%93%0A-%20KeepAlive%E7%BB%84%E4%BB%B6%0A-%20Teleport%E7%BB%84%E4%BB%B6%0A-%20Transition%E7%BB%84%E4%BB%B6%0A%0A%0A%23%23%20%E7%AC%AC%E4%BA%94%E7%AF%87%E3%80%8A%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B%0A%0A%23%23%23%20%E7%AC%AC15%E7%AB%A0%E3%80%8A%E7%BC%96%E8%AF%91%E5%99%A8%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88%E3%80%8B%0A%0A%23%23%23%23%20%E6%A8%A1%E7%89%88DSL%E7%9A%84%E7%BC%96%E8%AF%91%E5%99%A8%0A%3E%20%E7%BC%96%E8%AF%91%E5%99%A8%E5%85%B6%E5%AE%9E%E5%8F%AA%E6%98%AF%E4%B8%80%E6%AE%B5%E7%A8%8B%E5%BA%8F%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%B0%86%E2%80%9C%E4%B8%80%E7%A7%8D%E8%AF%AD%E8%A8%80A%E2%80%9D%E7%BF%BB%E8%AF%91%E6%88%90%E2%80%9C%E5%8F%A6%E5%A4%96%E4%B8%80%E7%A7%8D%E8%AF%AD%E8%A8%80B%E2%80%9D%0A%3E%20%E8%AF%AD%E8%A8%80A%E9%80%9A%E5%B8%B8%E5%8F%AB%E5%81%9A**%E6%BA%90%E4%BB%A3%E7%A0%81**%EF%BC%8C%E8%AF%AD%E8%A8%80B%E9%80%9A%E5%B8%B8%E5%8F%AB%E5%81%9A**%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81**%0A%3E%20%E7%BC%96%E8%AF%91%E5%99%A8%E5%B0%86%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BF%BB%E8%AF%91%E4%B8%BA%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%9A%84%E8%BF%87%E7%A8%8B%E5%8F%AB%E5%81%9A**%E7%BC%96%E8%AF%91**%0A%3E%20%E5%AE%8C%E6%95%B4%E7%9A%84%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E9%80%9A%E5%B8%B8%E5%8C%85%E5%90%AB%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E3%80%81%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E3%80%81%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90%E3%80%81%E4%B8%AD%E9%97%B4%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E3%80%81%E4%BC%98%E5%8C%96%E3%80%81%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E7%AD%89%E6%AD%A5%E9%AA%A4%0A%0A%E6%95%B4%E4%B8%AA%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E5%88%86%E4%B8%BA%E7%BC%96%E8%AF%91%E5%89%8D%E7%AB%AF%E5%92%8C%E7%BC%96%E8%AF%91%E5%90%8E%E7%AB%AF%EF%BC%8C%E7%BC%96%E8%AF%91%E5%89%8D%E7%AB%AF%E5%8C%85%E5%90%AB%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E3%80%81%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E5%92%8C%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90%EF%BC%8C%E5%AE%83%E9%80%9A%E5%B8%B8%E4%B8%8E%E7%9B%AE%E6%A0%87%E5%B9%B3%E5%8F%B0%E6%97%A0%E5%85%B3%EF%BC%8C%E4%BB%85%E8%B4%9F%E8%B4%A3%E5%88%86%E6%9E%90%E6%BA%90%E4%BB%A3%E7%A0%81%E3%80%82%E7%BC%96%E8%AF%91%E5%90%8E%E7%AB%AF%E5%88%99%E9%80%9A%E5%B8%B8%E4%B8%8E%E7%9B%AE%E6%A0%87%E5%B9%B3%E5%8F%B0%E6%9C%89%E5%85%B3%EF%BC%8C%E7%BC%96%E8%AF%91%E5%90%8E%E7%AB%AF%E6%B6%89%E5%8F%8A%E4%B8%AD%E9%97%B4%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%92%8C%E4%BC%98%E5%8C%96%E4%BB%A5%E5%8F%8A%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E3%80%82%E4%BD%86%E6%98%AF%E7%BC%96%E8%AF%91%E5%90%8E%E7%AB%AF%E5%B9%B6%E4%B8%8D%E4%B8%80%E5%AE%9A%E4%BC%9A%E5%8C%85%E5%90%AB%E4%B8%AD%E9%97%B4%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%92%8C%E4%BC%98%E5%8C%96%EF%BC%8C%E8%BF%99%E5%8F%96%E5%86%B3%E4%BA%8E%E5%85%B7%E4%BD%93%E7%9A%84%E5%9C%BA%E6%99%AF%E5%92%8C%E5%AE%9E%E7%8E%B0%0A%0AVue%E7%9A%84%E6%A8%A1%E7%89%88%E4%BD%9C%E4%B8%BADSL(%E9%A2%86%E5%9F%9F%E7%89%B9%E5%AE%9A%E8%AF%AD%E8%A8%80)%EF%BC%8C%E5%85%B6%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E4%BC%9A%E6%9C%89%E6%89%80%E4%B8%8D%E5%90%8C%E3%80%82%E5%AF%B9%E4%BA%8EVue%E6%9D%A5%E8%AF%B4%EF%BC%8C%E6%BA%90%E4%BB%A3%E7%A0%81%E5%B0%B1%E6%98%AF%E7%BB%84%E4%BB%B6%E7%9A%84%E6%A8%A1%E7%89%88%EF%BC%8C%E8%80%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E6%98%AF%E8%83%BD%E5%A4%9F%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B9%B3%E5%8F%B0%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%9A%84JavaScript%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%88%96%E5%85%B6%E4%BB%96%E6%8B%A5%E6%9C%89JavaScript%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%E5%B9%B3%E5%8F%B0%E4%BB%A3%E7%A0%81%E3%80%82%0A%0AVue%E6%A8%A1%E7%89%88%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%EF%BC%9A%0AVue%E6%A8%A1%E7%89%88%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%9A%E9%A6%96%E5%85%88%E5%AF%B9%E6%A8%A1%E7%89%88%E8%BF%9B%E8%A1%8C%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%92%8C%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%EF%BC%8C%E5%BE%97%E5%88%B0%E6%A8%A1%E7%89%88AST%E3%80%82%E6%8E%A5%E7%9D%80%E5%B0%86%E6%A8%A1%E7%89%88AST%E8%BD%AC%E6%8D%A2%E6%88%90JavaScript%20AST%E3%80%82%E6%9C%80%E5%90%8E%E6%A0%B9%E6%8D%AEJavaScript%20AST%E7%94%9F%E6%88%90JavaScript%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%8D%B3%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E4%BB%A3%E7%A0%81%0A%0A%60%60%60js%0A%2F*%0A%3Cdiv%3E%0A%20%20%20%20%3Ch1%20v-if%3D%22ok%22%3EVue%20Template%3C%2Fh1%3E%0A%3C%2Fdiv%3E%0A*%2F%0A%2F%2F%20%E4%BC%9A%E8%A2%AB%E7%BC%96%E8%AF%91%E4%B8%BA%E5%A6%82%E4%B8%8BAST%0Aconst%20ast%20%3D%20%7B%0A%20%20%20%20%2F%2F%20%E9%80%BB%E8%BE%91%E6%A0%B9%E8%8A%82%E7%82%B9%0A%20%20%20%20type%3A%20'Root'%2C%0A%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%2F%2F%20div%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'Element'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20h1%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'Element'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tag%3A%20'h1'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20props%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'Directive'%2C%20%2F%2F%20%E7%B1%BB%E5%9E%8B%E4%B8%BADirective%E8%A1%A8%E7%A4%BA%E6%8C%87%E4%BB%A4%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3A%20'if'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20exp%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'Expression'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20content%3A%20'ok'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%5D%0A%7D%0A%0A%2F%2F%20%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0AST%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E5%85%B7%E6%9C%89%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84%E7%9A%84%E5%AF%B9%E8%B1%A1%E3%80%82%E6%A8%A1%E7%89%88AST%E5%85%B7%E6%9C%89%E4%B8%8E%E6%A8%A1%E7%89%88%E5%90%8C%E6%9E%84%E7%9A%84%E5%B5%8C%E5%A5%97%E7%BB%93%E6%9E%84%E3%80%82%E6%AF%8F%E4%B8%80%E6%A3%B5AST%E9%83%BD%E6%9C%89%E4%B8%80%E4%B8%AA%E9%80%BB%E8%BE%91%E4%B8%8A%E7%9A%84%E8%B7%9F%E8%8A%82%E7%82%B9%EF%BC%8C%E5%85%B6%E7%B1%BB%E5%9E%8B%E4%B8%BARoot%E3%80%82%E6%A8%A1%E7%89%88%E4%B8%AD%E7%9C%9F%E6%AD%A3%E7%9A%84%E6%A0%B9%E8%8A%82%E7%82%B9%E5%88%99%E4%BD%9C%E4%B8%BARoot%E8%8A%82%E7%82%B9%E7%9A%84children%E5%AD%98%E5%9C%A8%0A%0A%0A%2F%2F%20%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%B0%81%E8%A3%85parse%E5%87%BD%E6%95%B0%E6%9D%A5%E5%AE%8C%E6%88%90%E5%AF%B9%E6%A8%A1%E7%89%88%E7%9A%84%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%92%8C%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%0Aconst%20template%20%3D%20%60%0A%20%20%20%20%3Cdiv%3E%0A%20%20%20%20%20%20%20%20%3Ch1%20v-if%3D%22ok%22%3EVue%20Template%3C%2Fh1%3E%0A%20%20%20%20%3C%2Fdiv%3E%0A%60%0Aconst%20templateAST%20%3D%20parse(template)%0A%0A%2F%2F%20%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%B0%81%E8%A3%85transform%E5%87%BD%E6%95%B0%E6%9D%A5%E5%AE%8C%E6%88%90%E6%A8%A1%E7%89%88AST%E5%88%B0JavaScript%20AST%E7%9A%84%E8%BD%AC%E6%8D%A2%E5%B7%A5%E4%BD%9C%0A%0Aconst%20jsAST%20%3D%20transform(templateAST)%0A%0A%2F%2F%20%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E5%B0%81%E8%A3%85generate%E5%87%BD%E6%95%B0%E6%9D%A5%E5%AE%8C%E6%88%90JavaScript%20AST%E5%88%B0JavaScript%E4%BB%A3%E7%A0%81%E7%9A%84%E8%BD%AC%E6%8D%A2%0Aconst%20code%20%3D%20generate(jsAST)%20%2F%2F%20%E8%BF%94%E5%9B%9E%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%BD%A2%E5%BC%8F%E7%9A%84%E4%BB%A3%E7%A0%81%0A%60%60%60%0A%0A%0A%23%23%23%23%20parser%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B8%8E%E7%8A%B6%E6%80%81%E6%9C%BA%0A%3E%20%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E8%87%AA%E5%8A%A8%E6%9C%BA%EF%BC%9A%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%98%AF%E6%8C%87%E6%9C%89%E9%99%90%E4%B8%AA%E7%8A%B6%E6%80%81%EF%BC%8C%E8%80%8C%E8%87%AA%E5%8A%A8%E6%9C%BA%E6%84%8F%E5%91%B3%E7%9D%80%E9%9A%8F%E7%9D%80%E5%AD%97%E7%AC%A6%E7%9A%84%E8%BE%93%E5%85%A5%EF%BC%8C%E8%A7%A3%E6%9E%90%E5%99%A8%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%9C%B0%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%8A%B6%E6%80%81%E9%97%B4%E8%BF%81%E7%A7%BB%0A%0A%60%60%60js%0A%2F%2F%20%E5%AE%9A%E4%B9%89%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E7%8A%B6%E6%80%81%0Aconst%20State%20%3D%20%7B%0A%20%20%20%20initial%3A%201%2C%20%2F%2F%20%E5%88%9D%E5%A7%8B%E7%8A%B6%E6%80%81%0A%20%20%20%20tagOpen%3A%202%2C%20%2F%2F%20%E6%A0%87%E7%AD%BE%E5%BC%80%E5%A7%8B%E7%8A%B6%E6%80%81%0A%20%20%20%20tagName%3A%203%2C%20%2F%2F%20%E6%A0%87%E7%AD%BE%E5%90%8D%E7%A7%B0%E7%8A%B6%E6%80%81%0A%20%20%20%20text%3A%204%2C%20%2F%2F%20%E6%96%87%E6%9C%AC%E7%8A%B6%E6%80%81%0A%20%20%20%20tagEnd%3A%205%2C%20%2F%2F%20%E7%BB%93%E6%9D%9F%E6%A0%87%E7%AD%BE%E7%8A%B6%E6%80%81%0A%20%20%20%20tagEndName%3A%206%2C%20%2F%2F%20%E7%BB%93%E6%9D%9F%E6%A0%87%E7%AD%BE%E5%90%8D%E7%A7%B0%E7%8A%B6%E6%80%81%0A%7D%0A%60%60%60%0A%0A%E6%80%BB%E8%80%8C%E8%A8%80%E4%B9%8B%EF%BC%8C%E9%80%9A%E8%BF%87%E6%9C%89%E9%99%90%E8%87%AA%E5%8A%A8%E6%9C%BA%EF%BC%8C%E8%83%BD%E5%A4%9F%E5%B0%86%E6%A8%A1%E7%89%88%E8%A7%A3%E6%9E%90%E4%B8%BA%E4%B8%80%E4%B8%AA%E4%B8%AAToken%EF%BC%8C%E8%BF%9B%E8%80%8C%E5%8F%AF%E4%BB%A5%E7%94%A8%E4%BB%96%E4%BB%AC%E6%9E%84%E5%BB%BA%E4%B8%80%E6%A3%B5AST%E3%80%82%0A%0A%23%23%23%23%20%E6%9E%84%E9%80%A0AST%0A%3E%20GPL%E9%80%9A%E7%94%A8%E7%94%A8%E9%80%94%E8%AF%AD%E8%A8%80(js%2Cc%2C...)%0A%3E%20DSL%E7%89%B9%E5%AE%9A%E9%A2%86%E5%9F%9F%E8%AF%AD%E8%A8%80(vue%20template%20...)%0A%0A%3E%20%E9%A6%96%E5%85%88%E4%BD%BF%E7%94%A8%E4%B9%8B%E5%89%8D%E7%9A%84tokenize%E5%87%BD%E6%95%B0%E5%B0%86%E6%A8%A1%E7%89%88%E8%BF%9B%E8%A1%8C%E6%A0%87%E8%AE%B0%E5%8C%96%0A%0A%60%60%60js%0Aconst%20tokens%20%3D%20tokenize(%60%3Cdiv%3E%3Cp%3EVue%3C%2Fp%3E%3Cp%3ETemplate%3C%2Fp%3E%3C%2Fdiv%3E%60)%0A%0A%2F*%0Atokens%20%3D%20%5B%0A%20%20%20%20%7B%20type%3A%20'tag'%2C%20name%3A%20'div'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'tag'%2C%20name%3A%20'p'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'text'%2C%20content%3A%20'Vue'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'tagEnd'%2C%20name%3A%20'p'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'tag'%2C%20name%3A%20'p'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'text'%2C%20content%3A%20'Template'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'tagEnd'%2C%20name%3A%20'p'%20%7D%2C%0A%20%20%20%20%7B%20type%3A%20'tagEnd'%2C%20name%3A%20'div'%20%7D%2C%0A%5D%0A*%2F%0A%0A%0A%2F%2F%20%E6%89%AB%E6%8F%8Ftoken%E5%88%97%E8%A1%A8%E5%B9%B6%E6%9E%84%E5%BB%BAAST%0Afunction%20parse(str)%20%7B%0A%20%20%20%20%2F%2F%20%E9%A6%96%E5%85%88%E5%AF%B9%E6%A8%A1%E7%89%88%E6%A0%87%E8%AE%B0%E5%8C%96%EF%BC%8C%E5%BE%97%E5%88%B0tokens%0A%20%20%20%20const%20tokens%20%3D%20tokenize(str)%0A%20%20%20%20%2F%2F%20%E5%88%9B%E5%BB%BARoot%E6%A0%B9%E8%8A%82%E7%82%B9%0A%20%20%20%20const%20root%20%3D%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20'Root'%2C%0A%20%20%20%20%20%20%20%20children%3A%20%5B%5D%2C%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20%E5%88%9B%E5%BB%BAelementStack%E6%A0%88%EF%BC%8C%E8%B5%B7%E5%88%9D%E5%8F%AA%E6%9C%89Root%E6%A0%B9%E8%8A%82%E7%82%B9%0A%20%20%20%20const%20elementStack%20%3D%20%5Broot%5D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%BC%80%E5%90%AFwhile%E5%BE%AA%E7%8E%AF%E6%89%AB%E6%8F%8Ftokens%0A%20%20%20%20while(tokens.length)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E6%A0%88%E9%A1%B6%E8%8A%82%E7%82%B9%E4%BD%9C%E4%B8%BA%E7%88%B6%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20const%20parent%20%3D%20elementStack%5BelementStack.length%20-%201%5D%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%BD%93%E5%89%8D%E6%89%AB%E6%8F%8F%E7%9A%84token%0A%20%20%20%20%20%20%20%20const%20t%20%3D%20tokens%5B0%5D%0A%20%20%20%20%20%20%20%20switch(t.type)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20case%20'tag'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8DToken%E6%98%AF%E5%BC%80%E5%A7%8B%E6%A0%87%E7%AD%BE%EF%BC%8C%E5%88%99%E5%88%9B%E5%BB%BAElement%E7%B1%BB%E5%9E%8B%E7%9A%84AST%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20elementNode%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'Element'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tag%3A%20t.name%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20children%3A%20%5B%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86%E5%85%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%88%B6%E7%BA%A7%E8%8A%82%E7%82%B9%E7%9A%84children%E4%B8%AD%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parent.children.push(elementNode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E5%8E%8B%E5%85%A5%E6%A0%88%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elementStack.push(elementNode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20case%20'text'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20const%20textNode%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'Text'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20content%3A%20t.content%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parent.children.push(textNode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20case%20'tagEnd'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elementStack.pop()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%B6%88%E8%B4%B9%E5%B7%B2%E7%BB%8F%E6%89%AB%E6%8F%8F%E8%BF%87%E7%9A%84token%0A%20%20%20%20%20%20%20%20tokens.shift()%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20%E8%BF%94%E5%9B%9EAST%0A%20%20%20%20return%20root%0A%7D%0A%0A%2F%2F%20%E9%97%AE%E9%A2%98%EF%BC%9A%0A%2F%2F%20%E8%BF%98%E4%B8%8D%E8%83%BD%E5%A4%84%E7%90%86%E8%87%AA%E9%97%AD%E5%92%8C%E6%A0%87%E7%AD%BE%E7%AD%89%0A%60%60%60%0A%0A%23%23%23%23%20AST%E7%9A%84%E8%BD%AC%E6%8D%A2%E4%B8%8E%E6%8F%92%E4%BB%B6%E5%8C%96%E6%9E%B6%E6%9E%84%0A%3E%20AST%E7%9A%84%E8%BD%AC%E6%8D%A2%EF%BC%8C%E6%8C%87%E7%9A%84%E6%98%AF%E5%AF%B9AST%E8%BF%9B%E8%A1%8C%E4%B8%80%E7%B3%BB%E5%88%97%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%B0%86%E5%85%B6%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%96%B0%E7%9A%84AST%E7%9A%84%E8%BF%87%E7%A8%8B%0A%3E%20%E6%96%B0%E7%9A%84AST%E5%8F%AF%E4%BB%A5%E6%98%AF%E5%8E%9F%E8%AF%AD%E8%A8%80%E6%88%96%E5%8E%9FDSL%E7%9A%84%E6%8F%8F%E8%BF%B0%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%98%AF%E5%85%B6%E4%BB%96%E8%AF%AD%E8%A8%80%E6%88%96%E5%85%B6%E4%BB%96DSL%E7%9A%84%E6%8F%8F%E8%BF%B0%0A%0A%E7%94%B1%E4%BA%8EAST%E6%98%AF%E6%A0%91%E5%9E%8B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C%E6%89%80%E4%BB%A5%E9%9C%80%E8%A6%81%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E9%81%8D%E5%8E%86%E7%9A%84%E7%AE%97%E6%B3%95%0A%0A%60%60%60js%0Afunction%20traverseNode(ast%2C%20context)%20%7B%0A%20%20%20%20%2F%2F%20%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%EF%BC%8Cast%E6%9C%AC%E8%BA%AB%E5%B0%B1%E6%98%AFRoot%E8%8A%82%E7%82%B9%0A%20%20%20%20const%20currentNode%20%3D%20ast%0A%20%20%20%20%0A%20%20%20%20const%20transform%20%3D%20context.nodeTransforms%0A%20%20%20%20for(let%20i%20%3D%200%3B%20i%20%3C%20transform.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9currentNode%E5%92%8Ccontext%E9%83%BD%E4%BC%A0%E9%80%92%E7%BB%99nodeTransforms%E4%B8%AD%E6%B3%A8%E5%86%8C%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20transform%5Bi%5D(currentNode%2C%20context)%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E6%9C%89%E5%AD%90%E8%8A%82%E7%82%B9%EF%BC%8C%E5%88%99%E9%80%92%E5%BD%92%E5%9C%B0%E8%B0%83%E7%94%A8traverseNode%0A%20%20%20%20const%20children%20%3D%20currentNode.children%0A%20%20%20%20if%20(children)%20%7B%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%200%3B%20i%20%3C%20children.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20traverseNode(children%5Bi%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%0Afunction%20transformElement(node)%20%7B%0A%20%20%20%20const%20context%20%3D%20%7B%0A%20%20%20%20%20%20%20%20nodeTransforms%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20transformElement%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20transformText%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20traverseNode(ast%2C%20context)%0A%7D%0A%0Afunction%20transformElement(node)%20%7B%0A%20%20%20%20%2F%2F%20...%0A%7D%0Afunction%20transformText(node)%20%7B%0A%20%20%20%20%2F%2F%20...%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E5%B0%86%E6%A8%A1%E7%89%88AST%E8%BD%AC%E4%B8%BAJavaScript%20AST%0A%60%60%60js%0A%3Cdiv%3E%3Cp%3EVue%3C%2Fp%3E%3Cp%3ETemplate%3E%3C%2Fp%3E%3C%2Fdiv%3E%0A%0A%2F%2F%20%E7%9B%AE%E6%A0%87%0Afunction%20render()%20%7B%0A%20%20%20%20return%20h('div'%2C%20%5B%0A%20%20%20%20%20%20%20%20h('p'%2C%20'Vue')%2C%0A%20%20%20%20%20%20%20%20h('p'%2C%20'Tempalte')%2C%0A%20%20%20%20%5D)%0A%7D%0A%0A%2F%2F%20%E8%AE%BE%E8%AE%A1%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%9D%A5%E6%8F%8F%E8%BF%B0%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E%E8%AF%AD%E5%8F%A5%0Aconst%20FunctionDeclNode%20%3D%20%7B%0A%20%20%20%20type%3A%20'FunctionDecl'%2C%20%2F%2F%20%E4%BB%A3%E8%A1%A8%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E%0A%20%20%20%20id%3A%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20'Identifier'%2C%0A%20%20%20%20%20%20%20%20name%3A%20'render'%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20params%3A%20%5B%5D%2C%20%2F%2F%20%E5%8F%82%E6%95%B0%0A%20%20%20%20body%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'ReturnStatement'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20return%3A%20null%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%5D%0A%7D%0A%0A%2F%2F%20%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%0Aconst%20CallExp%20%3D%20%7B%0A%20%20%20%20type%3A%20'CallExpression'%2C%0A%20%20%20%20%2F%2F%20%E8%A2%AB%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E5%90%8D%E7%A7%B0%0A%20%20%20%20callee%3A%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20'Identifier'%2C%0A%20%20%20%20%20%20%20%20name%3A%20'h'%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20arguments%3A%20%5B%5D%2C%0A%7D%0A%0A%2F%2F%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E9%9D%A2%E9%87%8F%0Aconst%20Str%20%3D%20%7B%0A%20%20%20%20type%3A%20'StringLiteral'%2C%0A%20%20%20%20value%3A%20'div'%2C%0A%7D%0A%0A%2F%2F%20%E6%95%B0%E7%BB%84%0Aconst%20Arr%20%3D%20%7B%0A%20%20%20%20type%3A%20'ArrayExpression'%2C%0A%20%20%20%20elements%3A%20%5B%5D%2C%0A%7D%0A%0A%2F%2F%20%E6%9C%80%E7%BB%88JavaScript%20AST%0Aconst%20FunctionDeclNode%20%3D%20%7B%0A%20%20%20%20type%3A%20'FunctionDecl'%2C%20%2F%2F%20%E4%BB%A3%E8%A1%A8%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E%0A%20%20%20%20id%3A%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20'Identifier'%2C%0A%20%20%20%20%20%20%20%20name%3A%20'render'%2C%0A%20%20%20%20%7D%2C%0A%20%20%20%20params%3A%20%5B%5D%2C%20%2F%2F%20%E5%8F%82%E6%95%B0%0A%20%20%20%20body%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'ReturnStatement'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20return%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'CallExpression'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20callee%3A%20%7B%20type%3A%20'Identifier'%2C%20name%3A%20'h'%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arguments%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'StringLiteral'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value%3A%20'div'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'ArrayExpression'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elements%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'CallExpression'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20callee%3A%20%7B%20type%3A%20'Identifier'%2C%20name%3A%20'h'%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arguments%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7Btype%3A%20'StringLiteral'%2C%20value%3A%20'p'%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7Btype%3A%20'StringLiteral'%2C%20value%3A%20'Vue'%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'CallExpression'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20callee%3A%20%7B%20type%3A%20'Identifier'%2C%20name%3A%20'h'%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arguments%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%20type%3A%20'StringLiteral'%2C%20value%3A%20'p'%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%20type%3A%20'StringLiteral'%2C%20value%3A%20'Template'%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%5D%0A%7D%0A%0A%0A%2F%2F%20%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0%0A%2F%2F%20%E7%94%A8%E6%9D%A5%E5%88%9B%E5%BB%BAStringLiteral%E8%8A%82%E7%82%B9%0Afunction%20createStringLiteral(value)%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20'StringLiteral'%2C%0A%20%20%20%20%20%20%20%20value%0A%20%20%20%20%7D%0A%7D%0A%2F%2F%20%E7%94%A8%E6%9D%A5%E5%88%9B%E5%BB%BAIdentifier%E8%8A%82%E7%82%B9%0Afunction%20createIdentifier(name)%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20'Identifier'%2C%0A%20%20%20%20%20%20%20%20name%0A%20%20%20%20%7D%0A%7D%0A%2F%2F%20%E7%94%A8%E6%9D%A5%E5%88%9B%E5%BB%BAArrayExpression%E8%8A%82%E7%82%B9%0Afunction%20createArrayExpression(elements)%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20'ArrayExpression'%2C%0A%20%20%20%20%20%20%20%20elements%0A%20%20%20%20%7D%0A%7D%0A%2F%2F%20%E7%94%A8%E6%9D%A5%E5%88%9B%E5%BB%BACallExpression%E8%8A%82%E7%82%B9%0Afunction%20createCallExpression(callee%2C%20arguments)%20%7B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20type%3A%20'CallExpression'%2C%0A%20%20%20%20%20%20%20%20callee%3A%20createIdentifier(callee)%2C%0A%20%20%20%20%20%20%20%20arguments%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0%0A%2F%2F%20%E8%BD%AC%E6%8D%A2%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%0Afunction%20transformText(node)%20%7B%0A%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%98%AF%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%EF%BC%8C%E7%9B%B4%E6%8E%A5return%0A%20%20%20%20if%20(node.type%20!%3D%3D%20'Text')%20%7B%0A%20%20%20%20%20%20%20%20return%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%E5%AF%B9%E5%BA%94%E7%9A%84JavaScript%20AST%E8%8A%82%E7%82%B9%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E9%9D%A2%E9%87%8F%EF%BC%8C%0A%20%20%20%20%2F%2F%20%E5%9B%A0%E6%AD%A4%E5%8F%AA%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8node.content%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAStringLiteral%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%8A%82%E7%82%B9%E5%8D%B3%E5%8F%AF%0A%20%20%20%20%2F%2F%20%E6%9C%80%E5%90%8E%E5%B0%86%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%E5%AF%B9%E5%BA%94%E7%9A%84JavaScript%20AST%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E5%88%B0node.jsNode%E5%B1%9E%E6%80%A7%E4%B8%8B%0A%20%20%20%20node.jsNode%20%3D%20createStringLiteral(node.content)%0A%7D%0A%0A%2F%2F%20%E8%BD%AC%E6%8D%A2%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%0Afunction%20transformElement(node)%20%7B%0A%20%20%20%20%2F%2F%20%E5%B0%86%E8%BD%AC%E6%8D%A2%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E5%9C%A8%E9%80%80%E5%87%BA%E9%98%B6%E6%AE%B5%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E4%B8%AD%EF%BC%8C%0A%20%20%20%20%2F%2F%20%E8%BF%99%E6%A0%B7%E5%8F%AF%E4%BB%A5%E4%BF%9D%E8%AF%81%E8%AF%A5%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E5%85%A8%E9%83%A8%E8%A2%AB%E5%A4%84%E7%90%86%E5%AE%8C%E6%AF%95%0A%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E8%A2%AB%E8%BD%AC%E6%8D%A2%E7%9A%84%E8%8A%82%E7%82%B9%E4%B8%8D%E6%98%AF%E5%85%83%E7%B4%A0%E8%8A%82%E7%82%B9%EF%BC%8C%E7%9B%B4%E6%8E%A5return%0A%20%20%20%20%20%20%20%20if%20(node.type%20!%3D%3D%20'Element')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%201.%E5%88%9B%E5%BB%BAh%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%AF%AD%E5%8F%A5%0A%20%20%20%20%20%20%20%20%2F%2F%20h%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E6%98%AF%E6%A0%87%E7%AD%BE%E5%90%8D%E7%A7%B0%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%BB%A5node.tag%E6%9D%A5%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E9%9D%A2%E9%87%8F%E8%8A%82%E7%82%B9%E4%BD%9C%E4%B8%BA%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%0A%20%20%20%20%20%20%20%20const%20callExp%20%3D%20createCallExpression('h'%2C%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20createStringLiteral(node.tag)%0A%20%20%20%20%20%20%20%20%5D)%0A%20%20%20%20%20%20%20%20%2F%2F%202.%E5%A4%84%E7%90%86h%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E7%9A%84%E5%8F%82%E6%95%B0%0A%20%20%20%20%20%20%20%20node.children.length%20%3D%3D%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8D%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E5%AD%90%E8%8A%82%E7%82%B9%EF%BC%8C%E5%88%99%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84jsNode%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0%0A%20%20%20%20%20%20%20%20%20%20%20%20%3F%20callExp.arguments.push(node.children%5B0%5D.jsNode)%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8D%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%E6%9C%89%E5%A4%9A%E4%B8%AA%E5%AD%90%E8%8A%82%E7%82%B9%EF%BC%8C%E5%88%99%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAArrayExpression%E8%8A%82%E7%82%B9%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0%0A%20%20%20%20%20%20%20%20%20%20%20%20%3A%20callExp.arguments.push(createArrayExpression(node.children.map((c)%20%3D%3E%20c.jsNode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%2F%2F%203.%E5%B0%86%E5%BD%93%E5%89%8D%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%E5%AF%B9%E5%BA%94%E7%9A%84JavaScript%20AST%E6%B7%BB%E5%8A%A0%E5%88%B0JsNode%E5%B1%9E%E6%80%A7%E4%B8%8B%0A%20%20%20%20%20%20%20%20node.jsNode%20%3D%20callExp%0A%20%20%20%20%7D%0A%7D%0A%0A%0A%2F%2F%20%E8%A1%A5%E5%85%A8JavaScript%20AST%0A%2F%2F%20%E8%BD%AC%E6%8D%A2Root%E6%A0%B9%E8%8A%82%E7%82%B9%0Afunction%20transformRoot(node)%20%7B%0A%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%98%AF%E6%A0%B9%E8%8A%82%E7%82%B9%EF%BC%8C%E7%9B%B4%E6%8E%A5return%0A%20%20%20%20%20%20%20%20if%20(node.type%20!%3D%3D%20'Root')%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20node%E6%98%AF%E6%A0%B9%E8%8A%82%E7%82%B9%EF%BC%8C%E6%A0%B9%E8%8A%82%E7%82%B9%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AD%90%E8%8A%82%E7%82%B9%E5%B0%B1%E6%98%AF%E6%A8%A1%E7%89%88%E7%9A%84%E6%A0%B9%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%BF%99%E9%87%8C%E5%85%88%E4%B8%8D%E8%80%83%E8%99%91%E6%A8%A1%E7%89%88%E5%AD%98%E5%9C%A8%E5%A4%9A%E4%B8%AA%E6%A0%B9%E8%8A%82%E7%82%B9%E7%9A%84%E6%83%85%E5%86%B5%0A%20%20%20%20%20%20%20%20const%20vnodeJSAST%20%3D%20node.children%5B0%5D.jsNode%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%88%9B%E5%BB%BArender%E5%87%BD%E6%95%B0%E7%9A%84%E5%A3%B0%E6%98%8E%E8%AF%AD%E5%8F%A5%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B0%86vnodeJSAST%E4%BD%9C%E4%B8%BArender%E5%87%BD%E6%95%B0%E4%BD%93%E7%9A%84%E8%BF%94%E5%9B%9E%E8%AF%AD%E5%8F%A5%0A%20%20%20%20%20%20%20%20node.jsNode%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'FunctionDecl'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20id%3A%20%7B%20type%3A%20'Identifier'%2C%20name%3A%20'render'%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20params%3A%20%5B%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20body%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'ReturnStatement'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%3A%20vnodeJSAST%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%0A%3E%20%E6%A0%B9%E6%8D%AEJavaScript%20AST%E7%94%9F%E6%88%90%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E7%9A%84%E4%BB%A3%E7%A0%81%0A%3E%20%E6%9C%AC%E8%B4%A8%E4%B8%8A%E6%98%AF%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E7%9A%84%E8%89%BA%E6%9C%AF%0A%0A%60%60%60js%0Afunction%20generate(node)%20%7B%0A%20%20%20%20const%20context%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%AD%98%E5%82%A8%E6%9C%80%E7%BB%88%E7%94%9F%E6%88%90%E7%9A%84%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E4%BB%A3%E7%A0%81%0A%20%20%20%20%20%20%20%20code%EF%BC%9A%20''%2C%0A%20%20%20%20%20%20%20%20%2F%2F%2F%20%E5%9C%A8%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%E6%97%B6%EF%BC%8C%E9%80%9A%E8%BF%87%E8%B0%83%E7%94%A8push%E5%AE%8C%E6%88%90%E4%BB%A3%E7%A0%81%E7%9A%84%E6%8B%BC%E6%8E%A5%0A%20%20%20%20%20%20%20%20push(code)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20context.code%20%2B%3D%20code%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%AE%8C%E6%88%90%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%8A%9F%E8%83%BD%0A%20%20%20%20genNode(node%2C%20context)%0A%20%20%20%20%0A%20%20%20%20return%20context.code%0A%7D%0A%0A%2F%2F%20%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E8%80%83%E8%99%91%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%E7%9A%84%E6%A0%BC%E6%95%B0%EF%BC%8C%E5%B0%B1%E8%A6%81%E8%80%83%E8%99%91%E7%BC%A9%E8%BF%9B%E3%80%81%E6%8D%A2%E8%A1%8C...%0A%2F%2F%20%E8%BF%99%E5%B0%B1%E9%9C%80%E8%A6%81%E6%89%A9%E5%B1%95context%E5%AF%B9%E8%B1%A1%0Afunction%20generate(node)%20%7B%0A%20%20%20%20const%20context%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%AD%98%E5%82%A8%E6%9C%80%E7%BB%88%E7%94%9F%E6%88%90%E7%9A%84%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E4%BB%A3%E7%A0%81%0A%20%20%20%20%20%20%20%20code%EF%BC%9A%20''%2C%0A%20%20%20%20%20%20%20%20%2F%2F%2F%20%E5%9C%A8%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%E6%97%B6%EF%BC%8C%E9%80%9A%E8%BF%87%E8%B0%83%E7%94%A8push%E5%AE%8C%E6%88%90%E4%BB%A3%E7%A0%81%E7%9A%84%E6%8B%BC%E6%8E%A5%0A%20%20%20%20%20%20%20%20push(code)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20context.code%20%2B%3D%20code%3B%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%BC%A9%E8%BF%9B%E7%BA%A7%E5%88%AB%EF%BC%8C0%E4%BB%A3%E8%A1%A8%E6%B2%A1%E6%9C%89%E7%BC%A9%E8%BF%9B%0A%20%20%20%20%20%20%20%20currentIndent%3A%200%2C%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%8D%A2%E8%A1%8C%E5%90%8E%EF%BC%8C%E5%90%8C%E6%A0%B7%E8%A6%81%E4%BF%9D%E6%8C%81%E7%BC%A9%E8%BF%9B%E7%9A%84%E7%A9%BA%E6%A0%BC%E6%95%B0%E9%87%8F%0A%20%20%20%20%20%20%20%20newline()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20context.code%20%2B%3D%20'%5Cn'%20%2B%20%60%20%20%60.repeat(context.currentIndent)%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%2F%2F%20%E7%94%A8%E6%9D%A5%E7%BC%A9%E8%BF%9B%EF%BC%8C%E5%8D%B3%E8%AE%A9currentIndent%E8%87%AA%E5%A2%9E%E5%90%8E%EF%BC%8C%E8%B0%83%E7%94%A8%E6%8D%A2%E8%A1%8C%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20indent()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20context.currentIndent%2B%2B%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20context.newline()%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%8F%96%E6%B6%88%E7%BC%A9%E8%BF%9B%0A%20%20%20%20%20%20%20%20deIndent()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20context.currentIndent--%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20context.newline()%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%AE%8C%E6%88%90%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%8A%9F%E8%83%BD%0A%20%20%20%20genNode(node%2C%20context)%0A%20%20%20%20%0A%20%20%20%20return%20context.code%0A%7D%0A%0A%2F%2F%20%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81%E5%87%BD%E6%95%B0%0Afunction%20generate(node%2C%20context)%20%7B%0A%20%20%20%20switch(node.type)%20%7B%0A%20%20%20%20%20%20%20%20case%20'FunctionDecl'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20genFunctionDecl(node%2C%20context)%0A%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20case%20'ReturnStatement'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20genReturnStatement(node%2C%20context)%0A%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20case%20'CallExpression'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20genCallExpression(node%2C%20context)%0A%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20case%20'StringLiteral'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20genStringLiteral(node%2C%20context)%0A%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20case%20'ArrayExpression'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20genArrayExpression(node%2C%20context)%0A%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20genNode(nodes%2C%20context)%20%7B%0A%20%20%20%20const%20%7B%20push%20%7D%20%3D%20context%0A%20%20%20%20for(let%20i%20%3D%200%3B%20i%20%3C%20nodes.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20const%20node%20%3D%20nodes%5Bi%5D%0A%20%20%20%20%20%20%20%20genNode(node%2C%20context)%0A%20%20%20%20%20%20%20%20if%20(i%20%3C%20nodes.length%20-%201)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20push('%2C%20')%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20genFunctionDecl(node%2C%20context)%20%7B%0A%20%20%20%20const%20%7B%20push%2C%20indent%2C%20deIndent%20%7D%20%3D%20context%0A%20%20%20%20%0A%20%20%20%20push(%60fucntion%20%24%7Bnode.id.name%7D%60)%0A%20%20%20%20push(%60(%60)%0A%20%20%20%20genNodeList(node.params%2C%20context)%0A%20%20%20%20push(%60)%60)%0A%20%20%20%20push(%60%7B%60)%0A%20%20%20%20indent()%0A%20%20%20%20node.body.forEach(n%20%3D%3E%20genNode(n%2C%20context))%0A%20%20%20%20deIndent()%0A%20%20%20%20push(%60%7D%60)%0A%7D%0A%0Afunction%20genArrayExpression(node%2C%20context)%20%7B%0A%20%20%20%20%2F%2F%20...%0A%7D%0A%0A%2F%2F%20%E3%80%82%E3%80%82%E3%80%82%E3%80%82%0A%0A%2F%2F%20%E6%9C%80%E7%BB%88%E5%BE%97%E5%88%B0%E7%9A%84%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%0Afunction%20render()%20%7B%0A%20%20%20%20return%20h('div'%2C%20%5Bh('p'%2C%20'Vue')%2C%20h('p'%2C%20'Template')%5D)%0A%7D%0A%60%60%60%0A%0A%0A%23%23%23%20%E7%AC%AC16%E7%AB%A0%E3%80%8A%E8%A7%A3%E6%9E%90%E5%99%A8%E3%80%8B%0A%0A%23%23%23%23%20%E6%96%87%E6%9C%AC%E6%A8%A1%E5%BC%8F%E5%8F%8A%E5%85%B6%E5%AF%B9%E8%A7%A3%E6%9E%90%E5%99%A8%E7%9A%84%E5%BD%B1%E5%93%8D%0A%3E%20%E6%96%87%E6%9C%AC%E6%A8%A1%E5%BC%8F%E6%8C%87%E7%9A%84%E6%98%AF**%E8%A7%A3%E6%9E%90%E5%99%A8**%E5%9C%A8%E5%B7%A5%E4%BD%9C%E6%97%B6%E6%89%80%E8%BF%9B%E5%85%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E6%AE%8A%E7%8A%B6%E6%80%81%EF%BC%8C%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E7%89%B9%E6%AE%8A%E7%8A%B6%E6%80%81%E4%B8%8B%EF%BC%8C%E8%A7%A3%E6%9E%90%E5%99%A8%E5%AF%B9%E6%96%87%E6%9C%AC%E7%9A%84%E8%A7%A3%E6%9E%90%E8%A1%8C%E4%B8%BA%E4%BC%9A%E6%9C%89%E6%89%80%E4%B8%8D%E5%90%8C%E3%80%82%0A%3E%20%E5%85%B7%E4%BD%93%E6%9D%A5%E8%AF%B4%EF%BC%8C%E5%BD%93%E8%A7%A3%E6%9E%90%E5%99%A8%E9%81%87%E5%88%B0%E4%B8%80%E4%BA%9B%E7%89%B9%E6%AE%8A%E6%A0%87%E7%AD%BE%EF%BC%8C%E4%BC%9A%E5%88%87%E6%8D%A2%E6%A8%A1%E5%BC%8F%EF%BC%8C%E4%BB%8E%E8%80%8C%E5%BD%B1%E5%93%8D%E5%AF%B9%E6%96%87%E6%9C%AC%E7%9A%84%E8%A7%A3%E6%9E%90%E8%A1%8C%E4%B8%BA%0A%3E%20%E8%BF%99%E4%BA%9B%E7%89%B9%E6%AE%8A%E6%A0%87%E7%AD%BE%E6%98%AF%0A%3E%20-%20%3Ctitle%3E%E3%80%81%3Ctextarea%3E%EF%BC%8C%E4%BC%9A%E5%88%87%E6%8D%A2%E5%88%B0RCDATA%E6%A8%A1%E5%BC%8F%0A%3E%20-%20%3Cstyle%3E%E3%80%81%3Cxmp%3E%E3%80%81%3Ciframe%3E%E3%80%81%3Cnoembed%3E%E3%80%81%3Cnoframes%3E%E3%80%81%3Cnoscript%3E%E6%A0%87%E7%AD%BE%EF%BC%8C%E4%BC%9A%E5%88%87%E6%8D%A2%E5%88%B0RAWTEXT%E6%A8%A1%E5%BC%8F%0A%3E%20-%20%E5%BD%93%E9%81%87%E5%88%B0%3C!%5BCDATA%5B%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%97%B6%EF%BC%8C%E4%BC%9A%E8%BF%9B%E5%85%A5CDATA%E6%A8%A1%E5%BC%8F%0A%0A%23%23%23%23%20%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E7%AE%97%E6%B3%95%E6%9E%84%E9%80%A0%E6%A8%A1%E7%89%88AST%0A%20%20%20%20%0A%23%23%23%23%20%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E5%BC%80%E5%90%AF%E4%B8%8E%E5%81%9C%E6%AD%A2%0A%3E%20%E5%BD%93%E8%A7%A3%E6%9E%90%E5%99%A8%E9%81%87%E5%88%B0%E5%BC%80%E5%A7%8B%E6%A0%87%E7%AD%BE%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%B0%86%E8%AF%A5%E6%A0%87%E7%AD%BE%E5%8E%8B%E5%85%A5%E7%88%B6%E7%BA%A7%E8%8A%82%E7%82%B9%E6%A0%88%EF%BC%8C%E5%90%8C%E6%97%B6%E5%BC%80%E5%90%AF%E6%96%B0%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA%E3%80%82%E5%BD%93%E8%A7%A3%E6%9E%90%E5%99%A8%E9%81%87%E5%88%B0%E7%BB%93%E6%9D%9F%E6%A0%87%E7%AD%BE%EF%BC%8C%E5%B9%B6%E4%B8%94%E7%88%B6%E7%BA%A7%E8%8A%82%E7%82%B9%E6%A0%88%E4%B8%AD%E5%AD%98%E5%9C%A8%E4%B8%8E%E8%AF%A5%E6%A0%87%E7%AD%BE%E5%90%8C%E5%90%8D%E7%9A%84%E5%BC%80%E5%A7%8B%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%81%9C%E6%AD%A2%E5%BD%93%E5%89%8D%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA%0A%0A%0A%23%23%23%23%20%E8%A7%A3%E6%9E%90%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9%0A%0A%23%23%23%23%20%E8%A7%A3%E6%9E%90%E5%B1%9E%E6%80%A7%0A%0A%23%23%23%23%20%E8%A7%A3%E6%9E%90%E6%96%87%E6%9C%AC%E4%B8%8E%E8%A7%A3%E7%A0%81HTML%E5%AE%9E%E4%BD%93%0A%0A%0A%0A%0A%0A%23%23%23%20%E7%AC%AC17%E7%AB%A0%E3%80%8A%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96%E3%80%8B%0A%0A%23%23%23%23%20%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E6%94%B6%E9%9B%86%E4%B8%8E%E8%A1%A5%E4%B8%81%E6%A0%87%E5%BF%97%0A%0A%3E%20%E4%B9%8B%E5%89%8D%E7%9A%84Diff%E7%AE%97%E6%B3%95%E6%97%A0%E8%AE%BA%E6%98%AF%E5%93%AA%E4%B8%80%E7%A7%8D%EF%BC%8C%E5%BD%93%E5%AE%83%E5%9C%A8%E5%AF%B9%E6%AF%94%E6%96%B0%E6%97%A7%E4%B8%A4%E6%A3%B5%E8%99%9A%E6%8B%9FDOM%E6%A0%91%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%80%BB%E6%98%AF%E8%A6%81%E6%8C%89%E7%85%A7%E8%99%9A%E6%8B%9FDOM%E7%9A%84%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84%E4%B8%80%E5%B1%82%E4%B8%80%E5%B1%82%E7%9A%84%E9%81%8D%E5%8E%86%0A%0A%60%60%60html%0A%3Cdiv%20id%3D%22foo%22%3E%0A%20%20%20%20%3Cp%20class%3D%22bar%22%3E%7B%7B%20text%20%7D%7D%3C%2Fp%3E%0A%3C%2Fdiv%3E%0A%60%60%60%0A%E5%9C%A8%E4%B8%8A%E9%9D%A2%E8%BF%99%E6%AE%B5%E6%A8%A1%E7%89%88%E4%B8%AD%EF%BC%8C%E5%94%AF%E4%B8%80%E5%8F%AF%E8%83%BD%E5%8F%98%E5%8C%96%E7%9A%84%E5%B0%B1%E6%98%AFp%E6%A0%87%E7%AD%BE%E7%9A%84%E6%96%87%E6%9C%AC%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E5%86%85%E5%AE%B9%E3%80%82%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%EF%BC%8C%E5%BD%93%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AEtext%E7%9A%84%E5%80%BC%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E6%9C%80%E9%AB%98%E6%95%88%E7%9A%84%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F%E5%B0%B1%E6%98%AF%E7%9B%B4%E6%8E%A5%E8%AE%BE%E7%BD%AEp%E6%A0%87%E7%AD%BE%E7%9A%84%E6%96%87%E6%9C%AC%E5%86%85%E5%AE%B9%E3%80%82%E4%BD%86%E6%98%AF%E4%BC%A0%E7%BB%9FDiff%E7%AE%97%E6%B3%95%E4%BC%9A%E5%AF%B9%E6%AF%94%E6%96%B0%E6%97%A7DOM%E6%A0%91%EF%BC%9A%0A-%20%E5%AF%B9%E6%AF%94div%E8%8A%82%E7%82%B9%EF%BC%8C%E4%BB%A5%E5%8F%8A%E8%AF%A5%E8%8A%82%E7%82%B9%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E5%AD%90%E8%8A%82%E7%82%B9%0A-%20%E5%AF%B9%E6%AF%94p%E8%8A%82%E7%82%B9%EF%BC%8C%E4%BB%A5%E5%8F%8A%E8%AF%A5%E8%8A%82%E7%82%B9%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E5%AD%90%E8%8A%82%E7%82%B9%0A-%20%E5%AF%B9%E6%AF%94p%E8%8A%82%E7%82%B9%E7%9A%84%E6%96%87%E6%9C%AC%E5%AD%90%E8%8A%82%E7%82%B9%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%96%87%E6%9C%AC%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E5%86%85%E5%AE%B9%E5%8F%98%E4%BA%86%EF%BC%8C%E5%88%99%E6%9B%B4%E6%96%B0%0A%0A%3E%20%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%A6%82%E6%9E%9C%E8%83%BD%E8%B7%B3%E8%BF%87%E8%BF%99%E4%BA%9B%E6%97%A0%E6%84%8F%E4%B9%89%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%80%A7%E8%83%BD%E5%B0%86%E4%BC%9A%E5%A4%A7%E5%B9%85%E6%8F%90%E5%8D%87%EF%BC%8C%E8%80%8C%E8%BF%99%E5%B0%B1%E6%98%AFVue3%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96%E7%9A%84%E6%80%9D%E8%B7%AF%E6%9D%A5%E6%BA%90%0A%0A%3E%20%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E6%A8%A1%E7%89%88%E7%9A%84%E7%BB%93%E6%9E%84%E9%9D%9E%E5%B8%B8%E7%A8%B3%E5%AE%9A%E3%80%82%E9%80%9A%E8%BF%87%E7%BC%96%E8%AF%91%E6%89%8B%E6%AE%B5%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%88%86%E6%9E%90%E5%87%BA%E5%BE%88%E5%A4%9A%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF%EF%BC%8C%E4%BE%8B%E5%A6%82%E5%93%AA%E4%BA%9B%E6%98%AF%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%EF%BC%8C%E5%93%AA%E4%BA%9B%E6%98%AF%E9%9D%99%E6%80%81%E8%8A%82%E7%82%B9%E3%80%82%E7%BB%93%E5%90%88%E8%BF%99%E4%BA%9B%E4%BF%A1%E6%81%AF%EF%BC%8C%E7%BC%96%E8%AF%91%E5%99%A8%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E7%94%9F%E6%88%90%E5%8E%9F%E7%94%9FDOM%E6%93%8D%E4%BD%9C%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%BF%99%E6%A0%B7%E7%94%9A%E8%87%B3%E8%83%BD%E5%A4%9F%E6%8A%9B%E6%8E%89%E8%99%9A%E6%8B%9FDOM%EF%BC%8C%E4%BB%8E%E8%80%8C%E9%81%BF%E5%85%8D%E8%99%9A%E6%8B%9FDOM%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80%E3%80%82%E4%BD%86%E6%98%AF%EF%BC%8C%E8%80%83%E8%99%91%E5%88%B0%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E7%9A%84%E7%81%B5%E6%B4%BB%E6%80%A7%EF%BC%8C%E4%BB%A5%E5%8F%8AVue2%E7%9A%84%E5%85%BC%E5%AE%B9%E9%97%AE%E9%A2%98%EF%BC%8CVue3%E6%9C%80%E7%BB%88%E8%BF%98%E6%98%AF%E9%80%89%E6%8B%A9%E4%BA%86%E4%BF%9D%E7%95%99%E8%99%9A%E6%8B%9FDOM%E3%80%82%E8%BF%99%E6%A0%B7%E4%BE%9D%E8%B5%96%EF%BC%8C%E5%B0%B1%E5%BF%85%E7%84%B6%E8%A6%81%E9%9D%A2%E4%B8%B4%E5%AE%83%E6%89%80%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%A2%9D%E5%A4%96%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80%0A%0A%3E%20%E4%B8%BA%E4%BB%80%E4%B9%88%E8%99%9A%E6%8B%9FDOM%E4%BC%9A%E4%BA%A7%E7%94%9F%E9%A2%9D%E5%A4%96%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80%EF%BC%9F%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0%E5%9C%A8%E4%BA%8E%EF%BC%8C%E6%B8%B2%E6%9F%93%E5%99%A8%E5%9C%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E5%BE%97%E4%B8%8D%E5%88%B0%E8%B6%B3%E5%A4%9F%E7%9A%84%E4%BF%A1%E6%81%AF%E3%80%82%E4%BC%A0%E7%BB%9FDiff%E7%AE%97%E6%B3%95%E6%97%A0%E6%B3%95%E5%88%A9%E7%94%A8%E7%BC%96%E8%AF%91%E6%97%B6%E6%8F%90%E5%8F%96%E5%88%B0%E4%BB%BB%E4%BD%95%E7%9A%84%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF%EF%BC%8C%E8%BF%99%E5%AF%BC%E8%87%B4%E6%B8%B2%E6%9F%93%E5%99%A8%E5%9C%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E4%B8%8D%E5%8F%AF%E8%83%BD%E5%8E%BB%E5%81%9A%E7%9B%B8%E5%85%B3%E7%9A%84%E4%BC%98%E5%8C%96%E3%80%82%E8%80%8CVue3%E7%9A%84%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%9A%E5%B0%86%E7%BC%96%E8%AF%91%E6%97%B6%E5%BE%97%E5%88%B0%E7%9A%84%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF%E9%99%84%E7%9D%80%E5%9C%A8%E5%AE%83%E7%94%9F%E6%88%90%E7%9A%84%E8%99%9A%E6%8B%9FDOM%E4%B8%8A%EF%BC%8C%E8%BF%99%E4%BA%9B%E4%BF%A1%E6%81%AF%E4%BC%9A%E9%80%9A%E8%BF%87%E8%99%9A%E6%8B%9FDOM%E4%BC%A0%E9%80%92%E7%BB%99%E6%B8%B2%E6%9F%93%E5%99%A8%E3%80%82%E6%9C%80%E7%BB%88%EF%BC%8C%E6%B8%B2%E6%9F%93%E5%99%A8%E4%BC%9A%E6%A0%B9%E6%8D%AE%E8%BF%99%E4%BA%9B%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF%E6%89%A7%E8%A1%8C%E2%80%9C%E5%BF%AB%E6%8D%B7%E8%B7%AF%E5%BE%84%E2%80%9D%EF%BC%8C%E4%BB%8E%E8%80%8C%E6%8F%90%E5%8D%87%E8%BF%90%E8%A1%8C%E6%97%B6%E6%80%A7%E8%83%BD%0A%0A%0A%23%23%23%23%23%20Block%E4%B8%8EPatchFlags%0A%60%60%60html%0A%3C!--%20%E5%81%87%E5%A6%82%E6%9C%89%E5%A6%82%E4%B8%8B%E6%A8%A1%E7%89%88--%3E%0A%3Cdiv%3E%0A%20%20%20%20%3Cdiv%3Efoo%3C%2Fdiv%3E%0A%20%20%20%20%3Cp%3E%7B%7B%20bar%20%7D%7D%3C%2Fp%3E%0A%3C%2Fdiv%3E%0A%60%60%60%0A%E8%BF%99%E9%87%8C%E5%8F%AA%E6%9C%89%7B%7B%20bar%20%7D%7D%E6%98%AF%E5%8A%A8%E6%80%81%E7%9A%84%E5%86%85%E5%AE%B9%E3%80%82%E5%9B%A0%E6%AD%A4%E5%9C%A8%E7%90%86%E6%83%B3%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E5%BD%93%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AEbar%E7%9A%84%E5%80%BC%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E5%8F%AA%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0p%E6%A0%87%E7%AD%BE%E7%9A%84%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%E5%8D%B3%E5%8F%AF%0A%0A%60%60%60js%0A%2F%2F%20%E4%BC%A0%E7%BB%9F%E7%9A%84%E8%99%9A%E6%8B%9FDOM%0Aconst%20vnode%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'div'%2C%20children%3A%20'foo'%20%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20ctx.bar%20%7D%2C%0A%20%20%20%20%5D%0A%7D%0A%0A%2F%2F%20%E4%BC%98%E5%8C%96%E5%90%8E%E7%9A%84%E8%99%9A%E6%8B%9FDOM%0Aconst%20vnode%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'div'%2C%20children%3A%20'foo'%20%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20ctx.bar%2C%20patchFlag%3A%201%20%7D%20%2F%2F%20%E8%BF%99%E6%98%AF%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%0A%20%20%20%20%5D%0A%7D%0A%60%60%60%0A%0A%3E%20%E7%94%A8%E6%9D%A5%E6%8F%8F%E8%BF%B0p%E6%A0%87%E7%AD%BE%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E6%8B%A5%E6%9C%89%E4%B8%80%E4%B8%AA%E9%A2%9D%E5%A4%96%E7%9A%84%E5%B1%9E%E6%80%A7%EF%BC%8C%E5%8D%B3patchFlag%2C%E5%AE%83%E7%9A%84%E5%80%BC%E6%98%AF%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%E3%80%82%E5%8F%AA%E8%A6%81%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E5%AD%98%E5%9C%A8%E8%AF%A5%E5%B1%9E%E6%80%A7%EF%BC%8C%E5%B0%B1%E8%AE%A4%E4%B8%BA%E5%AE%83%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E3%80%82%0A%3E%20patchFlag%E5%B0%B1%E6%98%AF%E6%89%80%E8%B0%93%E7%9A%84%E8%A1%A5%E4%B8%81%E6%A0%87%E5%BF%97%0A%3E%20%E5%8F%AF%E4%BB%A5%E6%8A%8A%E5%AE%83%E7%90%86%E8%A7%A3%E4%B8%BA%E4%B8%80%E7%B3%BB%E5%88%97%E6%95%B0%E5%AD%97%E6%A0%87%E8%AE%B0%EF%BC%8C%E5%B9%B6%E6%A0%B9%E6%8D%AE%E6%95%B0%E5%AD%97%E5%80%BC%E7%9A%84%E4%B8%8D%E5%90%8C%E8%B5%8B%E4%BA%88%E5%AE%83%E4%B8%8D%E5%90%8C%E7%9A%84%E5%90%AB%E4%B9%89%EF%BC%9A%0A%3E%20-%20%E6%95%B0%E5%AD%971%3A%E4%BB%A3%E8%A1%A8%E5%85%83%E7%B4%A0%E6%9C%89%E5%8A%A8%E6%80%81%E7%9A%84TextContent%0A%3E%20-%20%E6%95%B0%E5%AD%972%3A%E4%BB%A3%E8%A1%A8%E5%85%83%E7%B4%A0%E6%9C%89%E5%8A%A8%E6%80%81%E7%9A%84class%E7%BB%91%E5%AE%9A%0A%3E%20-%20%E6%95%B0%E5%AD%973%3A%E4%BB%A3%E8%A1%A8%E5%85%83%E7%B4%A0%E6%9C%89%E5%8A%A8%E6%80%81%E7%9A%84style%E7%BB%91%E5%AE%9A%0A%3E%20-%20%E6%95%B0%E5%AD%974%3A%E5%85%B6%E4%BB%96...%0A%0A%60%60%60js%0Aconst%20PatchFlags%20%3D%20%7B%0A%20%20%20%20TEXT%3A%201%2C%0A%20%20%20%20CLASS%3A%202%2C%0A%20%20%20%20STYLE%3A%203%2C%0A%20%20%20%20...%0A%7D%0A%60%60%60%0A%0A%E6%9C%89%E4%BA%86%E8%BF%99%E9%A1%B9%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%9C%A8%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E7%9A%84%E5%88%9B%E5%BB%BA%E9%98%B6%E6%AE%B5%EF%BC%8C%E6%8A%8A%E5%AE%83%E7%9A%84%E5%8A%A8%E6%80%81%E5%AD%90%E8%8A%82%E7%82%B9%E6%8F%90%E5%8F%96%E5%87%BA%E6%9D%A5%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%85%B6%E5%AD%98%E5%82%A8%E5%88%B0%E8%AF%A5%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E7%9A%84dynamicChildren%E6%95%B0%E7%BB%84%E5%86%85%3A%0A%0A%60%60%60js%0Aconst%20vnode%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'div'%2C%20children%3A%20'foo'%20%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20ctx.bar%2C%20patchFlag%3A%20PatchFlags.TEXT%20%7D%20%2F%2F%20%E8%BF%99%E6%98%AF%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%0A%20%20%20%20%5D%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20ctx.bar%2C%20patchFlag%3A%20PatchFlags.TEXT%20%7D%0A%20%20%20%20%5D%0A%7D%0A%60%60%60%0A%0A%3E%20%E8%BF%99%E9%87%8C%E5%A4%9A%E4%BA%86%E4%B8%80%E4%B8%AA%E9%A2%9D%E5%A4%96%E7%9A%84dynamicChildren%E5%B1%9E%E6%80%A7%EF%BC%8C%E6%8A%8A%E5%B8%A6%E6%9C%89%E8%AF%A5%E5%B1%9E%E6%80%A7%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E7%A7%B0%E4%B8%BA%E2%80%9C%E5%9D%97%E2%80%9C%EF%BC%8C%E5%8D%B3**Block**%0A%3E%20%E6%89%80%E4%BB%A5%E4%B8%80%E4%B8%AABlock%E6%9C%AC%E8%B4%A8%E4%B8%8A%E4%B9%9F%E6%98%AF%E4%B8%80%E4%B8%AA%E8%99%9A%E6%8B%9FDOM%E8%8A%82%E7%82%B9%EF%BC%8C%E5%AE%83%E5%8F%AA%E4%B8%8D%E8%BF%87%E6%AF%94%E6%99%AE%E9%80%9A%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E5%A4%9A%E5%87%BA%E4%B8%80%E4%B8%AA%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E5%8A%A8%E6%80%81%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84dynamicChildren%E5%B1%9E%E6%80%A7%0A%3E%20%E4%B8%80%E4%B8%AABlock%E4%B8%8D%E4%BB%85%E8%83%BD%E5%A4%9F%E6%94%B6%E9%9B%86%E5%AE%83%E7%9A%84%E7%9B%B4%E6%8E%A5%E5%8A%A8%E6%80%81%E5%AD%90%E8%8A%82%E7%82%B9%EF%BC%8C%E8%BF%98%E8%83%BD%E5%A4%9F%E6%94%B6%E9%9B%86%E6%89%80%E6%9C%89%E5%8A%A8%E6%80%81%E5%AD%90%E4%BB%A3%E8%8A%82%E7%82%B9%0A%0A%60%60%60html%0A%3Cdiv%3E%0A%20%20%20%20%3Cdiv%3E%0A%20%20%20%20%20%20%20%20%3Cp%3E%7B%7B%20bar%20%7D%7D%3C%2Fp%3E%0A%20%20%20%20%3C%2Fdiv%3E%0A%3C%2Fdiv%3E%0A%60%60%60%0ABlock%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%60%60%60js%0Aconst%20vnode%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20ctx.bar%2C%20patchFlag%3A%20PatchFlags.TEXT%20%7D%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%5D%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%2F%2F%20Block%E5%8F%AF%E4%BB%A5%E6%94%B6%E9%9B%86%E6%89%80%E6%9C%89%E5%8A%A8%E6%80%81%E5%AD%90%E4%BB%A3%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20ctx.bar%2C%20patchFlag%3A%20PatchFlags.TEXT%20%7D%0A%20%20%20%20%5D%0A%7D%0A%60%60%60%0A%0A%3E%20%E6%9C%89%E4%BA%86Block%E7%9A%84%E6%A6%82%E5%BF%B5%E5%90%8E%EF%BC%8C%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E6%9B%B4%E6%96%B0%E6%93%8D%E4%BD%9C%E5%B0%86%E4%BC%9A%E4%BB%A5Block%E4%B8%BA%E7%BB%B4%E5%BA%A6%E3%80%82%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%EF%BC%8C%E5%BD%93%E6%B8%B2%E6%9F%93%E5%99%A8%E5%9C%A8%E6%9B%B4%E6%96%B0%E4%B8%80%E4%B8%AABlock%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%BF%BD%E7%95%A5%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E7%9A%84Children%E6%95%B0%E7%BB%84%EF%BC%8C%E8%80%8C%E6%98%AF%E7%9B%B4%E6%8E%A5%E6%89%BE%E5%88%B0%E8%AF%A5%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E7%9A%84dynamicChildren%E6%95%B0%E7%BB%84%EF%BC%8C%E5%B9%B6%E5%8F%AA%E6%9B%B4%E6%96%B0%E8%AF%A5%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E3%80%82%E8%BF%99%E6%A0%B7%E5%9C%A8%E6%9B%B4%E6%96%B0%E7%9A%84%E6%97%B6%E5%80%99%E5%B0%B1%E5%AE%9E%E7%8E%B0%E4%BA%86%E8%B7%B3%E8%BF%87%E9%9D%99%E6%80%81%E5%86%85%E5%AE%B9%EF%BC%8C%E5%8F%AA%E6%9B%B4%E6%96%B0%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9%0A%3E%20%E5%90%8C%E6%97%B6%EF%BC%8C%E7%94%B1%E4%BA%8E%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E4%B8%AD%E5%AD%98%E5%9C%A8%E5%AF%B9%E5%BA%94%E7%9A%84%E8%A1%A5%E4%B8%81%E6%A0%87%E5%BF%97%EF%BC%8C%E6%89%80%E4%BB%A5%E5%9C%A8%E6%9B%B4%E6%96%B0%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%B9%9F%E8%83%BD%E5%A4%9F%E5%81%9A%E5%88%B0%E9%9D%B6%E5%90%91%E6%9B%B4%E6%96%B0%0A%0A**%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E9%9C%80%E8%A6%81%E5%B0%86%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E5%8F%98%E6%88%90Block%E8%8A%82%E7%82%B9%E5%91%A2**%0A%3E%20%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E5%9C%A8%E7%BC%96%E5%86%99%E6%A8%A1%E7%89%88%E4%BB%A3%E7%A0%81%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%89%80%E6%9C%89%E6%A8%A1%E7%89%88%E7%9A%84%E6%A0%B9%E8%8A%82%E7%82%B9%E9%83%BD%E4%BC%9A%E6%98%AF%E4%B8%80%E4%B8%AABlock%E8%8A%82%E7%82%B9%0A%0A%60%60%60html%0A%3Ctempalte%3E%0A%20%20%20%20%3C!--%20%E8%BF%99%E4%B8%AAdiv%E6%A0%87%E7%AD%BE%E6%98%AF%E4%B8%80%E4%B8%AABlock%20--%3E%0A%20%20%20%20%3Cdiv%3E%0A%20%20%20%20%20%20%20%20%3Cp%3E%7B%7B%20bar%20%7D%7D%3C%2Fp%3E%0A%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3C!--%20%E8%BF%99%E4%B8%AAh1%E6%A0%87%E7%AD%BE%E6%98%AF%E4%B8%80%E4%B8%AABlock%20--%3E%0A%20%20%20%20%3Ch1%3E%0A%20%20%20%20%20%20%20%20%3Cspan%20%3Aid%3D%22dynamicId%22%3E%3C%2Fspan%3E%0A%20%20%20%20%3C%2Fh1%3E%0A%60%60%60%0A%0A%3E%20%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E9%99%A4%E4%BA%86%E6%A8%A1%E7%89%88%E4%B8%AD%E7%9A%84%E6%A0%B9%E8%8A%82%E7%82%B9%E8%A6%81%E4%BD%9C%E4%B8%BABLock%E8%A7%92%E8%89%B2%E5%A4%96%E3%80%82%E4%BB%BB%E4%BD%95%E5%B8%A6%E6%9C%89v-for%E3%80%81v-if%2Fv-else-if%2Fv-else%E7%AD%89%E6%8C%87%E4%BB%A4%E7%9A%84%E8%8A%82%E7%82%B9%E9%83%BD%E9%9C%80%E8%A6%81%E4%BD%9C%E4%B8%BABlock%E8%8A%82%E7%82%B9%0A%0A%0A%23%23%23%23%23%20%E6%94%B6%E9%9B%86%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%0A%0A%3E%20%E5%9C%A8%E7%BC%96%E8%AF%91%E5%99%A8%E7%94%9F%E6%88%90%E7%9A%84%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E4%BB%A3%E7%A0%81%E4%B8%AD%EF%BC%8C%E5%B9%B6%E4%B8%8D%E4%BC%9A%E7%9B%B4%E6%8E%A5%E5%8C%85%E5%90%AB%E7%94%A8%E6%9D%A5%E6%8F%8F%E8%BF%B0%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C%E8%80%8C%E6%98%AF%E5%8C%85%E5%90%AB%E7%9D%80%E7%94%A8%E6%9D%A5%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9FDOM%E8%8A%82%E7%82%B9%E7%9A%84%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0%0A%60%60%60js%0Arender()%20%7B%0A%20%20%20%20return%20createVNode('div'%2C%20%7B%20id%3A%20'foo'%20%7D%2C%20%5B%0A%20%20%20%20%20%20%20%20createVNode('p'%2C%20null%2C%20'text')%0A%20%20%20%20%5D)%0A%7D%0A%2F%2F%20%E5%85%B6%E4%B8%ADcreateVNode%E6%98%AF%E7%94%A8%E6%9D%A5%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9FDOM%E8%8A%82%E7%82%B9%E7%9A%84%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0%0Afunction%20createVNode(tag%2C%20props%2C%20children)%20%7B%0A%20%20%20%20const%20key%20%3D%20props%20%26%26%20props.key%0A%20%20%20%20props%20%26%26%20delete%20props.key%0A%20%20%20%20%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20tag%2C%0A%20%20%20%20%20%20%20%20props%2C%0A%20%20%20%20%20%20%20%20children%2C%0A%20%20%20%20%20%20%20%20key%2C%0A%20%20%20%20%7D%0A%7D%0A%0A%2F*%0A%3Cdiv%20id%3D%22foo%22%3E%0A%20%20%20%20%3Cp%20class%3D%22bar%22%3E%7B%7B%20text%20%7D%7D%20%3C%2Fp%3E%0A%3C%2Fdiv%3E%0A*%2F%0A%2F%2F%20%E5%9C%A8%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96%E5%90%8E%EF%BC%8C%E4%BC%9A%E7%94%9F%E6%88%90%E5%B8%A6%E6%9C%89%E8%A1%A5%E4%B8%81%E6%A0%87%E5%BF%97%E7%9A%84%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%0Arender()%20%7B%0A%20%20%20%20return%20createVNode('div'%2C%20%7B%20id%3A%20'foo'%20%7D%2C%20%5B%0A%20%20%20%20%20%20%20%20createVNode('p'%2C%20%7B%20class%3A%20'bar'%20%7D%2C%20text%2C%20PatchFlags.TEXT)%0A%20%20%20%20%5D)%20%20%20%20%20%20%20%0A%7D%0A%2F%2F%20%E8%BF%99%E9%87%8CPatchFlags.TEXT%E4%BB%A3%E8%A1%A8%E5%BD%93%E5%89%8D%E8%99%9A%E6%8B%9FDOM%E8%8A%82%E7%82%B9%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%8A%A8%E6%80%81%E5%9B%A0%E7%B4%A0%E6%98%AF%E5%85%B7%E6%9C%89%E5%8A%A8%E6%80%81%E7%9A%84%E6%96%87%E6%9C%AC%E5%AD%90%E8%8A%82%E7%82%B9%E3%80%82%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%AE%9E%E7%8E%B0%E4%BA%86%E5%AF%B9%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E7%9A%84%E6%A0%87%E8%AE%B0%0A%0A%2F%2F%20%E6%8E%A5%E4%B8%8B%E9%87%8C%E8%A6%81%E8%80%83%E8%99%91%E5%A6%82%E4%BD%95%E5%B0%86%E6%A0%B9%E8%8A%82%E7%82%B9%E5%8F%98%E6%88%90%E4%B8%80%E4%B8%AABlock%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%A6%82%E4%BD%95%E5%B0%86%E5%8A%A8%E6%80%81%E5%AD%90%E4%BB%A3%E8%8A%82%E7%82%B9%E6%94%B6%E9%9B%86%E5%88%B0%E8%AF%A5Block%E7%9A%84dynamicChildren%E6%95%B0%E7%BB%84%E4%B8%AD%E3%80%82%E8%BF%99%E9%87%8C%E6%9C%89%E4%B8%80%E4%B8%AA%E4%BA%8B%E5%AE%9E%EF%BC%8C%E5%8D%B3%E5%9C%A8%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E5%86%85%EF%BC%8C%E5%AF%B9createVNode%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E6%98%AF%E5%B1%82%E5%B1%82%E5%B5%8C%E5%A5%97%E7%BB%93%E6%9E%84%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%87%BD%E6%95%B0%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E6%98%AF%E2%80%9C%E5%86%85%E5%B1%82%E5%85%88%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%A4%96%E5%B1%82%E5%90%8E%E6%89%A7%E8%A1%8C%E2%80%9D%0A%2F%2F%20%E5%BD%93%E5%A4%96%E5%B1%82createVNode%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E5%86%85%E5%B1%82%E7%9A%84createVNode%E5%B7%B2%E7%BB%8F%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95%E4%BA%86%E3%80%82%E5%9B%A0%E6%AD%A4%EF%BC%8C%E4%B8%BA%E4%BA%86%E8%AE%A9%E5%A4%96%E5%B1%82Block%E8%8A%82%E7%82%B9%E8%83%BD%E5%A4%9F%E6%94%B6%E9%9B%86%E5%88%B0%E5%86%85%E5%B1%82%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E4%B8%80%E4%B8%AA%E6%A0%88%E7%BB%93%E6%9E%84%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9D%A5%E4%B8%B4%E6%97%B6%E5%AD%98%E5%82%A8%E5%86%85%E5%B1%82%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%0A%0A%2F%2F%20%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E6%A0%88%0Aconst%20dynamicChildrenStack%20%3D%20%5B%5D%0A%2F%2F%20%E5%BD%93%E5%89%8D%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E9%9B%86%E5%90%88%0Alet%20currentDynamicChildren%20%3D%20null%0A%2F%2F%20openBlock%E7%94%A8%E6%9D%A5%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E9%9B%86%E5%90%88%EF%BC%8C%E5%B9%B6%E5%B0%86%E8%AF%A5%E9%9B%86%E5%90%88%E5%8E%8B%E5%85%A5%E6%A0%88%E4%B8%AD%0Afunction%20openBlock()%20%7B%0A%20%20%20%20dynamicChildrenStack.push((currentDynamicChildren%20%3D%20%5B%5D))%0A%7D%0A%2F%2F%20closeBlock%E7%94%A8%E6%9D%A5%E5%B0%86%E9%80%9A%E8%BF%87openBlock%E5%88%9B%E5%BB%BA%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E9%9B%86%E5%90%88%E4%BB%8E%E6%A0%88%E4%B8%AD%E5%BC%B9%E5%87%BA%0Afunction%20openBlock()%20%7B%0A%20%20%20%20currentDynamicChildren%20%3D%20dynamicChildrenStack.pop()%0A%7D%0A%0A%2F%2F%20%E4%B8%BA%E6%AD%A4%E8%BF%98%E9%9C%80%E8%A6%81%E8%B0%83%E6%95%B4createVNode%E5%87%BD%E6%95%B0%0Afunction%20createVNode(tag%2C%20props%2C%20children%2C%20flags)%20%7B%0A%20%20%20%20const%20key%20%3D%20props%20%26%26%20props.key%0A%20%20%20%20props%20%26%26%20delete%20props.key%0A%20%20%20%20%0A%20%20%20%20const%20vnode%20%3D%20%7B%0A%20%20%20%20%20%20%20%20tag%2C%0A%20%20%20%20%20%20%20%20props%2C%0A%20%20%20%20%20%20%20%20children%2C%0A%20%20%20%20%20%20%20%20key%2C%0A%20%20%20%20%20%20%20%20patchFlags%3A%20flags%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(typeof%20flags%20!%3D%3D%20'undefined'%20%26%26%20currentDynamicChildren)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B0%86%E5%85%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%BD%93%E5%89%8D%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E9%9B%86%E5%90%88%0A%20%20%20%20%20%20%20%20currentDynamicChildren.push(vnode)%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E6%9C%80%E5%90%8E%E9%87%8D%E6%96%B0%E8%AE%BE%E8%AE%A1%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E7%9A%84%E6%89%A7%E8%A1%8C%E6%96%B9%E5%BC%8F%0Arender()%20%7B%0A%20%20%20%20%2F%2F%201.%E4%BD%BF%E7%94%A8createBlock%E4%BB%A3%E6%9B%BFcreateVNode%E6%9D%A5%E5%88%9B%E5%BB%BABlock%0A%20%20%20%20%2F%2F%202.%E6%AF%8F%E5%BD%93%E8%B0%83%E7%94%A8createBLock%E4%B9%8B%E5%89%8D%EF%BC%8C%E5%85%88%E8%B0%83%E7%94%A8openBlock%0A%20%20%20%20return%20(openBoock()%2C%20createBlock('div'%2C%20null%2C%20%5B%0A%20%20%20%20%20%20%20%20createVNode('p'%2C%20%7B%20class%3A%20'foo'%20%7D%2C%20null%2C%201%20%2F*%20patch%20flag*%2F)%2C%0A%20%20%20%20%20%20%20%20createVNode('p'%2C%20%7B%20class%3A%20'bar'%20%7D%2C%20null)%2C%0A%20%20%20%20%5D))%0A%7D%0A%0Afunction%20createBlock(tag%2C%20props%2C%20children)%20%7B%0A%20%20%20%20%2F%2F%20block%E6%9C%AC%E8%B4%A8%E4%B8%8A%E4%B9%9F%E6%98%AF%E4%B8%80%E4%B8%AAvnode%0A%20%20%20%20const%20block%20%3D%20createVNode(tag%2C%20props%2C%20children)%0A%20%20%20%20%2F%2F%20%E5%B0%86%E5%BD%93%E5%89%8D%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E9%9B%86%E5%90%88%E4%BD%9C%E4%B8%BAblock.dynamicChildren%0A%20%20%20%20block.dynamicChildren%20%3D%20currentDynamicChildren%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%85%B3%E9%97%ADBlock%0A%20%20%20%20closeBlock()%0A%20%20%20%20%2F%2F%20%E8%BF%94%E5%9B%9E%0A%20%20%20%20return%20block%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%20%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%B6%E6%94%AF%E6%8C%81%0A%0A%60%60%60js%0A%2F%2F%20%E4%BC%A0%E7%BB%9F%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%B4%E6%96%B0%E6%96%B9%E5%BC%8F%0Afunction%20patchElement(n1%2C%20n2)%20%7B%0A%20%20%20%20const%20el%20%3D%20n2.el%20%3D%20n1.el%0A%20%20%20%20const%20oldProps%20%3D%20n1.props%0A%20%20%20%20const%20newProps%20%3D%20n2.props%0A%20%20%20%20for(const%20key%20in%20newProps)%20%7B%0A%20%20%20%20%20%20%20%20if%20(newProps%5Bkey%5D%20!%3D%3D%20oldProps%5Bkey%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patchProps(el%2C%20key%2C%20oldProps%5Bkey%5D%2C%20newProps%5Bkey%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20for(const%20key%20in%20oldProps)%20%7B%0A%20%20%20%20%20%20%20%20if%20(!(key%20in%20newProps))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20patchProps(el%2C%20key%2C%20oldProps%5Bkey%5D%2C%20null)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%A4%84%E7%90%86children%E6%97%B6%EF%BC%8C%E8%B0%83%E7%94%A8patchCHildren%E5%87%BD%E6%95%B0%0A%20%20%20%20patchChildren(n1%2C%20n2%2C%20el)%0A%7D%0A%0A%2F%2F%20%E6%9C%89%E4%BA%86dynamicChildren%E5%90%8E%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E5%AF%B9%E6%AF%94%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%0Afunction%20patchElement(n1%2C%20n2)%20%7B%0A%20%20%20%20const%20el%20%3D%20n2.el%20%3D%20n1.el%0A%20%20%20%20const%20oldProps%20%3D%20n1.props%0A%20%20%20%20const%20newProps%20%3D%20n2.props%0A%20%20%20%20%0A%20%20%20%20for(const%20key%20in%20newProps)%20%7B%0A%20%20%20%20%20%20%20%20if%20(newProps%5Bkey%5D%20!%3D%3D%20oldProps%5Bkey%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patchProps(el%2C%20key%2C%20oldProps%5Bkey%5D%2C%20newProps%5Bkey%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20for(const%20key%20in%20oldProps)%20%7B%0A%20%20%20%20%20%20%20%20if%20(!(key%20in%20newProps))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20patchProps(el%2C%20key%2C%20oldProps%5Bkey%5D%2C%20null)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(n2.dynamicChildren)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8patchBlockChildren%E5%87%BD%E6%95%B0%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%8F%AA%E4%BC%9A%E6%9B%B4%E6%96%B0%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20patchBlockChildren(n1%2C%20n2)%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20patchChildren(n1%2C%20n2%2C%20el)%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20function%20patchBlockChildren(n1%2C%20n2)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%8F%AA%E6%9B%B4%E6%96%B0%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%200%3B%20i%20%3C%20n2.dynamicChildren.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patchElement(n1.dynamicChildren%5Bi%5D%2C%20n2.dynamicChildren%5Bi%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%0A%2F%2F%20%E5%AF%B9%E4%BA%8E%E5%8D%95%E4%B8%AA%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E7%9A%84%E6%9B%B4%E6%96%B0%E5%8F%AF%E4%BB%A5%E9%92%88%E5%AF%B9%E6%80%A7%E5%9C%B0%E5%AE%8C%E6%88%90%E9%9D%B6%E5%90%91%E6%9B%B4%E6%96%B0%0Afunction%20patchElement(n1%2C%20n2)%20%7B%0A%20%20%20%20const%20el%20%3D%20n2.el%20%3D%20n1.el%0A%20%20%20%20const%20oldProps%20%3D%20n1.props%0A%20%20%20%20const%20newProps%20%3D%20n2.props%0A%20%20%20%20%0A%20%20%20%20if%20(n2.patchFlags)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E9%9D%B6%E5%90%91%E6%9B%B4%E6%96%B0%0A%20%20%20%20%20%20%20%20if%20(n2.patchFlags%20%3D%3D%3D%201)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(n2.patchFlags%20%3D%3D%3D%202)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(...)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%85%A8%E9%87%8F%E6%9B%B4%E6%96%B0%0A%20%20%20%20%20%20%20%20for(const%20key%20in%20newProps)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(newProps%5Bkey%5D%20!%3D%3D%20oldProps%5Bkey%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patchProps(el%2C%20key%2C%20oldProps%5Bkey%5D%2C%20newProps%5Bkey%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20for(const%20key%20in%20oldProps)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(!(key%20in%20newProps))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patchProps(el%2C%20key%2C%20oldProps%5Bkey%5D%2C%20null)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(n2.dynamicChildren)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8patchBlockChildren%E5%87%BD%E6%95%B0%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%8F%AA%E4%BC%9A%E6%9B%B4%E6%96%B0%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20patchBlockChildren(n1%2C%20n2)%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20patchChildren(n1%2C%20n2%2C%20el)%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20function%20patchBlockChildren(n1%2C%20n2)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%8F%AA%E6%9B%B4%E6%96%B0%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%200%3B%20i%20%3C%20n2.dynamicChildren.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20patchElement(n1.dynamicChildren%5Bi%5D%2C%20n2.dynamicChildren%5Bi%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%0A%23%23%23%23%20Block%E6%A0%91%0A%0A%3E%20%E4%B9%8B%E5%89%8D%E7%BA%A6%E5%AE%9A%E7%BB%84%E4%BB%B6%E6%A8%A1%E7%89%88%E7%9A%84%E6%A0%B9%E8%8A%82%E7%82%B9%E5%BF%85%E9%A1%BB%E4%BD%9C%E4%B8%BABlock%E8%A7%92%E8%89%B2%E3%80%82%E8%BF%99%E6%A0%B7%EF%BC%8C%E4%BB%8E%E6%A0%B9%E8%8A%82%E7%82%B9%E5%BC%80%E5%A7%8B%EF%BC%8C%E6%89%80%E6%9C%89%E5%8A%A8%E6%80%81%E5%AD%90%E4%BB%A3%E8%8A%82%E7%82%B9%E9%83%BD%E4%BC%9A%E8%A2%AB%E6%94%B6%E9%9B%86%E5%88%B0%E6%A0%B9%E8%8A%82%E7%82%B9%E7%9A%84dynamicChildren%E6%95%B0%E7%BB%84%E4%B8%AD%E3%80%82%E4%BD%86%E6%98%AF%E5%A6%82%E6%9E%9C%E5%8F%AA%E6%9C%89%E6%A0%B9%E8%8A%82%E7%82%B9%E6%98%AFBlock%E8%A7%92%E8%89%B2%EF%BC%8C%E6%98%AF%E4%B8%8D%E4%BC%9A%E5%BD%A2%E6%88%90BLock%E6%A0%91%E7%9A%84%E3%80%82%0A%3E%20%E6%97%A2%E7%84%B6%E6%98%AFBlock%E6%A0%91%EF%BC%8C%E5%B0%B1%E6%84%8F%E5%91%B3%E7%9D%80%E8%BF%98%E4%BC%9A%E6%9C%89%E5%85%B6%E4%BB%96%E7%89%B9%E6%AE%8A%E8%8A%82%E7%82%B9%E5%85%85%E5%BD%93Block%E8%A7%92%E8%89%B2%0A%3E%20%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E5%B8%A6%E6%9C%89%E7%BB%93%E6%9E%84%E5%8C%96%E6%8C%87%E4%BB%A4%E7%9A%84%E8%8A%82%E7%82%B9%EF%BC%8C%E5%A6%82v-if%E5%92%8Cv-for%E6%8C%87%E4%BB%A4%E7%9A%84%E8%8A%82%E7%82%B9%E9%83%BD%E5%BA%94%E8%AF%A5%E4%BD%9C%E4%B8%BABlock%E8%A7%92%E8%89%B2%0A%0A%0A%0A%23%23%23%23%23%20%E5%B8%A6%E6%9C%89v-if%E6%8C%87%E4%BB%A4%E7%9A%84%E8%8A%82%E7%82%B9%0A%60%60%60js%0A%2F*%0A%3Cdiv%3E%0A%20%20%20%20%3Csection%20v-if%3D%22foo%22%3E%0A%20%20%20%20%20%20%20%20%3Cp%3E%7B%7B%20a%20%7D%7D%20%3C%2Fp%3E%0A%20%20%20%20%3C%2Fsection%3E%0A%20%20%20%20%3Cdiv%20v-else%3E%0A%20%20%20%20%20%20%20%20%3Cp%3E%7B%7B%20a%20%7D%7D%3C%2Fp%3E%0A%20%20%20%20%3C%2Fdiv%3E%0A%3C%2Fdiv%3E%0A*%2F%0A%2F%2F%20%E4%B8%8A%E9%9D%A2%E5%BD%93%E5%8F%98%E9%87%8Ffoo%E6%98%AFtrue%E6%97%B6%EF%BC%8C%E6%94%B6%E9%9B%86%E5%88%B0%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E6%98%AF%0Aconst%20block%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20ctx.a%2C%20patchFlags%3A%201%20%7D%0A%20%20%20%20%5D%0A%20%20%20%20%2F%2F%20...%0A%7D%0A%2F%2F%20%E4%B8%8A%E9%9D%A2%E5%BD%93%E5%8F%98%E9%87%8Ffoo%E6%98%AFfalse%E6%97%B6%EF%BC%8C%E6%94%B6%E9%9B%86%E5%88%B0%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E6%98%AF%0Aconst%20block%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20ctx.a%2C%20patchFlags%3A%201%20%7D%0A%20%20%20%20%5D%0A%20%20%20%20%2F%2F%20...%0A%7D%0A%0A%2F%2F%20%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%EF%BC%8C%E6%97%A0%E8%AE%BA%E5%8F%98%E9%87%8Ffoo%E6%98%AFtrue%E8%BF%98%E6%98%AFfalse%EF%BC%8Cblock%E6%89%80%E6%94%B6%E9%9B%86%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E6%98%AF%E4%B8%8D%E5%8F%98%E7%9A%84%E3%80%82%E8%BF%99%E6%84%8F%E5%91%B3%E7%9D%80%EF%BC%8C%E5%9C%A8Diff%E9%98%B6%E6%AE%B5%E4%B8%8D%E4%BC%9A%E5%81%9A%E4%BB%BB%E4%BD%95%E6%9B%B4%E6%96%B0%0A%2F%2F%20%E4%BD%86%E6%98%AF%E5%B8%A6%E6%9C%89v-if%E6%8C%87%E4%BB%A4%E7%9A%84%E6%98%AFSection%EF%BC%8C%E5%B8%A6%E6%9C%89v-else%E7%9A%84%E6%98%AFdiv%E3%80%82%E5%BE%88%E6%98%8E%E6%98%BE%EF%BC%8C%E6%9B%B4%E6%96%B0%E5%89%8D%E5%90%8E%E7%9A%84%E6%A0%87%E7%AD%BE%E4%B8%8D%E5%90%8C%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%81%9A%E4%BB%BB%E4%BD%95%E6%9B%B4%E6%96%B0%E5%B0%86%E4%BA%A7%E7%94%9F%E4%B8%A5%E9%87%8D%E7%9A%84bug%0A%0A%2F%2F%20%E4%BA%A7%E7%94%9F%E8%BF%99%E4%BA%9B%E9%97%AE%E9%A2%98%E7%9A%84%E5%8E%9F%E5%9B%A0%E5%9C%A8%E4%BA%8E%EF%BC%8CdynamicChildren%E6%95%B0%E7%BB%84%E4%B8%AD%E6%94%B6%E9%9B%86%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E6%98%AF%E5%BF%BD%E7%95%A5%E8%99%9A%E6%8B%9FDOM%E6%A0%91%E5%B1%82%E7%BA%A7%E7%9A%84%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%BF%85%E9%A1%BB%E8%A6%81%E8%AE%A9%E5%B8%A6%E6%9C%89v-if%2Fv-else-if%2Fv-else%E7%AD%89%E7%BB%93%E6%9E%84%E5%8C%96%E6%8C%87%E4%BB%A4%E7%9A%84%E8%8A%82%E7%82%B9%E4%B9%9F%E4%BD%9C%E4%B8%BABlock%E8%A7%92%E8%89%B2%0A%0A%2F*%0ABlock(Div)%0A%20%20%20%20-%20Block(Section%20v-if)%0A%20%20%20%20-%20BLock(Div%20v-else)%0A*%2F%0A%0A%2F%2F%20%E7%88%B6%E7%BA%A7Block%E9%99%A4%E4%BA%86%E4%BC%9A%E6%94%B6%E9%9B%86%E5%8A%A8%E6%80%81%E5%AD%90%E4%BB%A3%E8%8A%82%E7%82%B9%E5%A4%96%EF%BC%8C%E4%B9%9F%E4%BC%9A%E6%94%B6%E9%9B%86%E5%AD%90Block%EF%BC%8C%E4%B8%A4%E4%B8%AA%E5%AD%90Block%E5%B0%86%E4%BD%9C%E4%B8%BA%E7%88%B6%E7%BA%A7Block%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E8%A2%AB%E6%94%B6%E9%9B%86%E5%88%B0%E7%88%B6%E7%BA%A7%E7%9A%84dynamicChildren%E6%95%B0%E7%BB%84%E4%B8%AD%0A%0Aconst%20block%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'section'%2C%20%7B%20key%3A%200%20%2F*%20key%E5%80%BC%E4%BC%9A%E6%A0%B9%E6%8D%AE%E4%B8%8D%E5%90%8C%E7%9A%84Block%E8%80%8C%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%20*%2F%20%7D%2C%20dynamicChildren%3A%20%5B...%5D%7D%0A%20%20%20%20%5D%0A%7D%0A%2F%2F%20%E5%9C%A8Diff%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E6%B8%B2%E6%9F%93%E5%99%A8%E8%83%BD%E5%A4%9F%E6%A0%B9%E6%8D%AEBlock%E7%9A%84key%E5%80%BC%E5%8C%BA%E5%88%86%E5%87%BA%E6%9B%B4%E6%96%B0%E5%89%8D%E5%90%8E%E7%9A%84%E4%B8%A4%E4%B8%AABlock%E6%98%AF%E4%B8%8D%E5%90%8C%E7%9A%84%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8%E6%96%B0%E7%9A%84Block%E6%9B%BF%E6%8D%A2%E6%97%A7%E7%9A%84Block%0A%60%60%60%0A%0A%0A%23%23%23%23%23%20%E5%B8%A6%E6%9C%89v-for%E6%8C%87%E4%BB%A4%E7%9A%84%E8%8A%82%E7%82%B9%0A%60%60%60js%0A%2F*%0A%3Cdiv%3E%0A%20%20%20%20%3Cp%20v-for%3D%22item%20in%20list%22%3E%7B%7B%20item%20%7D%7D%3C%2Fp%3E%0A%20%20%20%20%3Ci%3E%7B%7B%20foo%20%7D%7D%3C%2Fi%3E%0A%20%20%20%20%3Ci%3E%7B%7B%20bar%20%7D%7D%3C%2Fi%3E%0A%3C%2Fdiv%3E%0A*%2F%0A%2F%2F%20list%E6%98%AF%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%EF%BC%8Clist%E6%95%B0%E7%BB%84%E7%94%B1%5B1%2C2%5D%E6%9B%B4%E6%96%B0%E4%B8%BA%5B1%5D%0A%2F%2F%20%E6%9B%B4%E6%96%B0%E5%89%8D%0Aconst%20prevBlock%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%201%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%202%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.foo%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.bar%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%5D%0A%7D%0A%2F%2F%20%E6%9B%B4%E6%96%B0%E5%90%8E%0Aconst%20nextBlock%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%201%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.foo%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.bar%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%5D%0A%7D%0A%0A%2F%2F%20%E6%9B%B4%E6%96%B0%E5%89%8D4%E4%B8%AA%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%EF%BC%8C%E6%9B%B4%E6%96%B0%E5%90%8E3%E4%B8%AA%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E3%80%82%E5%9B%A0%E4%B8%BAdynamicChildren%E5%86%85%E7%9A%84%E8%8A%82%E7%82%B9%E6%9C%AA%E5%BF%85%E6%98%AF%E5%90%8C%E7%BA%A7%E7%9A%84%EF%BC%8C%E6%89%80%E4%BB%A5%E4%B8%8D%E8%83%BD%E8%BF%9B%E8%A1%8CDiff%E6%93%8D%E4%BD%9C%0A%0A%2F%2F%20%E4%BD%BFv-for%E4%B9%9F%E6%98%AF%E4%B8%80%E4%B8%AABlock%0A%2F%2F%20%E7%94%B1%E4%BA%8Ev-for%E6%8C%87%E4%BB%A4%E6%B8%B2%E6%9F%93%E7%9A%84%E6%98%AF%E4%B8%80%E4%B8%AA%E7%89%87%E6%AE%B5%EF%BC%8C%E5%9B%A0%E6%AD%A4%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E7%B1%BB%E5%9E%8B%E4%B8%BAFragment%E7%9A%84%E8%8A%82%E7%82%B9%0Aconst%20block%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20Fragment%2C%20dynamicChildren%3A%20%5B%2F*%20v-for%E7%9A%84%E8%8A%82%E7%82%B9%20*%2F%5D%20%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.foo%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.bar%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%5D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%20Fragment%E7%9A%84%E7%A8%B3%E5%AE%9A%E6%80%A7%0A%0A%60%60%60js%0A%2F%2F%20%E6%9B%B4%E6%96%B0%E5%89%8D%0Aconst%20prevBlock%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20Fragment%2C%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20item%2C%201%20%2F*TEXT*%2F%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20item%2C%202%20%2F*TEXT*%2F%20%7D%0A%20%20%20%20%20%20%20%20%5D%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.foo%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.bar%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%5D%0A%7D%0A%2F%2F%20%E6%9B%B4%E6%96%B0%E5%90%8E%0Aconst%20nextBlock%20%3D%20%7B%0A%20%20%20%20tag%3A%20'div'%2C%0A%20%20%20%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20Fragment%2C%20dynamicChildren%3A%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20item%2C%201%20%2F*TEXT*%2F%20%7D%0A%20%20%20%20%20%20%20%20%5D%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.foo%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'i'%2C%20children%3A%20ctx.bar%2C%201%20%2F*%20TEXT%20*%2F%7D%2C%0A%20%20%20%20%5D%0A%7D%0A%0A%2F%2F%20%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%EF%BC%8CFragment%E6%9C%AC%E8%BA%AB%E6%94%B6%E9%9B%86%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E4%BB%8D%E7%84%B6%E9%9D%A2%E4%B8%B4%E7%BB%93%E6%9E%84%E4%B8%8D%E7%A8%B3%E5%AE%9A%E7%9A%84%E6%83%85%E5%86%B5%E3%80%82%0A%2F%2F%20%E6%89%80%E8%B0%93%E7%BB%93%E6%9E%84%E4%B8%8D%E7%A8%B3%E5%AE%9A%EF%BC%8C%E4%BB%8E%E7%BB%93%E6%9E%9C%E4%B8%8A%E7%9C%8B%EF%BC%8C%E6%8C%87%E7%9A%84%E6%98%AF%E6%9B%B4%E6%96%B0%E5%89%8D%E5%90%8E%E4%B8%80%E4%B8%AAblock%E7%9A%84dynamicChildren%E6%95%B0%E7%BB%84%E4%B8%AD%E6%94%B6%E9%9B%86%E7%9A%84%E8%8A%82%E7%82%B9%E6%95%B0%E9%87%8F%E6%88%96%E9%A1%BA%E5%BA%8F%E4%B8%8D%E4%B8%80%E8%87%B4%0A%2F%2F%20%E8%BF%99%E7%A7%8D%E4%B8%8D%E4%B8%80%E8%87%B4%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%97%A0%E6%B3%95%E8%BF%9B%E8%A1%8C%E9%9D%B6%E5%90%91%E6%9B%B4%E6%96%B0%0A%2F%2F%20%E4%BD%86%E6%98%AF%E9%92%88%E5%AF%B9%E8%BF%99%E7%A7%8D%E6%83%85%E5%86%B5%EF%BC%8C%E6%B2%A1%E6%9C%89%E6%9B%B4%E5%A5%BD%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%E3%80%82%E5%8F%AA%E8%83%BD%E5%9B%9E%E9%80%80%E5%88%B0%E4%BC%A0%E7%BB%9F%E8%99%9A%E6%8B%9FDOM%E7%9A%84Diff%E6%89%8B%E6%AE%B5%EF%BC%8C%E5%8D%B3%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8Fragment%E7%9A%84children%E8%80%8C%E9%9D%9EdynamicChildren%E6%9D%A5%E8%BF%9B%E8%A1%8CDiff%E6%93%8D%E4%BD%9C%0A%0A%2F%2F%20%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%EF%BC%8CFragment%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9(children)%E4%BB%8D%E7%84%B6%E5%8F%AF%E4%BB%A5%E6%98%AF%E7%94%B1Block%E7%BB%84%E6%88%90%E7%9A%84%E6%95%B0%E7%BB%84%0Aconst%20block%20%3D%20%7B%0A%20%20%20%20tag%3A%20Fragment%2C%0A%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20item%2C%20dynamicChildren%3A%20%5B%2F*...*%2F%5D%2C%201%20%2F*%20TEXT%20*%2F%20%7D%2C%0A%20%20%20%20%20%20%20%20%7B%20tag%3A%20'p'%2C%20children%3A%20item%2C%20dynamicChildren%3A%20%5B%2F*...*%2F%5D%2C%201%20%2F*%20TEXT%20*%2F%20%7D%2C%0A%20%20%20%20%5D%0A%7D%0A%2F%2F%20%E8%BF%99%E6%A0%B7%EF%BC%8C%E5%BD%93Fragment%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E8%BF%9B%E8%A1%8C%E6%9B%B4%E6%96%B0%E6%97%B6%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E6%81%A2%E5%A4%8D%E4%BC%98%E5%8C%96%E6%A8%A1%E5%BC%8F%0A%60%60%60%0A%0A%23%23%23%23%20%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87%0A%3E%20%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87%E8%83%BD%E5%A4%9F%E5%87%8F%E5%B0%91%E6%9B%B4%E6%96%B0%E6%97%B6%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9FDOM%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80%E5%92%8C%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%0A%0A%60%60%60js%0A%2F*%0A%3Cdiv%3E%0A%20%20%20%20%3Cp%3Estatic%20text%3C%2Fp%3E%0A%20%20%20%20%3Cp%3E%7B%7B%20title%20%7D%7D%3C%2Fp%3E%0A%3C%2Fdiv%3E%0A*%2F%0A%0A%2F%2F%20%E5%9C%A8%E6%B2%A1%E6%9C%89%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E5%AF%B9%E5%BA%94%E7%9A%84%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%EF%BC%9A%0Afunction%20render()%20%7B%0A%20%20%20%20return%20(openBlock()%2C%20createBlock('div'%2C%20null%2C%20%5B%0A%20%20%20%20%20%20%20%20createVNode('p'%2C%20null%2C%20'static%20text')%2C%0A%20%20%20%20%20%20%20%20createVNode('p'%2C%20null%2C%20ctx.title%2C%201%20%2F*%20TEXT%20*%2F)%2C%0A%20%20%20%20%5D))%0A%7D%0A%0A%2F%2F%20%E5%BD%93%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AEtitle%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E6%97%B6%EF%BC%8C%E6%95%B4%E4%B8%AA%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E4%BC%9A%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%B9%B6%E4%BA%A7%E7%94%9F%E6%96%B0%E7%9A%84%E8%99%9A%E6%8B%9FDOM%E3%80%82%E8%BF%99%E4%B8%AA%E8%BF%87%E7%A8%8B%E4%BC%9A%E6%9C%89%E4%B8%80%E4%B8%AA%E6%98%8E%E6%98%BE%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E5%8D%B3%E7%BA%AF%E9%9D%99%E6%80%81%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E5%9C%A8%E6%9B%B4%E6%96%B0%E6%97%B6%E4%B9%9F%E4%BC%9A%E8%A2%AB%E9%87%8D%E6%96%B0%E5%88%9B%E5%BB%BA%E4%B8%80%E6%AC%A1%EF%BC%8C%E8%BF%99%E6%98%AF%E6%B2%A1%E6%9C%89%E5%BF%85%E8%A6%81%E7%9A%84%0A%2F%2F%20%E5%9B%A0%E6%AD%A4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E5%B0%B1%E6%98%AF%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87%EF%BC%8C%E5%8D%B3%E6%8A%8A%E7%BA%AF%E9%9D%99%E6%80%81%E7%9A%84%E8%8A%82%E7%82%B9%E6%8F%90%E5%8D%87%E5%88%B0%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E4%B9%8B%E5%A4%96%0Aconst%20hoist1%20%3D%20createVNode('p'%2C%20null%2C%20'text')%0A%0Afunction%20render()%20%7B%0A%20%20%20%20return%20(openBlock()%2C%20createBlock('div'%2C%20null%2C%20%5B%0A%20%20%20%20%20%20%20%20hoist1%2C%20%2F%2F%20%E9%9D%99%E6%80%81%E8%8A%82%E7%82%B9%E5%BC%95%E7%94%A8%0A%20%20%20%20%20%20%20%20createVNode('p'%2C%20null%2C%20ctx.title%2C%201%20%2F*%20TEXT%20*%2F)%2C%0A%20%20%20%20%5D))%0A%7D%0A%0A%2F%2F%20%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%EF%BC%8C%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87%E6%98%AF%E4%BB%A5%E6%A0%91%E4%B8%BA%E5%8D%95%E4%BD%8D%E7%9A%84%E3%80%82%0A%2F*%0A%3Cdiv%3E%0A%20%20%20%20%3Csection%3E%0A%20%20%20%20%20%20%20%20%3Cp%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cspan%3Eabc%3C%2Fspan%3E%0A%20%20%20%20%20%20%20%20%3C%2Fp%3E%0A%20%20%20%20%3C%2Fsection%3E%0A%3C%2Fdiv%3E%0A%E8%BF%99%E9%87%8C%E9%99%A4%E4%BA%86%E6%A0%B9%E8%8A%82%E7%82%B9%E4%BC%9A%E4%BD%9C%E4%B8%BABLock%E8%A7%92%E8%89%B2%E8%80%8C%E4%B8%8D%E5%8F%AF%E8%A2%AB%E6%8F%90%E5%8D%87%E5%A4%96%EF%BC%8C%E6%95%B4%E4%B8%AA%3Csection%3E%E5%85%83%E7%B4%A0%E5%8F%8A%E5%85%B6%E5%AD%90%E4%BB%A3%E8%8A%82%E7%82%B9%E9%83%BD%E4%BC%9A%E8%A2%AB%E6%8F%90%E5%8D%87%0A*%2F%0A%0A%2F%2F%20%E8%99%BD%E7%84%B6%E5%8C%85%E5%90%AB%E5%8A%A8%E6%80%81%E7%BB%91%E5%AE%9A%E7%9A%84%E8%8A%82%E7%82%B9%E6%9C%AC%E8%BA%AB%E4%B8%8D%E4%BC%9A%E8%A2%AB%E6%8F%90%E5%8D%87%EF%BC%8C%E4%BD%86%E6%98%AF%E8%AF%A5%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E4%B8%8A%E4%BB%8D%E7%84%B6%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E7%BA%AF%E9%9D%99%E6%80%81%E7%9A%84%E5%B1%9E%E6%80%A7%0A%2F*%0A%3Cdiv%3E%0A%20%20%20%20%3Cp%20foo%3D%22bar%22%20a%3Db%3E%7B%7B%20text%20%7D%7D%3C%2Fp%3E%0A%3C%2Fdiv%3E%0A*%2F%0A%2F%2F%20%E5%8F%AF%E4%BB%A5%E5%B0%86%E7%BA%AF%E9%9D%99%E6%80%81%E7%9A%84props%E6%8F%90%E5%8D%87%E5%88%B0%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E4%B9%8B%E5%A4%96%0Aconst%20hoistProp%20%3D%20%7B%20foo%3A%20'bar'%2C%20a%3A%20'b'%20%7D%0A%0Afunction%20render(ctx)%20%7B%0A%20%20%20%20return%20(openBlock()%2C%20createBlock('div'%2C%20null%2C%20%5B%0A%20%20%20%20%20%20%20%20createVNode('p'%2C%20hoistProp%2C%20ctx.text)%0A%20%20%20%20%5D))%0A%7D%0A%2F%2F%20%E8%BF%99%E6%A0%B7%E5%81%9A%E5%90%8C%E6%A0%B7%E5%8F%AF%E4%BB%A5%E5%87%8F%E5%B0%91%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9FDOM%E4%BA%A7%E7%94%9F%E7%9A%84%E5%BC%80%E9%94%80%E4%BB%A5%E5%8F%8A%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%0A%60%60%60%0A%0A%0A%23%23%23%23%20%E9%A2%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%96%0A%3E%20%E5%9F%BA%E4%BA%8E%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E8%BF%9B%E4%B8%80%E6%AD%A5%E9%87%87%E7%94%A8%E9%A2%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%96%E7%9A%84%E4%BC%98%E5%8C%96%E6%89%8B%E6%AE%B5%0A%3E%20%E9%A2%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%96%E6%98%AF%E5%9F%BA%E4%BA%8E%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87%E7%9A%84%E4%B8%80%E7%A7%8D%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5%0A%0A%60%60%60js%0A%2F*%0A%3Cdiv%3E%0A%20%20%20%20%3Cp%3E%3C%2Fp%3E%20%20%20%20%0A%20%20%20%20%3Cp%3E%3C%2Fp%3E%20%20%20%20%0A%20%20%20%20%3Cp%3E%3C%2Fp%3E%20%20%20%20%0A%20%20%20%20...%0A%3C%2Fdiv%0A*%2F%0A%2F%2F%20%E4%B8%8A%E9%9D%A2%E6%A8%A1%E7%89%88%E5%8C%85%E5%90%AB%E5%A4%A7%E9%87%8F%E9%9D%99%E6%80%81%E8%8A%82%E7%82%B9%EF%BC%8C%E5%BD%93%E9%87%87%E7%94%A8%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87%E4%BC%98%E5%8C%96%E6%97%B6%EF%BC%8C%E7%BC%96%E8%AF%91%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%0Aconst%20hoist1%20%3D%20createVNode('p'%2C%20null%2C%20null%2C%20PatchFlags.HOISTED)%0Aconst%20hoist2%20%3D%20createVNode('p'%2C%20null%2C%20null%2C%20PatchFlags.HOISTED)%0A...%0A%0Arender()%20%7B%0A%20%20%20%20return%20(openBlock()%2C%20createBlock('div'%2C%20null%2C%20%5B%0A%20%20%20%20%20%20%20%20hoist1%2C%20hoist2%2C%20...%0A%20%20%20%20%5D))%0A%7D%0A%0A%2F%2F%20%E9%A2%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%96%E8%83%BD%E5%A4%9F%E5%B0%86%E8%BF%99%E4%BA%9B%E9%9D%99%E6%80%81%E8%8A%82%E7%82%B9%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E5%B9%B6%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AAStatic%E7%B1%BB%E5%9E%8B%E7%9A%84VNode%0Aconst%20hoistStatic%20%3D%20createStatickVNode('%3Cp%3E%3C%2Fp%3E%3Cp%3E%3C%2Fp%3E.....%3Cp%3E%3C%2Fp%3E')%0Arender()%20%7B%0A%20%20%20%20return%20(openBlock()%2C%20createBlock('div'%2C%20null%2C%20%5B%0A%20%20%20%20%20%20%20%20hoistStatic%0A%20%20%20%20%5D))%0A%7D%0A%0A%2F%2F%20%E8%BF%99%E4%B9%88%E5%81%9A%E7%9A%84%E4%BC%98%E5%8A%BF%E6%9C%89%EF%BC%9A%0A%2F%2F%201.%E5%A4%A7%E5%9D%97%E7%9A%84%E9%9D%99%E6%80%81%E5%86%85%E5%AE%B9%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87innerHTML%E8%BF%9B%E8%A1%8C%E8%AE%BE%E7%BD%AE%EF%BC%8C%E5%9C%A8%E6%80%A7%E8%83%BD%E4%B8%8A%E6%9C%89%E4%B8%80%E5%AE%9A%E4%BC%98%E5%8A%BF%0A%2F%2F%202.%E5%87%8F%E5%B0%91%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E4%BA%A7%E7%94%9F%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80%0A%2F%2F%203.%E8%BE%83%E5%B0%91%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%0A%60%60%60%0A%0A%23%23%23%23%20%E7%BC%93%E5%AD%98%E5%86%85%E8%81%94%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%0A%3E%20%E7%BC%93%E5%AD%98%E5%86%85%E8%81%94%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E6%9B%B4%E6%96%B0%0A%0A%60%60%60js%0A%2F*%0A%3CComp%20%40change%3D%22a%2Bb%22%2F%3E%0A*%2F%0A%2F%2F%20%E4%B8%8A%E9%9D%A2%E7%BC%96%E8%AF%91%E5%90%8E%0Afunction%20render(ctx)%20%7B%0A%20%20%20%20return%20h(Comp%2C%20%7B%0A%20%20%20%20%20%20%20%20onChange%3A%20()%20%3D%3E%20(ctx.a%20%2B%20ctx.b)%0A%20%20%20%20%7D)%0A%7D%0A%0A%2F%2F%20%E5%BE%88%E6%98%BE%E7%84%B6%EF%BC%8C%E6%AF%8F%E6%AC%A1%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%EF%BC%8C%E9%83%BD%E4%BC%9A%E4%B8%BAComp%E7%BB%84%E4%BB%B6%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%85%A8%E6%96%B0%E7%9A%84props%E5%AF%B9%E8%B1%A1%E3%80%82%E5%90%8C%E6%97%B6%EF%BC%8Cprops%E4%B8%AD%E7%9A%84onChange%E4%B9%9F%E4%BC%9A%E6%98%AF%E5%85%A8%E6%96%B0%E7%9A%84%E5%87%BD%E6%95%B0%E3%80%82%E8%BF%99%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%B8%B2%E6%9F%93%E5%99%A8%E5%AF%B9Comp%E7%BB%84%E4%BB%B6%E8%BF%9B%E8%A1%8C%E6%9B%B4%E6%96%B0%EF%BC%8C%E9%80%A0%E6%88%90%E9%A2%9D%E5%A4%96%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80%0A%0Afunction%20render(ctx%2C%20cache)%20%7B%0A%20%20%20%20return%20h(Comp%2C%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%86%E5%86%85%E8%81%94%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E7%BC%93%E5%AD%98%E5%88%B0cache%E6%95%B0%E7%BB%84%E4%B8%AD%0A%20%20%20%20%20%20%20%20%2F%2F%20cache%E6%95%B0%E7%BB%84%E6%9D%A5%E8%87%AA%E7%BB%84%E4%BB%B6%E5%AE%9E%E4%BE%8B%0A%20%20%20%20%20%20%20%20onChange%3A%20cache%5B0%5D%20%7C%7C%20(cache%5B0%5D%20%3D%20(%24event)%20%3D%3E%20(ctx.a%20%2B%20ctx.b))%0A%20%20%20%20%7D)%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20v-once%0A%0A%3E%20Vue3%E4%B8%8D%E4%BB%85%E4%BC%9A%E7%BC%93%E5%AD%98%E5%86%85%E8%81%94%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%EF%BC%8C%E9%85%8D%E5%90%88v-once%E8%BF%98%E5%8F%AF%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%99%9A%E6%8B%9FDOM%E7%9A%84%E7%BC%93%E5%AD%98%E3%80%82%0A%0A%60%60%60js%0A%2F*%0A%3Csection%3E%0A%20%20%20%20%3Cdiv%20v-once%3E%7B%7B%20foo%20%7D%7D%3C%2Fdiv%3E%0A%3C%2Fsection%3E%0A*%2F%0A%0A%2F%2F%20%E7%BC%96%E8%AF%91%E5%90%8E%0Afunction%20render(ctx%2C%20cache)%20%7B%0A%20%20%20%20return%20(openBlock()%2C%20createBlock('div'%2C%20null%2C%20%5B%0A%20%20%20%20%20%20%20%20cache%5B1%5D%20%7C%7C%20(cache%5B1%5D%20%3D%20createVNode('div'%2C%20null%2C%20ctx.foo%2C%201%20%2F*%20TEXT%20*%2F))%0A%20%20%20%20%5D))%0A%7D%0A%0A%2F%2F%20%E5%9B%A0%E6%AD%A4%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E4%BC%9A%E4%BC%98%E5%85%88%E8%AF%BB%E5%8F%96%E7%BC%93%E5%AD%98%EF%BC%8C%E4%B9%9F%E4%B8%8D%E9%9C%80%E8%A6%81%E5%8F%82%E4%B8%8EDiff%E6%93%8D%E4%BD%9C%E4%BA%86%0A%2F%2F%20%E5%AE%9E%E9%99%85%E7%BC%96%E8%AF%91%E5%90%8E%0Afunction%20render(ctx%2C%20cache)%20%7B%0A%20%20%20%20return%20(openBlock()%2C%20createBlock('div'%2C%20null%2C%20%5B%0A%20%20%20%20%20%20%20%20cache%5B1%5D%20%7C%7C%20(%0A%20%20%20%20%20%20%20%20setBlockTracking(-1)%20%2F%2F%20%E9%98%BB%E6%AD%A2%E8%BF%99%E6%AE%B5VNode%E8%A2%ABBlock%E6%94%B6%E9%9B%86%0A%20%20%20%20%20%20%20%20(cache%5B1%5D%20%3D%20createVNode('div'%2C%20null%2C%20ctx.foo%2C%201%20%2F*%20TEXT%20*%2F))%2C%0A%20%20%20%20%20%20%20%20setBlockTracking(1)%2C%20%2F%2F%20%E6%81%A2%E5%A4%8D%0A%20%20%20%20%20%20%20%20cache%5B1%5D%20%2F%2F%20%E6%95%B4%E4%B8%AA%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%80%BC%0A%20%20%20%20%5D)))%0A%7D%0A%2F%2F%20setBlockTracking(-1)%E7%94%A8%E6%9D%A5%E6%9A%82%E5%81%9C%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E7%9A%84%E6%94%B6%E9%9B%86%E3%80%82%E5%8D%B3%E4%BD%BF%E7%94%A8V-once%E5%8C%85%E8%A3%B9%E7%9A%84%E5%8A%A8%E6%80%81%E8%8A%82%E7%82%B9%E4%B8%8D%E4%BC%9A%E8%A2%AB%E7%88%B6%E7%BA%A7Block%E6%94%B6%E9%9B%86%0A%0A%2F%2F%20v-once%E9%80%9A%E5%B8%B8%E7%94%A8%E4%BA%8E%E4%B8%8D%E4%BC%9A%E5%8F%91%E7%94%9F%E6%94%B9%E5%8F%98%E7%9A%84%E5%8A%A8%E6%80%81%E7%BB%91%E5%AE%9A%E4%B8%AD%EF%BC%8C%E4%BE%8B%E5%A6%82%E7%BB%91%E5%AE%9A%E4%B8%80%E4%B8%AA%E5%B8%B8%E9%87%8F%EF%BC%8C%E4%B8%BA%E4%BA%86%E6%8F%90%E5%8D%87%E6%80%A7%E8%83%BD%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8v-once%E6%9D%A5%E6%A0%87%E8%AE%B0%E8%BF%99%E6%AE%B5%E5%86%85%E5%AE%B9%0A%0A%2F%2F%20v-once%E4%BB%8E%E4%B8%A4%E4%B8%AA%E6%96%B9%E9%9D%A2%E6%8F%90%E5%8D%87%E6%80%A7%E8%83%BD%EF%BC%9A%0A%2F%2F%201.%E9%81%BF%E5%85%8D%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0%E6%97%B6%E9%87%8D%E6%96%B0%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9FDOM%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%80%A7%E8%83%BD%E5%BC%80%E9%94%80(cache)%0A%2F%2F%202.%E9%81%BF%E5%85%8D%E6%97%A0%E7%94%A8%E7%9A%84Diff%E5%BC%80%E9%94%80(v-once)%0A%60%60%60%0A%0A%23%23%23%20%E7%AC%AC%E5%85%AD%E7%AF%87%E3%80%8A%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E3%80%8B%0A%0A%23%23%23%23%20%E7%AC%AC18%E7%AB%A0%E3%80%8A%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E3%80%8B%0A%3E%20Vue%E5%8F%AF%E4%BB%A5%E5%9C%A8Nodejs%E7%8E%AF%E5%A2%83%E4%B8%AD%E8%BF%90%E8%A1%8C%EF%BC%8C%E5%AE%83%E5%8F%AF%E4%BB%A5%E5%B0%86%E5%90%8C%E6%A0%B7%E7%9A%84%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B9%B6%E5%8F%91%E9%80%81%E7%BB%99%E6%B5%8F%E8%A7%88%E5%99%A8%E3%80%82%0A%3E%20Vue%E4%B8%8D%E4%BB%85%E8%83%BD%E5%A4%9F%E7%8B%AC%E7%AB%8B%E5%9C%B0%E8%BF%9B%E8%A1%8CCSR%E6%88%96SSR%EF%BC%8C%E8%BF%98%E8%83%BD%E5%A4%9F%E5%B0%86%E4%B8%A4%E8%80%85%E7%BB%93%E5%90%88%EF%BC%8C%E5%BD%A2%E6%88%90%E6%89%80%E8%B0%93%E7%9A%84**%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93**%0A%0A%23%23%23%23%23%20CSR%E3%80%81SSR%E4%BB%A5%E5%8F%8A%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%0A%0A%3E%20%E5%9C%A8Web2.0%E4%B9%8B%E5%89%8D%EF%BC%8C%E7%BD%91%E7%AB%99%E4%B8%BB%E8%A6%81%E8%B4%9F%E8%B4%A3%E6%8F%90%E4%BE%9B%E5%90%84%E7%A7%8D%E5%86%85%E5%AE%B9%EF%BC%8C%E5%8C%85%E6%8B%AC%E5%8D%9A%E5%AE%A2%E3%80%81%E6%96%B0%E9%97%BB%E3%80%81%E5%B0%8F%E8%AF%B4%E7%AD%89%E3%80%82%E8%BF%99%E4%BA%9B%E7%AB%99%E7%82%B9%E4%B8%BB%E8%A6%81%E5%BC%BA%E8%B0%83%E5%86%85%E5%AE%B9%E6%9C%AC%E8%BA%AB%EF%BC%8C%E8%80%8C%E4%B8%8D%E5%BC%BA%E8%B0%83%E4%B8%8E%E7%94%A8%E6%88%B7%E7%9A%84%E4%BA%A4%E4%BA%92%E3%80%82%E5%BD%93%E6%97%B6%E7%9A%84%E7%AB%99%E7%82%B9%E5%9F%BA%E6%9C%AC%E9%87%87%E7%94%A8%E4%BC%A0%E7%BB%9F%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%8A%80%E6%9C%AF%E6%9D%A5%E5%AE%9E%E7%8E%B0%0A%0A%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%9A%0A-%20%E7%94%A8%E6%88%B7%E9%80%9A%E8%BF%87%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AF%B7%E6%B1%82%E7%AB%99%E7%82%B9%0A-%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%B7%E6%B1%82API%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%0A-%20%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E7%BB%99%E6%9C%8D%E5%8A%A1%E7%AB%AF%0A-%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A0%B9%E6%8D%AE%E6%A8%A1%E7%89%88%E5%92%8C%E8%8E%B7%E5%8F%96%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8B%BC%E6%8E%A5%E5%87%BA%E6%9C%80%E7%BB%88%E7%9A%84HTML%E5%AD%97%E7%AC%A6%E4%B8%B2%0A-%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%86HTML%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%91%E9%80%81%E7%BB%99%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A7%A3%E6%9E%90HTML%E5%86%85%E5%AE%B9%E5%B9%B6%E6%B8%B2%E6%9F%93%0A%0A%3E%20%E5%90%8E%E6%9D%A5AJAX%E4%B8%BA%E4%BB%A3%E8%A1%A8%EF%BC%8C%E5%82%AC%E7%94%9F%E4%BA%86Web2.0%E3%80%82%E5%A4%A7%E9%87%8F%E7%9A%84SPA%E8%AF%9E%E7%94%9F%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AFCSR%EF%BC%8C%E4%B8%8ESSR%E4%B8%8D%E5%90%8C%EF%BC%8CCSR%E6%97%B6%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E5%AE%8C%E6%88%90%E6%A8%A1%E7%89%88%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%9A%84%E8%9E%8D%E5%90%88%EF%BC%8C%E5%B9%B6%E6%B8%B2%E6%9F%93%E5%87%BA%E6%9C%80%E7%BB%88%E7%9A%84HTML%E9%A1%B5%E9%9D%A2%0A%0ACSR%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%9A%0A-%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%88%96CDN%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%EF%BC%8C%E8%8E%B7%E5%8F%96%E9%9D%99%E6%80%81%E7%9A%84HTML%E9%A1%B5%E9%9D%A2%E3%80%82%E9%80%9A%E5%B8%B8%E6%AD%A4%E6%97%B6%E7%9A%84HTML%E6%98%AF%E7%A9%BA%E9%A1%B5%E9%9D%A2%EF%BC%8C%E6%AD%A4%E6%97%B6%E9%A1%B5%E9%9D%A2%E5%A4%84%E4%BA%8E%E7%99%BD%E5%B1%8F%E9%98%B6%E6%AE%B5%0A-%20%E8%99%BD%E7%84%B6HTML%E9%A1%B5%E9%9D%A2%E6%98%AF%E7%A9%BA%E7%9A%84%EF%BC%8C%E4%BD%86%E6%98%AF%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BC%9A%E8%A7%A3%E6%9E%90HTML%E5%86%85%E5%AE%B9%E3%80%82%E5%9B%A0%E4%B8%BA%E9%A1%B5%E9%9D%A2%E7%9A%84%E6%B8%B2%E6%9F%93%E4%BB%BB%E5%8A%A1%E6%98%AF%E7%94%B1JavaScript%E6%9D%A5%E5%AE%8C%E6%88%90%E7%9A%84%EF%BC%8C%E6%89%80%E4%BB%A5%E5%BD%93JavaScript%E8%A2%AB%E8%A7%A3%E9%87%8A%E5%92%8C%E6%89%A7%E8%A1%8C%E5%90%8E%E6%89%8D%E4%BC%9A%E6%B8%B2%E6%9F%93%E5%87%BA%E9%A1%B5%E9%9D%A2%E5%86%85%E5%AE%B9%EF%BC%8C%E5%8D%B3%E7%99%BD%E5%B1%8F%E7%BB%93%E6%9D%9F%0A-%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%86%8D%E9%80%9A%E8%BF%87AJAX%E6%8A%80%E6%9C%AF%E8%AF%B7%E6%B1%82API%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%B8%80%E6%97%A6%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B0%B1%E4%BC%9A%E5%AE%8C%E6%88%90%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9%E7%9A%84%E6%B8%B2%E6%9F%93%EF%BC%8C%E5%B9%B6%E5%91%88%E7%8E%B0%E5%AE%8C%E6%95%B4%E7%9A%84%E9%A1%B5%E9%9D%A2%0A%0ASSR%E4%B8%8ECSR%E7%9A%84%E6%AF%94%E8%BE%83%EF%BC%9A%0A%7C%7CSSR%7CCSR%7C%0A%7C-%7C-%7C-%7C%0A%7CSEO%7C%E5%8F%8B%E5%A5%BD%7C%E4%B8%8D%E5%8F%8B%E5%A5%BD%7C%0A%7C%E7%99%BD%E5%B1%8F%E9%97%AE%E9%A2%98%7C%E6%97%A0%7C%E6%9C%89%7C%0A%7C%E5%8D%A0%E7%94%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%B5%84%E6%BA%90%7C%E5%A4%9A%7C%E5%B0%91%7C%0A%7C%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%7C%E5%B7%AE%7C%E5%A5%BD%7C%0A%0A%0A**%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%EF%BC%9A**%0A%3E%20%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E5%88%86%E4%B8%BA%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93(%E5%8D%B3%E9%A6%96%E6%AC%A1%E8%AE%BF%E9%97%AE%E9%A1%B5%E9%9D%A2%E6%88%96%E5%88%B7%E6%96%B0%E9%A1%B5%E9%9D%A2)%E4%BB%A5%E5%8F%8A%E9%9D%9E%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%0A%3E%20%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E4%B8%AD%E7%9A%84%E9%A6%96%E6%AC%A1%E6%B8%B2%E6%9F%93%E4%B8%8ESSR%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%80%E8%87%B4%E3%80%82%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%EF%BC%8C%E5%BD%93%E9%A6%96%E6%AC%A1%E8%AE%BF%E9%97%AE%E6%88%96%E8%80%85%E5%88%B7%E6%96%B0%E9%A1%B5%E9%9D%A2%E6%97%B6%EF%BC%8C%E6%95%B4%E4%B8%AA%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%86%85%E5%AE%B9%E6%98%AF%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%8C%E6%88%90%E6%B8%B2%E6%9F%93%E7%9A%84%E3%80%82%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E6%89%80%E4%BA%A7%E7%94%9F%E7%9A%84HTML%E4%B8%8ESSR%E6%89%80%E4%BA%A7%E7%94%9F%E7%9A%84HTML%E9%A1%B5%E9%9D%A2%E6%9C%89%E4%B8%80%E7%82%B9%E6%9C%80%E5%A4%A7%E7%9A%84%E4%B8%8D%E5%90%8C%EF%BC%8C%E5%8D%B3%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E4%BA%A7%E7%94%9F%E7%9A%84HTML%E4%BC%9A%E5%8C%85%E5%90%AB%E5%BD%93%E5%89%8D%E9%A1%B5%E9%9D%A2%E6%89%80%E9%9C%80%E8%A6%81%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%80%9A%E8%BF%87API%E8%AF%B7%E6%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%9A%E8%A2%AB%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E5%B9%B6%E6%8B%BC%E6%8E%A5%E5%88%B0%E9%9D%99%E6%80%81%E7%9A%84HTML%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%0A%3E%20%E5%BD%93%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8E%A5%E5%8F%97%E5%88%B0%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93%E7%9A%84%E9%9D%99%E6%80%81HMTL%E9%A1%B5%E9%9D%A2%E5%90%8E%EF%BC%8C%E4%BC%9A%E8%A7%A3%E6%9E%90%E5%B9%B6%E6%B8%B2%E6%9F%93%E8%AF%A5%E9%A1%B5%E9%9D%A2%EF%BC%8C%E4%BC%9A%E5%8F%91%E7%8E%B0HTML%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%3Clink%3E%E5%92%8C%3Cscript%3E%EF%BC%8C%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%BA%94%E7%9A%84%E8%B5%84%E6%BA%90%E5%B9%B6%E6%BF%80%E6%B4%BB%EF%BC%8C%E8%BF%99%E9%87%8C%E7%9A%84%E6%BF%80%E6%B4%BB%E5%B0%B1%E6%98%AF%22hydration%22%0A%3E%20%E6%BF%80%E6%B4%BB%E5%8C%85%E5%90%AB%E4%B8%A4%E9%83%A8%E5%88%86%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AE%B9%EF%BC%9A%0A%3E%20-%20Vue%E5%9C%A8%E5%BD%93%E5%89%8D%E9%A1%B5%E9%9D%A2%E5%B7%B2%E7%BB%8F%E6%B8%B2%E6%9F%93%E7%9A%84DOM%E5%85%83%E7%B4%A0%E4%BB%A5%E5%8F%8AVue%E7%BB%84%E4%BB%B6%E6%89%80%E6%B8%B2%E6%9F%93%E7%9A%84%E8%99%9A%E6%8B%9FDOM%E4%B9%8B%E9%97%B4%E5%BB%BA%E7%AB%8B%E8%81%94%E7%B3%BB%0A%3E%20-%20Vue%E4%BB%8EHTML%E4%B8%AD%E6%8F%90%E5%8F%96%E7%94%B1%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BA%8F%E5%88%97%E5%8C%96%E5%90%8E%E5%8F%91%E9%80%81%E8%BF%87%E6%9D%A5%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E7%94%A8%E4%BB%A5%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B4%E4%B8%AAVuejs%E7%A8%8B%E5%BA%8F%0A%0A%3E%20%E6%BF%80%E6%B4%BB%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E6%95%B4%E4%B8%AA%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%B7%B2%E7%BB%8F%E5%AE%8C%E5%85%A8%E8%A2%ABVue%E6%8E%A5%E7%AE%A1%E4%B8%BACSR%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%BA%86%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%88%B7%E6%96%B0%E9%A1%B5%E9%9D%A2%EF%BC%8C%E4%BB%8D%E7%84%B6%E4%BC%9A%E8%BF%9B%E8%A1%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E8%BF%9B%E8%A1%8C%E6%BF%80%E6%B4%BB%EF%BC%8C%E5%A6%82%E6%AD%A4%E5%BE%80%E5%A4%8D%0A%0A%E5%AF%B9%E6%AF%94%EF%BC%9A%0A%7C%7CSSR%7CCSR%7C%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%7C%0A%7C-%7C-%7C-%7C-%7C%0A%7CSEO%7C%E5%8F%8B%E5%A5%BD%7C%E4%B8%8D%E5%8F%8B%E5%A5%BD%7C%E5%8F%8B%E5%A5%BD%0A%7C%E7%99%BD%E5%B1%8F%E9%97%AE%E9%A2%98%7C%E6%97%A0%7C%E6%9C%89%7C%E6%97%A0%0A%7C%E5%8D%A0%E7%94%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%B5%84%E6%BA%90%7C%E5%A4%9A%7C%E5%B0%91%7C%E4%B8%AD%0A%7C%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%7C%E5%B7%AE%7C%E5%A5%BD%7C%E5%A5%BD%0A%0A**%60%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E6%97%A0%E6%B3%95%E6%8F%90%E5%8D%87%E5%8F%AF%E4%BA%A4%E4%BA%92%E6%97%B6%E9%97%B4(TTI)%60**%0A%0A%3E%20%E5%90%8C%E6%9E%84%E7%9A%84%E5%90%AB%E4%B9%89%E6%98%AF%EF%BC%8C%E5%90%8C%E6%A0%B7%E4%B8%80%E5%A5%97%E4%BB%A3%E7%A0%81%E6%97%A2%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%90%E8%A1%8C%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%90%E8%A1%8C%0A%0A%23%23%23%23%20%E5%B0%86%E8%99%9A%E6%8B%9FDOM%E6%B8%B2%E6%9F%93%E4%B8%BAHTML%E5%AD%97%E7%AC%A6%E4%B8%B2%0A%60%60%60js%0Aconst%20ElementVNode%20%3D%20%7B%0A%20%20%20%20type%3A%20'div'%2C%0A%20%20%20%20props%3A%20%7B%0A%20%20%20%20%20%20%20%20id%3A%20'foo'%0A%20%20%20%20%7D%2C%0A%20%20%20%20children%3A%20%5B%0A%20%20%20%20%20%20%20%20%7B%20type%3A%20'p'%2C%20children%3A%20'hello'%20%7D%0A%20%20%20%20%5D%0A%7D%0A%2F%2F%20%E4%B8%BA%E4%BA%86%E5%B0%86%E5%85%B6%E6%B8%B2%E6%9F%93%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E9%9C%80%E8%A6%81%E5%AE%9E%E7%8E%B0renderElementVNode%0Afunction%20renderElementVNode(vnode)%20%7B%0A%20%20%20%20%2F%2F%20%E5%8F%96%E5%87%BA%E6%A0%87%E7%AD%BE%E5%90%8D%E7%A7%B0tag%E5%92%8C%E6%A0%87%E7%AD%BE%E5%B1%9E%E6%80%A7props%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%A0%87%E7%AD%BE%E5%AD%90%E8%8A%82%E7%82%B9%0A%20%20%20%20const%20%7B%20type%3A%20tag%2C%20props%2C%20children%20%7D%20%3D%20vnode%0A%20%20%20%20%2F%2F%20%E5%BC%80%E5%A7%8B%E6%A0%87%E7%AD%BE%E7%9A%84%E5%A4%B4%E9%83%A8%0A%20%20%20%20let%20ret%20%3D%20%60%3C%24%7Btag%7D%60%0A%20%20%20%20%0A%20%20%20%20if%20(props)%20%7B%0A%20%20%20%20%20%20%20%20for(const%20k%20in%20props)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E4%BB%A5key%3D%22value%22%E7%9A%84%E5%BD%A2%E5%BC%8F%E6%8B%BC%E6%8E%A5%E5%AD%97%E7%AC%A6%E4%B8%B2%0A%20%20%20%20%20%20%20%20%20%20%20%20ret%20%2B%3D%20%60%20%24%7Bk%7D%3D%22%24%7Bprops%5Bk%5D%7D%22%60%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20%E5%BC%80%E5%A7%8B%E6%A0%87%E7%AD%BE%E9%97%AD%E5%90%88%0A%20%20%20%20ret%20%2B%3D%20%60%3E%60%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E5%A4%84%E7%90%86%E5%AD%90%E8%8A%82%E7%82%B9%0A%20%20%20%20if%20(typeof%20children%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20ret%20%2B%3D%20children%0A%20%20%20%20%7D%20else%20if%20(Array.isArray(children))%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A6%82%E6%9E%9C%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%98%AF%E6%95%B0%E7%BB%84%EF%BC%8C%E5%88%99%E9%80%92%E5%BD%92%E8%B0%83%E7%94%A8renderElementVNode%0A%20%20%20%20%20%20%20%20children.forEach(child%20%3D%3E%20ret%20%2B%3D%20renderElementVNode(child))%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E7%BB%93%E6%9D%9F%E6%A0%87%E7%AD%BE%0A%20%20%20%20ret%20%2B%3D%20%60%3C%2F%24%7Btag%7D%3E%60%0A%20%20%20%20%0A%20%20%20%20return%20ret%0A%7D%0A%0A%2F%2F%20%E4%BE%9D%E7%84%B6%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9A%0A%2F%2F%201.%E8%87%AA%E9%97%AD%E5%92%8C%E6%A0%87%E7%AD%BE%E7%9A%84%E5%A4%84%E7%90%86%0A%2F%2F%202.%E5%AF%B9Props%E5%A4%84%E7%90%86%EF%BC%8C%E8%80%83%E8%99%91%E6%98%AF%E5%90%A6%E5%90%88%E6%B3%95%EF%BC%8C%E6%98%AF%E5%90%A6%E8%BF%9B%E8%A1%8CHTML%E8%BD%AC%E4%B9%89%0A%2F%2F%203.%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%8F%AF%E8%83%BD%E6%98%AFFragment%E3%80%81%E7%BB%84%E4%BB%B6%E3%80%81%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6%E3%80%81%E6%96%87%E6%9C%AC%E7%AD%89%0A%2F%2F%204.%E6%A0%87%E7%AD%BE%E7%9A%84%E6%96%87%E6%9C%AC%E5%AD%90%E8%8A%82%E7%82%B9%E4%B9%9F%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8CHTML%E8%BD%AC%E4%B9%89%0A%0A%0A%2F%2F%201.%E8%87%AA%E9%97%AD%E5%92%8C%E6%A0%87%E7%AD%BE%0A%2F%2F%20%E4%B8%8D%E6%B7%BB%E5%8A%A0%E7%BB%93%E6%9D%9F%E6%A0%87%E7%AD%BE%EF%BC%8C%E5%90%8C%E6%A0%B7%E4%B9%9F%E6%B2%A1%E6%9C%89%E5%AD%90%E8%8A%82%E7%82%B9%EF%BC%8C%E4%B8%8D%E5%A4%84%E7%90%86%0A%0A%2F%2F%202.props%0A%2F%2F%20key%E5%B1%9E%E6%80%A7%E4%BB%85%E7%94%A8%E4%BA%8EDiff%E7%AE%97%E6%B3%95%EF%BC%8CRef%E5%B1%9E%E6%80%A7%E4%BB%85%E7%94%A8%E4%BA%8E%E5%AE%9E%E7%8E%B0template%20ref%E5%8A%9F%E8%83%BD%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%97%B6%E5%BA%94%E8%AF%A5%E5%BF%BD%E7%95%A5%E8%BF%99%E4%BA%9B%E5%B1%9E%E6%80%A7%0A%2F%2F%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E4%B9%9F%E6%97%A0%E9%9C%80%E8%80%83%E8%99%91%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%0A%60%60%60%0A%0A%23%23%23%23%20%E5%B0%86%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E4%B8%BAHTML%E5%AD%97%E7%AC%A6%E4%B8%B2%0A%60%60%60html%0Aconst%20MyComponent%20%3D%20%7B%0A%20%20%20%20setup()%20%7B%0A%20%20%20%20%20%20%20%20return%20()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20type%3A%20'div'%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20children%3A%20'hello'%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%2F%2F%20%E7%94%A8%E6%9D%A5%E6%8F%8F%E8%BF%B0%E7%BB%84%E4%BB%B6%E7%9A%84VNode%E5%AF%B9%E8%B1%A1%0Aconst%20CompVNode%20%3D%20%7B%0A%20%20%20%20type%3A%20MyComponent%0A%7D%0A%60%60%60%0A%0A%60%60%60js%0A%2F%2F%20%E6%B8%B2%E6%9F%93%E7%BB%84%E4%BB%B6%0Aconst%20html%20%3D%20renderComponentVNode(CompVNode)%0A%0Afunction%20renderComponentVNode(vnode)%20%7B%0A%20%20%20%20%2F%2F%20%E8%8E%B7%E5%8F%96setup%E7%BB%84%E4%BB%B6%E9%80%89%E9%A1%B9%0A%20%20%20%20let%20%7B%20type%3A%20%7B%20setup%20%7D%20%7D%20%3D%20vnode%0A%20%20%20%20%2F%2F%20%E6%89%A7%E8%A1%8Csetup%E5%87%BD%E6%95%B0%E5%BE%97%E5%88%B0%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0render%0A%20%20%20%20const%20render%20%3D%20setup()%0A%20%20%20%20%2F%2F%20%E6%89%A7%E8%A1%8C%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E5%BE%97%E5%88%B0subTree%2C%E5%8D%B3%E7%BB%84%E4%BB%B6%E8%A6%81%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%0A%20%20%20%20const%20subTree%20%3D%20render()%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8renderElementVNode%E5%AE%8C%E6%88%90%E6%B8%B2%E6%9F%93%EF%BC%8C%E5%B9%B6%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%0A%20%20%20%20return%20renderElementVNode(subTree)%0A%7D%0A%2F%2F%20%E4%BB%8D%E7%84%B6%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98%EF%BC%9A%0A%2F%2F%201.subTree%E6%9C%AC%E8%BA%AB%E5%8F%AF%E8%83%BD%E6%98%AF%E4%BB%BB%E6%84%8F%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%EF%BC%8C%E4%B8%8D%E8%83%BD%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8renderElementVNode%E6%9D%A5%E6%B8%B2%E6%9F%93%0A%2F%2F%202.%E6%89%A7%E8%A1%8Csetup%E5%87%BD%E6%95%B0%E6%97%B6%EF%BC%8C%E4%B9%9F%E5%BA%94%E8%AF%A5%E6%8F%90%E4%BE%9BsetupContext%E5%AF%B9%E8%B1%A1%E3%80%82%E8%80%8C%E6%89%A7%E8%A1%8C%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0render%E6%97%B6%EF%BC%8C%E4%B9%9F%E5%BA%94%E8%AF%A5%E5%B0%86%E5%85%B6%E6%8C%87%E5%90%91renderContext%E5%AF%B9%E8%B1%A1%0A%0A%2F%2F%201.%E8%A7%A3%E5%86%B3%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98%0A%2F%2F%20%E5%B0%81%E8%A3%85%E9%80%9A%E7%94%A8%E5%87%BD%E6%95%B0%0Afunction%20renderVNode(vnode)%20%7B%0A%20%20%20%20const%20type%20%3D%20typeof%20vnode.type%0A%20%20%20%20if%20(type%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20return%20renderElementVNode(vnode)%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%3D%20'object'%20%7C%7C%20type%20%3D%3D%3D%20'function')%20%7B%0A%20%20%20%20%20%20%20%20return%20renderComponentVNode(vnode)%0A%20%20%20%20%7D%20else%20if%20(vnode.type%20%3D%3D%3D%20TEXT)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A4%84%E7%90%86%E6%96%87%E6%9C%AC%0A%20%20%20%20%7D%20else%20if%20(vnode.type%20%3D%3D%3D%20Fragment)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A4%84%E7%90%86%E7%89%87%E6%AE%B5%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%A4%84%E7%90%86%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B%0A%20%20%20%20%7D%0A%7D%0A%2F%2F%20%E4%BD%BF%E7%94%A8renderVNode%0Afunction%20renderComponentVNode(vnode)%20%7B%0A%20%20%20%20%2F%2F%20%E8%8E%B7%E5%8F%96setup%E7%BB%84%E4%BB%B6%E9%80%89%E9%A1%B9%0A%20%20%20%20let%20%7B%20type%3A%20%7B%20setup%20%7D%20%7D%20%3D%20vnode%0A%20%20%20%20%2F%2F%20%E6%89%A7%E8%A1%8Csetup%E5%87%BD%E6%95%B0%E5%BE%97%E5%88%B0%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0render%0A%20%20%20%20const%20render%20%3D%20setup()%0A%20%20%20%20%2F%2F%20%E6%89%A7%E8%A1%8C%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E5%BE%97%E5%88%B0subTree%2C%E5%8D%B3%E7%BB%84%E4%BB%B6%E8%A6%81%E6%B8%B2%E6%9F%93%E7%9A%84%E5%86%85%E5%AE%B9%0A%20%20%20%20const%20subTree%20%3D%20render()%0A%20%20%20%20%2F%2F%20%E8%B0%83%E7%94%A8renderElementVNode%E5%AE%8C%E6%88%90%E6%B8%B2%E6%9F%93%EF%BC%8C%E5%B9%B6%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%0A%20%20%20%20return%20renderVNode(subTree)%0A%7D%0A%0A%2F%2F%202.%E8%A7%A3%E5%86%B3setup%0A%2F%2F%20%E5%9C%A8%E8%BF%9B%E8%A1%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%97%B6%EF%BC%8C%E7%BB%84%E4%BB%B6%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%97%B6%E7%BB%84%E4%BB%B6%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9F%BA%E6%9C%AC%E4%B8%80%E8%87%B4%EF%BC%8C%E4%BD%86%E6%9C%89%E4%B8%A4%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%0A%2F%2F%20-%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E7%9A%84%E6%98%AF%E5%BA%94%E7%94%A8%E7%9A%84%E5%BD%93%E5%89%8D%E5%BF%AB%E7%85%A7%EF%BC%8C%E5%AE%83%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%8F%98%E6%9B%B4%E5%90%8E%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%E7%9A%84%E6%83%85%E5%86%B5%E3%80%82%E5%9B%A0%E6%AD%A4%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%83%BD%E6%97%A0%E9%A1%BB%E6%98%AF%E5%93%8D%E5%BA%94%E5%BC%8F%E7%9A%84%E3%80%82%E5%88%A9%E7%94%A8%E8%BF%99%E4%B8%80%E7%82%B9%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%87%8F%E5%B0%91%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BC%80%E9%94%80%0A%2F%2F%20-%20%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E5%8F%AA%E9%9C%80%E8%A6%81%E8%8E%B7%E5%8F%96%E7%BB%84%E4%BB%B6%E8%A6%81%E6%B8%B2%E6%9F%93%E7%9A%84subTree%E5%8D%B3%E5%8F%AF%EF%BC%8C%E6%97%A0%E9%A1%BB%E8%B0%83%E7%94%A8%E6%B8%B2%E6%9F%93%E5%99%A8%E5%AE%8C%E6%88%90%E7%9C%9F%E5%AE%9EDOM%E7%9A%84%E5%88%9B%E5%BB%BA%0A%0A%2F%2F%20%E7%94%B1%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E4%B8%8D%E9%9C%80%E8%A6%81%E6%B8%B2%E6%9F%93%E7%9C%9F%E5%AE%9EDOM%EF%BC%8C%E6%89%80%E4%BB%A5%E6%97%A0%E9%A1%BB%E5%88%9B%E5%BB%BA%E5%B9%B6%E6%89%A7%E8%A1%8Crender%20effect%E3%80%82%E8%BF%99%E6%84%8F%E5%91%B3%E7%9D%80%EF%BC%8C%E7%BB%84%E4%BB%B6%E7%9A%84beforeMount%E4%BB%A5%E5%8F%8Amounted%E9%92%A9%E5%AD%90%E4%B8%8D%E4%BC%9A%E8%A2%AB%E8%A7%A6%E5%8F%91%E3%80%82%E8%80%8C%E4%B8%94%EF%BC%8C%E7%94%B1%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E4%B8%8D%E5%AD%98%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%8F%98%E6%9B%B4%E5%90%8E%E7%9A%84%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93%E9%80%BB%E8%BE%91%EF%BC%8C%E6%89%80%E4%BB%A5beforeUpdate%E4%B8%8Eupdated%E9%92%A9%E5%AD%90%E4%B9%9F%E4%B8%8D%E4%BC%9A%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%89%A7%E8%A1%8C%0A%60%60%60%0A%0A%0A%23%23%23%23%20%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%BF%80%E6%B4%BB%E7%9A%84%E5%8E%9F%E7%90%86%0A%0A%3E%20%E5%AF%B9%E4%BA%8E%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E6%9D%A5%E8%AF%B4%EF%BC%8C%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BC%9A%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%88%86%E5%88%AB%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%E3%80%82%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%8C%E7%BB%84%E4%BB%B6%E4%BC%9A%E8%A2%AB%E6%B8%B2%E6%9F%93%E4%B8%BA%E9%9D%99%E6%80%81%E7%9A%84HTML%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E7%84%B6%E5%90%8E%E5%8F%91%E9%80%81%E7%BB%99%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E5%86%8D%E6%8A%8A%E8%BF%99%E6%AE%B5%E7%BA%AF%E9%9D%99%E6%80%81%E7%9A%84HTML%E6%B8%B2%E6%9F%93%E5%87%BA%E6%9D%A5%E3%80%82%E8%BF%99%E6%84%8F%E5%91%B3%E7%9D%80%EF%BC%8C%E6%AD%A4%E6%97%B6%E9%A1%B5%E9%9D%A2%E4%B8%AD%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%E5%AF%B9%E5%BA%94%E7%9A%84DOM%E5%85%83%E7%B4%A0%E3%80%82%E5%90%8C%E6%97%B6%EF%BC%8C%E8%AF%A5%E7%BB%84%E4%BB%B6%E8%BF%98%E4%BC%9A%E8%A2%AB%E6%89%93%E5%8C%85%E5%88%B0%E4%B8%80%E4%B8%AAJavaScript%E6%96%87%E4%BB%B6%E4%B8%AD%EF%BC%8C%E5%B9%B6%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%A2%AB%E4%B8%8B%E8%BD%BD%E5%88%B0%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E8%A7%A3%E9%87%8A%E5%B9%B6%E6%89%A7%E8%A1%8C%E3%80%82%E8%BF%99%E6%97%B6%E9%97%AE%E9%A2%98%E6%9D%A5%E4%BA%86%EF%BC%8C%E5%BD%93%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BB%A3%E7%A0%81%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%89%A7%E8%A1%8C%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%86%8D%E6%AC%A1%E5%88%9B%E5%BB%BADOM%E5%90%97%EF%BC%9F%E7%AD%94%E6%A1%88%E6%98%AF%E4%B8%8D%E4%BC%9A%E3%80%82%E7%94%B1%E4%BA%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E5%9C%A8%E6%B8%B2%E6%9F%93%E4%BA%86%E7%94%B1%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%8F%91%E9%80%81%E8%BF%87%E6%9D%A5%E7%9A%84HTML%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B9%8B%E5%90%8E%EF%BC%8C%E9%A1%B5%E9%9D%A2%E4%B8%AD%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%E5%AF%B9%E5%BA%94%E7%9A%84DOM%E5%85%83%E7%B4%A0%E4%BA%86%EF%BC%8C%E6%89%80%E4%BB%A5%E7%BB%84%E4%BB%B6%E4%BB%A3%E7%A0%81%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%90%E8%A1%8C%E6%97%B6%EF%BC%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E5%86%8D%E6%AC%A1%E5%88%9B%E5%BB%BA%E5%93%8D%E5%BA%94%E7%9A%84DOM%E5%85%83%E7%B4%A0%E3%80%82%E4%BD%86%E6%98%AF%E7%BB%84%E4%BB%B6%E4%BB%A3%E7%A0%81%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%8D%E7%84%B6%E9%9C%80%E8%A6%81%E5%81%9A%E4%B8%A4%E4%BB%B6%E9%87%8D%E8%A6%81%E7%9A%84%E4%BA%8B%E6%83%85%EF%BC%9A%0A%3E%20-%20%E5%9C%A8%E9%A1%B5%E9%9D%A2%E4%B8%AD%E7%9A%84DOM%E5%85%83%E7%B4%A0%E4%B8%8E%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E5%AF%B9%E8%B1%A1%E4%B9%8B%E9%97%B4%E5%BB%BA%E7%AB%8B%E8%81%94%E7%B3%BB%0A%3E%20-%20%E4%B8%BA%E9%A1%B5%E9%9D%A2%E4%B8%AD%E7%9A%84DOM%E5%85%83%E7%B4%A0%E6%B7%BB%E5%8A%A0%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%0A%0A%0A%3E%20%E4%B8%80%E4%B8%AA%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E8%A2%AB%E6%8C%82%E8%BD%BD%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%B8%BA%E4%BA%86%E4%BF%9D%E8%AF%81%E6%9B%B4%E6%96%B0%E7%A8%8B%E5%BA%8F%E8%83%BD%E6%AD%A3%E7%A1%AE%E8%BF%90%E8%A1%8C%EF%BC%8C%E9%9C%80%E8%A6%81%E9%80%9A%E8%BF%87%E8%AF%A5%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E7%9A%84vnode.el%E5%B1%9E%E6%80%A7%E5%AD%98%E5%82%A8%E5%AF%B9%E7%9C%9F%E5%AE%9EDOM%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BC%95%E7%94%A8%E3%80%82%E8%80%8C%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E4%B9%9F%E6%98%AF%E4%B8%80%E6%A0%B7%EF%BC%8C%E4%B8%BA%E4%BA%86%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%9C%A8%E5%90%8E%E7%BB%AD%E6%9B%B4%E6%96%B0%E8%BF%87%E7%A8%8B%E4%B8%AD%E8%83%BD%E5%A4%9F%E6%AD%A3%E7%A1%AE%E8%BF%90%E8%A1%8C%EF%BC%8C%E9%9C%80%E8%A6%81%E5%9C%A8%E9%A1%B5%E9%9D%A2%E4%B8%AD%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%E7%9A%84DOM%E5%AF%B9%E8%B1%A1%E4%B8%8E%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E5%AF%B9%E8%B1%A1%E4%B9%8B%E9%97%B4%E5%BB%BA%E7%AB%8B%E6%AD%A3%E7%A1%AE%E7%9A%84%E8%81%94%E7%B3%BB%0A%0A%60%60%60js%0A%2F%2F%20%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E4%BD%BF%E7%94%A8render.hydrate%E6%9D%A5%E5%AE%8C%E6%88%90%E6%BF%80%E6%B4%BB%0Arenderer.hydrate(vnode%2C%20container)%0A%0A%2F%2F%20mock%E6%B5%81%E7%A8%8B%0A%2F%2F%20html%E4%BB%A3%E8%A1%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%0Aconst%20html%20%3D%20renderComponentVNode(compVNode)%0A%2F%2F%20%E8%8E%B7%E5%8F%96%E6%8C%82%E8%BD%BD%E7%82%B9%0Aconst%20container%20%3D%20document.querySelector('%23app')%0Acontainer.innerHTML%20%3D%20html%0A%0A%2F%2F%20%E6%BF%80%E6%B4%BB%0Arenderer.hydrate(compVNode%2C%20container)%0A%0A%0A%2F%2F%20%E5%AE%9E%E7%8E%B0hydrate%0Afunction%20createRenderer(options)%20%7B%0A%20%20%20%20function%20hydrate(node%2C%20vnode)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20render%2C%0A%20%20%20%20%20%20%20%20hydrate%2C%0A%20%20%20%20%7D%0A%7D%0A%0Afunction%20hyrate(vnode%2C%20container)%20%7B%0A%20%20%20%20%2F%2F%20%E4%BB%8E%E5%AE%B9%E5%99%A8%E5%85%83%E7%B4%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AD%90%E8%8A%82%E7%82%B9%E5%BC%80%E5%A7%8B%0A%20%20%20%20hydrateNode(container%2C.firstChild%2C%20vnode)%0A%7D%0A%0Afunction%20hydrateNode(node%2C%20vnode)%20%7B%0A%20%20%20%20const%20%7B%20type%20%7D%20%3D%20vnode%0A%20%20%20%20%2F%2F%20%E8%AE%A9vnode%E5%BC%95%E7%94%A8%E7%9C%9F%E5%AE%9Enode%0A%20%20%20%20vnode.el%20%3D%20node%0A%20%20%20%20%2F%2F%20%E6%A3%80%E6%9F%A5%E8%99%9A%E6%8B%9FDOM%E7%9A%84%E7%B1%BB%E5%9E%8B%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%88%99%E8%B0%83%E7%94%A8mountCOmponent%E5%87%BD%E6%95%B0%E5%AE%8C%E6%88%90%E6%BF%80%E6%B4%BB%0A%20%20%20%20if(typeof%20type%20%3D%3D%3D%20'object')%20%7B%0A%20%20%20%20%20%20%20%20mountComponent(vnode%2C%20container%2C%20null)%0A%20%20%20%20%7D%20else%20if%20(typeof%20type%20%3D%3D%3D%20'string')%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%A3%80%E6%9F%A5%E7%9C%9F%E5%AE%9EDOM%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%B8%8E%E8%99%9A%E6%8B%9FDOM%E7%B1%BB%E5%9E%8B%E6%98%AF%E5%90%A6%E5%8C%B9%E9%85%8D%0A%20%20%20%20%20%20%20%20if%20(node.nodeType%20!%3D%3D%201)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20console.error('xxx')%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%99%AE%E9%80%9A%E5%85%83%E7%B4%A0%E8%B0%83%E7%94%A8hydrateElement%0A%20%20%20%20%20%20%20%20%20%20%20%20hydrateElement(node%2C%20vnode)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20hydrateNode%E5%87%BD%E6%95%B0%E9%9C%80%E8%A6%81%E8%BF%94%E5%9B%9E%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E7%9A%84%E4%B8%8B%E4%B8%80%E4%B8%AA%E5%85%84%E5%BC%9F%E8%8A%82%E7%82%B9%EF%BC%8C%E4%BB%A5%E4%BE%BF%E7%BB%A7%E7%BB%AD%E8%BF%9B%E8%A1%8C%E5%90%8E%E7%BB%AD%E7%9A%84%E6%BF%80%E6%B4%BB%E6%93%8D%E4%BD%9C%0A%20%20%20%20return%20node.nextSibling%0A%7D%0A%0Afunction%20hydrateElement(el%2C%20vnode)%20%7B%0A%20%20%20%20%2F%2F%20%E4%B8%BADOM%E5%85%83%E7%B4%A0%E6%B7%BB%E5%8A%A0%E4%BA%8B%E4%BB%B6%0A%20%20%20%20if(vnode.props)%20%7B%0A%20%20%20%20%20%20%20%20for(const%20key%20in%20vnode.props)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(%2F%5Eon%2F.test(key))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patchProps(el%2C%20key%2C%20null%2C%20vnode.props%5Bkey%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E9%80%92%E5%BD%92%E5%9C%B0%E6%BF%80%E6%B4%BB%E5%AD%90%E8%8A%82%E7%82%B9%0A%20%20%20%20if%20(Array.isArray(vnode.children))%20%7B%0A%20%20%20%20%20%20%20%20let%20nextNode%20%3D%20el.firstChild%0A%20%20%20%20%20%20%20%20const%20len%20%3D%20vnode.children.length%0A%20%20%20%20%20%20%20%20for(let%20i%20%3D%200%3B%20i%20%3C%20len%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20nextNode%20%3D%20hydrateNode(nextNode%2C%20vnode.children%5Bi%5D)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%2F%2F%20%E5%AF%B9%E4%BA%8E%E7%BB%84%E4%BB%B6%E7%9A%84%E6%BF%80%E6%B4%BB%EF%BC%8C%E8%BF%98%E9%9C%80%E8%A6%81%E9%92%88%E5%AF%B9%E6%80%A7%E5%9C%B0%E5%A4%84%E7%90%86mountComponent%E5%87%BD%E6%95%B0%0A%2F%2F%20%E7%94%B1%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E7%9A%84%E9%A1%B5%E9%9D%A2%E4%B8%AD%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%E7%9C%9F%E5%AE%9EDOM%E5%85%83%E7%B4%A0%EF%BC%8C%E6%89%80%E4%BB%A5%E8%B0%83%E7%94%A8mountComponent%E8%BF%9B%E8%A1%8C%E7%BB%84%E4%BB%B6%E7%9A%84%E6%8C%82%E8%BD%BD%E6%97%B6%EF%BC%8C%E6%97%A0%E9%A1%BB%E5%86%8D%E6%AC%A1%E5%88%9B%E5%BB%BA%E7%9C%9F%E5%AE%9EDOM%E5%85%83%E7%B4%A0%0Afunction%20mountComponent(vnode%2C%20container%2C%20anchor)%20%7B%0A%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%20instance.update%20%3D%20effect(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20const%20subTree%20%3D%20render.call(renderContext%2C%20renderContext)%0A%20%20%20%20%20%20%20%20if%20(!instance.isMounted)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20beforeMount%20%26%26%20beforeMount.call(renderContext)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(vnode.el)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%AD%98%E5%9C%A8vnode.el%EF%BC%8C%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B0%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hydrateNode(vnode.el%2C%20subTree)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E6%AD%A3%E5%B8%B8%E6%8C%82%E8%BD%BD%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20patch(null%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20instance.isMounted%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20mounted%20%26%26%20mounted.call(renderContext)%0A%20%20%20%20%20%20%20%20%20%20%20%20instance.mounted%20%26%26%20instance.mounted.forEach(hook%20%3D%3E%20hook.call(renderContext))%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20beforeUpdate%20%26%26%20beforeUpdate.call(renderContext)%0A%20%20%20%20%20%20%20%20%20%20%20%20patch(instance.subTree%2C%20subTree%2C%20container%2C%20anchor)%0A%20%20%20%20%20%20%20%20%20%20%20%20updated%20%26%26%20updated.call(renderContext)%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20instance.subTree%20%3D%20subTree%0A%20%20%20%20%20%7D%2C%20%7B%0A%20%20%20%20%20%20%20%20scheduler%3A%20queueJob%0A%20%20%20%20%20%7D)%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%20%E7%BC%96%E5%86%99%E5%90%8C%E6%9E%84%E7%9A%84%E4%BB%A3%E7%A0%81%0A%0A%23%23%23%23%23%20%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%0A%3E%20%E5%AE%9E%E9%99%85%E4%B8%8A%E5%8F%AA%E6%9C%89beforeCreate%E4%B8%8Ecreated%E8%BF%99%E4%B8%A4%E4%B8%AA%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E4%BC%9A%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%89%A7%E8%A1%8C%0A%0A%3E%20%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%97%B6%EF%BC%8C%E5%AE%9A%E6%97%B6%E5%99%A8%E5%86%85%E7%9A%84%E4%BB%A3%E7%A0%81%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E6%84%8F%E4%B9%89%EF%BC%8C%E9%81%87%E5%88%B0%E8%BF%99%E7%A7%8D%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%EF%BC%9A%0A%3E%20-%20%E5%B0%86%E5%88%9B%E5%BB%BA%E5%AE%9A%E6%97%B6%E5%99%A8%E7%9A%84%E4%BB%A3%E7%A0%81%E7%A7%BB%E5%8A%A8%E5%88%B0mounted%E9%92%A9%E5%AD%90%E4%B8%AD%EF%BC%8C%E5%8D%B3%E5%8F%AA%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E5%99%A8%0A%3E%20-%20%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%8C%85%E8%A3%B9%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%AE%A9%E5%85%B6%E4%B8%8D%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%AD%E8%BF%90%E8%A1%8C%0A%0A%60%60%60js%0Acreate()%20%7B%0A%20%20%20%20if%20(!import.meta.env.SSR)%20%7B%0A%20%20%20%20%20%20%20%20this.timer%20%3D%20setInterval(()%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20...%0A%20%20%20%20%20%20%20%20%7D%2C%201000)%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A%23%23%23%23%23%20%E4%BD%BF%E7%94%A8%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%9A%84API%0A%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81%E6%97%B6%EF%BC%8C%E8%A6%81%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E5%B9%B3%E5%8F%B0%E7%89%B9%E6%9C%89%E7%9A%84API%0A%0A%23%23%23%23%23%20%E5%8F%AA%E5%9C%A8%E6%9F%90%E4%B8%80%E7%AB%AF%E5%BC%95%E5%85%A5%E6%A8%A1%E5%9D%97%0A%3E%20%E4%BD%BF%E7%94%A8import.meta.env.SSR%E6%9D%A5%E5%81%9A%E4%BB%A3%E7%A0%81%E5%AE%88%E5%8D%AB%0A%0A%23%23%23%23%23%20%E9%81%BF%E5%85%8D%E4%BA%A4%E5%8F%89%E8%AF%B7%E6%B1%82%E5%BC%95%E8%B5%B7%E7%9A%84%E7%8A%B6%E6%80%81%E6%B1%A1%E6%9F%93%0A%3E%20%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%97%B6%EF%BC%8C%E4%BC%9A%E4%B8%BA%E6%AF%8F%E4%B8%80%E4%B8%AA%E8%AF%B7%E6%B1%82%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%85%A8%E6%96%B0%E7%9A%84%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B%E3%80%81%0A%0A%0A%23%23%23%23%23%20%3CClientOnly%3E%E7%BB%84%E4%BB%B6%0A%60%60%60html%0A%0A%3Ctempalte%3E%0A%20%20%20%20%3CClientOnly%3E%0A%20%20%20%20%20%20%20%20%3CSsrIncompatibleComp%2F%3E%0A%20%20%20%20%3C%2FClientOnly%3E%0A%3C%2Ftemplate%3E%0A%60%60%60</center></body></html>